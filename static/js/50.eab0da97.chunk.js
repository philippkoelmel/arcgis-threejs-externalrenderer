(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[50,192],{1079:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return j}));var r=i(13),n=i(2),a=i(4),s=i(28),o=i(27),l=i(6),c=i(7),d=i(0),u=i(134),h=i(3),f=i(1),b=(i(17),i(18),i(15),i(11)),v=i(46),y=i(42),g=i(844),m=i(578),_=i(420),p=i(577),O=function(e){Object(l.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(n.a)(this,i),(e=t.apply(this,arguments)).type="integrated-mesh-3d",e.lodFactor=1,e._elevationContext="im",e._isIntegratedMesh=!0,e._supportsLabeling=!1,e.drapeTargetType=1,e._overlayTexOffset=Object(v.g)(-1,-1,-1,-1),e._overlayTexScale=Object(v.e)(),e._overlayColor=null,e._overlayHighlight=null,e._overlayNormal=null,e}return Object(a.a)(i,[{key:"progressiveLoadFactor",get:function(){return this.lodFactor>=1?.2:1}},{key:"setDrapingTextures",value:function(e){var t=this;this._clearDrapingTexture(0),this._clearDrapingTexture(1);var i,n=Object(r.a)(e);try{for(n.s();!(i=n.n()).done;){var a=i.value,s=a.index,o=a.extent,l=a.needsColorWithoutRasterImage?a.getValidTarget(1):a.hasDrapedFeatureSource?a.getValidTarget(0):null;if(Object(h.k)(l)&&Object(y.d)(o)>0){this._overlayTexOffset[2*s]=-o[0]/Object(y.A)(o),this._overlayTexOffset[2*s+1]=-o[1]/Object(y.u)(o),this._overlayTexScale[2*s]=1/Object(y.A)(o),this._overlayTexScale[2*s+1]=1/Object(y.u)(o);var c=a.getValidTarget(2),d=a.getValidTarget(3);this._overlayColor=l.getTexture(),this._overlayHighlight=c?c.getTexture():null,this._overlayNormal=d?d.getTexture():null}}}catch(u){n.e(u)}finally{n.f()}this._forAllNodes((function(e){return Object(h.k)(e)&&t._collection.updateMaterial(e.objectHandle,(function(e){return t._updateMaterialOverlay(e)}))}))}},{key:"_clearDrapingTexture",value:function(e){this._overlayTexOffset[2*e]=-1,this._overlayTexOffset[2*e+1]=-1,this._overlayTexScale[2*e]=0,this._overlayTexScale[2*e+1]=0,this._overlayColor=null,this._overlayHighlight=null,this._overlayNormal=null}},{key:"_updateMaterialOverlay",value:function(e){e.overlayColor=this._overlayColor,e.overlayHighlight=this._overlayHighlight,e.overlayNormal=this._overlayNormal,e.overlayTexOffset=this._overlayTexOffset,e.overlayTexScale=this._overlayTexScale}},{key:"initialize",value:function(){var e=this;this.updatingHandles.add(this.layer,"modifications",(function(){return e._loadModifications()}),2)}},{key:"_createLayerGraphic",value:function(){var e=new u.a;return e.layer=this.layer,e.sourceLayer=this.layer,e}},{key:"canResume",value:function(){return Object(s.a)(Object(o.a)(i.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)}},{key:"_loadModifications",value:function(){var e=this;if(this.handles.remove("modifications"),Object(h.j)(this.layer.modifications))this._modifications=[];else{var t=this.layer.modifications;this.handles.add(this.updatingHandles.addOnCollectionChange(t,(function(){return e._modifications=t.toArray()}),2),"modifications")}}}]),i}(Object(g.a)(Object(m.a)(p.a)));Object(d.a)([Object(f.b)()],O.prototype,"layer",void 0),Object(d.a)([Object(f.b)({aliasOf:"layer"})],O.prototype,"i3slayer",void 0),Object(d.a)([Object(f.b)()],O.prototype,"suspended",void 0),Object(d.a)([Object(f.b)(_.a)],O.prototype,"updatingProgress",void 0),Object(d.a)([Object(f.b)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],O.prototype,"updatingProgressValue",void 0),Object(d.a)([Object(f.b)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.integratedMesh.lodFactor"})],O.prototype,"lodFactor",void 0),Object(d.a)([Object(f.b)({readOnly:!0})],O.prototype,"progressiveLoadFactor",null);var j=O=Object(d.a)([Object(b.a)("esri.views.3d.layers.SceneLayerView3D")],O)},713:function(e,t,i){"use strict";i.r(t),i.d(t,"destroyContext",(function(){return x})),i.d(t,"dracoDecompressPointCloudData",(function(){return v})),i.d(t,"filterObbsForModifications",(function(){return g})),i.d(t,"filterObbsForModificationsSync",(function(){return w})),i.d(t,"initialize",(function(){return S})),i.d(t,"interpretObbModificationResults",(function(){return C})),i.d(t,"process",(function(){return f})),i.d(t,"setLegacySchema",(function(){return O})),i.d(t,"setModifications",(function(){return _})),i.d(t,"setModificationsSync",(function(){return k})),i.d(t,"test",(function(){return D}));var r,n,a,s=i(8),o=i.n(s),l=i(16),c=i(3),d=i(98),u=i(96);function h(e){return Object(u.b)("esri/libs/i3s/".concat(e))}function f(e){return b.apply(this,arguments)}function b(){return(b=Object(l.a)(o.a.mark((function e(t){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S();case 2:return i=[t.geometryBuffer],e.abrupt("return",{result:I(t,i),transferList:i});case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e){return y.apply(this,arguments)}function y(){return(y=Object(l.a)(o.a.mark((function e(t){var i,r,n,s,l,c,u,h,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S();case 2:if(r=[t.geometryBuffer],n=t.geometryBuffer,s=n.byteLength,l=a._malloc(s),(c=new Uint8Array(a.HEAPU8.buffer,l,s)).set(new Uint8Array(n)),u=a.dracoDecompressPointCloudData(l,c.byteLength),a._free(l),!(u.error.length>0)){e.next=7;break}throw"i3s.wasm: ".concat(u.error);case 7:return h=(null==(i=u.featureIds)?void 0:i.length)>0?Object(d.m)(u.featureIds):null,f=Object(d.m)(u.positions),h&&r.push(h.buffer),r.push(f.buffer),e.abrupt("return",{result:{positions:f,featureIds:h},transferList:r});case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e){return m.apply(this,arguments)}function m(){return(m=Object(l.a)(o.a.mark((function e(t){var i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S();case 2:return w(t),i={buffer:t.buffer},e.abrupt("return",{result:i,transferList:[i.buffer]});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _(e){return p.apply(this,arguments)}function p(){return(p=Object(l.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S();case 2:k(t);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function O(e){return j.apply(this,arguments)}function j(){return(j=Object(l.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,S();case 2:a.setLegacySchema(t.context,t.jsonSchema);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){N(e)}function k(e){for(var t=e.modifications,i=a._malloc(8*t.length),r=new Float64Array(a.HEAPU8.buffer,i,t.length),n=0;n<t.length;++n)r[n]=t[n];a.setModifications(e.context,i,t.length,e.isGeodetic),a._free(i)}function I(e,t){if(!a)return null;var i=e.context,r=e.localOrigin,n=e.globalTrafo,s=e.mbs,o=e.obb,l=e.elevationOffset,u=e.geometryBuffer,h=e.geometryDescriptor,f=e.indexToVertexProjector,b=e.vertexToRenderProjector,v=a._malloc(u.byteLength),y=a._malloc(33*Float64Array.BYTES_PER_ELEMENT),g=new Uint8Array(a.HEAPU8.buffer,v,u.byteLength);g.set(new Uint8Array(u));var m=new Float64Array(a.HEAPU8.buffer,y,33);M(m,r);var _=m.byteOffset+3*m.BYTES_PER_ELEMENT,p=new Float64Array(m.buffer,_);M(p,n),_+=16*m.BYTES_PER_ELEMENT,M(p=new Float64Array(m.buffer,_),s),_+=4*m.BYTES_PER_ELEMENT,Object(c.k)(o)&&(M(p=new Float64Array(m.buffer,_),o.center),_+=3*m.BYTES_PER_ELEMENT,M(p=new Float64Array(m.buffer,_),o.halfSize),_+=3*m.BYTES_PER_ELEMENT,M(p=new Float64Array(m.buffer,_),o.quaternion));var O=h,j={isDraco:!1,isLegacy:!1,color:e.layouts.some((function(e){return e.some((function(e){return"color"===e.name}))})),normal:e.needNormals&&e.layouts.some((function(e){return e.some((function(e){return"normalCompressed"===e.name}))})),uv0:e.layouts.some((function(e){return e.some((function(e){return"uv0"===e.name}))})),uvRegion:e.layouts.some((function(e){return e.some((function(e){return"uvRegion"===e.name}))})),featureIndex:O.featureIndex},x=a.process(i,!!e.obb,v,g.byteLength,O,j,y,l,f,b,e.normalReferenceFrame);if(a._free(y),a._free(v),x.error.length>0)throw"i3s.wasm: ".concat(x.error);if(x.discarded)return null;var k=x.componentOffsets.length>0?Object(d.m)(x.componentOffsets):null,I=x.featureIds.length>0?Object(d.m)(x.featureIds):null,C=Object(d.m)(x.interleavedVertedData).buffer,w=1===x.indicesType?Object(d.m)(new Uint16Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/2)):Object(d.m)(new Uint32Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/4)),N=Object(d.m)(x.positions),S=1===x.positionIndicesType?Object(d.m)(new Uint16Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/2)):Object(d.m)(new Uint32Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/4)),D={layout:e.layouts[0],interleavedVertexData:C,indices:w,hasColors:x.hasColors,hasModifications:x.hasModifications,positionData:{data:N,indices:S}};return I&&t.push(I.buffer),k&&t.push(k.buffer),t.push(C),t.push(w.buffer),t.push(N.buffer),t.push(S.buffer),{componentOffsets:k,featureIds:I,transformedGeometry:D,obb:x.obb}}function C(e){return 0===e?0:1===e?1:2===e?2:3}function w(e){var t=e.context,i=e.buffer,r=a._malloc(i.byteLength),n=i.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(a.HEAPU8.buffer,r,n),o=new Float64Array(i);s.set(o),a.filterOBBs(t,r,n),o.set(s),a._free(r)}function N(e){a&&a.destroy(e)}function M(e,t){for(var i=0;i<t.length;++i)e[i]=t[i]}function S(){return a?Promise.resolve():(n||(n=(r||(r=new Promise((function(e){return i.e(95).then(i.bind(null,1121)).then((function(e){return e.i})).then((function(t){var i=(0,t.default)({locateFile:h,onRuntimeInitialized:function(){return e(i)}});delete i.then}))})).catch((function(e){return Promise.reject(e)}))),r).then((function(e){a=e,n=null}))),n)}var D={transform:I,destroy:N}},754:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(13),n=i(3);function a(e,t){return e?t?4:3:t?3:2}function s(e,t,i,s,c){if(Object(n.j)(t)||!t.lengths.length)return null;var d="upperLeft"===(null==c?void 0:c.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);var u,h=e.coords,f=[],b=i?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],v=t.lengths,y=t.coords,g=a(i,s),m=0,_=Object(r.a)(v);try{for(_.s();!(u=_.n()).done;){var p=u.value,O=o(b,y,m,p,i,s,d);O&&f.push(O),m+=p*g}}catch(k){_.e(k)}finally{_.f()}if(f.sort((function(e,t){var r=d*e[2]-d*t[2];return 0===r&&i&&(r=e[4]-t[4]),r})),f.length){var j=6*f[0][2];h[0]=f[0][0]/j,h[1]=f[0][1]/j,i&&(j=6*f[0][4],h[2]=0!==j?f[0][3]/j:0),(h[0]<b[0]||h[0]>b[1]||h[1]<b[2]||h[1]>b[3]||i&&(h[2]<b[4]||h[2]>b[5]))&&(h.length=0)}if(!h.length){var x=t.lengths[0]?l(y,0,v[0],i,s):null;if(!x)return null;h[0]=x[0],h[1]=x[1],i&&x.length>2&&(h[2]=x[2])}return e}function o(e,t,i,r,n,s){for(var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,l=a(n,s),c=i,d=i+l,u=0,h=0,f=0,b=0,v=0,y=0,g=r-1;y<g;y++,c+=l,d+=l){var m=t[c],_=t[c+1],p=t[c+2],O=t[d],j=t[d+1],x=t[d+2],k=m*j-O*_;b+=k,u+=(m+O)*k,h+=(_+j)*k,n&&(f+=(p+x)*(k=m*x-O*p),v+=k),m<e[0]&&(e[0]=m),m>e[1]&&(e[1]=m),_<e[2]&&(e[2]=_),_>e[3]&&(e[3]=_),n&&(p<e[4]&&(e[4]=p),p>e[5]&&(e[5]=p))}if(b*o>0&&(b*=-1),v*o>0&&(v*=-1),!b)return null;var I=[u,h,.5*b];return n&&(I[3]=f,I[4]=.5*v),I}function l(e,t,i,r,n){for(var s=a(r,n),o=t,l=t+s,f=0,b=0,v=0,y=0,g=0,m=i-1;g<m;g++,o+=s,l+=s){var _=e[o],p=e[o+1],O=e[o+2],j=e[l],x=e[l+1],k=e[l+2],I=r?d(_,p,O,j,x,k):c(_,p,j,x);if(I)if(f+=I,r){var C=h(_,p,O,j,x,k);b+=I*C[0],v+=I*C[1],y+=I*C[2]}else{var w=u(_,p,j,x);b+=I*w[0],v+=I*w[1]}}return f>0?r?[b/f,v/f,y/f]:[b/f,v/f]:i>0?r?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}function c(e,t,i,r){var n=i-e,a=r-t;return Math.sqrt(n*n+a*a)}function d(e,t,i,r,n,a){var s=r-e,o=n-t,l=a-i;return Math.sqrt(s*s+o*o+l*l)}function u(e,t,i,r){return[e+.5*(i-e),t+.5*(r-t)]}function h(e,t,i,r,n,a){return[e+.5*(r-e),t+.5*(n-t),i+.5*(a-i)]}},764:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,n,a,s={exports:{}};r=s,n=function(){function e(i,r,n,a,s){for(;a>n;){if(a-n>600){var o=a-n+1,l=r-n+1,c=Math.log(o),d=.5*Math.exp(2*c/3),u=.5*Math.sqrt(c*d*(o-d)/o)*(l-o/2<0?-1:1);e(i,r,Math.max(n,Math.floor(r-l*d/o+u)),Math.min(a,Math.floor(r+(o-l)*d/o+u)),s)}var h=i[r],f=n,b=a;for(t(i,n,r),s(i[a],h)>0&&t(i,n,a);f<b;){for(t(i,f,b),f++,b--;s(i[f],h)<0;)f++;for(;s(i[b],h)>0;)b--}0===s(i[n],h)?t(i,n,b):t(i,++b,a),b<=r&&(n=b+1),r<=b&&(a=b-1)}}function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function i(e,t){return e<t?-1:e>t?1:0}return function(t,r,n,a,s){e(t,r,n||0,a||t.length-1,s||i)}},void 0!==(a=n())&&(r.exports=a);var o=s.exports},772:function(e,t,i){"use strict";function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}i.d(t,"a",(function(){return r}))},773:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return c}));var r=i(3),n=i(5),a=i(10),s=i(48),o=i(37);function l(e,t,i,r){for(var a=t.getComponentAabb(i,e,u),s=t.getObjectTransform(i),o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=4&o?a[2]:a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),r[3*o]=h[0],r[3*o+1]=h[1],r[3*o+2]=h[2];return r}function c(e,t,i){var n=new Float64Array(24);return function(a){var c=a.meta.featureExtents;if(Object(r.j)(c)){c=new Float64Array(6*a.meta.featureIds.length),a.meta.featureExtents=c;for(var d=0;d<c.length;d+=6)c[d]=Number.POSITIVE_INFINITY}var u=new Float64Array(c.buffer,6*a.index*Float64Array.BYTES_PER_ELEMENT,6);return u[0]===Number.POSITIVE_INFINITY&&(l(a.index,i,a.meta.objectHandle,n),Object(s.q)(n,t,0,n,e,0,8)?(Object(o.B)(u,o.a),Object(o.n)(u,n,0,8)):Object(o.B)(u,o.c)),u}}function d(e,t,i,r){var a=t.getComponentAabb(i,e,u),s=t.getObjectTransform(i);r[0]=0,r[1]=0,r[2]=0;for(var o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),r[0]+=h[0],r[1]+=h[1],r[2]+=h[2];return r[0]/=8,r[1]/=8,r[2]/=8,r}var u=Object(o.h)(),h=Object(a.e)()},774:function(e,t,i){"use strict";i.d(t,"a",(function(){return k})),i.d(t,"b",(function(){return O})),i.d(t,"c",(function(){return v})),i.d(t,"d",(function(){return _})),i.d(t,"e",(function(){return I})),i.d(t,"f",(function(){return C}));var r=i(20),n=i(17),a=i(21),s=i(3),o=i(2),l=i(4),c=function(){function e(t,i){var r=this;Object(o.a)(this,e),this._textureRep=t,this._textureId=i,this._textureRef=Object(s.c)(this._textureId,(function(e){return r._textureRep.acquire(e)}))}return Object(l.a)(e,[{key:"dispose",value:function(){var e=this;this._textureRef=Object(s.c)(this._textureId,(function(t){e._textureRep.release(t)}))}},{key:"bind",value:function(e,t,i){if(Object(s.k)(this._textureRef)){var r=this._textureRef.glTexture;e.bindTexture(r,t),e.setUniform2f(i,r.descriptor.width,r.descriptor.height)}}}]),e}(),d=i(282),u=i(113),h=i(56);var f,b=i(213);function v(e,t){var i=new Map,r=function(e,t){if(Object(s.j)(e))return-1;if(i.has(e.id)){var r=i.get(e.id);return r.usage|=t,r.id}var n=i.size;return i.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,o=t.emissiveFactor,l=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),c=l?d.a[0]:n?n.metallicFactor:1,u=l?d.a[1]:n?n.roughnessFactor:1,h="mask"===t.alphaMode?33:1,f={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,h),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,2),metallicFactor:c,roughnessFactor:u},b={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:r(t.normalTexture,4),emissiveTextureId:r(t.emissiveTexture,16),occlusionTextureId:r(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:l},v=[];return i.forEach((function(t,i){var r=t.usage,n=Object(s.k)(e)&&e[i]&&e[i].formats,a=n?y(n.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:g[i]}}))):[];v.push({id:i,usage:r,encodings:a})})),{material:b,textures:v}}function y(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var g={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},m=(f={},Object(r.a)(f,b.a.KTX2_ENCODING,2),Object(r.a)(f,b.a.BASIS_ENCODING,2),Object(r.a)(f,b.a.DDS_ENCODING,4),Object(r.a)(f,"image/png",8),Object(r.a)(f,"image/jpg",16),Object(r.a)(f,"image/jpeg",16),Object(r.a)(f,"image/ktx",32),f);function _(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],n=i&&e.textureDefinitions[i],s=p();if(null!=r){var o=r.params;o.diffuse&&(s.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(s.doubleSided=o.doubleSided,s.cullFace=o.doubleSided?0:2),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(s.cullFace="none"===o.cullFace?0:"back"===o.cullFace?2:1),o.transparency&&(s.metallicRoughness.baseColorFactor[3]=Object(a.f)(1-o.transparency,0,1)),(o.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}var l=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(s.wrapTextures=!0);var c=1;"rgba"===n.channels&&(s.alphaMode="blend",c|=32);var d=n.images.length-1,u=n.images[d],h=function(e){return e&&e.split("/").pop()},f=Array.isArray(n.encoding)?y(n.encoding.map((function(e,t){return{name:h(u.href[t]),encoding:m[e]||0}}))):[{name:h(u.href),encoding:m[n.encoding]||0}];l.push({id:0,usage:c,encodings:f}),s.metallicRoughness.baseColorTextureId=0}return{material:s,textures:l}}var p=function(){return{alphaMode:"opaque",alphaCutoff:u.b,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function O(e,t,i,r){if(Object(s.j)(e)||null==e.data)return null;var n=e.data,o=!(n instanceof HTMLImageElement)||Object(a.l)(n.width)&&Object(a.l)(n.height),l=r.renderingContext.parameters.maxMaxAnisotropy,c=i&&!r.capabilities.shaderTextureLOD?1:l,d=o&&!e.downsampled&&c>1,u=i||!t.wrapTextures?j:x,h=function(e){switch(e){case 1:return b.a.KTX2_ENCODING;case 2:return b.a.BASIS_ENCODING;case 4:return b.a.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),f=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new b.a(n,{mipmap:d,maxAnisotropy:c,encoding:h,wrap:u,components:f,noUnpackFlip:!0})}var j={s:33071,t:33071},x={s:10497,t:10497};function k(e,t,i,r,n,o){var l=o.rendererTextureUsage,d=function(e){return function(e,t,i){if(Object(s.j)(e)||0===i)return null;for(var r=0;r<e.length;r++){var n=e[r];if(Object(s.k)(n)&&0!=(n.usage&i))return t[r].id}return null}(r,i,e&l)},f=t.metallicRoughness.baseColorFactor,b=Object(a.f)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[f[0],f[1],f[2],b],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=o.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=o.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:u.b,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var v=d(33);v&&(e.baseColorTexture=new c(n,v));var y=d(2);y&&(e.metallicRoughnessTexture=new c(n,y));var g=d(16);g&&(e.emissionTexture=new c(n,g));var m=d(8);m&&(e.occlusionTexture=new c(n,m));var _=d(4);_&&(e.normalTexture=new c(n,_)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&Object(h.i)(e)?2:e&&Object(h.j)(e)?3:1}(o.viewSpatialReference)}function I(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,r=Object(n.a)("disable-feature:i3s-basis")?0:3;return 24|(t?4|r:0)|(i?r:0)}function C(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}},775:function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r=i(8),n=i.n(r),a=i(16),s=i(14),o=i(13),l=i(3),c=i(772),d=i(43),u=i(588),h=i(211),f=i(167),b=i(1);function v(e){return y[function(e){return e instanceof Blob?e.type:function(e){var t=Object(d.n)(e);return _[t]||g}(e.url)}(e)]||m}var y={},g="text/plain",m=y[g],_={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(var p in _)y[_[p]]=p;var O=i(132);function j(e){var t=Object(l.k)(e)&&e.origins?e.origins:[void 0];return function(i,r){var n,a=function(e,t,i){if(Object(l.k)(e)&&"resource"===e.type)return function(e,t,i){var r=Object(h.b)(t,i);return{type:String,read:function(e,t,i){var n=Object(O.d)(e,t,i);return r.type===String?n:"function"==typeof r.type?new r.type({url:n}):void 0},write:{writer:function(t,n,a,o){if(!o||!o.resources)return"string"==typeof t?void(n[a]=Object(O.e)(t,o)):void(n[a]=t.write({},o));var u=function(e){return Object(l.j)(e)?null:"string"==typeof e?e:e.url}(t),h=u?Object(O.e)(u,Object(s.a)(Object(s.a)({},o),{},{verifyItemRelativeUrls:o&&o.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null}),1):null,b=r.type!==String&&(!Object(c.a)(this)||o&&o.origin&&this.originIdOf(i)>Object(f.d)(o.origin));o&&o.portalItem&&Object(l.k)(h)&&!Object(d.s)(h)?b?function(e,t,i,r,n,a,s,o){var l=s.portalItem.resourceFromPath(r),c=I(i,r,s);v(c)===Object(d.n)(l.path)?(k(e,t,l,c,s.resources.toUpdate),n[a]=r):x(e,t,i,r,n,a,s,o)}(this,i,t,h,n,a,o,e):function(e,t,i,r){r.resources.toKeep.push({resource:r.portalItem.resourceFromPath(e)}),t[i]=e}(h,n,a,o):o&&o.portalItem&&(Object(l.j)(h)||Object(l.k)(Object(O.b)(h))||Object(d.t)(h)||b)?x(this,i,t,h,n,a,o,e):n[a]=h}}}}(e,t,i);switch(Object(l.k)(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":return{read:O.c.read,write:O.c.write}}}(e,i,r),u=Object(o.a)(t);try{for(u.s();!(n=u.n()).done;){var y=n.value,g=Object(b.c)(i,y,r);for(var m in a)g[m]=a[m]}}catch(_){u.e(_)}finally{u.f()}}}function x(e,t,i,r,n,a,s,o){var c=Object(u.a)(),h=I(i,r,s),f=Object(d.z)(Object(l.i)(o,"prefix"),c),b="".concat(f,".").concat(v(h)),y=s.portalItem.resourceFromPath(b);Object(d.t)(r)&&s.resources.pendingOperations.push(function(e){return C.apply(this,arguments)}(r).then((function(e){y.path="".concat(f,".").concat(v(e)),n[a]=y.itemRelativeUrl})).catch((function(){}))),k(e,t,y,h,s.resources.toAdd),n[a]=y.itemRelativeUrl}function k(e,t,i,r,n){n.push({resource:i,content:r,finish:function(i){!function(e,t,i){"string"==typeof e[t]?e[t]=i.url:e[t].url=i.url}(e,t,i)}})}function I(e,t,i){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(i))],{type:"application/json"})}function C(){return(C=Object(a.a)(n.a.mark((function e(t){var r,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(i.bind(null,101));case 2:return r=e.sent.default,e.next=5,r(t,{responseType:"blob"});case 5:return a=e.sent,s=a.data,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},781:function(e,t,i){"use strict";function r(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){var i=t.toLowerCase();for(var r in e)if(r.toLowerCase()===i)return e[r];return null}(t,i);var r=e.get(i);return r?t[r.name]:null}i.d(t,"a",(function(){return r}))},795:function(e,t,i){"use strict";i.d(t,"a",(function(){return _}));var r,n=i(2),a=i(4),s=i(6),o=i(7),l=i(0),c=(i(129),i(29)),d=i(25),u=i(196),h=i(1),f=(i(18),i(17),i(15),i(11)),b=i(45),v=i(775),y=i(48),g=i(148),m=r=function(e){Object(s.a)(i,e);var t=Object(o.a)(i);function i(e){var r;return Object(n.a)(this,i),(r=t.call(this,e)).geometry=null,r.type="clip",r}return Object(a.a)(i,[{key:"writeGeometry",value:function(e,t,i,r){if(r.layer&&r.layer.spatialReference&&!r.layer.spatialReference.equals(this.geometry.spatialReference)){if(!Object(y.b)(e.spatialReference,r.layer.spatialReference))return void(r&&r.messages&&r.messages.push(new u.a("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:r.layer.spatialReference,context:r})));var n=new g.a;Object(y.w)(e,n,r.layer.spatialReference),t[i]=n.toJSON(r)}else t[i]=e.toJSON(r);delete t[i].spatialReference}},{key:"clone",value:function(){return new r({geometry:Object(d.a)(this.geometry),type:this.type})}}]),i}(c.a);Object(l.a)([Object(h.b)({type:g.a}),Object(v.a)()],m.prototype,"geometry",void 0),Object(l.a)([Object(b.a)(["web-scene","portal-item"],"geometry")],m.prototype,"writeGeometry",null),Object(l.a)([Object(h.b)({type:["clip","mask","replace"],nonNullable:!0}),Object(v.a)()],m.prototype,"type",void 0);var _=m=r=Object(l.a)([Object(f.a)("esri.layers.support.SceneModification")],m)},796:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(44),n=i(13),a=i(2),s=i(4),o=i(6),l=i(7),c=i(90),d=i(117),u=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(){var e;return Object(a.a)(this,i),(e=t.apply(this,arguments))._map=new Map,e}return Object(s.a)(i,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,i=0;i<e.length;i++){var r=e[i],n=r.objectId,a=this._map.get(n);a?(t.add(n),r!==a&&(e[i]=a),++a.refCount):(r.refCount=1,this._map.set(n,r))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),i.push(a))}}catch(l){r.e(l)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"removeManyByObjectId",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),i.push(s))}}catch(o){r.e(o)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"toArray",value:function(){return Object(r.a)(this._map.values())}},{key:"find",value:function(e){var t;return Object(d.c)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),i}(c.a)},798:function(e,t,i){"use strict";i.d(t,"a",(function(){return Le}));var r=i(44),n=i(34),a=i(2),s=i(4),o=i(6),l=i(7),c=i(0),d=i(33),u=i(60),h=i(17),f=i(15),b=i(3),v=i(71),y=i(243),g=i(23),m=i(36),_=i(1),p=(i(18),i(11)),O=i(48),j=i(37),x=i(42),k=i(184),I=i(596),C=i(13),w=i(108),N=i(97),M=function(){function e(t){Object(a.a)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(N.b.I3S_CONTROLLER,this)}return Object(s.a)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=Object(C.a)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(i){t.e(i)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this.sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}},{key:"sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){Object(w.k)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}]),e}(),S=new Map;function D(e,t){var i=S.get(e);return null==i&&(i=new M(e),S.set(e,i)),i.add(t),{remove:function(){null!=i&&(i.remove(t),i.callbacks.length>0||(S.delete(e),i.destroy()),i=null)}}}var P=i(5),F=i(46),E=function e(t,i){Object(a.a)(this,e),this.id=t,this.mbs=i,this.renderMbs=Object(F.d)([0,0,0,-1]),this.imModificationImpact=4},R=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e,r,n,s,o,l,c,d,u,h){var f;return Object(a.a)(this,i),(f=t.call(this,e,n)).index=r,f.childCount=s,f.level=o,f.resources=l,f.version=c,f.lodMetric=d,f.maxError=u,f.numFeatures=h,f.failed=!1,f.hasModifications=!1,f.cacheState=0,f.vertexCount=0,f.memory=0,f}return i}(E),A=function e(t,i,r,n){Object(a.a)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=r,this.version=n},V=i(740),L=i(374),T=function e(t,i,r,n,s){Object(a.a)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=r,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=2},U=function(){function e(t,i,r,n,s,o,l,c,d,u,h,f,b,y){Object(a.a)(this,e),this.streamDataController=r,this.viewportQueries=n,this.logger=s,this.holeFilling=o,this._isLoaded=l,this._isReloading=c,this._isSelected=d,this._enable=u,this._needsUpdate=h,this._canRequest=f,this._computeVisibilityObb=b,this._computeNodeFiltering=y,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=z(0),this._visibilityCacheVersion=z(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new v.a({deallocator:null}),this._prefetch=new v.a({deallocator:null}),this._updates=new G,this._imModificationUncategorized=new v.a({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(i)}return Object(s.a)(e,[{key:"init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=$}this.addPage(W(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new E(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}},{key:"loadPage",value:function(e){var t=this;this._loading.add(e);var i=this.urlPrefix+e;this.streamDataController.request(i,"json").then((function(i){t._loading.delete(e),t.addPage(e,i)})).catch((function(i){t._loading.delete(e),Object(g.n)(i)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),i))}))}},{key:"addPage",value:function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],a=[],s=t.nodes.map((function(t,r){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var l=0;l<o;l++)n.push(t.children[l]);var c="".concat(t.index),d=Object(L.b)(t.obb),u=Object(F.d)([d.center[0],d.center[1],d.center[2],Object(P.r)(d.halfSize)]),h=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,v={hasSharedResource:!1,hasFeatureData:!!f,attributes:h&&null!=h.resource?"".concat(h.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:b&&null!=b.resource?"".concat(b.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:b?b.definition:-1},y=new R(c,e*i.nodesPerPage+r,u,o,0,v,i.lastUpdate,i.lodMetric,i.lodConversion(t.lodThreshold),f?f.featureCount:null);return y.serviceObb=d,y.visibilityObb=i._computeVisibilityObb(y),y.vertexCount=f?f.vertexCount:0,new T(s,o,B(i._visibilityCacheVersion),null,y)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length,this.updateParentsAndLevel()}},{key:"updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,r,n){var a=e.getPage(i);if(Object(b.k)(a)){var s=J(i,e.nodesPerPage);a.parents[s]=r;var o=a.nodes[s].node;Object(b.k)(o)&&(o.level=n,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var r=t.pop(),n=this.getNode(r);if(Object(b.k)(n))for(var a=0;a<n.childCount;a++)i(this.getChildIndex(n,a),r,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"getPage",value:function(e){return this._nodePages[W(e,this.nodesPerPage)]}},{key:"getNodeInternal",value:function(e){var t=this.getPage(e);return Object(b.j)(t)?null:t.nodes[J(e,this.nodesPerPage)]}},{key:"addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),r=Object(b.k)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);var n=function(e){if(e)for(var t=0;t<e.length;t++){var i,r=Object(C.a)(X);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){r.e(a)}finally{r.f()}}return{lodMetric:0,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=Object(b.t)(this.getNodeInternal(t));return o.node=new R(e.id,t,Object(F.d)(e.mbs),o.childCount,r,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=Object(L.b)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),Object(b.k)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"makeRefNode",value:function(e,t){var i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new T(0,0,B(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,Object(b.k)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),r}},{key:"populateChildren",value:function(e,t){var i=Object(b.t)(this.getNodeInternal(e)),r=Object(b.t)(this.getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(var n=0;n<t.length;n++){var a=this.makeRefNode(t[n],e);r.children.push(a)}}},{key:"getNode",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this.forAllNodes((function(i,r){(Object(b.k)(i.node)&&i.node.id===e||Object(b.k)(i.ref)&&i.ref.id===e)&&(t=r)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this.getPage(e.index);if(Object(b.j)(i))return-1;var r=i.nodes[J(e.index,this.nodesPerPage)];return i.children[r.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this.getPage(e);return Object(b.k)(t)?t.parents[J(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=z(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=B(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&(q(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"invalidateGeometryVisibility",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&Object(b.k)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,Object(b.k)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;Object(b.j)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"isNodeVisible",value:function(e){var t=this.getNodeInternal(e);if(Object(b.j)(t)||Object(b.k)(t.ref)&&!t.ref.mbs)return!0;if(!K(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,r=Object(b.k)(i)&&(Object(b.j)(t.ref)||Object(b.k)(i.visibilityObb))?i:Object(b.k)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(Object(b.k)(i)||Object(b.k)(t.ref))&&2===t.filterImpact){var n=Object(b.k)(i)?i.mbs:Object(b.k)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):0}var a=Object(b.k)(i)&&1===t.filterImpact,s=!(Object(b.k)(i)&&2===i.imModificationImpact)&&(!r||this.viewportQueries.isNodeVisible(r))&&!a;return t.visibilityCache=Q(s,this._visibilityCacheVersion),s}return Y(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(Object(b.k)(t)&&Object(b.k)(t.node)&&Object(b.k)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,r,n){var a=this.getPage(e);if(!Object(b.j)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,l=t.childOffset;l<s;++l){var c=a.children[l],d=this.getNodeInternal(c);Object(b.k)(d)&&Object(b.k)(d.node)&&this.isGeometryVisible(c)&&o.push(d)}r/=o.length;for(var u=0,h=o;u<h.length;u++){var f=h[u],v=Object(b.t)(f.node).index;this._isLoaded(v)||this._isReloading(v)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(v,f,i+1,r,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(Object(b.j)(t))return!1;if("always"===this.holeFilling)return!0;if(K(t.useAsHole,this._version))return Y(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var r=i.delta*i.coverage<=.5;return t.useAsHole=Q(r,this._version),r}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=z(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var i=e.node;Object(b.k)(i)&&(i.imModificationImpact=4,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this.forAllNodes((function(e){if(Object(b.k)(e)){e.filterImpact=2;var i=e.node;Object(b.k)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var r=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),H.clear();var n=!0,a=new Z,s=new Z,o=this._imModificationUncategorized;o.clear();var l=new Set;this.traverseVisible((function(c,d,u){if(Object(b.j)(d)){var h=r.entryPriority(c);h===1/0&&(h=r.entryPriority(u));var f=W(c,r.nodesPerPage);return H.set(f,Math.max(h,H.get(f)||0)),r._loading.has(f)||r._failedPages.has(f)||r._missing.push(f),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,h))}var v=d.node;if(r._updateNodeFeatureEstimate(v,s),Object(b.j)(v)){var y=r.entryPriority(c);return r._loading.has(c)||r._failedNodes.has(c)||(r._missing.push(c),H.set(c,y)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,y))}var g=Object(b.t)(r.getPage(c));if(0===r._missing.length&&0===r.nodesPerPage)for(var m=0;m<d.childCount;m++){var _=g.children[d.childOffset+m],p=r.getNodeInternal(_);!Object(b.k)(p)||p.node||r._loading.has(_)||r._failedNodes.has(_)||(H.set(_,r.entryPriority(_)),r._prefetch.push(_))}if(!v.failed&&v.resources.hasFeatureData)if(l.add(v.id),r._isLoaded(c)){if(a.known+=v.memory,++a.knownNodes,r._isSelected(v)?d.childCount>0&&(n=!1):(a.unremoved+=v.memory,n=!1),r._needsUpdate(v)){var O=r.entryPriority(c);H.set(c,O),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,O),r._updates.update.push(c)}}else if(v.memory&&(a.known+=v.memory,++a.knownNodes),r._isSelected(v)){if(d.childCount>0&&(n=!1),v.memory?(a.missing+=v.memory,a.known+=v.memory,++a.knownNodes):++a.missingNodes,e.indexOf(v.index)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(c)),void(r._updates.cancel=r._updates.cancel.filter((function(e){return e!==v.index})));if(t.done||!r._enable(v)){var j=r.entryPriority(c);H.set(c,j),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,j),r._updates.add.push(c),r.layerHasModifications&&i&&Object(b.k)(v)&&4===v.imModificationImpact&&o.push(c)}else t.madeProgress()}else r._isReloading(c)&&r._updates.remove.push(c)}));var c=this._updates.add;c.length>0&&this.layerHasModifications&&(o.length>0&&i(o),c.filterInPlace((function(e){var t=r.getNodeInternal(e),i=Object(b.j)(t)||Object(b.j)(t.node)||2!==t.node.imModificationImpact;return i||r.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||r._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return H.get(e)-H.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=H.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return H.get(e)>=r._maxUnloadedPrio})).sort((function(e,t){return H.get(e)-H.get(t)})),this._updates.update.sort((function(e,t){return H.get(e)-H.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,H.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,s=10;s--;){var o=new Z;if(this._updateFeatureEstimate(r,o),this._computeFeatureEstimate(o)<=e){if(r>=t||o.missingNodes>0||0===s)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate(Object(b.k)(r)&&r.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!(Object(b.j)(e)||e.failed||Object(b.j)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(Object(b.k)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return H.get(e)-H.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if(Object(b.j)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&K(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&i>s.lodLevel}else n=i>0}else n=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=n,t.version=Q(!0,this._version),t):(t=new A(r,n,i,Q(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=Object(b.t)(this.getNodeInternal(e)).ref;if(Object(b.j)(i))this._failedNodes.add(e);else{var r=i.id,n=this.urlPrefix+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(i){a();var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t.addNode(n,e);t.nodeTraversalState(s)}}),(function(i){a(),Object(g.n)(i)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("#validateNode()",i.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)r("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i.logger.error("#validateNode()",i.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new E("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){Object(b.k)(e.node)&&(e.node.failed=!1)}))}},{key:"entryPriority",value:function(e){var t=this.getNodeInternal(e),i=this.getParentIndex(e);if(Object(b.j)(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);var r=0;if(t.node&&i>=0){var n=this._nodeTraversalState.get(i);null!=n&&(r=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=Object(b.k)(t.ref)?this.viewportQueries.distToPOI(t.ref):Object(b.k)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-r*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this.getNodeInternal(this.rootIndex);Object(b.j)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,r){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&r(e,i,t);else if(this.isNodeVisible(e)&&(r(e,i,t),null!=i.node)){var n=this.nodeTraversalState(i.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=Object(b.t)(this.getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],l=this.getNodeInternal(o);Object(b.k)(l)?this._traverseVisible(o,e,l,r):r(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,r=this.getNodeInternal(i);Object(b.k)(r)&&this._traverseChildren(i,r,t)}},{key:"_traverseChildren",value:function(e,t,i){var r=this.getPage(e);if(!Object(b.j)(r))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=r.children[a],o=this.getNodeInternal(s);Object(b.k)(o)&&Object(b.k)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e){this.forAllNodes(q),this.viewportQueries.updateElevationInfo(e)}},{key:"forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e.addNode(t,i)}}}}]),e}(),H=new Map,G=function(){function e(){Object(a.a)(this,e),this.update=new v.a({deallocator:null}),this.add=new v.a({deallocator:null}),this.remove=new v.a({deallocator:null}),this.cancel=[]}return Object(s.a)(e,[{key:"reset",value:function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}]),e}();function q(e){Object(b.k)(e.node)&&(e.node.renderMbs[3]=-1,Object(b.k)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),Object(b.k)(e.ref)&&(e.ref.renderMbs[3]=-1,Object(b.k)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function B(e){return Object(V.a)(e,-2)}function z(e){return Object(V.a)(e,2)}function Q(e,t){return t+(e?1:0)}function K(e,t){return(-2&e)===t}function Y(e){return 1==(1&e)}function W(e,t){return 0===t?0:e/t|0}function J(e,t){return 0===t?e:e%t}var X=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];var Z=function e(){Object(a.a)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function $(e){return Math.sqrt(e*(4/Math.PI))}var ee=function(){function e(t){Object(a.a)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return Object(s.a)(e,[{key:"startNodeLoading",value:function(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if(Object(b.j)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));te.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1);var r=te.length;this._removeNodes(te,e);var n=te.length<r;return 0!==te.length&&(this._lodGlobalDirty=!0),te.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,i){if(Object(b.j)(e))return!1;var r=e.index,n=this._index,a=this.layerView,s=n.nodeTraversalState(e),o=this.isChosenMaxLOD(s),l=a.isNodeLoaded(r),c=a.nodeCrossfadingEnabled;if(c&&l&&o){var d=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,0,!d)}var u=l&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(l&&(a.updateNodeState(r,o?1:0),o))return u&&this._removeChildrenRecursive(e),u;var h=e.childCount>0,f=h;if(h)for(var v=0;v<e.childCount;v++){var y=n.getChildIndex(e,v),g=n.getNode(y);Object(b.k)(g)?n.isGeometryVisible(y)&&!this._lodGlobalHandling(g,t,i||u)&&this._isNodeInScaleBounds(g)&&(f=!1):n.isNodeVisible(y)&&(f=!1)}var m=l&&!o&&(f||te.length<t);m&&te.push(r),!c||m||!l||i||f||a.fadeNode(r,0,!1);var _=!e.resources.hasFeatureData;return f||u&&!m||_}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&te.push(e.index),!0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(!t.layerView.isNodeLoaded(e.index)||(i=!1,!1))})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,(function(e){if(!r||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(i=!0),!t.layerView.isNodeLoaded(e.index)||(r=!1,!1)})),r&&i}},{key:"isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),te=new v.a({deallocator:null}),ie=i(8),re=i.n(ie),ne=i(16),ae=i(130),se=i(25),oe=i(43),le=i(778),ce=i(774),de=function(){function e(t,i,r,n,s,o){if(Object(a.a)(this,e),this.streamDataController=i,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var l=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return Object(ce.c)(l,e)}))}}return Object(s.a)(e,[{key:"load",value:function(e,t,i){return this.streamDataController.request(e,t,i)}},{key:"loadAttribute",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this.load(r,"binary",i).then((function(e){return Object(le.d)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var r=this;return Object(g.k)(t.map((function(t){return r.loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var n={},a=0;a<t.length;++a)if(i[a].value)n[t[a].name]=i[a].value;else{if(Object(g.n)(i[a].error))throw i[a].error;r.logger.error("#loadAttributes",r.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=Object(ne.a)(re.a.mark((function e(t,i){var r,n,a,s,o,l,c,d,u,h,f,v,y,g,m,_,p,O,j,x,k,I;return re.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this.requiredAttributes&&t.resources.attributes?Object(ae.d)(this.loadAttributes(t,this.requiredAttributes,i)):null,n=be(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,l=o?Object(ae.d)(this.loadGeometry(t.resources.geometry,s,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this.loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(c=e.t0,d=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=c?Object(ce.d)(c):null,u=d&&d.material,h=d&&d.textures,f="".concat(t.id),!(v=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this.loadFeatureData(f,i);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(y=e.t1,g=v?ue(y):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:u}}],featureDataPosition:[0,0,0]},m=Object(b.j)(g)&&he(y),_=null!=h&&h.length>0?Object(ae.d)(this.loadTextures(t,h,i)):null,p=null,O=null,!l){e.next=39;break}return e.t2=ae.a,e.next=35,l;case 35:e.t3=e.sent,p=(0,e.t2)(e.t3),j=fe(this.defaultGeometrySchema,c),O=Object(le.a)(a,j);case 39:if(!_){e.next=47;break}return e.t5=ae.a,e.next=43,_;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(x=e.t4,!r){e.next=57;break}return e.t8=ae.a,e.next=53,r;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:return k=e.t7,I=k?{attributeData:k,loadedAttributes:this.requiredAttributes}:null,e.abrupt("return",Object(b.k)(g)?{geometryData:g,attributeDataInfo:I,geometryBuffer:p,geometryDescriptor:O,requiredTextures:h,textureData:x}:Object(b.k)(m)?{pointData:m,attributeDataInfo:I,geometryBuffer:p,geometryDescriptor:O,requiredTextures:h,textureData:x}:Promise.reject());case 61:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"loadShared",value:function(t,i){var r="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this.load(r,"json",i).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,r),t}))}},{key:"loadTexture",value:function(e,t,i,r,n,a){var s=!1;return 4===n||1===n||2===n?this.load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:n,downsampled:s}})):this.load(e,"image",a).then((function(e){var a=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),l=Math.ceil(e.height/2),c=document.createElement("canvas");c.width=o,c.height=l,c.getContext("2d").drawImage(e,0,0,o,l),a=c,s=!0}return{id:t,usage:i,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var r=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Object(ce.f)(t.encodings,r.options.textureEncodings);if(null==s)return r.logger.error("#loadTextures",r.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,l="".concat(r.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return r.loadTexture(l,t.id,t.usage,n,s.encoding,i)})))}},{key:"loadFeatureData",value:function(e,t){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this.load(i,"json",t)}},{key:"loadGeometry",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this.load(r,"binary",i)}}],[{key:"addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++){var a,s=n[r],o=Object(C.a)(i[s].images);try{for(o.s();!(a=o.n()).done;){var l=a.value;Array.isArray(l.href)?l.hrefConcat=l.href.map((function(e){return Object(oe.A)(e,t)})):l.hrefConcat=Object(oe.A)(l.href,t)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a=r.encoding[n];"data:"===a.substring(0,5)&&(r.encoding[n]=a.substring(5))}else{var s=r.encoding;"data:"===s.substring(0,5)&&(r.encoding=s.substring(5))}}}}]),e}();function ue(e){var t,i=Object(C.a)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.geometries;if(null!=n){var a,s=Object(C.a)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[r.id],featureDataPosition:r.position,geometries:[o]}}}catch(l){s.e(l)}finally{s.f()}}}}catch(l){i.e(l)}finally{i.f()}return null}function he(e){var t,i=new Array,r=Object(C.a)(e.featureData);try{for(r.s();!(t=r.n()).done;){var n=t.value;null!=n.position&&i.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){r.e(a)}finally{r.f()}return i}function fe(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Object(se.a)(e)).vertexAttributes.region,e}function be(e,t){var i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;var r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(var n=0;n<r.length;n++){var a=r[n];if(null==a.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=r[n];else if("draco"===a.compressedAttributes.encoding&&!Object(h.a)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=a,i}return i}var ve=function(){function e(t,i){Object(a.a)(this,e),this.requester=t,this.apiKey=i,this.activeRequests=new Set}return Object(s.a)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,i){var r=this,n=Object(g.e)(),a=Object(g.t)(i,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),l={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(l),Object(g.c)(o,(function(){var e;l.abortController=null,null==(e=l.abortHandle)||e.remove(),l.abortHandle=null,r.activeRequests.delete(l)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,i;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(i=e.abortHandle)||i.remove()})),this.activeRequests.clear()}}]),e}(),ye=i(10),ge=i(54),me=i(68),_e=i(125),pe=i(72),Oe=i(69),je=i(157),xe=i(237),ke=1e5,Ie=function(){function e(t,i,r,n,s,o,l){var c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};Object(a.a)(this,e),this.indexSR=t,this._renderCoordsHelper=i,this.extent=s,this.elevationProvider=o,this.options=c,this._frustum=Object(_e.c)(),this._useFrustumCulling=!1,this._poi=Object(ye.e)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=Object(ye.e)(),this._tmp2=Object(ye.e)(),this._tmp3=Object(ye.e)(),this._tmp0=Object(ye.e)(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(r,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(l),this.tmpPoint=Object(k.j)(0,0,0,t)}return Object(s.a)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=je.a.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Object(xe.c)(Object(xe.f)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&Object(_e.e)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}},{key:"updateExtent",value:function(e){this.extent=e}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return t[3]<0&&(Object(ge.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=Object(Oe.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),Object(O.p)(t,this.indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if(Object(b.k)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb;return Object(b.j)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i){if(Object(b.j)(t)&&(t=Object(L.e)()),t.halfSize[0]<0){var r=0;this._elevationContext&&i<ke&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],r=Object(Oe.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),Object(V.v)(e,this.indexSR,t,this.engineSR,r)}return t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return Object(b.k)(i)?Object(L.h)(i,this._frustum):Object(_e.j)(this._frustum,Object(pe.n)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return Object(b.k)(t)?Object(L.h)(t,this._frustum):this.isNodeVisible(e)}},{key:"isMBSinExtent",value:function(e){return!this.extent||0!==Object(V.s)(this.extent,e)}},{key:"screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),r=Math.sqrt(Object(P.n)(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=Object(P.o)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/Object(P.r)(t)+i)/Object(P.o)(t,this._camPos);return Math.min(1,r)}},{key:"hasLOD",value:function(e){return 0!==e.lodMetric}},{key:"getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"getDistanceGlobeMode",value:function(e,t){var i=Object(P.r)(t),r=Object(P.r)(e)-i;Object(P.g)(this._tmp0,e,Object(P.j)(e,t)/Object(P.v)(e));var n=Object(P.n)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(r);var s=Object(P.g)(this._tmp0,t,1/i),o=i,l=a*a/2/o,c=Object(P.g)(this._tmp1,s,o-l),d=e,u=Object(P.l)(this._tmp2,d,c),h=Object(P.l)(this._tmp2,u,Object(P.g)(this._tmp3,s,Object(P.j)(s,u))),f=Object(P.h)(this._tmp2,c,Object(P.g)(this._tmp2,h,a/Object(P.r)(h))),b=Object(P.o)(d,f);if(r>=2e5){var v=Object(P.l)(this._tmp1,d,f),y=Object(P.j)(v,s)/Object(P.r)(v);y<.08&&(y=1e-4),b/=y}return b}},{key:"getDistance",value:function(e,t){return this.engineSR===Object(me.g)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case 2:var i=this.getRenderMbs(e),r=this.getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,a=r+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case 1:var s=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return Object(P.o)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return Object(P.o)(this._camPos,this._poi)}}]),e}(),Ce=i(460),we=i(553),Ne=i(466),Me=f.a.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Se=1e-4,De=function(e){Object(o.a)(i,e);var t=Object(l.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leavesReached=!1,r.scaleVisibilityEnabled=!0,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new v.a({deallocator:null}),r._loadedNodeScales=new Map,r._modificationsNodeFilteringArray=new v.a,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new u.a,r._idleQueue=new I.a,r._elevationUpdateNodes=new v.a({deallocator:null}),r._errorCount=0,r}return Object(s.a)(i,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new ve(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(3);return new ve(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return Object(V.r)(this.layer)}},{key:"crsIndex",get:function(){return Object(V.p)(this.layer)}},{key:"rootNodeVisible",get:function(){if(Object(b.k)(this._index)){var e=this._index.rootNode;if(Object(b.k)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new ee(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=Object(h.a)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((function(i){var r,a=Object(n.a)(i,1)[0];if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var s=e.layerView.view;e._setClippingArea(s.clippingArea);var o=e.layerView.view.resourceController;e._handles.add([Object(m.a)(s,"pointsOfInterest.focus.renderLocation",(function(t){return e._pointOfInterestChanged(t)})),o.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),Object(m.a)(e.layerView,"suspended",(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},r=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=r):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,r)})),D(e.layerView.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),s.state.watch("contentCamera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return Object(b.k)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new Ie(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,s.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new U(t,a,e.indexStreamController,e._viewportQueries,Me,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}),null!=(r=e.layerView)&&r.computeNodeFiltering?function(t){return e.layerView.computeNodeFiltering(t)}:void 0);var l=Object(b.k)(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(l),e._startNodeLoading()}}))),this._tmpPoint=Object(k.j)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,r=this.layerView;Object(b.k)(i)&&r&&r.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var r=i.getNode(e);Object(b.k)(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Fe.prune(),Object(b.k)(Pe)&&(Pe.hide(),Pe=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=Re(e,i),n=Re(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Ee(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=Object(j.h)();Object(Ce.a)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){Object(b.k)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),Object(b.k)(this._index)&&(this._index.progressiveLoadPenalty=Ae.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),Object(b.k)(this._viewportQueries)&&Object(b.k)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this,r=this._index;if(!Object(b.j)(r)){var n=r.rootNode;if(!Object(b.j)(n)){var a=this._elevationUpdateNodes;a.clear(),Object(V.l)(e,t,n,this.crsIndex,r,(function(e){return a.push(e.index)})),a.forAll((function(e){r.invalidateBoundingVolumeCache(e),e===n.index&&i.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}}},{key:"getParentIndex",value:function(e){return Object(b.k)(this._index)&&this._index.getParentIndex(e)}},{key:"_elevationInfoChanged",value:function(){Object(b.k)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t,i){var r=this,n=this._index;if(!Object(b.j)(n)){var a=n.rootNode;!Object(b.j)(a)&&Object(O.o)(t,i,Ve,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,i){var a=n.getNode(i);Object(b.k)(a)&&Object(x.h)(Ve,a.mbs)&&r._loadedNodeScales.set(i,e)}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=Object(Ne.a)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return Object(b.j)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return Object(b.k)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||Object(b.j)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Me.error("Error during processing: "+i):50===this._errorCount&&Me.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!Object(b.j)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}}},{key:"_processIndex",value:function(e){var t=this;if(Object(b.j)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Object(r.a)(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading()||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(Object(b.j)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.isGraphics3D&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Se)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Se)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Se,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(Object(b.j)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);Object(b.k)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,0)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(Object(b.j)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var n=this._index.getNode(r.update.pop());Object(b.k)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if(Object(b.j)(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<we.b&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=(Object(b.k)(this._index)?this._index.getIndexMissing():0)+3*(Object(b.k)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,r=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Ae.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"updateBoundingVolume",value:function(e){Object(b.k)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){Object(b.k)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){if(Object(b.k)(this._index)){var e=Object(b.k)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"_shouldDropNode",value:function(e){if(Object(b.j)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||Object(b.j)(t)||Object(b.j)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new de(this.layer,this.dataStreamController,Me,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,1)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if(Object(b.j)(i)||Object(b.j)(this._viewportQueries))return!1;Fe.clear(),this.layerView.getLoadedNodeIndices(Fe);var r=0===this._viewportQueries.maxDistance,n=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return Fe.filterInPlace((function(e){var r=i.getNode(e);return Object(b.j)(r)||!i.isGeometryVisible(e)||n(r)||!t._isNodeInScaleBounds(r)})),Fe.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Fe,e,0),!(r&&this.lodDropFactor<1)&&(0===Fe.length||(Fe.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Fe.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Fe,N.d,0)}},{key:"_removeNodes",value:function(e,t,i){var r=e.length;if(0!==r&&!t.done){for(Object(b.k)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&Object(b.k)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,1,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<r;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=Object(g.e)();this._updatingNodes.set(e.index,i),(Ee(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r},i.signal)}),i.signal)})).catch((function(r){if(!Object(g.n)(r))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Me.error("already loading node "+e.index);else{var i=Object(g.e)();this._loadingNodes.set(e.index,i);var r=function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then(r).catch((function(e){if(r(),!Object(g.n)(e))throw e}))}}},{key:"_loadAndAddNode",value:function(e,t){var i=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,Object(b.k)(i._index)&&i._index.updates.add.push(e.index))})).catch((function(t){if(!Object(g.n)(t))throw e.cacheState=1,t}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||Object(b.j)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return Object(b.k)(t)&&Object(b.k)(t.attributeInfo)&&Ee(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){Object(b.k)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule((function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))}),t).then((function(n){if(Object(b.j)(n))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return r.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,r,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=2})).catch((function(t){if(!Object(g.n)(t))throw Me.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,Object(b.k)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&Object(b.k)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=Object(Ne.a)(this.layer),r=i.minScale,n=i.maxScale;return Object(Ne.d)(t,r,n)}},{key:"updateStats",value:function(e){e.index=Object(b.k)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),Object(b.k)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){Object(b.k)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),Object(b.k)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;Object(b.k)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),i}(Object(y.b)(d.a));Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"isMeshPyramid",null),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"isGraphics3D",null),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"indexStreamController",null),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"dataStreamController",null),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"crsVertex",null),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"crsIndex",null),Object(c.a)([Object(_.b)()],De.prototype,"screenSizeFactor",void 0),Object(c.a)([Object(_.b)()],De.prototype,"featureTarget",void 0),Object(c.a)([Object(_.b)()],De.prototype,"fixedFeatureTarget",void 0),Object(c.a)([Object(_.b)()],De.prototype,"layerView",void 0),Object(c.a)([Object(_.b)()],De.prototype,"layer",void 0),Object(c.a)([Object(_.b)({})],De.prototype,"updating",void 0),Object(c.a)([Object(_.b)({})],De.prototype,"updatingProgress",void 0),Object(c.a)([Object(_.b)({readOnly:!0})],De.prototype,"leavesReached",void 0),Object(c.a)([Object(_.b)({constructOnly:!0})],De.prototype,"scaleVisibilityEnabled",void 0),Object(c.a)([Object(_.b)({readOnly:!0,dependsOn:[]})],De.prototype,"rootNodeVisible",null),De=Object(c.a)([Object(p.a)("esri.layers.graphics.controllers.I3SOnDemandController")],De);var Pe,Fe=new v.a({deallocator:null});function Ee(e,t){return Object(b.k)(e)&&e.length===t.length&&e.every((function(e){return Re(t,e.name)>=0}))}function Re(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var Ae={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ve=Object(x.l)(),Le=De},799:function(e,t,i){"use strict";i.d(t,"a",(function(){return I}));var r=i(44),n=i(8),a=i.n(n),s=i(16),o=i(34),l=i(13),c=i(2),d=i(4),u=i(101),h=i(108),f=i(130),b=i(467),v=i(15),y=i(3),g=i(23),m=i(169),_=i(155);function p(e,t,i){return O.apply(this,arguments)}function O(){return(O=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=i.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(i.maxRecordCountFactor=x(t)),n=j(t),s=t.capabilities.query.supportsPagination,i.start=0,i.num=n,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(i,r);case 6:if(l=e.sent,Object(y.j)(o)?o=l:o.features=o.features.concat(l.features),o.exceededTransferLimit=l.exceededTransferLimit,s&&l.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:i.start+=n;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return x(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function x(e){return e.capabilities.query.supportsMaxRecordCountFactor?_.a.MAX_MAX_RECORD_COUNT_FACTOR:1}var k=v.a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),I=function(){function e(t,i){var r=this;Object(c.a)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=Object(g.e)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=N,this.memCache=i.getMemCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return r.pendingFetchAbortController=null}))}return Object(d.a)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),Object(y.j)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var i=this.interactiveEditingSessions,r=new C(e,{rollback:function(){Object(h.j)(i,r),0===i.length&&(t.interactiveEditingSessions=null)},commit:function(i){var r,n=Object(l.a)(i);try{for(n.s();!(r=n.n()).done;){var a=Object(o.a)(r.value,2),s=a[0],c=a[1];t.updateValue(e,s,c)}}catch(d){n.e(d)}finally{n.f()}}});return i.unshift(r),r}},{key:"apply",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,l,c,d,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(y.j)(i)){e.next=2;break}return e.abrupt("return");case 2:if(n=i.loadedAttributes,s=i.attributeData,!Object(y.j)(n)&&0!==n.length&&!Object(y.j)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(g.A)(this.pendingFetchChangedObjectIds,r);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:n,attributeData:s},l=this.getOverridesFromCache(t,o,this.changedObjectIds),c=l.objectIds,d=l.fieldNames,e.next=15,this.queryOverridesFromAssociatedLayer(c,d,r);case 15:u=e.sent,Object(y.j)(u)||this.processOverridesFromAssociatedLayer(t,u,d,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)}},{key:"cacheValue",value:function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))}},{key:"getOverridesFromCache",value:function(e,t,i){var r,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,c=Object(l.a)(n);try{for(c.s();!(r=c.n()).done;){var d=r.value;o[d.index]=a[d.name]}}catch(m){c.e(m)}finally{c.f()}for(var u=new Set,h=0;h<e.length;h++){var f=e[h];if(i.has(f)){var b,v=Object(l.a)(n);try{for(v.s();!(b=v.n()).done;){var y=b.value,g=this.fromCache(f,y.index);void 0===g?(s.add(f),u.add(y.name)):o[y.index][h]=g}}catch(m){v.e(m)}finally{v.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(u)}}},{key:"fromCache",value:function(e,t){var i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var r=this.getCacheKey(e,t);return this.memCache.get(r)}},{key:"fromInteractiveEditingSession",value:function(e,t){if(!Object(y.j)(this.interactiveEditingSessions)){var i,r=Object(l.a)(this.interactiveEditingSessions);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){r.e(s)}finally{r.f()}}}},{key:"getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"queryOverridesFromAssociatedLayer",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,n){var s,o,l,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning()),s=Object(y.t)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat(Object(r.a)(i)),o.cacheHint=!0,o.objectIds=t,l=j(s),c=t.length>l?Object(h.n)(t,l).map((function(e){var t=o.clone();return t.objectIds=e,Object(f.e)(p(s,t,{signal:n}))})):[Object(f.e)(p(s,o,{signal:n}))],e.next=8,Promise.all(c);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat(Object(m.b)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),k.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"processOverridesFromAssociatedLayer",value:function(e,t,i,r){var n,a=r.loadedAttributes,s=r.attributeData,o=Object(y.t)(this.layer.associatedLayer).objectIdField,c=i.map((function(e){return s[e]})),d=new Map(a.map((function(e){return[e.name,e.index]}))),u=i.map((function(e){return d.get(e)})),h=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=Object(l.a)(t);try{for(f.s();!(n=f.n()).done;)for(var b=n.value,v=b.attributes[o],g=0;g<i.length;g++){var m=u[g],_=h.get(v),p=b.attributes[i[g]];c[g][_]=p,this.cacheValue(v,m,p)}}catch(O){f.e(O)}finally{f.f()}}},{key:"memCacheValueSize",value:function(e){return"string"==typeof e?Object(b.d)(e):Object(b.c)()}},{key:"fetchChangedObjectIds",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var i,r,n,s,o,l,c,d,h,b,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!Object(y.j)(s.associatedLayer)&&null!=(i=s.associatedLayer.capabilities)&&null!=(r=i.operations)&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this.getFetchChangedObjectIdsServerGen(),!Object(y.j)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return l=s.associatedLayer.layerId,e.next=12,Object(f.d)(Object(u.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(l),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:l,serverGen:o}])},timeout:w,signal:t}));case 12:if(c=e.sent,d=c.ok&&null!=(n=c.value.data)&&n.edits?Object(y.i)(c.value.data.edits[0],"objectIds","updates"):null,Object(y.k)(d))for((h=Math.min(this._maximumNumberOfEditOVerrides,d.length))<d.length&&(this.warnMaximumChangedObjectsExceeded=!0),b=d.sort((function(e,t){return e-t})),v=0;v<h;v++)this.changedObjectIds.add(b[v]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if(Object(y.k)(e.serviceUpdateTimeStamp)&&Object(y.k)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return Object(y.k)(t)&&Object(y.k)(t.serverGens)&&Object(y.k)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),C=function(){function e(t,i){Object(c.a)(this,e),this.objectId=t,this.options=i,this.updates=new Map,this.state=0}return Object(d.a)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=2,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return 0===this.state}}]),e}(),w=1e4,N=5e4},844:function(e,t,i){"use strict";i.d(t,"a",(function(){return tt}));var r=i(44),n=i(8),a=i.n(n),s=i(16),o=i(14),l=i(13),c=i(4),d=i(19),u=i(2),h=i(6),f=i(7),b=i(0),v=i(51),y=i(134),g=i(53),m=i(17),_=i(15),p=i(117),O=i(3),j=i(71),x=i(23),k=i(142),I=i(98),C=i(76),w=i(36),N=i(1),M=(i(18),i(11)),S=i(66),D=i(236),P=i(26),F=i(32),E=i(5),R=i(10),A=i(54),V=i(48),L=i(37),T=i(798),U=i(105),H=i(229),G=i(795),q=i(424),B=i(156),z=i(227),Q=i(425),K=(i(99),i(33)),Y=i(60),W=i(583),J=i(184),X=i(843),Z=i(820),$=i(773),ee=i(90),te=i(796),ie=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(u.a)(this,i),(r=t.call(this))._limit=e,r._all=new te.a,r._active=new ne(Object(d.a)(r)),r._pending=new Map,r._handle=r._all.on("change",(function(e){return r._handleChanges(e)})),r}return Object(c.a)(i,[{key:"destroy",value:function(){this._handle.remove()}},{key:"length",get:function(){return this._active.length}},{key:"toArray",value:function(){return this._active.toArray()}},{key:"find",value:function(e){return this._active.find(e)}},{key:"forEach",value:function(e){this._active.forEach(e)}},{key:"addMany",value:function(e){this._all.addMany(e)}},{key:"removeManyByObjectId",value:function(e){this._all.removeManyByObjectId(e)}},{key:"_handleChanges",value:function(e){var t=this,i=e.removed;if(this._pending.size>0){i=new Array;var r,n=Object(l.a)(e.removed);try{for(n.s();!(r=n.n()).done;){var a=r.value;this._pending.delete(a.objectId)||i.push(a)}}catch(f){n.e(f)}finally{n.f()}}var s=this._limit-this._active.length+i.length;s<e.added.length&&(this._active.removeMany(i),i=[],re.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((function(e){re.sample()&&(i.push(e),t._pending.set(e.objectId,e))})),s=this._limit-this._active.length+i.length);var o=e.added;if(s<e.added.length){o=new Array,re.reset(s/e.added.length);var c,d=Object(l.a)(e.added);try{for(d.s();!(c=d.n()).done;){var u=c.value;re.sample()?o.push(u):this._pending.set(u.objectId,u)}}catch(f){d.e(f)}finally{d.f()}}var h=s-o.length;h>0&&this._pending.size>0&&(re.reset(h/this._pending.size),this._pending.forEach((function(e){re.sample()&&(o.push(e),t._pending.delete(e.objectId))}))),this._active.addAndRemove(o,i)}}]),i}(ee.a),re=new(function(){function e(){Object(u.a)(this,e),this.percentage=1,this.last=-1,this.index=0}return Object(c.a)(e,[{key:"reset",value:function(e){this.percentage=e,this.last=-1}},{key:"sample",value:function(){var e=Math.floor(this.index*this.percentage);return++this.index,e!==this.last&&(this.last=e,!0)}}]),e}()),ne=function(){function e(t){Object(u.a)(this,e),this._parent=t,this._map=new Map}return Object(c.a)(e,[{key:"length",get:function(){return this._map.size}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}},{key:"find",value:function(e){var t;return Object(p.c)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"toArray",value:function(){return Object(r.a)(this._map.values())}},{key:"addAndRemove",value:function(e,t){var i,r=Object(l.a)(e);try{for(r.s();!(i=r.n()).done;){var n=i.value;this._map.set(n.objectId,n)}}catch(c){r.e(c)}finally{r.f()}var a,s=Object(l.a)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._map.delete(o.objectId)}}catch(c){s.e(c)}finally{s.f()}(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}},{key:"removeMany",value:function(e){var t,i=Object(l.a)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._map.delete(r.objectId)}}catch(n){i.e(n)}finally{i.f()}e.length>0&&this._parent.emit("change",{added:[],removed:e})}}]),e}(),ae=i(207),se=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(u.a)(this,i),(r=t.call(this,e)).loadedGraphics=new ie(5e4),r.slicePlaneEnabled=!1,r._renderingInfo={symbol:new ae.a},r._handles=new Y.a,r._graphicsByNode=new Map,r._scaleVisibility=null,r}return Object(c.a)(i,[{key:"initialize",value:function(){var e=this;this._graphicsCore=new X.a({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});var t=this.view.basemapTerrain;this._scaleVisibility=new Z.a({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,(function(t,i,r){return e._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,i,r)}),this._graphicsCore,t);var i=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),r=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:i,deconflictor:r,scaleVisibility:this._scaleVisibility}).then((function(){e._graphicsCore.startCreateGraphics()})).catch((function(){})),this._handles.add([this.layer.watch("labelingInfo",(function(t,i){Object(W.a)(t,i)&&e._graphicsCore.updateLabelingInfo()}))])}},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}},{key:"addNodeMeta",value:function(e,t){var i=this,r=0,n=e.filteredIds,a=e.featureIds.map((function(a,s){Object($.b)(s,i.collection,e.objectHandle,le);var o=Object(J.j)(0,0,0,i.view.spatialReference);i.view.renderCoordsHelper.fromRenderCoords(le,o);var l=t(s,e),c=!1;return Object(O.j)(n)?c=!0:r<n.length&&a===n[r]&&(c=!0,r++),{objectId:a,uid:y.a.generateUID(),attributes:l,visible:c,geometry:o}}));this.loadedGraphics.addMany(a),this._graphicsByNode.set(e.node.index,a)}},{key:"setNodeMetaAttributes",value:function(e,t){for(var i=this._graphicsByNode.get(e.node.index),r=new Array(i.length),n=0;n<i.length;n++){var a=i[n];a.attributes=t(n,e),r[n]=a.uid}this._graphicsCore.updateLabelingInfo(r)}},{key:"applyFilterChange",value:function(e){var t=this._graphicsByNode.get(e.node.index);if(t)if(Object(O.j)(e.filteredIds)){var i,r=Object(l.a)(t);try{for(r.s();!(i=r.n()).done;){var n=i.value;n.visible||(n.visible=!0,oe.graphic=n,oe.property="visible",oe.oldValue=!1,oe.newValue=!0,this._graphicsCore.graphicUpdateHandler(oe))}}catch(u){r.e(u)}finally{r.f()}}else{var a,s=0,o=Object(l.a)(t);try{for(o.s();!(a=o.n()).done;){var c=a.value,d=c.visible;s<e.filteredIds.length&&c.objectId===e.filteredIds[s]?(c.visible=!0,s++):c.visible=!1,d!==c.visible&&(oe.graphic=c,oe.property="visible",oe.oldValue=d,oe.newValue=c.visible,this._graphicsCore.graphicUpdateHandler(oe))}}catch(u){o.e(u)}finally{o.f()}}}},{key:"removeNodeMeta",value:function(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}},{key:"getRenderingInfo",value:function(){return this._renderingInfo}},{key:"notifyGraphicGeometryChanged",value:function(){}},{key:"notifyGraphicVisibilityChanged",value:function(){}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]),i}(K.a);Object(b.a)([Object(N.b)()],se.prototype,"view",void 0),Object(b.a)([Object(N.b)()],se.prototype,"layer",void 0),Object(b.a)([Object(N.b)()],se.prototype,"collection",void 0),Object(b.a)([Object(N.b)()],se.prototype,"loadedGraphics",void 0),Object(b.a)([Object(N.b)({aliasOf:"_graphicsCore.updating"})],se.prototype,"updating",void 0),Object(b.a)([Object(N.b)()],se.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(N.b)()],se.prototype,"_graphicsCore",void 0),se=Object(b.a)([Object(M.a)("esri.views.3d.layers.I3SMeshViewLabeler")],se);var oe={graphic:null,property:null,oldValue:null,newValue:null},le=Object(R.e)(),ce=se,de=i(458),ue=_.a.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle"),he=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){return Object(u.a)(this,i),t.call(this,"SceneLayerWorker","process",e,{hasInitialize:!0})}return Object(c.a)(i,[{key:"getTransferList",value:function(e){return[e.geometryBuffer]}},{key:"setModifications",value:function(e,t,i){var r={context:e,modifications:ve(t,i),isGeodetic:i.isGeographic};this.broadcast(r,"setModifications")}},{key:"setLegacySchema",value:function(e,t){var i=JSON.stringify(t);this.broadcast({context:e,jsonSchema:i},"setLegacySchema")}},{key:"destroyContext",value:function(e){return this.broadcast(e,"destroyContext")}}]),i}(de.a),fe=new j.a({deallocator:null}),be=[0,0,0];function ve(e,t){fe.clear();var i,r=Object(l.a)(e);try{var n=function(){var e=i.value,r="clip"===e.type?2:"mask"===e.type?1:0,n=e.geometry,a=function(e){return e};if(n.spatialReference){if(!Object(V.b)(n.spatialReference,t))return ue.warn("Can't project modification polygon into layer spatial reference, ignoring modification"),"continue";a=function(e){return Object(V.z)(e,n.spatialReference,be,t),be}}else n.hasZ||(be[2]=0,a=function(e){return be[0]=e[0],be[1]=e[1],be});fe.push(r),fe.push(n.rings.length);var s,o=Object(l.a)(n.rings);try{for(o.s();!(s=o.n()).done;){var c=s.value;fe.push(c.length);var d,u=Object(l.a)(c);try{for(u.s();!(d=u.n()).done;){var h=a(d.value);fe.push(h[0]),fe.push(h[1]),fe.push(h[2])}}catch(f){u.e(f)}finally{u.f()}}}catch(f){o.e(f)}finally{o.f()}};for(r.s();!(i=r.n()).done;)n()}catch(o){r.e(o)}finally{r.f()}fe.push(3);for(var a=new Float64Array(fe.length),s=0;s<fe.length;++s)a[s]=fe.getItemAt(s);return a}var ye=i(713),ge=i(107),me=i(108),_e=function e(){Object(u.a)(this,e),this.ids=new Set,this.paused=!1},pe=function(){function e(t){var i=t.collection,r=t.forAllFeatures,n=t.forAllFeaturesOfNode;Object(u.a)(this,e),this.highlights=[],this.collection=i,this.forAllFeatures=r,this.forAllFeaturesOfNode=n}return Object(c.a)(e,[{key:"destroy",value:function(){var e=this;this.highlights.forEach((function(t){return e.releaseSet(t)})),this.highlights=null}},{key:"acquireSet",value:function(){var e=this,t=new _e;this.highlights.push(t);var i={remove:function(){e.releaseSet(t),Object(me.k)(e.highlights,t)},pause:function(){e.releaseSet(t),t.paused=!0},resume:function(){t.paused=!1,e.initializeSet(t)}};return{set:t,handle:i}}},{key:"setFeatureIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)}},{key:"initializeSet",value:function(e){var t=this;this.forAllFeatures((function(i,r,n){return e.ids.has(i)&&t.collection.addComponentHighlight(n.objectHandle,r),1}))}},{key:"releaseSet",value:function(e){var t=this;this.forAllFeatures((function(i,r,n){return e.ids.has(i)&&t.collection.removeComponentHighlight(n.objectHandle,r),1}))}},{key:"objectCreated",value:function(e){var t=this;this.highlights.forEach((function(i){i.paused||t.forAllFeaturesOfNode(e,(function(r,n){return i.ids.has(r)&&t.collection.addComponentHighlight(e.objectHandle,n),1}))}))}},{key:"objectDeleted",value:function(e){this.collection.clearHighlights(e.objectHandle)}}]),e}(),Oe=i(799),je=function e(){Object(u.a)(this,e),this.lodCrossfadeSignedDuration=0},xe=function(){function e(t){Object(u.a)(this,e),this.view=t,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}return Object(c.a)(e,[{key:"updating",get:function(){return this._numFadingNodes>0}},{key:"stopNodeFading",value:function(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=Object(O.s)(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}},{key:"_startNodeFading",value:function(e,t,i){var r=this;0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=Object(k.a)({preRender:function(e){return r._updateAllNodeFading(e)}}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=i,e.lodCrossfadeProgress=t}},{key:"_updateAllNodeFading",value:function(e){var t=this,i=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode((function(r,n){if(Object(O.k)(n)&&Object(O.k)(n.lodCrossfadeProgress)){var a=n.lodCrossfadeSignedDuration,s=a>0?t.view.fullOpacity:0,o=e.deltaTime/a,l=n.lodCrossfadeProgress+Math.abs(o),c=!i||l>=1||0===a,d=s-(c?0:a>0?1:-1)*(1-l);c?(t.stopNodeFading(n),a<0&&t.view.markNodeToRemove(r)):n.lodCrossfadeProgress=l,t.view.setNodeOpacityByIndex(r,d)}})),this.view.removeMarkedNodes()}},{key:"stopAllNodeFading",value:function(){var e=this;this.view.foreachCrossfadeNode((function(t,i){if(Object(O.k)(i)&&Object(O.k)(i.lodCrossfadeProgress)){e.stopNodeFading(i);var r=i.lodCrossfadeSignedDuration;r<0&&e.view.markNodeToRemove(t);var n=r>0?e.view.fullOpacity:0;e.view.setNodeOpacityByIndex(t,n)}})),this.view.removeMarkedNodes()}},{key:"fadeNode",value:function(e,t,i,r){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());var n=this.view,a=n.nodeCrossfadingEnabled,s=0===i?n.fullOpacity:0,o=a?r?0===i?n.lodCrossfadeinDuration:n.lodCrossfadeoutDuration:n.lodCrossfadeUncoveredDuration:0,l=this.view.getNodeOpacityByIndex(e);if(a&&l!==s&&o>0){var c=1-Math.abs(s-l);this._startNodeFading(t,c,function(e){return 0===e?1:-1}(i)*o)}else this.stopNodeFading(t),this.view.setNodeOpacityByIndex(e,s),1===i&&this.view.removeNode(e)}},{key:"isNodeFullyFadedIn",value:function(e){var t=this.view.getNodeCrossfadeMetaData(e);return Object(O.k)(t)&&null==t.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity}}]),e}();var ke=i(42),Ie=i(146),Ce=Object(ke.n)(),we=Object(F.d)(),Ne=Object(R.e)(),Me=Object(R.e)(),Se=Object(R.e)(),De=_.a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider"),Pe=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e){var r;return Object(u.a)(this,i),(r=t.call(this,e)).tmpEvent={spatialReference:null,extent:Ce,context:"scene"},r}return Object(c.a)(i,[{key:"initialize",value:function(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new Ie.a(this.view.state.viewingMode),this.intersector.options.store=0;var e=this.layerView.i3slayer.fullExtent;this.zmin=e.zmin,this.zmax=e.zmax,this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}},{key:"getElevation",value:function(e,t,i,r){if(Ne[0]=e,Ne[1]=t,Ne[2]=i,!this.renderCoordsHelper.toRenderCoords(Ne,r,Ne))return De.error("could not project point to compute elevation"),null;var n=this.layerView.elevationOffset,a=this.zmin+n,s=this.zmax+n;return this.renderCoordsHelper.setAltitude(Me,s,Ne),this.renderCoordsHelper.setAltitude(Se,a,Ne),this.intersector.reset(Me,Se),this.intersectionHandler.intersect(this.intersector,null,Me,Se),this.intersector.results.min.getIntersectionPoint(Ne)?this.renderCoordsHelper.getAltitude(Ne):null}},{key:"layerChanged",value:function(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"objectChanged",value:function(e){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(e),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"computeObjectExtent",value:function(e){return Object(ke.n)(Ce),this._expandExtent(e,Ce),Ce}},{key:"computeLayerExtent",value:function(){Object(ke.n)(Ce);var e,t=Object(l.a)(this.layerView.getVisibleNodes());try{for(t.s();!(e=t.n()).done;){var i=e.value;this._expandExtent(i,Ce)}}catch(r){t.e(r)}finally{t.f()}return Ce}},{key:"_expandExtent",value:function(e,t){var i=e.visibilityObb||e.serviceObbInRenderSR;if(Object(O.k)(i)){Object(P.x)(we,i.quaternion),we[12]=i.center[0],we[13]=i.center[1],we[14]=i.center[2];for(var r=0;r<8;++r)Ne[0]=1&r?i.halfSize[0]:-i.halfSize[0],Ne[1]=2&r?i.halfSize[1]:-i.halfSize[1],Ne[2]=4&r?i.halfSize[2]:-i.halfSize[2],Object(E.s)(Ne,Ne,we),this.renderCoordsHelper.fromRenderCoords(Ne,Ne,this.spatialReference),Object(ke.p)(t,Ne,t)}else{var n=e.renderMbs[3],a=Object(E.m)(Me,e.renderMbs);a[0]-=n,a[1]-=n,a[2]-=n;var s=Object(E.m)(Se,e.renderMbs);s[0]+=n,s[1]+=n,s[2]+=n;for(var o=0;o<8;++o)Ne[0]=1&o?a[0]:s[0],Ne[1]=2&o?a[1]:s[1],Ne[2]=4&o?a[2]:s[2],this.renderCoordsHelper.fromRenderCoords(Ne,Ne,this.spatialReference),Object(ke.p)(t,Ne,t)}}}]),i}(ee.a.EventedMixin(K.a));Object(b.a)([Object(N.b)({constructOnly:!0})],Pe.prototype,"layerView",void 0),Object(b.a)([Object(N.b)({constructOnly:!0})],Pe.prototype,"intersectionHandler",void 0),Object(b.a)([Object(N.b)()],Pe.prototype,"view",void 0),Object(b.a)([Object(N.b)({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],Pe.prototype,"spatialReference",void 0);var Fe=Pe=Object(b.a)([Object(M.a)("esri.views.3d.layers.i3s.I3SElevationProvider")],Pe),Ee=i(374),Re=i(251),Ae=i(187),Ve=function(){function e(t){Object(u.a)(this,e),this.type="I3S",this.layerUid=t.layerUid,this.sublayerUid=t.sublayerUid,this.collection=t.collection,this.traverseNodeHierarchy=t.traverseNodeHierarchy,this.slicePlane=t.slicePlaneEnabled,this.isGround=t.isGround}return Object(c.a)(e,[{key:"intersect",value:function(e,t,i,r){var n=this,a=e.results,s=2===e.options.store,o=e.ray.direction,l=e.tolerance,c=function(e){return e},d=function(e){return e},u=Object(Ae.c)(e.verticalOffset);Object(O.k)(u)&&(c=function(e){return u.applyToMbs(e)},d=function(e){return u.applyToObb(e)}),this.traverseNodeHierarchy((function(h,f){return!(Object(O.k)(h.serviceObbInRenderSR)&&!Object(Ee.f)(d(h.serviceObbInRenderSR),i,o,l))&&(!f||Object(O.k)(h.geometryObb)&&!Object(Ee.f)(d(h.geometryObb),i,o,l)||!Object(O.k)(h.serviceObbInRenderSR)&&!function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=e[3]+r,a=t[0]-e[0],s=t[1]-e[1],o=t[2]-e[2],l=i[0],c=i[1],d=i[2],u=l*a+c*s+d*o;return u*u-(l*l+c*c+d*d)*(a*a+s*s+o*o-n*n)>=0}(c(h.renderMbs),i,o,l)||n.collection.intersect(f,i,r,l,u,(function(o,l,c,d){if(l>=0){if(null!=t&&!t(i,r,l))return;var u=function(e){e.intersector=n.type,e.target={type:"external",metadata:{layerUid:n.layerUid,sublayerUid:n.sublayerUid,nodeIndex:h.index,componentIndex:o}},e.dist=l,Object(E.m)(e.normal,c),e.triangleNr=d};if(n.isGround&&(null==a.ground.dist||l<a.ground.dist)&&u(a.ground),e.options.isFiltered)return;if((null==a.min.dist||l<a.min.dist)&&u(a.min),(null==a.max.dist||l>a.max.dist)&&u(a.max),s){var f=new Re.a(e.ray);u(f),e.results.all.push(f)}}})),!0)}))}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}();var Le=i(774),Te=i(812),Ue=i(740),He=i(22),Ge=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:14;Object(u.a)(this,e),this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=t,this._storeName=i}return Object(c.a)(e,[{key:"init",value:function(){var e=this;return Promise.resolve().then((function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(i){var r=t.result,n=t.transaction,a=r.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):r.createObjectStore(e._storeName),s=r.objectStoreNames.contains("last_access")?n.objectStore("last_access"):r.createObjectStore("last_access");s.indexNames.contains("date")||s.createIndex("date","date",{unique:!1}),s.indexNames.contains("byteSize")||s.createIndex("byteSize","byteSize",{unique:!1}),i.oldVersion<e._version&&(a.clear(),s.clear())},Be(t)})).then((function(t){e._destroyed?t.close():e._db=t}))}},{key:"destroy",value:function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}},{key:"initialized",get:function(){return null!=this._db}},{key:"getHitRate",value:function(){return this._hit/(this._hit+this._miss)}},{key:"put",value:function(e,t){var i=this;return null==this._db?Promise.reject(new He.a("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((function(){return i._put(e,t)})).catch((function(r){if(r&&"QuotaExceededError"===r.name)return null==i._quotaReductionPromise&&(i._quotaReductionPromise=i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*i.quotaReductionFactor))})),i._quotaReductionPromise.then((function(){return i._quotaReductionPromise=null}),(function(){return i._quotaReductionPromise=null}))),i._quotaReductionPromise.then((function(){return i._put(e,t)}));throw r})).then((function(){i._gcCounter--,i._gcCounter<0&&null!=i._db&&(i._gcCounter=i.gcFrequency,i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(e-i.maxByteSize)})))}))}},{key:"get",value:function(e,t){var i=this;if(null==this._db)return Promise.resolve(null);var r=null;return Promise.resolve().then((function(){var n=i._db.transaction(i._storeName,"readonly");return r=Object(x.s)(t,(function(){n.abort()})),Be(n.objectStore(i._storeName).get(e))})).then((function(t){return null==t?++i._miss:i._db&&(++i._hit,i._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),Object(O.k)(r)&&r.remove(),t})).catch((function(){return++i._miss,Object(x.x)(t),Object(O.k)(r)&&r.remove(),null}))}},{key:"remove",value:function(e){var t=this;return null==this._db?Promise.resolve():Promise.resolve().then(Object(s.a)(a.a.mark((function i(){var r,n,s,o,l;return a.a.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return r=t._db.transaction([t._storeName,"last_access"],"readwrite"),n=r.objectStore(t._storeName),s=r.objectStore("last_access"),o=n.delete(e),l=s.delete(e),i.next=3,Promise.all([Be(o),Be(l),qe(r)]);case 3:case"end":return i.stop()}}),i)}))))}},{key:"_put",value:function(e,t){var i=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=i.objectStore(this._storeName),n=i.objectStore("last_access"),a=r.put(t,e),s=n.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([Be(a),Be(s),qe(i)])}},{key:"_removeLeastRecentlyAccessed",value:function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=t.objectStore(this._storeName),r=t.objectStore("last_access"),n=0,a=r.index("date").openCursor(null,"next");return a.onsuccess=function(){var t=a.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),i.delete(t.primaryKey),r.delete(t.primaryKey),n<e&&t.continue())},qe(t)}}},{key:"_getCacheSize",value:function(){var e=this._db.transaction("last_access"),t=e.objectStore("last_access"),i=0,r=t.index("byteSize").openKeyCursor();return r.onsuccess=function(){var e=r.result;if(e){var t=e.key;null!=t&&(i+=t),e.continue()}},qe(e).then((function(){return i}))}}]),e}();function qe(e){return new Promise((function(t,i){e.oncomplete=function(){return t()},e.onerror=function(){return i(e.error)},e.onabort=function(){return i(e.error)}}))}function Be(e){return new Promise((function(t,i){"done"===e.readyState?null!=e.error?i(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return i(e.error)})}))}var ze=i(781),Qe=i(86),Ke=i(460),Ye=i(420),We=i(145),Je=i(608),Xe=i(431),Ze=_.a.getLogger("esri.views.3d.layers.SceneLayerView3D"),$e=[1,1,1,1],et=function(e){Object(h.a)(i,e);var t=Object(f.a)(i);function i(e,r,n,a,s,o,l){var c;return Object(u.a)(this,i),(c=t.call(this)).node=e,c.featureIds=r,c.objectHandle=n,c.cachedRendererVersion=a,c.attributeInfo=s,c.material=o,c.textures=l,c.cachedEdgeMaterials=new Array,c.cachedSymbology=null,c}return i}(je),tt=function(e){var t=function(e){Object(h.a)(n,e);var t=Object(f.a)(n);function n(){var e;Object(u.a)(this,n);for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return(e=t.call(this,r))._elevationProvider=null,e._intersectionHandler=null,e._nodeId2Meta=new Map,e._nodeId2MetaReloading=new Map,e._i3sWasmLoaded=!1,e._hasLoadedPBRTextures=!1,e._asyncModuleLoading=0,e._addTasks=new Map,e._rendererVersion=0,e._colorVariable=null,e._opacityVariable=null,e._rendererFields=null,e._symbologyFields=null,e._symbologyOverride=null,e._symbologyOverrideFields=null,e._symbolInfos=new Map,e._idbCache=new Ge("esri-scenelayer-cache","geometries"),e.holeFilling="auto",e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._modifications=new Array,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new y.a(null,null,{}),e._crossfadeHelper=new xe(Object(d.a)(e)),e}return Object(c.a)(n,[{key:"lodCrossfadeoutDuration",get:function(){return 0}},{key:"lodCrossfadeinDuration",get:function(){return 0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return 0}},{key:"layerUid",get:function(){return this.i3slayer&&this.i3slayer.uid}},{key:"sublayerUid",get:function(){return null}},{key:"hasTexturesOrVertexColors",get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}},{key:"rendererTextureUsage",get:function(){return Object(Ue.u)(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}},{key:"elevationOffset",get:function(){var e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=Object(C.g)(this.i3slayer.spatialReference),i=Object(Q.a)(e.unit);return Object(O.u)(e.offset,0)*i/t}return 0}},{key:"supportedTextureEncodings",get:function(){return Object(Le.e)(this.view._stage.renderView.capabilities)}},{key:"uncompressedTextureDownsamplingEnabled",get:function(){var e,t=null==(e=this.view)?void 0:e.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled,i=0==(4&this.supportedTextureEncodings);return t&&i}},{key:"initialize",value:function(){var e=this;this.preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);var t=this.view.resourceController;if(this.attributeOverrides=new Oe.a(this.i3slayer,t.memoryController),this._worker=new he((function(e){return t.schedule(e)})),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),Object(Ue.e)(this.i3slayer),Object(Ue.d)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new T.a({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new pe({collection:this._collection,forAllFeatures:function(t){return e._forAllFeatures(t,null,1)},forAllFeaturesOfNode:function(t,i){return e._forAllFeaturesOfNode(t,i)}}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var r=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(r&&r.faceRange&&r.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,(function(t){return e._deleteComponentObject(t)}));this._intersectionHandler=new Ve({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:function(t){return Object(O.k)(e._controller.index)&&Object(O.k)(e._controller.index.rootNode)?e._controller.index.traverse(e._controller.index.rootNode,(function(i){var r=i.index,n=e._nodeId2Meta.get(r)||e._nodeId2MetaReloading.get(r);return t(i,Object(O.k)(n)?n.objectHandle:null)})):function(){}}}),this._elevationProvider=new Fe({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR(),this.updatingHandles.add(this,"view.clippingArea",(function(){return e._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(t){return e._opacityChange(t)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._slicePlaneEnabledChange(t)})),this.updatingHandles.add(this,"elevationOffset",(function(t,i){e._reloadAll(i),e._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(function(){return e._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return e._updatePBR()}));var n=function(){e._reloadAll(),e.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",n),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",n),this.updatingHandles.add(this,"suspended",(function(t){return e._suspendedChange(t)}),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this,"_modifications",(function(){return e._modificationsChanged()}),2),this.handles.add([Object(w.a)(Qe.a,"I3S_TREE_SHOW_TILES",(function(t){if(t&&!e._treeDebugger){var r=e._controller.crsIndex;i.e(37).then(i.bind(null,1124)).then((function(t){var i=t.I3STreeDebugger;!e._treeDebugger&&Qe.a.I3S_TREE_SHOW_TILES&&(e._treeDebugger=new i({lv:e,view:e.view,nodeSR:r}))}))}else t||Qe.a.I3S_TREE_SHOW_TILES||(e._treeDebugger=Object(O.e)(e._treeDebugger))})),Object(w.a)(Qe.a,"I3S_SHOW_MODIFICATIONS",(function(){return e._showModifications()}))]),this._cacheKeySuffix=Object(Ue.m)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return Ze.warn("Failed to initialize IndexedDB cache: ".concat(e))}))}},{key:"destroy",value:function(){this._clearAddTasks(),this.attributeOverrides=Object(O.e)(this.attributeOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var e=this._worker;e&&(e.destroyContext(this.i3slayer.uid).then((function(){return e.destroy()})),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=Object(O.e)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=Object(O.e)(this._labeler),this._treeDebugger=Object(O.e)(this._treeDebugger),this._controller=Object(O.e)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}},{key:"memEstimateTextureAdded",value:function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t}},{key:"memEstimateTextureRemoved",value:function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t}},{key:"memEstimateGeometryAdded",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t}},{key:"memEstimateGeometryRemoved",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t}},{key:"isNodeLoaded",value:function(e){return this._nodeId2Meta.has(e)}},{key:"isNodeReloading",value:function(e){return this._nodeId2MetaReloading.has(e)}},{key:"getUsedMemory",value:function(){var e=Object(O.k)(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=Object(O.k)(t)?t.node.memory:0})),this._nodeId2MetaReloading.forEach((function(t){return e+=Object(O.k)(t)?t.node.memory:0})),e}},{key:"getUnloadedMemory",value:function(){return(Object(O.k)(this._controller)?this._controller.unloadedMemoryEstimate:0)+(Object(O.k)(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}},{key:"ignoresMemoryFactor",value:function(){return!1}},{key:"_labelingChanged",value:function(){var e=this;if(Object(H.a)(this.i3slayer)&&this._supportsLabeling){if(!Object(O.k)(this._labeler)){var t=new ce({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((function(i){return Object(O.k)(i)&&e._addMetaToLabeler(t,i)})),this._labeler=t}}else Object(O.k)(this._labeler)&&(this._labeler.destroy(),this._labeler=null)}},{key:"_loadAsyncModule",value:function(e){var t=this;return++this._asyncModuleLoading,e.then((function(e){return--t._asyncModuleLoading,e}),(function(e){throw--t._asyncModuleLoading,e}))}},{key:"_modificationsChanged",value:function(){var e=this;if(!this._i3sWasmLoaded&&this._hasModifications)return this._i3sWasmLoaded=Object(ye.initialize)().then((function(){e._i3sWasmLoaded=!0,e._modificationsChanged(),e.notifyUpdate()})),void this.notifyUpdate();if(!0===this._i3sWasmLoaded){var t=this.i3slayer.uid,i=this.i3slayer.spatialReference;this._worker.setModifications(t,this._modifications,i);var r=ve(this._modifications,i);Object(ye.setModificationsSync)({context:t,modifications:r,isGeodetic:i.isGeographic}),this._controller.modificationsChanged();var n=this._hasModifications?new j.a:null;this._nodeId2Meta.forEach((function(t,i){Object(O.j)(t)?e._nodeId2Meta.delete(i):t.node.hasModifications?(e._nodeId2Meta.delete(i),e._nodeId2MetaReloading.set(i,t)):Object(O.k)(n)&&n.push(t.node)})),Object(O.k)(n)&&this._nodeId2MetaReloading.forEach((function(e){return n.push(e.node)})),Object(O.k)(n)&&n.length>0&&(this.updateNodeModificationStatus(n),n.forAll((function(t){if(2!==t.imModificationImpact){var i=e._nodeId2Meta.get(t.index);e._controller.invalidateGeometryVisibility(t.index),e._nodeId2Meta.delete(t.index),Object(O.k)(i)&&e._nodeId2MetaReloading.set(t.index,i)}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}}},{key:"_showModifications",value:function(){if(Object(O.k)(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),Qe.a.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;var i,r=Object(l.a)(this._modifications);try{for(r.s();!(i=r.n()).done;){var n=i.value;n.geometry.spatialReference=this.i3slayer.spatialReference;var a=Object(o.a)(Object(o.a)({},t),{},{color:e[n.type]});this._modificationGraphics.push(new y.a({geometry:n.geometry,symbol:a}))}}catch(s){r.e(s)}finally{r.f()}this.view.graphics.addMany(this._modificationGraphics)}}},{key:"_addMetaToLabeler",value:function(e,t){var i=this;e.addNodeMeta(t,(function(e,t){return i._createAttributes(e,t)}))}},{key:"_suspendedChange",value:function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}},{key:"getLoadedAttributes",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(O.k)(t)&&Object(O.k)(t.attributeInfo))return t.attributeInfo.loadedAttributes}},{key:"getAttributeData",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(O.k)(t)&&Object(O.k)(t.attributeInfo))return t.attributeInfo.attributeData}},{key:"setAttributeData",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&Object(O.k)(i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}},{key:"updateAttributes",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._nodeId2Meta.get(t),e.t0=Object(O.k)(n),!e.t0){e.next=7;break}return e.next=5,this.attributeOverrides.apply(n.featureIds,i,r);case 5:n.attributeInfo=i,this._attributeValuesChanged(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_attributeValuesChanged",value:function(e){var t=this;e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,Object(O.k)(this._labeler)&&this._labeler.setNodeMetaAttributes(e,(function(e,i){return t._createAttributes(e,i)})),this._updateEngineObject(e)}},{key:"clearMemCache",value:function(){Object(O.k)(this._memCache)&&this._memCache.clear()}},{key:"getVisibleNodes",value:function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return Object(O.k)(t)&&e.push(t.node)})),e}},{key:"getLoadedNodeIndices",value:function(e){this._nodeId2Meta.forEach((function(t,i){return e.push(i)})),this._nodeId2MetaReloading.forEach((function(t,i){return e.push(i)}))}},{key:"preLoadBasis",value:function(){!Object(m.a)("disable-feature:i3s-basis")&&0!=(2&this.supportedTextureEncodings)&&Object(O.c)(this.i3slayer.textureSetDefinitions,(function(e){return e.some((function(e){return e.formats.some((function(e){return"basis"===e.format||"ktx2"===e.format}))}))}))&&Object(Xe.e)()}},{key:"_getVertexBufferLayout",value:function(e,t){var i={hasTexture:lt(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return Object(We.a)(Object(Je.a)(this._getGeometryParameters(i)))}},{key:"_getObjectIdField",value:function(){return this.i3slayer.objectIdField||"OBJECTID"}},{key:"_findGraphicNodeAndIndex",value:function(e){var t=Object(ze.a)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField()),i=null;return Object(p.c)(this._nodeId2Meta,(function(e){if(Object(O.j)(e))return!1;var r=e.featureIds.indexOf(t);return-1!==r&&(i={node:e.node,index:r},!0)})),i}},{key:"_getGraphicIndices",value:function(e,t){var i=this._nodeId2Meta.get(e.index);if(Object(O.j)(i))return[];var r,n=[],a=this._getObjectIdField(),s=this.i3slayer.fieldsIndex,o=Object(l.a)(t);try{for(o.s();!(r=o.n()).done;){var c=r.value,d=Object(ze.a)(s,c.attributes,a),u=i.featureIds.indexOf(d);-1!==u&&n.push(u)}}catch(h){o.e(h)}finally{o.f()}return n}},{key:"whenGraphicBounds",value:function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();var i=this._nodeId2Meta.get(t.node.index);if(Object(O.j)(i))return Promise.reject();var r=i.objectHandle,n=Object($.a)(t.index,this._collection,r,new Float64Array(24)),a=this.view.renderSpatialReference,s=this.view.spatialReference;if(Object(V.q)(n,a,0,n,s,0,8)){var o=Object(L.k)();return Object(L.n)(o,n,0,8),Promise.resolve({boundingBox:o,screenSpaceObjects:[]})}}},{key:"whenGraphicAttributes",value:function(e,t){var i=this;return Object(Ue.x)(this.i3slayer,e,this._getObjectIdField(),t,(function(){return Object(r.a)(i._nodeId2Meta.values()).filter(O.k)}))}},{key:"getGraphicFromIntersectorMetadata",value:function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return Object(O.j)(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}},{key:"_getCacheKey",value:function(e){return"".concat(this._layerUrl,"/v").concat(19,"/").concat(e.id).concat(this._cacheKeySuffix)}},{key:"_getMemCacheKey",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;return e+"#"+t}},{key:"_idbCacheEnabled",get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix}},{key:"loadCachedGPUData",value:function(e){return Object(O.k)(this._memCache)?this._memCache.pop(this._getMemCacheKey(e.index)):null}},{key:"deleteCachedGPUData",value:function(e){Object(O.k)(e)&&this._deleteComponentObject(e)}},{key:"_cacheGPUData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;if(Object(O.j)(this._memCache))this._deleteComponentObject(e);else{var i=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,i)}}},{key:"loadMissingTextures",value:function(e,t,i,r){var n=this,a=e.filter((function(e,i){if(0==(e.usage&n.rendererTextureUsage))return!1;if(Object(O.j)(t))return!0;var r=Object(Le.f)(e.encodings,n.supportedTextureEncodings),a=t[i];return!!(Object(O.j)(a)||null==a.data||r&&a.encoding!==r.encoding)}));return 0===a.length?Promise.resolve(!1):i(a,r).then((function(i){for(var r=0,n=0;n<e.length;n++)r<i.length&&i[r].id===e[n].id&&(t[n]=i[r],r++);return!0}))}},{key:"loadCachedNodeData",value:function(e,t,i){var r=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((function(n){return null==n?null:n.nodeVersion!==e.version?(r._idbCache.remove(r._getCacheKey(e)),null):(e.geometryObb=n.geometryObb,r.loadMissingTextures(n.requiredTextures,n.textureData,i,t).then((function(i){return i&&r._idbCache.initialized&&Object(O.k)(n.textureData)&&(n.byteSize=dt(n.transformedGeometry,n.textureData),n.textureData.every(ct)&&ut(e,n)&&r._idbCache.put(r._getCacheKey(e),n).catch((function(t){return Ze.warn("Failed to update node with textures in IndexedDB cache: ".concat(e.id,": ").concat(t))}))),Object(x.x)(t),n})))})):Promise.resolve(null)}},{key:"addNode",value:function(e,t,i){var r=this;return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(function(){return r._transformNode(e,t,i).then((function(n){return r._safeReschedule((function(){if(Object(O.j)(n))return e.hasModifications=!1,r._addCachedNodeData(e,null,i);e.hasModifications=n.transformedGeometry.hasModifications;var a=n.obb,s=n.componentOffsets,l=n.featureIds,c=n.transformedGeometry,d=r._controller.crsIndex,u=r.view.renderSpatialReference,h=Object(Te.a)(e.mbs,r.elevationOffset,d,u);e.geometryObb=Object(Ee.e)([a.center.x,a.center.y,a.center.z],[a.extents.x,a.extents.y,a.extents.z],[a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w]),Object(E.s)(e.geometryObb.center,e.geometryObb.center,h),t.geometryData.componentOffsets=s,l&&(t.geometryData.featureIds=Array.prototype.slice.call(l));var f={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:c,globalTrafo:h,geometryObb:e.geometryObb,byteSize:dt(c,t.textureData)};if(r._idbCacheEnabled&&r._idbCache.initialized&&ut(e,f)){var b=Object(O.k)(f.textureData)?f.textureData.map((function(e){return ct(e)?e:null})):null;r._idbCache.put(r._getCacheKey(e),Object(o.a)(Object(o.a)({},f),{},{textureData:b})).catch((function(t){return Ze.warn("Failed to store node in IndexedDB cache: ".concat(e.id,": ").concat(t))}))}return r._addCachedNodeData(e,f,i)}),i)}))})):Promise.reject()}},{key:"computeVisibilityObb",value:function(e){return Object(Ue.h)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}},{key:"_transformNode",value:function(e,t,i){for(var r=t.geometryData.geometries,n=new Array(r.length),a=0;a<r.length;++a)n[a]=this._getVertexBufferLayout(r[a],t.geometryDescriptor);var s=e.mbs,o=this.elevationOffset,l=this._controller.crsIndex,c=this._controller.crsVertex,d=this.view.renderSpatialReference,u=Object(Te.b)(s,o,l),h=Object(Te.a)(s,o,l,d),f=Object(V.e)(l,c),b=Object(V.e)(c,d);if(Object(O.j)(f)||Object(O.j)(b))return Promise.resolve(null);var v={context:this.i3slayer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:n,localOrigin:u,globalTrafo:h,mbs:s,obb:e.serviceObb,elevationOffset:o,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:f,vertexToRenderProjector:b};return this._worker.invoke(v,i)}},{key:"supportsNodeCrossFading",get:function(){var e,t;return!(null!=(e=this.view)&&null!=(t=e._stage)&&t.renderView.hasShadowsEnabled)}},{key:"nodeCrossfadingEnabled",get:function(){return this.supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}},{key:"nodeFadeoutEnabled",get:function(){return this.supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}},{key:"_setNewNodeOpacity",value:function(e){var t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}},{key:"addCachedGPUData",value:function(e,t,i){if(e.geometryObb=Object(Ee.b)(this._collection.getComponentObb(t.objectHandle)),this._controller.isGeometryVisible(e)){Object(O.k)(this._labeler)&&this._addMetaToLabeler(this._labeler,t);var r=e.index;this._addNodeMeta(r,t),this.updateNodeState(r,i),this._collection.setObjectVisibility(t.objectHandle,1),this._updateMaterial(t),this._setNewNodeOpacity(t),this._updateEngineObject(t),this._highlights.objectCreated(t),Object(O.k)(this._treeDebugger)&&this._treeDebugger.update()}else this._cacheGPUData(t)}},{key:"addCachedNodeData",value:function(e,t,i,r){var n=this;return this._addData(e,i,(function(){return n._addCachedNodeData(e,t,r)}))}},{key:"_addCachedNodeData",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,l,c,d,u,h,f,b,v,y,g,_,p,j,x,k,I,C,w,N,M,E,A,L,T,U,H,G,q,B,z=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended&&this._controller.isGeometryVisible(t)){e.next=2;break}return e.abrupt("return",void this._removeNodeStageData(t.index,this.elevationOffset,this._nodeId2MetaReloading));case 2:if(!Object(O.j)(i)){e.next=4;break}return e.abrupt("return",void this._addNodeMeta(t.index,null));case 4:return n=this._addTasks.get(t.index),s=i.geometryData,o=i.transformedGeometry,l=i.globalTrafo,e.next=7,this.attributeOverrides.apply(s.featureIds,n.attributeInfo,r);case 7:if(c=Object(O.k)(i.textureData)?i.textureData.filter((function(e){return Object(O.k)(e)&&0!=(e.usage&z.rendererTextureUsage)})):[],e.t0=!Object(m.a)("disable-feature:i3s-basis")&&c.some((function(e){return Object(O.k)(e)&&(2===e.encoding||1===e.encoding)})),!e.t0){e.next=12;break}return e.next=12,Object(Xe.e)();case 12:return t.memory=0,d=s.componentOffsets,u=s.geometries,h=s.featureIds,f=this._collection,b=u[0],v=o.layout,y=o.indices,g=o.interleavedVertexData,_=o.positionData,p=o.hasColors,j=this._materialParameters(b,v),x=d||new Uint32Array([0,y?y.length:g.byteLength/v[0].stride]),k={vertices:{data:g,count:g.byteLength/v[0].stride,layoutParameters:j.geometryParams},positionData:{positions:_.data,indices:_.indices},indices:y,componentOffsets:x},I=b.transformation?Object(F.c)(b.transformation):Object(F.d)(),Object(P.m)(I,l,I),C=Object(P.v)(Object(R.e)(),I),w=Object(S.f)(Object(D.b)(),I),N=this.view.renderSpatialReference,M=this.view.basemapTerrain.spatialReference,E=Object(R.e)(),A=[1,1,1],Object(V.k)(C,N,A,M)||Ze.errorOnce("Unsupported coordinate system for IM overlay"),Object(V.z)(C,N,E,M),L=f.createObject({toMapSpace:[E[0],E[1],A[0],A[1]],geometry:k,obb:Object(O.t)(t.geometryObb),transform:{position:C,rotationScale:w}}),T=2===j.geometryParams.textureCoordinates,U=this._initMaterialAndTextures(L,j.material,c,T),t.memory+=this.memEstimateGeometryAdded(L),t.memory+=U.reduce((function(e,t){return e+(Object(O.k)(t)?z.memEstimateTextureAdded(t):0)}),0),H=!!j.material.hasParametersFromSource,G="blend"!==j.material.alphaMode&&j.material.metallicRoughness.baseColorFactor[3]>=1,q=new et(t,h,L,this._getInvalidRendererVersion(),n.attributeInfo,{hasParametersFromSource:H,isOpaque:G},U),n.meta=q,!this._hasTextures&&i.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||p,this._hasTextures=this._hasTextures||!!t.resources.texture,this.notifyChange("hasTexturesOrVertexColors"),B=this.slicePlaneEnabled,e.abrupt("return",this._addOrUpdateEdgeRendering(q).then((function(e){return Object(O.k)(e)&&e.updateObjectVisibility(q.objectHandle,!1),z._safeReschedule((function(){var i=z._addTasks.get(t.index);if(i)if(Object(O.k)(z._labeler)&&z._addMetaToLabeler(z._labeler,q),z._addNodeMeta(t.index,q),i.meta=null,z.suspended)z._removeNodeStageData(t.index,z.elevationOffset);else{f.setObjectVisibility(L,1),Object(O.k)(e)&&e.updateObjectVisibility(q.objectHandle,!0),q.attributeInfo=i.attributeInfo;var r=q.cachedRendererVersion!==z._rendererVersion,n=B!==z.slicePlaneEnabled;z._setObjectSymbolColors(q);var a=z._applyFiltersToNode(q);(r||Object(O.k)(e)&&(n||a))&&z._addOrUpdateEdgeRendering(q),z._visibleGeometryChanged(q),z._highlights.objectCreated(q),z._updateMaterial(q),z._setNewNodeOpacity(q),Object(O.k)(z._treeDebugger)&&z._treeDebugger.update()}}),r)})).catch((function(e){throw Object(O.k)(n.meta)&&(z._deleteComponentObject(n.meta),n.meta=null),e})));case 23:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_addNodeMeta",value:function(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){Ze.error("Removing duplicated node");var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._deleteComponentObject(i)}Object(O.k)(t)&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&ft(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t)}},{key:"_safeReschedule",value:function(e,t){return Object(x.x)(t),this._controller.reschedule(e,t)}},{key:"_materialParameters",value:function(e,t){var i=e.params.material,r=t.some((function(e){return"uvRegion"===e.name})),n=t.some((function(e){return"normalCompressed"===e.name})),a=lt(i);return{geometryParams:this._getGeometryParameters({hasTexture:a,hasNormals:n,hasRegions:r}),material:i}}},{key:"_initMaterialAndTextures",value:function(e,t,i,r){var n,a=this,s=this._stage.renderView,o=i.map((function(e){return Object(Le.b)(e,t,r,s)})),c=Object(l.a)(o);try{for(c.s();!(n=c.n()).done;){var d=n.value;Object(O.k)(d)&&this._stage.add(d)}}catch(u){c.e(u)}finally{c.f()}return this._collection.updateMaterial(e,(function(e){Object(Le.a)(e,t,o,i,a.view._stage.renderView.textureRepository,{rendererTextureUsage:a.rendererTextureUsage,usePBR:a._usePBR(),isIntegratedMesh:a._isIntegratedMesh,slicePlaneEnabled:a.slicePlaneEnabled,viewSpatialReference:a.view.spatialReference}),a._updateMaterialOverlay(e)})),o}},{key:"_getGeometryParameters",value:function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}}},{key:"_addData",value:function(e,t,i){var r=this,n=this._addTasks.get(e.index);return n?n.attributeInfo=t:(n=Object(o.a)(Object(o.a)({},Object(x.h)()),{},{attributeInfo:t,meta:null}),this._addTasks.set(e.index,n),i().then(n.resolve,n.reject).then((function(){return r._addTasks.delete(e.index)})).catch((function(t){throw r._addTasks.delete(e.index),t}))),n.promise}},{key:"_clearAddTasks",value:function(){var e=this;this._addTasks.forEach((function(t){Object(O.k)(t.meta)&&(e._deleteComponentObject(t.meta),t.meta=null)})),this._addTasks.clear()}},{key:"_clippingAreaChanged",value:function(){var e=Object(L.h)();Object(Ke.a)(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)}},{key:"_geometryFilterChange",value:function(){this._controller.geometryFilterChanged(this.hasGeometryFilter)}},{key:"hasGeometryFilter",get:function(){return!1}},{key:"_filterChange",value:function(){this._applyFilters(!1)}},{key:"_applyFilters",value:function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){Object(O.k)(e)&&t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t._visibleGeometryChanged(e))}))}},{key:"getFilters",value:function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,i){return e._boundingboxFilter(t,i,e._clippingArea)})),t}},{key:"addSqlFilter",value:function(e,t,i){var r=this;if(Object(O.k)(t)){var n=t.fieldNames;e.push((function(e,a){return r._sqlFilter(e,a,t,n,i)}))}}},{key:"_sqlFilter",value:function(e,t,i,r,n){var a={},s=this._createLayerGraphic(a),o=this.i3slayer.objectIdField,c=t.featureIds,d=Object(O.k)(t.attributeInfo)&&t.attributeInfo.attributeData;r.every((function(e){return null!=d[e]||e===o}))&&Object(Ue.j)(e,c,(function(e){a[o]=c[e];var u,h=Object(l.a)(r);try{for(h.s();!(u=h.n()).done;){var f=u.value;f!==o&&(a[f]=Object(Ue.n)(d[f],e))}}catch(b){h.e(b)}finally{h.f()}try{return i.testFeature(s)}catch(t){return n(t),!1}}))}},{key:"_boundingboxNodeTest",value:function(e,t){return Object(V.p)(e.node.mbs,this._controller.crsIndex,ot,this.view.renderSpatialReference),Object(Ue.s)(t,ot)}},{key:"_boundingboxFeatureTest",value:function(e,t,i){return Object(L.v)(i,this._collection.getComponentAabb(e.objectHandle,t,it))}},{key:"_boundingboxFilter",value:function(e,t,i){var r=this,n=this._collection,a=this._boundingboxNodeTest(t,i);if(3!==a)if(0!==a){var s=n.getComponentCount(t.objectHandle);if(s.invisible+s.visible===t.featureIds.length){var o=this._transformAABB(rt,i,t.objectHandle);Object(Ue.j)(e,t.featureIds,(function(e){return r._boundingboxFeatureTest(t,e,o)}))}}else e.length=0}},{key:"_transformAABB",value:function(e,t,i){var r=this._collection.getObjectTransform(i),n=r.position,a=r.rotationScale;return e[0]=(t[0]-n[0])/a[0],e[1]=(t[1]-n[1])/a[4],e[2]=(t[2]-n[2])/a[8],e[3]=(t[3]-n[0])/a[0],e[4]=(t[4]-n[1])/a[4],e[5]=(t[5]-n[2])/a[8],e}},{key:"_addOrUpdateEdgeRendering",value:function(e){var t=this,i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Object(O.j)(this._edgeView))return Promise.resolve(null);var r=e.objectHandle,n=this._edgeView.hasObject(r),a=this._getFilteredEdgeMaterials(e),s=a.hasEdges,o=a.perFeatureEdgeMaterials,l={slicePlaneEnabled:this.slicePlaneEnabled};return s?n?(this.nodeCrossfadingEnabled&&ft(o,this.getNodeOpacity(e)),this._edgeView.updateAllComponentMaterials(r,o,l,i),this._edgeView.updateObjectVisibility(r,!0),Promise.resolve(this._edgeView)):this._collection.addEdges(r,this._edgeView,o,l).then((function(){return t._edgeView})):(n&&this._edgeView.removeObject(r),Promise.resolve(null))}},{key:"_removeEdgeRendering",value:function(e){Object(O.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)}},{key:"_applyFiltersToNode",value:function(e){return!!this._applyFiltersToNodeComponents(e)&&(Object(O.k)(this._labeler)&&this._labeler.applyFilterChange(e),!0)}},{key:"_applyFiltersToNodeComponents",value:function(e){var t=this._collection,i=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!i;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!i;var r=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,r),!0}},{key:"_updateCachedFilteredIds",value:function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}},{key:"_computeFilteredIds",value:function(e){var t,i=e.featureIds.slice(),r=Object(l.a)(this._filters);try{for(r.s();!(t=r.n()).done;){if((0,t.value)(i,e),0===i.length)break}}catch(n){r.e(n)}finally{r.f()}return i.length===e.featureIds.length?e.featureIds:i}},{key:"_computeFilteredComponentIndices",value:function(e){var t=new Array;return e.featureIds.forEach((function(i,r){e.filteredIds[t.length]===i&&t.push(r)})),t}},{key:"_removeAllNodeDataFromStage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._nodeId2Meta.forEach((function(i,r){return e._removeNodeStageData(r,t)})),this._nodeId2MetaReloading.forEach((function(i,r){return e._removeNodeStageData(r,t,e._nodeId2MetaReloading)}))}},{key:"removeNode",value:function(e){var t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading)}},{key:"_removeNodeStageData",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodeId2Meta,r=i.get(e);Object(O.j)(r)?i.delete(e):(this._collection.setObjectVisibility(r.objectHandle,0),this._visibleGeometryChanged(r),this._removeEdgeRendering(r),Object(O.k)(this._labeler)&&this._labeler.removeNodeMeta(r),i.delete(e),this._highlights.objectDeleted(r),i===this._nodeId2Meta?(this._cacheGPUData(r,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(r)):this._deleteComponentObject(r),Object(O.k)(this._treeDebugger)&&this._treeDebugger.update())}},{key:"_deleteComponentObject",value:function(e){if(Object(O.k)(this._edgeView)&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures){var t,i=Object(l.a)(e.textures);try{for(i.s();!(t=i.n()).done;){var r=t.value;this.memEstimateTextureRemoved(r),this._stage.remove(r)}}catch(n){i.e(n)}finally{i.f()}}}},{key:"updateNodeState",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._collection.updateMaterial(i.objectHandle,(function(e){return e.polygonOffsetEnabled=0===t}))}},{key:"_invalidateAllSymbols",value:function(){this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}},{key:"_getInvalidRendererVersion",value:function(){return Object(Ue.a)(this._rendererVersion,-1)}},{key:"_rendererChange",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var i,r,n,s,o,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._currentRenderer=t,this.notifyChange("rendererTextureUsage"),this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e.t0=t,!e.t0){e.next=12;break}return e.next=11,t.getRequiredFields(this.i3slayer.fieldsIndex);case 11:this._rendererFields=e.sent;case 12:if(this._updateSymbologyFields(),e.t1=!this._arcade&&t&&"arcadeRequired"in t&&t.arcadeRequired,!e.t1){e.next=18;break}return e.next=17,Object(B.e)();case 17:this._arcade=e.sent;case 18:if(!(t&&"visualVariables"in t&&t.visualVariables)){e.next=21;break}i=Object(l.a)(t.visualVariables);try{for(i.s();!(r=i.n()).done;)"color"===(n=r.value).type?this._colorVariable=n:"opacity"===n.type?this._opacityVariable=n:Ze.warn("Unsupported visual variable type for 3D Object Scene Services: ".concat(n.type))}catch(a){i.e(a)}finally{i.f()}case 21:if(t){s=Object(l.a)(t.getSymbols());try{for(s.s();!(o=s.n()).done;)"mesh-3d"!==(c=o.value).type&&Ze.error("Symbols of type '".concat(c.type,"' are not supported for 3D Object Scene Services."))}catch(a){s.e(a)}finally{s.f()}}this._controller&&this._controller.requestUpdate();case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getCachedEdgeMaterials",value:function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}},{key:"_getSymbolColors",value:function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,i){var r=5*e;Object(A.l)(i.externalColor,t[r+0]/255,t[r+1]/255,t[r+2]/255,t[r+3]/255),i.externalColorMixMode=15&t[r+4],i.castShadows=0!=(16&t[r+4]),i.pickable=0!=(32&t[r+4])}}},{key:"_getSymbolInfo",value:function(e,t){var i=e&&e.getSymbol(t,{arcade:this._arcade});if(!(i instanceof z.a))return null;var r=i.id;if(this._symbolInfos.has(r))return this._symbolInfos.get(r);var n=Object(Ue.q)(i);return this._symbolInfos.set(r,n),n}},{key:"_setSymbologyOverride",value:function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}},{key:"_updateSymbologyFields",value:function(){this._symbologyFields=Object(O.k)(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?Object(O.k)(this._rendererFields)&&this._rendererFields.length>0?Object(U.j)(this.i3slayer.fieldsIndex,[].concat(Object(r.a)(this._rendererFields),Object(r.a)(this._symbologyOverrideFields))):this._symbologyOverrideFields:this._rendererFields}},{key:"_updateCachedRendererData",value:function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,i={};t.attributes=i;var r=this._currentRenderer,n=Object(O.k)(e.attributeInfo)&&e.attributeInfo.attributeData,a=null!=e.featureIds?this.i3slayer.objectIdField:null,s=null!=n&&Object(O.k)(this._symbologyFields)&&this._symbologyFields.length>0,c=s?[]:null,d=s?[]:null;if(s&&Object(O.k)(this._symbologyFields)){var u,h=Object(l.a)(this._symbologyFields);try{for(h.s();!(u=h.n()).done;){var f=u.value,b=n[f];b&&(c.push(f),d.push(b))}}catch(D){h.e(D)}finally{h.f()}}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var v={color:at,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},y=this.fullOpacity,g=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):y,m=null,_=2,p=Ue.w,j=0,x=0;x<e.featureIds.length;x++){if(null!=a&&(i[a]=e.featureIds[x]),s)for(var k=0;k<c.length;k++)i[c[k]]=Object(Ue.n)(d[k],x);var I=this._getSymbolInfo(r,t),C=null,w=null;if(r&&"visualVariables"in r){if(this._colorVariable){var N=Object(q.getColor)(this._colorVariable,t,{color:st,arcade:this._arcade});N&&((C=at)[0]=N.r/255,C[1]=N.g/255,C[2]=N.b/255,this._opacityVariable||null===N.a||(w=N.a))}this._opacityVariable&&(w=Object(q.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(I&&I.material){var M=I.material;C=Object(O.j)(C)||Object(O.j)(w)?Object(ge.i)(C,w,M.color,M.alpha,$e,at):Object(ge.i)(C,w,null,null,$e,at)}if(Object(O.j)(C)&&((C=at)[0]=1,C[1]=1,C[2]=1,C[3]=1),v.pickable=!0,v.castShadows=!I||I.castShadows,v.colorMixMode=I&&I.material?I.material.colorMixMode:1,v.edgeMaterial=I?I.edgeMaterial:null,Object(O.k)(this._symbologyOverride)&&(v.color=C,this._symbologyOverride(t,v),C=v.color),Object(O.k)(v.edgeMaterial)){var S=C[3]<=0?0:C[3]>=1&&(e.material.isOpaque||3===v.colorMixMode)?2:1;v.edgeMaterial===m&&S===_||(p=Object(o.a)(Object(o.a)({},v.edgeMaterial),{},{opacity:g,objectTransparency:S}),m=v.edgeMaterial,_=S),e.cachedEdgeMaterials[x]=p}else e.cachedEdgeMaterials[x]=Ue.w;e.cachedSymbology[j+0]=Math.round(255*C[0]),e.cachedSymbology[j+1]=Math.round(255*C[1]),e.cachedSymbology[j+2]=Math.round(255*C[2]),e.cachedSymbology[j+3]=Math.round(255*C[3]),e.cachedSymbology[j+4]=v.colorMixMode|+v.castShadows<<4|+v.pickable<<5,j+=5}}}},{key:"_getFilteredEdgeMaterials",value:function(e){var t=this._getCachedEdgeMaterials(e);if(this.nodeCrossfadingEnabled||ft(t,this.fullOpacity),Object(O.j)(e.filteredIds))return{hasEdges:t.some((function(e){return e!==Ue.w})),perFeatureEdgeMaterials:t};var i=0,r=!1,n=t.map((function(t,n){return e.featureIds[n]!==e.filteredIds[i]?Ue.w:(r=r||t!==Ue.w,i++,t)}));return{hasEdges:r,perFeatureEdgeMaterials:n}}},{key:"_setObjectSymbolColors",value:function(e){if(this._hasSymbolColors){var t=e.objectHandle,i=this._getSymbolColors(e);this._collection.setComponentData(t,i),this._stage.renderView.setNeedsRender()}}},{key:"_reloadAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}},{key:"_opacityChange",value:function(e){var t=this;this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((function(i){Object(O.j)(i)||(t._collection.updateMaterial(i.objectHandle,(function(t){return t.objectOpacity=e})),ft(i.cachedEdgeMaterials,e),t._updateEdgeRendering(i))}))}},{key:"_updateMaterial",value:function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(e){e.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,e.usePBR=t._usePBR(),t._updateMaterialOverlay(e)}))}},{key:"_updateMaterialOverlay",value:function(e){}},{key:"_updateEngineObject",value:function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e)}},{key:"_slicePlaneEnabledChange",value:function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),Object(O.k)(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(i){Object(O.j)(i)||(t._collection.updateMaterial(i.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(i,!1))}))}},{key:"_updatePBR",value:function(){var e=this;this._nodeId2Meta.forEach((function(t){Object(O.j)(t)||e._collection.updateMaterial(t.objectHandle,(function(t){t.usePBR=e._usePBR()}))})),this._hasLoadedPBRTextures=!0}},{key:"_usePBR",value:function(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}},{key:"_updateEdgeRendering",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object(O.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}},{key:"_forAllNodes",value:function(e){this._nodeId2Meta.forEach(e)}},{key:"_forAllFeatures",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(p.c)(this._nodeId2Meta,(function(n){if(Object(O.j)(n))return!1;if(Object(O.k)(t))switch(t(n)){case 0:return!0;case 2:return!1}var a=1;switch(r){case 1:a=i._forAllFeaturesOfNode(n,e);break;case 0:a=i._forVisibleFeaturesOfNode(n,e);break;case 2:a=i._forAllFeaturesOfNodeInClippingArea(n,e)}return 0===a}))}},{key:"_forAllFeaturesOfNode",value:function(e,t){for(var i=1,r=e.featureIds,n=0;n<r.length;n++)if(0===(i=t(r[n],n,e)))return i;return i}},{key:"_forVisibleFeaturesOfNode",value:function(e,t){var i=1,r=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(n){return 1===(i=t(r[n],n,e))})),i}},{key:"_forAllFeaturesOfNodeInClippingArea",value:function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var i=this._boundingboxNodeTest(e,this._clippingArea);if(0===i)return 1;if(3===i)return this._forAllFeaturesOfNode(e,t);for(var r=e.featureIds,n=e.objectHandle,a=Object(Ue.o)(this._clippingArea,this._collection.getObjectTransform(n)),s=0;s<r.length;s++)if(this._boundingboxFeatureTest(e,s,a)){var o=t(r[s],s,e);if(0===o)return o}return 1}},{key:"_createAttributes",value:function(e,t){var i={};null!=t.featureIds&&(i[this._getObjectIdField()]=t.featureIds[e]);var r=Object(O.k)(t.attributeInfo)&&t.attributeInfo.attributeData;if(Object(O.k)(r))for(var n=0,a=Object.keys(r);n<a.length;n++){var s=a[n];i[s]=Object(Ue.n)(r[s],e)}return i}},{key:"_createGraphic",value:function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}},{key:"highlight",value:function(e){var t=this._highlights;if("number"==typeof e||e instanceof y.a?e=[e]:e instanceof g.a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y.a){var i=e,r=this.i3slayer.fieldsIndex,n=this._getObjectIdField(),a=i.map((function(e){return Object(ze.a)(r,e.attributes,n)})),s=t.acquireSet(),o=s.set,l=s.handle;return t.setFeatureIds(o,a),l}if("number"==typeof e[0]){var c=e,d=t.acquireSet(),u=d.set,h=d.handle;return t.setFeatureIds(u,c),h}}return ht}},{key:"_visibleGeometryChanged",value:function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=Object(k.b)((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))}},{key:"performanceInfo",get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};return Object(O.k)(this._memCache)&&(e.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e}},{key:"test",get:function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}}},{key:"getNodeOpacityByIndex",value:function(e){var t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}},{key:"getNodeOpacity",value:function(e){return Object(O.k)(e)?this._collection.getMaterial(e.objectHandle).objectOpacity:0}},{key:"isNodeFullyFadedIn",value:function(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}},{key:"getNodeCrossfadeMetaData",value:function(e){return this._nodeId2Meta.get(e)}},{key:"markNodeToRemove",value:function(e){this._controller&&this._controller.markNodeToRemove(e)}},{key:"removeMarkedNodes",value:function(){this._controller&&this._controller.removeMarkedNodes()}},{key:"foreachCrossfadeNode",value:function(e){this._nodeId2Meta.forEach((function(t,i){return e(i,t)}))}},{key:"fadeNode",value:function(e,t,i){if(this.nodeCrossfadingEnabled){var r=this._nodeId2Meta.get(e);Object(O.k)(r)&&this._crossfadeHelper.fadeNode(e,r,t,i)}}},{key:"setNodeOpacityByIndex",value:function(e,t){var i=this._nodeId2Meta.get(e);Object(O.k)(i)&&this._setNodeOpacity(i,t)}},{key:"_setNodeOpacity",value:function(e,t){this._collection.updateMaterial(e.objectHandle,(function(e){return e.objectOpacity=t})),this._setNodeEdgeOpacity(e,t)}},{key:"_setNodeEdgeOpacity",value:function(e,t){if(Object(O.k)(this._edgeView)&&e.cachedEdgeMaterials){ft(e.cachedEdgeMaterials,t);var i=e.objectHandle;this._edgeView.hasObject(i)&&this._edgeView.updateAllComponentOpacities(i,t)}}},{key:"_hasModifications",get:function(){return this._modifications&&this._modifications.length>0}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=e.length;if(this._hasModifications&&!(i<=0)&&!0===this._i3sWasmLoaded){var r=this.i3slayer.uid,n=function(e){if(0===e.length)return null;var t=10*e.length,i=new Float64Array(t);return e.forAll((function(e,t){var r=e.serviceObb;Object(O.j)(r)&&(r=nt,Object(E.m)(r.center,e.mbs),r.halfSize[0]=r.halfSize[1]=r.halfSize[2]=e.mbs[3]);var n=10*t;i[n+0]=r.center[0],i[n+1]=r.center[1],i[n+2]=r.center[2],i[n+3]=r.halfSize[0],i[n+4]=r.halfSize[1],i[n+5]=r.halfSize[2],i[n+6]=r.quaternion[0],i[n+7]=r.quaternion[1],i[n+8]=r.quaternion[2],i[n+9]=r.quaternion[3]})),i}(e);if(Object(O.k)(n)){var a={context:r,buffer:n.buffer};Object(ye.filterObbsForModificationsSync)(a);var s=new Float64Array(n.buffer);e.forAll((function(e,i){var r=s[i],n=Object(ye.interpretObbModificationResults)(r);e.imModificationImpact=n,0!==n&&t._controller.invalidateGeometryVisibility(e.index)}))}}}},{key:"notifyUpdate",value:function(){this.notifyChange("updating")}},{key:"notifyLODUpdate",value:function(){this._controller.notifyLODUpdate()}},{key:"isUpdating",value:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||Object(O.k)(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0}}]),n}(e);return Object(b.a)([Object(N.b)()],t.prototype,"_hasLoadedPBRTextures",void 0),Object(b.a)([Object(N.b)()],t.prototype,"_asyncModuleLoading",void 0),Object(b.a)([Object(N.b)()],t.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),Object(b.a)([Object(N.b)()],t.prototype,"view",void 0),Object(b.a)([Object(N.b)()],t.prototype,"i3slayer",void 0),Object(b.a)([Object(N.b)()],t.prototype,"_controller",void 0),Object(b.a)([Object(N.b)()],t.prototype,"_labeler",void 0),Object(b.a)([Object(N.b)()],t.prototype,"updating",void 0),Object(b.a)([Object(N.b)()],t.prototype,"suspended",void 0),Object(b.a)([Object(N.b)()],t.prototype,"holeFilling",void 0),Object(b.a)([Object(N.b)(Ye.a)],t.prototype,"updatingProgress",void 0),Object(b.a)([Object(N.b)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),Object(b.a)([Object(N.b)({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),Object(b.a)([Object(N.b)({readOnly:!0})],t.prototype,"rendererTextureUsage",null),Object(b.a)([Object(N.b)({readOnly:!0})],t.prototype,"elevationOffset",null),Object(b.a)([Object(N.b)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(N.b)()],t.prototype,"supportedTextureEncodings",null),Object(b.a)([Object(N.b)()],t.prototype,"uncompressedTextureDownsamplingEnabled",null),Object(b.a)([Object(N.b)({type:[G.a]})],t.prototype,"_modifications",void 0),t=Object(b.a)([Object(M.a)("esri.views.3d.layers.I3SMeshView3D")],t)},it=Object(L.h)(),rt=Object(L.h)(),nt=Object(Ee.e)(),at=[0,0,0,0],st=new v.a([0,0,0,0]),ot=[0,0,0,0];function lt(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function ct(e){return Object(O.k)(e)&&Object(I.c)(e.data)}function dt(e,t){var i=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(Object(O.k)(t)){var r,n=Object(l.a)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;Object(O.k)(a)&&Object(I.c)(a.data)&&(i+=a.data.byteLength)}}catch(s){n.e(s)}finally{n.f()}}return i}function ut(e,t){return t.byteSize>104857600?(Ze.warn("Node is too big to store in IndexedDB cache: ".concat(e.id," (").concat(t.byteSize," bytes)")),!1):t.byteSize>0}var ht={remove:function(){},pause:function(){},resume:function(){}};function ft(e,t){e.forEach((function(e){return e.opacity=t}))}}}]);
//# sourceMappingURL=50.eab0da97.chunk.js.map