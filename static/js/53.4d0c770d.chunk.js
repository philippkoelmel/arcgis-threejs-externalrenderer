(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[53],{1212:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return I}));var i,n=r(2),a=r(3),s=r(6),u=r(7),o=r(0),c=r(24),l=r(1),h=(r(17),r(18),r(16),r(12)),d=r(14),f=(r(140),r(146)),p=r(34),y=r(213),v=r(4),b=r(268),m=r(954),g=r(999),O=r(829),j=r(271),k=i=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){return Object(n.a)(this,r),t.apply(this,arguments)}return Object(a.a)(r,[{key:"getObjectId",value:function(){return this.objectId}},{key:"clone",value:function(){return new i(Object(d.a)({objectId:this.objectId},this.cloneProperties()))}}]),r}(f.a);Object(o.a)([Object(l.b)({type:Number,json:{read:!0}})],k.prototype,"objectId",void 0),k=i=Object(o.a)([Object(h.a)("esri.layers.graphics.controllers.StreamGraphic")],k);var F=function(){function e(t){Object(n.a)(this,e),this.onUpdate=t,this._idToGraphic=new Map}return Object(a.a)(e,[{key:"destroy",value:function(){this._idToGraphic.clear()}},{key:"add",value:function(e){this._idToGraphic.set(e.objectId,e)}},{key:"get",value:function(e){return this._idToGraphic.get(e)}},{key:"forEach",value:function(e){this._idToGraphic.forEach(e)}},{key:"removeById",value:function(e){var t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=null,this._idToGraphic.delete(e),t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._idToGraphic.size}}]),e}(),_=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(n.a)(this,r),(e=t.apply(this,arguments))._updateInfo={websocket:0,client:0},e.graphics=new O.a,e}return Object(a.a)(r,[{key:"initialize",value:function(){var e=this;this.addResolvingPromise(this.layer.when((function(){return e._startup()})))}},{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0),this.connection&&(this.connection.destroy(),this.connection=null),this.store&&(this.store.destroy(),this.store=null),this.graphics.clear(),this.handles.removeAll()}},{key:"updating",get:function(){return!this.connection||"connected"===this.connection.connectionStatus}},{key:"_startup",value:function(){var e=this,t=this.layer,r=t.parsedUrl,i=t.spatialReference,n=t.definitionExpression,a=t.geometryDefinition,s=t.objectIdField,u=t.timeInfo,o=t.purgeOptions,c=t.maxReconnectionAttempts,l=t.maxReconnectionInterval,h=t.updateInterval,d=j.a.toJSON(this.layer.geometryType),f=i,p=this.layerView.view.spatialReference,y={geometry:a,where:n};this.clear(),this._set("connection",Object(g.a)(r,f,p,d,y,c,l)),this._outSpatialReference=p.toJSON(),this.store=new F(this._onUpdate.bind(this)),this.featuresManager=new m.a(this.store,s,u.toJSON(),o),this.handles.add([this.connection.on("feature",(function(t){return e._onFeature(t)})),this.layer.watch("definitionExpression",(function(){return e._startup()})),this.layer.watch("geometryDefinition",(function(){return e._startup()})),this.layer.watch("purgeOptions",(function(){return e._startup()}))]);var v=performance.now();this._updateIntervalId=setInterval((function(){var t=performance.now(),r=t-v;if(r>2500){v=t;var i=Math.round(e._updateInfo.client/(r/1e3)),n=Math.round(e._updateInfo.websocket/(r/1e3));e._updateInfo.client=0,e._updateInfo.websocket=0,e.layerView.emit("update-rate",{client:i,websocket:n})}e.featuresManager.checkForUpdates()}),h)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{Object(v.k)(e.geometry)&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._outSpatialReference);var t=k.fromJSON(e);t.sourceLayer=t.layer=this.layer,this.featuresManager.add(t)}catch(r){}}},{key:"_onUpdate",value:function(e,t){Object(v.k)(t)&&this.graphics.removeMany(t),Object(v.k)(e)&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}}]),r}(Object(y.b)(Object(b.b)(p.a)));Object(o.a)([Object(l.b)()],_.prototype,"connection",void 0),Object(o.a)([Object(l.b)()],_.prototype,"layer",void 0),Object(o.a)([Object(l.b)()],_.prototype,"layerView",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],_.prototype,"updating",null);var x=_=Object(o.a)([Object(h.a)("esri.layers.graphics.controllers.StreamController")],_),w=r(171),T=r(828),E=r(631),C=r(630),S=r(808),R=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(n.a)(this,r),(e=t.apply(this,arguments)).type="stream-3d",e.updatePolicy=0,e.hasZ=!0,e.hasM=!1,e}return Object(a.a)(r,[{key:"connectionError",get:function(){var e=this.get("controller.connection.errorString");if(e)return new c.a("stream-controller",e)}},{key:"createQuery",value:function(){return new w.a({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}},{key:"queryLatestObservations",value:function(e,t){return this.queryEngine.executeQueryForLatestObservations(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"createController",value:function(){return new x({layer:this.layer,layerView:this})}},{key:"beforeSetController",value:function(){}}]),r}(function(e){var t=function(e){Object(s.a)(r,e);var t=Object(u.a)(r);function r(){var e;Object(n.a)(this,r);for(var i=arguments.length,a=new Array(i),s=0;s<i;s++)a[s]=arguments[s];return(e=t.call.apply(t,[this].concat(a))).connectionError=null,e.connectionStatus="disconnected",e.filter=null,e}return r}(e);return Object(o.a)([Object(l.b)({readOnly:!0})],t.prototype,"connectionError",void 0),Object(o.a)([Object(l.b)({aliasOf:"controller.connection.connectionStatus",readOnly:!0})],t.prototype,"connectionStatus",void 0),Object(o.a)([Object(l.b)({type:S.a})],t.prototype,"filter",void 0),t=Object(o.a)([Object(h.a)("esri.layers.mixins.StreamLayerView")],t)}(Object(T.a)(Object(E.a)(C.a))));Object(o.a)([Object(l.b)({readOnly:!0})],R.prototype,"updatePolicy",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],R.prototype,"connectionError",null),Object(o.a)([Object(l.b)()],R.prototype,"controller",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],R.prototype,"hasZ",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],R.prototype,"hasM",void 0);var I=R=Object(o.a)([Object(h.a)("esri.views.3d.layers.StreamLayerView3D")],R)},811:function(e,t,r){"use strict";r.d(t,"a",(function(){return N})),r.d(t,"b",(function(){return A}));var i=r(11),n=r(8),a=r.n(n),s=r(15),u=r(2),o=r(3),c=r(6),l=r(7),h=r(0),d=r(34),f=r(61),p=r(16),y=r(127),v=r(4),b=r(25),m=r(154),g=r(36),O=r(1),j=(r(17),r(18),r(12)),k=r(43),F=r(204),_=r(642),x=r(171),w=r(646),T=function(){function e(t,r){Object(u.a)(this,e),this.highestResolutionVersion=null,this.versions=[],this.ref(t,r)}return Object(o.a)(e,[{key:"isReferenced",get:function(){return 0!==this.versions.length}},{key:"isSingle",get:function(){return 1===this.versions.length&&1===this.versions[0].refCount}},{key:"ref",value:function(e,t){var r=this.feature;C.oldVersion=r,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});var n,a=Object(i.a)(this.versions);try{for(a.s();!(n=a.n()).done;){var s=n.value;if(s.resolution===t){s.refCount++;var u=this.highestResolutionVersion===s&&!Object(w.a)(e,s.feature);return(u||this.highestResolutionVersion!==s)&&(s.feature=e),C.newVersion=u?e:r,C}}}catch(c){a.e(c)}finally{a.f()}var o={feature:e,resolution:t,refCount:1};return this.versions.push(o),!this.highestResolutionVersion||t<this.highestResolutionVersion.resolution?(C.newVersion=e,this.highestResolutionVersion=o):C.newVersion=r,C}},{key:"unref",value:function(e){for(var t=0;t<this.versions.length;t++){var r=this.versions[t];if(r.resolution===e)return r.refCount--,C.oldVersion=this.feature,0===r.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===r&&(this.recalculateHighestResolutionVersion(),C.oldVersion=r.feature)),C.newVersion=this.feature,C}return null}},{key:"feature",get:function(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}},{key:"recalculateHighestResolutionVersion",value:function(){if(0!==this.versions.length){for(var e=this.versions[0],t=1;t<this.versions.length;t++){var r=this.versions[t];r.resolution<e.resolution&&(e=r)}this.highestResolutionVersion=e}else this.highestResolutionVersion=null}}]),e}(),E=function(){function e(t){Object(u.a)(this,e),this._feature=t,this.refCount=1}return Object(o.a)(e,[{key:"isReferenced",get:function(){return 0!==this.refCount}},{key:"isSingle",get:function(){return 1===this.refCount}},{key:"ref",value:function(e){return++this.refCount,C.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),Object(w.a)(this._feature,e)||(this._feature=e),C.newVersion=this._feature,C}},{key:"unref",value:function(){return C.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(C.newVersion=null,C):(C.newVersion=this._feature,C)}},{key:"feature",get:function(){return this._feature}}]),e}(),C={oldVersion:null,newVersion:null},S=r(115),R=new Set,I=function(){function e(t){Object(u.a)(this,e),this.descriptor=t,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=D,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=R,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}return Object(o.a)(e,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"setFeatures",value:function(e,t,r){this._availableFields=Object(v.u)(r,R),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+Object(F.k)(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>D}},{key:"needsFeatureCount",get:function(){return this._numFeatures===D}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"updateMemoryEstimates",value:function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=Object(F.e)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(var r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=Object(F.e)(this._features[r]);return!0}return!1}},{key:"isFetching",get:function(){return 2===this.fetchStatus||3===this.fetchStatus}},{key:"isRefetching",get:function(){return 3===this.fetchStatus}},{key:"needsFetching",get:function(){return 0===this.fetchStatus||1===this.fetchStatus}},{key:"needsRefetching",get:function(){return 1===this.fetchStatus}},{key:"isFetched",get:function(){return 4===this.fetchStatus||5===this.fetchStatus}},{key:"resetFetching",value:function(){this.fetchStatus=3===this.fetchStatus?1:0}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!function(e,t,r){if(Object(v.j)(t)||Object(v.j)(e)||r!==t.length||r>e.length)return!1;for(var i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}},{key:"intersects",value:function(e){return!e||!this.descriptor.extent||(Object(k.s)(e,M),Object(k.w)(this.descriptor.extent,M))}},{key:"intersectionIncludingBorrowed",value:function(e,t){var r=Object(v.k)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?(e?(Object(k.s)(e,t),Object(k.v)(t,r,t)):Object(k.k)(t,r),t):(Object(k.k)(t,k.b),t)}},{key:"_shuffle",value:function(e){this._features.sort((function(t,r){return Object(F.g)(t,e)-Object(F.g)(r,e)})),Object(S.m)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}},{key:"reduceFeatures",value:function(e,t,r){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;var i=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,i=!0)),!this._shuffled&&e<1&&this._shuffle(r);var n=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>n&&(this._features.length=n,this.featuresMissing=!0,5===this.fetchStatus&&(this.fetchStatus=4)),i}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),e}(),D=-1;var M=Object(k.l)(),V=r(152),U=r(103),P=p.a.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D"),N=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var i;return Object(u.a)(this,r),(i=t.call(this,e))._useTileCount=!1,i.updating=!1,i.updatingTotal=0,i.updatingRemaining=0,i.expectedFeatureDiff=0,i.maximumNumberOfFeaturesExceeded=!1,i.maximumNumberOfFeaturesExceededThrottle=1e3,i._fullRatio=1,i._farRatio=1,i.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},i.handles=new f.a,i._frameTask=U.a,i._dirty=!1,i.featureTiles=new Map,i.displayingFeatureReferences=new Map,i.numDisplayingFeatureReferences=0,i.suspended=!0,i.pendingEdits=null,i}return Object(o.a)(r,[{key:"maximumNumberOfFeatures",set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))}},{key:"memoryFactor",set:function(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this.setDirty())}},{key:"lodFactor",set:function(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&Object(v.k)(this.context.query.queryFeatureCount)},set:function(e){this._useTileCount=e,this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.estimatedUnusedSize})),e}},{key:"totalVertices",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.numVertices})),e}},{key:"totalFeatures",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.numFeatures})),e}},{key:"filterExtent",set:function(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))P.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");else{var t=this._get("filterExtent");if(!(t===e||t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("filterExtent",r),this.reclip(r,t)}}}},{key:"initialize",value:function(){var e=this;this.handles.add(Object(g.b)(this,"tileDescriptors","change",(function(){return e.setDirty()}),(function(){return e.setDirty()}))),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?T:E;var t=this.context.scheduler;Object(v.k)(t)&&(this._frameTask=t.registerTask(U.b.FEATURE_TILE_FETCHER,this)),this.setDirty()}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this.handles=Object(v.e)(this.handles),this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.removeTile(t)})),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}},{key:"paused",get:function(){return this.suspended||!!this.pendingEdits}},{key:"restart",value:function(){var e=this;this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.clearTile(t),e.resetFetchTile(t)})),Object(v.k)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}},{key:"refetch",value:function(){var e=this;this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.resetFetchTile(t)})),Object(v.k)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}},{key:"suspend",value:function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())}},{key:"resume",value:function(){this.suspended&&(this.suspended=!1,this.unpause())}},{key:"pause",value:function(){var e=this;this.paused&&(this.featureTiles.forEach((function(t){return e.cancelFetchTile(t)})),this.updated())}},{key:"unpause",value:function(){this.paused||(this.setDirty(),this.updated())}},{key:"availableFields",get:function(){var e=null;return this.featureTiles.forEach((function(t){Object(v.j)(t.displayingFeatures)||0===t.displayingFeatures.length||(Object(v.j)(e)?e=new Set(t.availableFields):e.forEach((function(r){t.availableFields.has(r)||Object(v.t)(e).delete(r)})))})),Object(v.k)(e)?e:new Set}},{key:"applyEdits",value:function(e){var t=this;this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:Object(b.e)()},this.pause());var r=this.pendingEdits;r.count++;var i=r.edits.then((function(){return e.result.catch((function(e){if(Object(b.n)(e))throw e;return null})).then((function(e){return e?(t.applyEditsDeleteFeatures(e.deletedFeatures),t.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,r.controller.signal).then((function(){return e}))):e})).then((function(e){return 0==--r.count&&(t.pendingEdits===r&&(t.pendingEdits=null),Object(v.k)(t.context.memoryCache)&&t.context.memoryCache.clear(),t.unpause(),t.updated()),e}))}));return r.edits=i,this.updated(),i}},{key:"applyEditsDeleteFeatures",value:function(e){var t=this;if(0!==e.length){var r=this.context.globalIdField,i=r&&this.availableFields.has(r),n=new Set,a=this.objectIdField;e.forEach((function(e){var s=e.objectId,u=e.globalId;if((!s||s<0)&&r){i||P.errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(r," to be included the layer's outFields for updates to be reflected in the view"));var o=t.features.find((function(e){return e.attributes&&e.attributes[r]===u}));o&&n.add(Object(F.g)(o,a))}else n.add(s)})),this.featureTiles.forEach((function(e){if(e.features){var r=e.features.filter((function(e){return!n.has(Object(F.g)(e,t.objectIdField))}));r.length!==e.features.length&&(e.setFeatures(r,0,e.availableFields),t.invalidateCounts())}}))}}},{key:"applyEditsAddUpdateFeatures",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,u,o=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=[],s=new Set,t.forEach((function(e){return n.push(e.objectId)})),r.forEach((function(e){n.push(e.objectId),s.add(e.objectId)})),0!==n.length){e.next=3;break}return e.abrupt("return");case 3:return u=[],this.featureTiles.forEach((function(e){var t=o.applyEditsAddUpdateTile(e,n,s,i);t&&u.push(t)})),e.next=7,Object(b.k)(u);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"applyEditsAddUpdateTile",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,n,s){var u,o,c,l,h,d,f,p=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.features){e.next=2;break}return e.abrupt("return");case 2:return(u=this.createQuery(t)).resultType=void 0,u.cacheHint=!1,u.objectIds=r,e.next=6,this.queryFeatures(u,s);case 6:if(o=e.sent,c=null,n.size>0&&(l=t.features.filter((function(e){return!n.has(Object(F.g)(e,p.objectIdField))}))).length!==t.features.length&&(c=l),o.features.length>0){c||(c=t.features.slice()),h=Object(i.a)(o.features);try{for(h.s();!(d=h.n()).done;)f=d.value,c.push(f)}catch(a){h.e(a)}finally{h.f()}}c&&(t.hasPreciseFeatureCount&&(t.numFeatures=Math.max(t.numFeatures,c.length)),t.setFeatures(c,0,Q(t.availableFields,o.fields)),this.invalidateCounts());case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:J})}},{key:"setDirty",value:function(){this._dirty=!0,this.updated()}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=this;if(this._frameTask.processQueue(e),this._dirty&&this.constructed){this._dirty=!1;var r=this.getListOfTiles();if(this.markTilesNotAlive(r),e.run((function(){return t.addTiles(r,e)}))&&e.run((function(){return t.filterExtentTiles(r,e)}))&&e.run((function(){return t.removeTiles(r,e)}))&&!e.done){var i=this.sortTiles(r);e.run((function(){return t.displayTiles(i,e)}))&&e.run((function(){return t.fetchTiles(i,e)}))&&e.run((function(){return t.updateMemoryEstimates(i,e)}))||this.setDirty(),this.updated(),this.updating||this.updateMaximumNumberOfFeaturesExceeded()}else this.setDirty()}}},{key:"markTilesNotAlive",value:function(e){var t,r=Object(i.a)(e);try{for(r.s();!(t=r.n()).done;){t.value.alive=!1}}catch(n){r.e(n)}finally{r.f()}}},{key:"addTiles",value:function(e,t){var r=this;return!this.suspended&&(this.tileDescriptors.forEach((function(i){var n=r.featureTiles.get(i.id);n?n.alive=!0:t.done||(e.push(r.addTile(i)),t.madeProgress())})),t.hasProgressed)}},{key:"filterExtentTiles",value:function(e,t){var r,n=Object(i.a)(e);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(t.done)break;a.alive&&(a.filtered=!a.intersects(this.filterExtent),a.filtered&&(this.clearTile(a),t.madeProgress()))}}catch(s){n.e(s)}finally{n.f()}return t.hasProgressed}},{key:"removeTiles",value:function(e,t){for(var r=e.length-1;r>=0&&!t.done;r--){var i=e[r];i.alive||(this.removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}},{key:"sortTiles",value:function(e){return e.sort((function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority})),e}},{key:"displayTiles",value:function(e,t){var r,n=this,a=this.updateRatio(e),s=Object(i.a)(e);try{var u=function(){var e=r.value;if(!t.run((function(){return function(e){var t=n._fullRatio<1?a(e)*n._farRatio:1;return e.reduceFeatures(t,n.memoryFactor,n.objectIdField)&&n.setDirty(),n.showTile(e)}(e)})))return n.setDirty(),"break"};for(s.s();!(r=s.n()).done;){if("break"===u())break}}catch(o){s.e(o)}finally{s.f()}return t.hasProgressed}},{key:"fetchTiles",value:function(e,t){var r=this;if(this.paused)return!1;var n,a=!1,s=Object(i.a)(e);try{var u=function(){var e=n.value;if(!e.needsFetching)return"continue";var i=Object(v.k)(r.context.memoryCache)?r.context.memoryCache.pop(e.id):null;if(Object(v.k)(i))e.cache=i,r.setDirty(),r.scheduleUpdated(),t.madeProgress();else{if(r.needsNumFeatures(e)){var s=Object(b.e)(),u=r.fetchTileCount(e,s.signal);r._handleRequest(e,u,s,(function(){return e.numFeatures=-2})),a=!0,t.madeProgress()}if(t.done)return{v:!0}}};for(s.s();!(n=s.n()).done;){var o=u();if("continue"!==o&&"object"===typeof o)return o.v}}catch(f){s.e(f)}finally{s.f()}if(a)return t.hasProgressed;var c,l=Object(i.a)(e);try{var h=function(){var e=c.value;if(e.needsFetching){var i=Object(b.e)(),n=r.fetchTile(e,i.signal);if(r._handleRequest(e,n,i,(function(t){e.setFeatures([],0,null),r.invalidateCounts(),e.featuresMissing=!1,r.context.logFetchError(P,t)})),t.madeProgress(),t.done)return{v:!0}}};for(l.s();!(c=l.n()).done;){var d=h();if("object"===typeof d)return d.v}}catch(f){l.e(f)}finally{l.f()}return t.hasProgressed}},{key:"updateMemoryEstimates",value:function(e,t){var r=this;return e.some((function(e){return!t.run((function(){return e.updateMemoryEstimates()}))&&(r.setDirty(),!0)})),t.hasProgressed}},{key:"reclip",value:function(e,t){if(this.constructed){var r=new Array;this.featureTiles.forEach((function(i){Object(v.j)(i.displayingFeatures)||0===i.displayingFeatures.length||(i.intersectionIncludingBorrowed(t,H),i.intersectionIncludingBorrowed(e,W),Object(k.o)(H,W)||r.push(i))})),this.refreshDisplayingFeatures(r),this.updated()}}},{key:"refreshDisplayingFeatures",value:function(e){var t,r=new Set,n=this.changes.updates,a=Object(i.a)(e);try{for(a.s();!(t=a.n()).done;){var s=t.value;if(!Object(v.j)(s.displayingFeatures)){var u,o=Object(i.a)(s.displayingFeatures);try{for(o.s();!(u=o.n()).done;){var c=u.value,l=Object(F.g)(c,this.objectIdField);if(!r.has(l)){r.add(l);var h=this.displayingFeatureReferences.get(l).feature;n.removes.push(h),n.adds.push(h)}}}catch(d){o.e(d)}finally{o.f()}}}}catch(d){a.e(d)}finally{a.f()}this.applyChanges()}},{key:"updated",value:function(){var e=this,t=0;this.paused||this.featureTiles.forEach((function(e){return e.isFetching?++t:0}));var r=this._dirty||t>0||!!this.pendingEdits;if(this._set("updating",r),r){var i=0,n=0,a=0,s=0,u=0,o=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach((function(t){if(++n,t.isFetching&&t.hasPreciseFeatureCount){var r=e.maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),c=Object(v.k)(t.displayingFeatures)?t.displayingFeatures.length*o:0;u+=r-c}t.needsFetching?++s:t.numFeatures>0&&(++a,i+=t.numFeatures)})),s+=t;var c=0,l=0;i?(l=i,c=Math.min(s*i/a,i)):(l=n,c=s),u=Math.min(this.maximumNumberOfFeatures-this.features.length,u),this._set("updatingTotal",l),this._set("updatingRemaining",c),this._set("expectedFeatureDiff",u)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}},{key:"updateMaximumNumberOfFeaturesExceeded",value:function(){var e=Object(y.c)(this.featureTiles,(function(e){return e.perTileMaximumNumberOfFeaturesExceeded}));this._set("maximumNumberOfFeaturesExceeded",e)}},{key:"updateRatio",value:function(e){var t,r=function(e){var t,r=0,n=Object(i.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.features&&a.features.length>0&&a.alive&&(r=Math.max(r,a.descriptor.lij[0]))}}catch(s){n.e(s)}finally{n.f()}return r}(e),n=function(e){return 1/(1<<Math.max(0,r-e.descriptor.lij[0]))},a=0,s=0,u=Object(i.a)(e);try{for(u.s();!(t=u.n()).done;){var o=t.value,c=o.numFeatures;a+=c,s+=c*n(o)}}catch(l){u.e(l)}finally{u.f()}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/a),this._farRatio=this.maximumNumberOfFeatures/s,this.scheduleUpdated(),n}},{key:"maximumFeaturesUpdated",value:function(e,t){var r=this;e!==t&&(t>e&&this.featureTiles.forEach((function(e){if(e.featuresMissing){var t=r.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(r.cancelFetchTile(e),r.resetFetchTile(e))}})),this.setDirty())}},{key:"addTile",value:function(e){var t=new I(e);return this.featureTiles.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t}},{key:"referenceDisplayingFeaturesFromRelatedTiles",value:function(e){var t=this,r=e.descriptor.resolution;this.featureTiles.forEach((function(n){if(!(Object(v.j)(n.displayingFeatures)||e===n||e.descriptor.lij&&n.descriptor.lij&&!Object(V.j)(e.descriptor.lij,n.descriptor.lij))){Object(v.j)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&n.descriptor.extent&&(Object(v.j)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=Object(k.f)(e.descriptor.extent)),Object(k.p)(e.extentIncludingBorrowedFeatures,n.descriptor.extent,e.extentIncludingBorrowedFeatures));var a,s=Object(i.a)(n.displayingFeatures);try{for(s.s();!(a=s.n()).done;){var u=a.value;e.displayingFeatures.push(u);var o=t.displayingFeatureReferences.get(Object(F.g)(u,t.objectIdField));o.ref(o.feature,r),t.numDisplayingFeatureReferences++}}catch(c){s.e(c)}finally{s.f()}}})),e.featureLimit=Object(v.k)(e.displayingFeatures)?e.displayingFeatures.length:0}},{key:"removeTile",value:function(e){this.clearTile(e),this.featureTiles.delete(e.id)}},{key:"resetFetchTile",value:function(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=4):e.fetchStatus=0}},{key:"cancelFetchTile",value:function(e){var t=e.requestController;Object(v.k)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}},{key:"fetchTileCount",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.fetchCount(t,r);case 2:return t.numFeatures=e.sent,this.updateRatio(this.getListOfTiles()),e.abrupt("return",3===t.fetchStatus?1:0);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var i,n,s,u,o,c,l,h,d,f,p=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=this.maximumFeaturesForTile(t))<=0)){e.next=3;break}return e.abrupt("return",z(t));case 3:if(n=this.getMaxRecordCount(t),s=Math.ceil(i/n),!(L(t)||!this.context.capabilities.supportsMaxRecordCountFactor||t.numFeatures<=i&&s>x.a.MAX_MAX_RECORD_COUNT_FACTOR)){e.next=6;break}return e.abrupt("return",this.fetchPagedTile(t,r));case 6:return(u=this.createQuery(t)).maxRecordCountFactor=Math.ceil(i/n),t.isRefetching&&t.features&&t.features.length>0&&(o=Math.ceil(t.features.length/(1-t.emptyFeatureRatio)/n),u.maxRecordCountFactor=Math.max(o+1,u.maxRecordCountFactor)),e.next=10,this.queryFeatures(u,r);case 10:return c=e.sent,l=c.features,h=c.exceededTransferLimit,d=c.fields,f=h?u.maxRecordCountFactor>=x.a.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5,e.next=17,this._frameTask.schedule((function(){t.featuresMissing=l.length<t.numFeatures||h;var e=p._removeEmptyFeatures(l);t.setFeatures(l,e,G(d))}),r);case 17:return this.invalidateCounts(),e.abrupt("return",f);case 19:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchCount",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.context.query.queryFeatureCount(this.createFeatureCountQuery(t),{signal:r}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchPagedTile",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var i,n,s,u,o,c,l,h,d,f=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0,s=0,u=0,o=this.maximumFeaturesForTile(t)-u,c=this.getMaxRecordCount(t),l=null,h=a.a.mark((function e(){var h,d,p,y,b,m;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=f.createQuery(t),d=f.setPagingParameters(h,n,o,c),e.next=4,f.queryFeatures(h,r);case 4:return p=e.sent,y=p.features,b=p.exceededTransferLimit,m=p.fields,e.next=10,f._frameTask.schedule((function(){d&&(n+=Object(v.t)(h.num)),u+=y.length,s+=f._removeEmptyFeatures(y),t.featuresMissing=n<t.numFeatures||b,i=i?i.concat(y):y,l=Q(l,m),t.setFeatures(i,s,l)}),r);case 10:if(f.invalidateCounts(),f.setDirty(),o=f.maximumFeaturesForTile(t)-u,d&&b&&!(o<=0)){e.next=15;break}return e.abrupt("return",{v:b?4:5});case 15:case"end":return e.stop()}}),e)}));case 4:return e.delegateYield(h(),"t0",5);case 5:if("object"!==typeof(d=e.t0)){e.next=8;break}return e.abrupt("return",d.v);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFeatureCountQuery",value:function(e){var t=this.createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}},{key:"createQuery",value:function(e){var t=this.context.createQuery(),r=e.descriptor.extent;if(r){var i=this.context.tilingScheme.spatialReference;t.geometry=Object(k.z)(r,i)}return this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"setPagingParameters",value:function(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}},{key:"getEffectiveTileResolution",value:function(e){if(null==e.descriptor.resolution)return null;var t=1===this.context.viewingMode?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}},{key:"supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"setResolutionParams",value:function(e,t){if(this.supportsResolution){var r=this.getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new _.a({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}}},{key:"_removeEmptyFeatures",value:function(e){for(var t=e.length,r=0;r<e.length;){var i=e[r];Object(F.i)(i.geometry)?++r:(e[r]=e[e.length-1],--e.length)}return t-e.length}},{key:"needsNumFeatures",value:function(e){return this.useTileCount&&e.needsFeatureCount&&!L(e)}},{key:"getMaxRecordCount",value:function(e){var t=this.context,r=t.tileMaxRecordCount,i=t.maxRecordCount;return this.useTileQuery(e)&&Object(v.k)(r)&&r>0&&this.context.capabilities.supportsResultType?r:Object(v.k)(i)&&i>0?i:B}},{key:"useTileQuery",value:function(e){return(!L(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}},{key:"_handleRequest",value:function(e,t,r,i){var n=this;e.fetchStatus=e.needsRefetching?3:2,e.requestController=r;var a=!1;t.then((function(t){e.requestController=null,e.fetchStatus=t})).catch((function(t){e.requestController===r&&(e.requestController=null,e.fetchStatus=4),Object(b.n)(t)?a=!0:i(t)})).then((function(){a||n.setDirty(),n.scheduleUpdated()}))}},{key:"scheduleUpdated",value:function(){var e=this;this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(Object(m.b)((function(){e.handles.remove("scheduleUpdated"),e.updated()})),"scheduleUpdated")}},{key:"showTile",value:function(e){if(Object(v.k)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;var t=e.features;if(0===e.featureLimit||!t){var r=Object(v.k)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],r}var i=e.descriptor.resolution,n=this.changes.updates,a=this.changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(var u=0;u<s;++u){var o=t[u],c=Object(F.g)(o,this.objectIdField),l=this.displayingFeatureReferences.get(c);if(l){var h=l.ref(o,i);h.oldVersion!==h.newVersion&&(n.removes.push(h.oldVersion),n.adds.push(h.newVersion))}else this.displayingFeatureReferences.set(c,new this.FeatureReferenceClass(o,i)),a.push(o);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=t.slice(0,s),!0}},{key:"hideTile",value:function(e){this.cancelFetchTile(e),this.hideTileFeatures(e)}},{key:"hideTileFeatures",value:function(e){if(!Object(v.j)(e.displayingFeatures)){var t,r=this.changes.updates,n=this.changes.removes,a=Object(i.a)(e.displayingFeatures);try{for(a.s();!(t=a.n()).done;){var s=t.value,u=Object(F.g)(s,this.objectIdField),o=this.displayingFeatureReferences.get(u);if(o){var c=o.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,c?c.oldVersion!==c.newVersion&&(null==c.newVersion?(this.displayingFeatureReferences.delete(u),n.push(c.oldVersion)):(r.adds.push(c.newVersion),r.removes.push(c.oldVersion))):console.error("Hiding unreferenced feature")}}}catch(l){a.e(l)}finally{a.f()}this.applyChanges(),e.displayingFeatures=null}}},{key:"applyChanges",value:function(){var e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this.changes.adds,r=this.changes.removes,i=Math.min(t.length,r.length),n=0;n<i;){var a=Math.min(n+X,i);this.features.addMany(t.slice(n,a)),this.features.removeMany(r.slice(n,a)),n=a}t.length>i&&this.features.addMany(0===n?t:t.slice(n)),r.length>i&&this.features.removeMany(0===n?r:r.slice(n)),t.length=0,r.length=0}},{key:"clearTile",value:function(e){if(this.hideTile(e),e.features&&Object(v.k)(this.context.memoryCache)){var t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this.invalidateCounts()}},{key:"invalidateCounts",value:function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}},{key:"getListOfTiles",value:function(){return Array.from(this.featureTiles.values())}},{key:"storedFeatures",get:function(){return this.getListOfTiles().reduce((function(e,t){return e+(t.features?t.features.length:0)}),0)}},{key:"maximumFeaturesForTile",value:function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:1/0,r=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(r*i/(1-e.emptyFeatureRatio)),t)}},{key:"test",get:function(){var e=this;return{process:function(t){return e.runTask(t)},getFeatureTileById:function(t){return e.featureTiles.get(t)},forEachFeatureTile:function(t){return e.featureTiles.forEach(t)}}}}]),r}(d.a);function L(e){return"dummy-tile-full-extent"===e.id}function A(e){var t=e.capabilities.query;return{supportsMultipleResolutions:q(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function q(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function z(e){return e.setFeatures([],0,null),e.featuresMissing=!1,4}function G(e){return Object(v.j)(e)?new Set:new Set(e.map((function(e){return e.name})))}function Q(e,t){if(Object(v.j)(e)||Object(v.j)(t))return G(t);var r,n=new Set,a=Object(i.a)(t);try{for(a.s();!(r=a.n()).done;){var s=r.value.name;e.has(s)&&n.add(s)}}catch(u){a.e(u)}finally{a.f()}return n}Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"features",void 0),Object(h.a)([Object(O.b)()],N.prototype,"tileDescriptors",void 0),Object(h.a)([Object(O.b)({value:1/0})],N.prototype,"maximumNumberOfFeatures",null),Object(h.a)([Object(O.b)({value:1})],N.prototype,"memoryFactor",null),Object(h.a)([Object(O.b)({value:1})],N.prototype,"lodFactor",null),Object(h.a)([Object(O.b)()],N.prototype,"useTileCount",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updating",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updatingTotal",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updatingRemaining",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"expectedFeatureDiff",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"memoryForUnusedFeatures",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"maximumNumberOfFeaturesExceeded",void 0),Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"totalVertices",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"totalFeatures",null),Object(h.a)([Object(O.b)()],N.prototype,"filterExtent",null),Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"context",void 0),N=Object(h.a)([Object(j.a)("esri.views.3d.layers.support.FeatureTileFetcher3D")],N);var B=2e3,H=Object(k.l)(),W=Object(k.l)(),J=6e5,X=200},812:function(e,t,r){"use strict";r.d(t,"a",(function(){return z}));var i=r(11),n=r(8),a=r.n(n),s=r(15),u=r(2),o=r(3),c=r(6),l=r(7),h=r(0),d=r(34),f=r(142),p=r(54),y=(r(17),r(24)),v=r(61),b=r(27),m=r(16),g=r(4),O=r(268),j=r(25),k=r(36),F=r(1),_=(r(18),r(12)),x=r(285),w=r(634),T=r(500),E=r(811),C=r(29),S=r(146),R=r(163),I=r(272),D=r(227),M=r(259),V=r(228),U=r(232),P=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],N=function(){function e(t,r,i){Object(u.a)(this,e),this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=t,this.view=i,this.tilingScheme=new U.a(r),this.loadedSymbols=P.map((function(e){return new M.a(new I.a({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}}))})),this.loadingSymbols=[new M.a(new I.a({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new M.a(new I.a({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new M.a(new I.a({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}return Object(o.a)(e,[{key:"destroy",value:function(){this.enabled=!1}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()}},{key:"update",value:function(){var e=this;this._enabled?(this.synchronizeMaps(this.loadingGraphics,{filter:function(e){return e.isFetching},symbols:this.loadingSymbols}),this.synchronizeMaps(this.loadedGraphics,{filter:function(e){return!e.isFetching},symbols:this.loadedSymbols}),this.synchronizeMaps(this.pendingGraphics,{filter:function(e){return!e.isFetching},symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.loadingGraphics.clear(),this.loadedGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.loadedGraphics.clear(),this.pendingGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}},{key:"showDataExtent",value:function(e){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),e){var t=R.a.fromExtent(e);this.dataExtentGraphic=new S.a({geometry:t,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}}},{key:"synchronizeMaps",value:function(e,t){var r=this,i=[];e.forEach((function(e,n){var a=r.tileFetcher.test.getFeatureTileById(n);a&&t.filter(a)||(r.view.graphics.removeMany(e),i.push(n))})),i.forEach((function(t){return e.delete(t)})),this.tileFetcher.test.forEachFeatureTile((function(i){if(t.filter(i)&&!e.has(i.id)){var n=Object(C.a)(i.descriptor.lij,3),a=n[0],s=n[1],u=n[2];r.tilingScheme.ensureMaxLod(a);var o=r.tilingScheme.getExtentGeometry(a,s,u),c=[new S.a({geometry:o,symbol:t.symbols[a%t.symbols.length]}),new S.a({geometry:o.center,symbol:new D.a({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new V.a({text:"".concat(a,"/").concat(s,"/").concat(u),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(i.id,c),r.view.graphics.addMany(c)}}))}}]),e}(),L=r(89),A=r(270),q=m.a.getLogger("esri.layers.graphics.controllers.FeatureTileController3D"),z=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var i;return Object(u.a)(this,r),(i=t.call(this,e)).type="feature-tile-3d",i.watchUpdatingTracking=new A.a,i.serviceDataExtent=null,i.serviceDataCount=G.NO_SERVICE_DATA_COUNT,i.vertexLimitExceeded=!1,i.displayFeatureLimit=null,i.suspended=!1,i.tileFetcher=null,i.handles=new v.a,i.fetchDataInfoPromise=null,i.fetchDataInfoAbortController=null,i.lifeCycleAbortController=Object(j.e)(),i}return Object(o.a)(r,[{key:"extent",set:function(e){if(!e||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}}else q.error("#extent=","extent needs to be in the same spatial reference as the view")}},{key:"updating",get:function(){return!!(Object(g.k)(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return Object(g.k)(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!Object(g.k)(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return Object(g.k)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var e=this.layerView.layer;if("feature"===e.type&&Object(g.k)(e.infoFor3D))return"snapshot";if(this.serviceDataCount===G.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var t=this.layerView.view,r=t&&t.featureTiles,i=r&&r.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&i){var n=this.approximateExtentSizeAtScale(e.minScale,i);if((this.serviceDataExtent.width/n+this.serviceDataExtent.height/n)/2>G.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&Object(g.k)(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"approximateExtentSizeAtScale",value:function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),n=t.levels[0];return i*((n.tileSize[0]/(n.scale/e)+n.tileSize[1]/(n.scale/e))/2)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new p.a([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new p.a}},{key:"test",get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}},{key:"initialize",value:function(){var e=this;this.watchUpdatingTracking.add(this,"vertexLimitInfo",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))})),this.watchUpdatingTracking.add(this,"mode",(function(){return e.modeChanged()}),2),this.addResolvingPromise(Promise.resolve().then((function(){return e.verifyCapabilities()})).then((function(){return e.watchUpdatingTracking.addPromise(e.fetchServiceDataInfo())})).then((function(){return e.initializeTileFetcher()})))}},{key:"verifyCapabilities",value:function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==e.type)throw new y.a("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}},{key:"destroy",value:function(){this.cancelFetchServiceDataInfo(),this.tileFetcher=Object(g.e)(this.tileFetcher),this.handles=Object(g.e)(this.handles),this.tilesHandle=Object(g.s)(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}},{key:"suspend",value:function(){this.suspended||(this.suspended=!0,Object(g.k)(this.tileFetcher)&&this.tileFetcher.suspend())}},{key:"resume",value:function(){this.suspended&&(this.suspended=!1,Object(g.k)(this.tileFetcher)&&this.tileFetcher.resume())}},{key:"restart",value:function(){var e=this,t=function(){Object(g.k)(e.tileFetcher)&&e.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))}},{key:"refetch",value:function(){var e=this,t=function(){Object(g.k)(e.tileFetcher)&&e.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))}},{key:"initializeTileFetcher",value:function(){var e=this,t=this.layerView.view;if(t){var r=Object(k.j)(t.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(r),r.then((function(){var r=e.layerView,i=e.tileDescriptors,n=r.layer,a=new E.a({context:e.context,filterExtent:e.extent,tileDescriptors:i,features:e.graphics});e.tileFetcher=a,e.suspended?e.tileFetcher.suspend():e.tileFetcher.resume();var s=e.layerView.view.resourceController;s&&(e.handles.add(s.memoryController.events.on("quality-changed",(function(e){a.memoryFactor=e}))),e.tileFetcher.memoryFactor=s.memoryController.memoryFactor);var u="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;u&&e.handles.add(Object(k.a)(e.layerView.view,"qualitySettings.graphics3D."+u,(function(e){a.lodFactor=e||1})));e.watchUpdatingTracking.add(n,"createQueryVersion",(function(){return e.dataFilterChanged()})),e.watchUpdatingTracking.add(r,"availableFields",(function(t,r){return e.availableFieldsChanged(r,t)})),e.watchUpdatingTracking.add(r,"requiredFields",(function(t,r){return e.requiredFieldsChanged(r,t)})),e.handles.add([n.on("apply-edits",(function(t){return e.applyEdits(t)})),e.watch("extent",(function(e){return a.filterExtent=e}),!0),e.watch("tileDescriptors",(function(e){return a.tileDescriptors=e}),!0),Object(k.a)(e,"maximumNumberOfFeatures",(function(t){a.maximumNumberOfFeatures=t,a.useTileCount=e.serviceDataCount>t}),!0),Object(k.a)(e,"serviceDataCount",(function(t){return a.useTileCount=t>e.maximumNumberOfFeatures}),!0),Object(k.a)(L.a,"FEATURE_TILE_FETCH_SHOW_TILES",(function(r){r&&a&&!a.debugger?(a.debugger=new N(a,t.featureTiles.tilingScheme.toTileInfo(),t),a.debugger.update()):!r&&e.tileFetcher&&a.debugger&&(a.debugger.destroy(),a.debugger=null)}))]),e.supportsExceedsLimitQuery||e.watchUpdatingTracking.add(e,"maxTotalSnapshotVertices",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))}))})).catch((function(){}))}}},{key:"modeChanged",value:function(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:q.warn("Unhandled feature layer mode "+this.mode);case"snapshot":Object(g.k)(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}},{key:"dataFilterChanged",value:function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}},{key:"applyEdits",value:function(e){var t=this;Object(g.j)(this.tileFetcher)||this.tileFetcher.applyEdits(e).then((function(e){e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t.watchUpdatingTracking.addPromise(t.updateServiceDataExtent(t.lifeCycleAbortController.signal))})).catch((function(e){if(!Object(j.n)(e))throw e}))}},{key:"availableFieldsChanged",value:function(e,t){Object(g.k)(this.tileFetcher)&&H(this.tileFetcher.availableFields,t)&&this.refetch()}},{key:"requiredFieldsChanged",value:function(e,t){Object(g.k)(this.tileFetcher)&&H(this.tileFetcher.availableFields,t)&&this.restart()}},{key:"createVertexLimitExceededQuery",value:function(e){var t=this.layerView.layer,r=t.createQuery();return r.outStatistics=[new T.a({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(r.cacheHint=!0),r}},{key:"createDataInfoQuery",value:function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"fullExtentIsAccurate",value:function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return Object(x.c)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}},{key:"updateServiceDataExtent",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.tryUpdateServiceDataExtent(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),Object(j.n)(e.t0)||this._set("serviceDataExtent",Object(b.a)(this.layerView.fullExtentInLocalViewSpatialReference));case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"tryUpdateServiceDataExtent",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,n,s,u,o,c,l,h,d,f;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.layerView,i=r.layer,n=i.capabilities.query.supportsExtent,s=Object(b.a)(r.fullExtentInLocalViewSpatialReference),u=i.fullExtent,o=this.fullExtentIsAccurate(),c=this.serviceDataCount,!(n&&c<=G.MAX_FEATURE_COUNT_FOR_EXTENT)||s&&o||!("queryExtent"in i)){e.next=9;break}return l=this.createDataInfoQuery(),e.next=5,i.queryExtent(l,{timeout:G.QUERY_EXTENT_TIMEOUT,signal:t});case 5:h=e.sent,this._set("serviceDataExtent",h.extent),e.next=22;break;case 9:if(!s){e.next=13;break}this._set("serviceDataExtent",s),e.next=22;break;case 13:if(!u){e.next=21;break}return d="portalItem"in i?i.portalItem:null,e.next=17,Object(w.projectGeometry)(u,r.view.spatialReference,d,t);case 17:f=e.sent,this._set("serviceDataExtent",f),e.next=22;break;case 21:this._set("serviceDataExtent",null);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateServiceDataCount",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("queryFeatureCount"in(r=this.layerView.layer)){e.next=3;break}return e.abrupt("return",void this._set("serviceDataCount",G.NO_SERVICE_DATA_COUNT));case 3:return e.next=5,Object(f.d)(r.queryFeatureCount(this.createDataInfoQuery(),{timeout:G.QUERY_STATISTICS_TIMEOUT,signal:t}));case 5:if(!0!==(i=e.sent).ok){e.next=10;break}this._set("serviceDataCount",i.value),e.next=13;break;case 10:if(!Object(j.n)(i.error)){e.next=12;break}throw i.error;case 12:this._set("serviceDataCount",G.NO_SERVICE_DATA_COUNT);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"vertexLimitInfo",get:function(){if(Object(g.j)(this.displayFeatureLimit)||Object(g.j)(this.displayFeatureLimit.averageSymbolComplexity))return null;var e=this.displayFeatureLimit,t=e.averageSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,n=t.primitivesPerFeature,a=this._get("vertexLimitInfo");return Object(g.j)(a)||a.maximumTotalNumberOfPrimitives!==r||a.primitivesPerCoordinate!==i||a.primitivesPerFeature!==n?{primitivesPerCoordinate:i,primitivesPerFeature:n,maximumTotalNumberOfPrimitives:r}:a}},{key:"supportsExceedsLimitQuery",get:function(){var e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"updateVertexLimitExceeded",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r){var i,n,s,u,o,c,l,h,d,p,y;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.vertexLimitInfo,!Object(g.j)(i)){e.next=3;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 3:if(n=i.primitivesPerFeature<=0,s=this.minimumNumberOfVerticesForGeometry>1,n||s){e.next=6;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 6:if(u=i.primitivesPerFeature,o=i.primitivesPerCoordinate,c=i.maximumTotalNumberOfPrimitives,e.t0=0!==u&&Object(g.k)(t),!e.t0){e.next=11;break}return e.next=11,t;case 11:if(h=this.serviceDataCount,d=h!==G.NO_SERVICE_DATA_COUNT,l=d?Math.ceil((c-h*u)/(o||1)):Math.ceil(c/(o||1)),s&&(l=Math.min(l,B)),!(d&&this.minimumNumberOfVerticesForGeometry*h>l)){e.next=14;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!0));case 14:if(this.supportsExceedsLimitQuery){e.next=16;break}return e.abrupt("return",void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>l));case 16:return e.next=18,Object(f.d)(this.layerView.layer.queryFeatures(this.createVertexLimitExceededQuery(l),{timeout:G.QUERY_STATISTICS_TIMEOUT,signal:r}));case 18:if(!1!==(p=e.sent).ok){e.next=23;break}if(!Object(j.n)(p.error)){e.next=22;break}throw p.error;case 22:return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 23:(y=p.value.features[0])&&y.attributes?this._set("vertexLimitExceeded",!!y.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchServiceDataInfo",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t,r,i,n,s,u=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.cancelFetchServiceDataInfo(),t=Object(j.e)(),r=t.signal,i=this.updateServiceDataCount(r),n=Object(j.k)([i,this.updateVertexLimitExceeded(i,r)]),s=n.then((function(){return u.updateServiceDataExtent(r)})).catch((function(e){Object(j.n)(e)||q.error("#fetchServiceDataInfo()",e)})).then((function(){s===u.fetchDataInfoPromise&&(u.fetchDataInfoPromise=null,u.fetchDataInfoAbortController=null),t=null})),e.abrupt("return",(t&&(this.fetchDataInfoPromise=s),this.fetchDataInfoAbortController=t,n.then((function(){}),(function(){}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"cancelFetchServiceDataInfo",value:function(){var e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}},{key:"debug",get:function(){return{storedFeatures:Object(g.k)(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:Object(g.k)(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:Object(g.k)(this.tileFetcher)?this.tileFetcher.totalVertices:0}}}]),r}(Object(O.b)(d.a));Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"type",void 0),Object(h.a)([Object(F.b)({constructOnly:!0})],z.prototype,"graphics",void 0),Object(h.a)([Object(F.b)({constructOnly:!0})],z.prototype,"layerView",void 0),Object(h.a)([Object(F.b)({constructOnly:!0})],z.prototype,"context",void 0),Object(h.a)([Object(F.b)()],z.prototype,"extent",null),Object(h.a)([Object(F.b)()],z.prototype,"updating",null),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"watchUpdatingTracking",void 0),Object(h.a)([Object(F.b)()],z.prototype,"updatingTotal",null),Object(h.a)([Object(F.b)()],z.prototype,"updatingRemaining",null),Object(h.a)([Object(F.b)()],z.prototype,"expectedFeatureDiff",null),Object(h.a)([Object(F.b)()],z.prototype,"memoryForUnusedFeatures",null),Object(h.a)([Object(F.b)()],z.prototype,"maximumNumberOfFeaturesExceeded",null),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"serviceDataExtent",void 0),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"serviceDataCount",void 0),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"vertexLimitExceeded",void 0),Object(h.a)([Object(F.b)()],z.prototype,"displayFeatureLimit",void 0),Object(h.a)([Object(F.b)({type:Number})],z.prototype,"maximumNumberOfFeatures",null),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"mode",null),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"maxTotalSnapshotVertices",null),Object(h.a)([Object(F.b)({readOnly:!0,dependsOn:["mode"]})],z.prototype,"tileDescriptors",null),Object(h.a)([Object(F.b)()],z.prototype,"tileFetcher",void 0),Object(h.a)([Object(F.b)()],z.prototype,"fetchDataInfoPromise",void 0),Object(h.a)([Object(F.b)({readOnly:!0})],z.prototype,"vertexLimitInfo",null),z=Object(h.a)([Object(_.a)("esri.layers.graphics.controllers.FeatureTileController3D")],z);var G,Q,B=5e6;function H(e,t){if(!t)return!1;var r,n=Object(i.a)(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(!e.has(a))return!0}}catch(s){n.e(s)}finally{n.f()}return!1}(Q=G||(G={})).NO_SERVICE_DATA_COUNT=1/0,Q.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,Q.reset=function(){Q.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,Q.QUERY_STATISTICS_TIMEOUT=12e3,Q.QUERY_EXTENT_TIMEOUT=1e4},G.reset()},814:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var i=r(4),n=r(77),a=r(634);function s(e){var t=e.view.spatialReference,r=e.layer.fullExtent,s=r&&r.spatialReference;if(!s)return Promise.resolve(null);if(s.equals(t))return Promise.resolve(r.clone());var u=Object(n.d)(r,t);return Object(i.k)(u)?Promise.resolve(u):e.view.state.isLocal?Object(a.projectGeometry)(r,t,e.layer.portalItem).then((function(t){return!e.destroyed&&t?t:void 0})).catch((function(){return null})):Promise.resolve(null)}},828:function(e,t,r){"use strict";r.d(t,"a",(function(){return T}));var i=r(8),n=r.n(i),a=r(14),s=r(15),u=r(2),o=r(3),c=r(23),l=r(22),h=r(6),d=r(7),f=r(0),p=r(24),y=r(4),v=r(36),b=r(1),m=(r(17),r(18),r(16),r(12)),g=r(381),O=r(812),j=r(501),k=r(171),F=r(861),_=r(851),x=r(814),w=r(103),T=function(e){var t=function(e){Object(h.a)(r,e);var t=Object(d.a)(r);function r(){var e;return Object(u.a)(this,r),(e=t.apply(this,arguments)).controller=null,e.updatePolicy=1,e.suspendResumeExtentMode="computed",e.slicePlaneEnabled=!1,e.drapeSourceType=1,e.fullExtentInLocalViewSpatialReference=null,e.suspendResumeExtent=null,e._controllerCreated=!1,e.clippingExtent=null,e.supportsHeightUnitConversion=!0,e.pendingController=null,e.queryEngine=null,e}return Object(o.a)(r,[{key:"initialize",value:function(){var e=this,t=this.layer;"isTable"in t&&t.isTable?this.addResolvingPromise(Promise.reject(new p.a("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t}))):(this._set("graphics3d",new F.a({owner:this,layer:t,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:function(t){return e.updateClippingExtent(t)}})),this.updatingHandles.add(this,"updatePolicy",(function(t){return e.graphics3d.graphicsCore.preferredUpdatePolicy=t})),this.updatingHandles.add(this,"suspendResumeExtentMode",(function(t){e.graphics3d.suspendResumeExtentMode=t})),this.addResolvingPromise(this.graphics3d.setup().then((function(){return e.validateGeometryType()})).then((function(){return e.queryEngine=new _.a({layerView:e,priority:w.b.FEATURE_QUERY_ENGINE})})).then((function(){return Object(x.a)(e)})).then((function(t){return e.fullExtentInLocalViewSpatialReference=t})).then((function(){return e.initializeController()}))),this.notifyChange("updating"))}},{key:"destroy",value:function(){this.destroyPendingController(),this.controller=Object(y.e)(this.controller),this._set("graphics3d",Object(y.e)(this.graphics3d)),this.queryEngine=Object(y.e)(this.queryEngine),this.loadedGraphics=null}},{key:"destroyPendingController",value:function(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)}},{key:"legendEnabled",get:function(){var e,t;return this.canResume()&&!(null!=(e=this.graphics3d)&&null!=(t=e.frustumVisibility)&&t.suspended)}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"getRenderingInfo",value:function(e,t,r){var i=Object(j.c)(e,{renderer:t,arcade:r});if(Object(y.k)(i)&&i.color){var n=i.color;n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255}return i}},{key:"getRenderingInfoAsync",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r,i,s){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(j.d)(t,Object(a.a)({renderer:r,arcade:i},s)));case 1:case"end":return e.stop()}}),e)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"getGraphicFromGraphicUid",value:function(e){var t,r=this,i=null;return null==(t=this.loadedGraphics)||t.forEach((function(t){t.uid===e&&(i=Object(g.c)(t,r.layer))})),i}},{key:"graphics3DGraphics",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}},{key:"graphics3DGraphicsByObjectID",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}},{key:"symbolUpdateType",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}},{key:"whenGraphicBounds",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(e,t):null}},{key:"computeAttachmentOrigin",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null}},{key:"getSymbolLayerSize",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(e,t):null}},{key:"queryFeatures",value:function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryObjectIds",value:function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryFeatureCount",value:function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryExtent",value:function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"_ensureQuery",value:function(e){return Object(y.j)(e)?this.createQuery():k.a.from(e)}},{key:"highlight",value:function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}},{key:"maskOccludee",value:function(e){return this.graphics3d.maskOccludee(e)}},{key:"canResume",value:function(){return Object(c.a)(Object(l.a)(r.prototype),"canResume",this).call(this)&&(!this.graphics3d||!this.graphics3d.suspended)}},{key:"getSuspendInfo",value:function(){var e=Object(c.a)(Object(l.a)(r.prototype),"getSuspendInfo",this).call(this);return this.graphics3d?Object(a.a)(Object(a.a)({},e),this.graphics3d.suspendInfo):e}},{key:"isUpdating",value:function(){var e,t;return!(!this.graphics3d||this.graphics3d.destroyed)&&!(this._controllerCreated&&(null==(e=this.controller)||!e.updating)&&null!=(t=this.view.basemapTerrain)&&t.ready&&!this.graphics3d.updating)}},{key:"initializeController",value:function(){var e=Object(s.a)(n.a.mark((function e(){var t;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.createController(),this.pendingController=t,e.next=4,t.when();case 4:this.setControllerWhenInitialized(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"setControllerWhenInitialized",value:function(){var e=Object(s.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:if(this._controllerCreated=!0,this.notifyChange("updating"),!this.isResolved()||this.destroyed){e.next=19;break}return e.next=12,Object(v.l)(this.view,"basemapTerrain.ready");case 12:this.beforeSetController(t),this.pendingController=null,this.controller=t,this.loadedGraphics=t.graphics,this.notifyChange("updating"),e.next=20;break;case 19:this.destroyPendingController();case 20:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"updateClippingExtent",value:function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}},{key:"validateGeometryType",value:function(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new p.a("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}},{key:"_getResourceInfo",value:function(){var e=this.controller&&this.controller instanceof O.a?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?e.maximumNumberOfFeatures:-1,totalNumberOfFeatures:e?e.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return Object(f.a)([Object(b.b)()],t.prototype,"loadedGraphics",void 0),Object(f.a)([Object(b.b)()],t.prototype,"suspended",void 0),Object(f.a)([Object(b.b)({readOnly:!0})],t.prototype,"legendEnabled",null),Object(f.a)([Object(b.b)()],t.prototype,"updating",void 0),Object(f.a)([Object(b.b)()],t.prototype,"controller",void 0),Object(f.a)([Object(b.b)()],t.prototype,"graphics3d",void 0),Object(f.a)([Object(b.b)({readOnly:!0})],t.prototype,"updatePolicy",void 0),Object(f.a)([Object(b.b)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),Object(f.a)([Object(b.b)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),Object(f.a)([Object(b.b)({readOnly:!0})],t.prototype,"suspendInfo",void 0),t=Object(f.a)([Object(m.a)("esri.views.3d.layers.FeatureLikeLayerView3D")],t)}},829:function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var i=r(42),n=r(11),a=r(2),s=r(3),u=r(6),o=r(7),c=r(94),l=r(502),h=function(e){Object(u.a)(r,e);var t=Object(o.a)(r);function r(){var e;return Object(a.a)(this,r),(e=t.apply(this,arguments))._set=new Set,e}return Object(s.a)(r,[{key:"clear",value:function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._set.size}},{key:"addMany",value:function(e){if(0!==e.length){var t,r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._set.add(i)}}catch(a){r.e(a)}finally{r.f()}this.emit("after-changes",{type:1}),this.emit("change",{added:e,removed:[]})}}},{key:"remove",value:function(e){this._set.delete(e)&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[e]}))}},{key:"removeMany",value:function(e){var t,r=[],i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;this._set.delete(a)&&r.push(a)}}catch(s){i.e(s)}finally{i.f()}r.length>0&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:r}))}},{key:"toArray",value:function(){return Object(i.a)(this._set)}},{key:"find",value:function(e){var t;return Object(l.a)(this._set,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._set.forEach((function(t){return e(t)}))}}]),r}(c.a)},868:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var i=r(11),n=r(2),a=r(3),s=r(4),u=function(){function e(t){Object(n.a)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return Object(a.a)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,r=Object(i.a)(this._buffer);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(Object(s.k)(n)&&e(n))return n}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();Object(s.k)(t);)e&&e(t),t=this.dequeue()}}]),e}()},954:function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var i=r(11),n=r(2),a=r(3),s=r(868),u=r(21),o=r(4),c="__esri_stream_id__",l="__esri_timestamp__",h=function(){function e(t,r,i,a){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;Object(n.a)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=a,this.store=t,this.objectIdField=r,this.purgeInterval=s,this._useGeneratedIds=this.objectIdField===c}return Object(a.a)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return Object(o.j)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new s.a(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var i=Object(o.k)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,n=Object(u.f)(i,0,1e3);this._trackIdToObservations.set(r,new s.a(n))}var a=this._trackIdToObservations.get(r).enqueue(e.objectId);Object(o.k)(a)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[];if(Object(o.k)(t)){var a,s=Object(i.a)(t);try{for(s.s();!(a=s.n()).done;){var u=a.value,c=this.store.removeById(u);Object(o.k)(c)&&n.push(c)}}catch(p){s.e(p)}finally{s.f()}}if(Object(o.k)(e)){var h,d=Object(i.a)(e);try{for(d.s();!(h=d.n()).done;){var f=h.value;f.attributes[l]=r,this.store.add(f)}}catch(p){d.e(p)}finally{d.f()}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;Object(o.k)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r,n=Object(i.a)(this._trackIdToObservations.values());try{for(n.s();!(r=n.n()).done;){var a=r.value;if(t>e.displayCount&&a.size){var s=Object(o.t)(a.dequeue());this._removed.push(s),t--}}}catch(l){n.e(l)}finally{n.f()}}if(Object(o.k)(this._trackIdLessObservations))for(var u=t-e.displayCount;u-- >0;){var c=this._trackIdLessObservations.dequeue();Object(o.k)(c)&&this._removed.push(c)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var i=60*e.age*1e3,n=this._maxAge-i;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var i=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes[l]<i&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}()},999:function(e,t,r){"use strict";r.d(t,"a",(function(){return P}));var i,n,a=r(11),s=r(8),u=r.n(s),o=r(15),c=r(14),l=r(2),h=r(3),d=r(6),f=r(7),p=r(0),y=(r(140),r(107)),v=r(24),b=r(16),m=r(4),g=r(25),O=r(1),j=(r(17),r(18),r(12)),k=r(94),F=r(213),_=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(){return Object(l.a)(this,r),t.apply(this,arguments)}return Object(h.a)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(k.a.EventedMixin(F.a)),x=_=Object(p.a)([Object(j.a)("esri.layers.graphics.sources.connections.StreamConnection")],_),w=r(414),T=b.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(n=i||(i={}))[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED";var E=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){var i;Object(l.a)(this,r),(i=t.call(this)).errorString=null;var n=e.geometryType,a=e.spatialReference,s=e.sourceSpatialReference;return i._config=e,i._featureZScaler=Object(w.a)(n,s,a),i._open(),i}return Object(h.a)(r,[{key:"_open",value:function(){var e=Object(o.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(m.k)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(Object(m.j)(this._websocket))return"disconnected";switch(this._websocket.readyState){case i.CONNECTING:case i.OPEN:return"connected";case i.CLOSING:case i.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=Object(o.a)(u.a.mark((function e(){var t,r,i,n,a=arguments;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:this._config.source.path,r=a.length>1&&void 0!==a[1]?a[1]:1e3,i=a.length>2&&void 0!==a[2]?a[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this._createWebSocket(t);case 8:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=24;break;case 12:if(e.prev=12,e.t0=e.catch(3),n=r/1e3,!(this._config.maxReconnectionAttempts&&i>=this._config.maxReconnectionAttempts)){e.next=19;break}e.t1=(T.error(new v.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=23;break;case 19:return T.error(new v.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(n,"s"),e.t0)),e.next=22,Object(g.a)(r);case 22:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),i+1);case 23:return e.abrupt("return",e.t1);case 24:case"end":return e.stop()}}),e,this,[[3,12]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this,r=new WebSocket(e),i=new Promise((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return i.then((function(){if(t.destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),i}},{key:"_handshake",value:function(){var e=Object(o.a)(u.a.mark((function e(){var t,r,i,n,a,s,o,c,l=this,h=arguments;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=h.length>0&&void 0!==h[0]?h[0]:1e4,r=this._websocket,!Object(m.j)(r)){e.next=4;break}return e.abrupt("return");case 4:return i=Object(g.h)(),n=r.onmessage,a=this._config,s=a.filter,o=a.outFields,c=a.spatialReference,e.abrupt("return",(i.timeout(t),r.onmessage=function(e){var t,a=null;try{a=JSON.parse(e.data)}catch(u){}a&&"object"==typeof a||(T.error(new v.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),i.reject(),l.destroy()),(null==(t=a.spatialReference)?void 0:t.wkid)!==(null==c?void 0:c.wkid)&&(T.error(new v.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(c.wkid),e.data)),i.reject(),l.destroy()),"json"!==a.format&&(T.error(new v.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),i.reject(),l.destroy()),s&&a.filter!==s&&T.error(new v.a("websocket-connection","Tried to set filter, but server doesn't support it")),o&&a.outFields!==o&&T.error(new v.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=n,i.resolve()},r.send(JSON.stringify({filter:s,outFields:o,format:"json",spatialReference:{wkid:c.wkid}})),i.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new v.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,i=Object(a.a)(t.features);try{for(i.s();!(r=i.n()).done;){var n=r.value;this._featureZScaler&&this._featureZScaler(n.geometry),this.onFeature(n)}}catch(s){i.e(s)}finally{i.f()}}catch(u){return T.error(new v.a("websocket-connection","Failed to parse message",u)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),T.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&T.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(x);Object(p.a)([Object(O.b)()],E.prototype,"connectionStatus",null),Object(p.a)([Object(O.b)()],E.prototype,"errorString",void 0),E=Object(p.a)([Object(j.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],E);var C=r(305),S=r(171),R=r(108),I=r(56),D=b.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),M={maxQueryDepth:5,maxRecordCountFactor:3},V=function(e){Object(d.a)(i,e);var t=Object(f.a)(i);function i(e){return Object(l.a)(this,i),t.call(this,Object(c.a)(Object(c.a)({},M),e))}return Object(h.a)(i,[{key:"_open",value:function(){var e=Object(o.a)(u.a.mark((function e(){var t,r,i,n,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||D.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),e.next=6,this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);case 6:return r=e.sent,this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=10,this._buddyServicesQuery;case 10:return e.next=12,this._tryCreateWebSocket(r);case 12:i=this._config,n=i.filter,a=i.outFields,this.destroyed||this._setFilter(n,a);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void D.error(new v.a("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(o.a)(u.a.mark((function e(t){var r,i,n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={f:"json"},i=Object(y.default)(t.path,{query:r,responseType:"json"}),e.next=4,i;case 4:return n=e.sent.data,e.abrupt("return",(this._serviceDefinition=n,n));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(){var e=Object(o.a)(u.a.mark((function e(t,r){var i,n,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t[0],n=i.urls,a=i.token,e.abrupt("return","".concat(this._inferWebSocketBaseUrl(n),"/subscribe?outSR=").concat(r.wkid).concat(a?"&token="+a:""));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(-1!==i.indexOf("wss"))return i}}catch(n){r.e(n)}finally{r.f()}return D.error(new v.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(o.a)(u.a.mark((function e(t,r){var i,n,a,s,o,c,l=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._websocket,!(Object(m.j)(i)||Object(m.j)(t)&&Object(m.j)(r))){e.next=3;break}return e.abrupt("return");case 3:return n=JSON.stringify({filter:this._serializeFilter(t,r)}),a=!1,s=Object(g.h)(),o=function(){a||(l.destroyed||l._websocket!==i||D.error(new v.a("geoevent-connection","Server timed out when setting filter")),s.reject())},c=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(D.error(new v.a("geoevent-connection","Failed to set service filter",t.error)),l._set("errorString","Could not set service filter - ".concat(t.error)),s.reject(t.error)),i.onmessage=l._onMessage.bind(l),a=!0,s.resolve())},e.abrupt("return",(i.onmessage=c,i.send(n),setTimeout(o,1e4),s.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(Object(m.j)(e)&&Object(m.j)(t))return r;if(Object(m.k)(e)&&e.geometry)try{var i=Object(R.a)(e.geometry);if("extent"!==i.type)throw new v.a("Expected extent but found type ".concat(i.type));r.geometry=JSON.stringify(i.shiftCentralMeridian())}catch(n){D.error(new v.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",n))}return Object(m.k)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(m.k)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return D.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var i=this._relatedFeatures.get(r),n=i.attributes,a=i.geometry;for(var s in n)e.attributes[s]=n[s];return a&&(e.geometry=a),e.geometry||e.centroid||D.error(new v.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(o.a)(u.a.mark((function e(){var t,r,i,n,s,o,c,l,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,i=t.keepLatestArchive,n=this._queryRelatedFeatures(r),s=this._queryArchive(i),e.next=4,n;case 4:return e.next=6,s;case 6:if(o=e.sent){e.next=9;break}return e.abrupt("return");case 9:c=Object(a.a)(o.features);try{for(c.s();!(l=c.n()).done;)h=l.value,this.onFeature(this._enrich(h))}catch(u){c.e(u)}finally{c.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),D.error(new v.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(o.a)(u.a.mark((function e(t){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(o.a)(u.a.mark((function e(t){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(o.a)(u.a.mark((function e(t){var i,n,a,s,o,c,l,h,d,f,p;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,635));case 2:return e.t0=e.sent.default,e.t1={url:t},i=new e.t0(e.t1),e.next=7,i.load();case 7:if(n=e.sent,a=n.capabilities,s=a.query.supportsMaxRecordCountFactor,o=a.query.supportsPagination,c=a.query.supportsCentroid,l=this._config.maxRecordCountFactor,h=i.capabilities.query.maxRecordCount,d=s?h*l:h,(f=new S.a).outFields=Object(m.u)(this._config.outFields,["*"]),f.where=Object(m.u)(Object(m.i)(this._config.filter,"where"),"1=1"),f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=I.a.fromJSON(this._config.spatialReference),c&&(f.returnCentroid=!0),s&&(f.maxRecordCountFactor=l),!o){e.next=18;break}return e.abrupt("return",(f.num=d,i.destroy(),this._queryPages(t,f)));case 18:return e.next=20,Object(C.executeQuery)(t,f,this._config.sourceSpatialReference);case 20:return p=e.sent,e.abrupt("return",(i.destroy(),p.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(o.a)(u.a.mark((function e(t,r){var i,n,a,s,o=arguments;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.length>2&&void 0!==o[2]?o[2]:[],n=o.length>3&&void 0!==o[3]?o[3]:0,r.start=Object(m.k)(r.num)?n*r.num:null,e.next=5,Object(C.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return a=e.sent,s=a.data,e.abrupt("return",s.exceededTransferLimit&&n<this._config.maxQueryDepth?(s.features.forEach((function(e){return i.push(e)})),this._queryPages(t,r,i,n+1)):(i.forEach((function(e){return s.features.push(e)})),s));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,i=e.features,n=this._serviceDefinition.relatedFeatures.joinField,s=Object(a.a)(i);try{for(s.s();!(t=s.n()).done;){var u=t.value,o=u.attributes[n];r.set(o,u)}}catch(c){s.e(c)}finally{s.f()}this._relatedFeatures=r}}]),i}(E),U=V=Object(p.a)([Object(j.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],V);function P(e,t,r,i,n,a,s){var u=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),o={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:i,filter:n,maxReconnectionAttempts:a,maxReconnectionInterval:s};return u?new E(o):new U(o)}}}]);
//# sourceMappingURL=53.4d0c770d.chunk.js.map