(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[49,10],{1004:function(e,t,r){"use strict";r.d(t,"a",(function(){return k}));var i=r(8),n=r.n(i),a=r(15),s=r(42),o=r(2),u=r(3),c=r(6),l=r(7),d=r(0),h=r(34),f=r(16),b=r(87),v=r(12),p=r(425),g=function(e){var t=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).asyncUpdateState=new Map,e}return Object(u.a)(r,[{key:"autoUpdateAsync",value:function(e,t){var r=this;return function(e,t){var r=function(){a&&!s&&e(i)},i=function(){if(!a||s)return t();a.clear(),s=!0;var e=Object(b.b)(a,t);return s=!1,e},n=function(){a&&(a.destroy(),a=null)},a=new p.a(r),s=!1;return e(i),{remove:n}}((function(t){return r.updateAsync(e,t)}),t)}},{key:"updateAsync",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){var i;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.startAsyncUpdate(t)){e.next=12;break}return e.prev=1,e.next=4,r();case 4:i=e.sent,this._set(t,i),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),f.a.getLogger(this.declaredClass).warn('Async update of "'.concat(t,'" failed. Async update functions should not throw exceptions.'));case 11:this.endAsyncUpdate(t)&&this.updateAsync(t,r);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()},{key:"startAsyncUpdate",value:function(e){var t,r=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&r?(this.asyncUpdateState.set(e,2|r),!0):(this.asyncUpdateState.set(e,1|r),!1)}},{key:"endAsyncUpdate",value:function(e){var t,r=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&r?(this.asyncUpdateState.set(e,-3&r),!0):(this.asyncUpdateState.set(e,r),!1)}}]),r}(e);return t=Object(d.a)([Object(v.a)("esri.core.AsyncUpdate")],t)};var y=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(){return Object(o.a)(this,r),t.apply(this,arguments)}return r}(g(h.a));y=Object(d.a)([Object(v.a)("esri.core.AsyncUpdate")],y);var m=r(213),O=r(4),_=r(1),j=(r(17),r(18),r(112)),x=f.a.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields"),k=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){return Object(o.a)(this,r),t.call(this,e)}return Object(u.a)(r,[{key:"requiredFields",get:function(){var e=this.layerView,t=e.layer.fieldsIndex,r=e.definitionExpressionFields,i=this.rendererFields,n=this.labelingFields,a=this.viewFilterFields;return Object(j.j)(t,[].concat(Object(s.a)(Object(O.u)(r,[])),Object(s.a)(Object(O.u)(i,[])),Object(s.a)(Object(O.u)(n,[])),Object(s.a)(Object(O.u)(a,[]))))}},{key:"initialize",value:function(){var e=this,t=this.layerView.layer;this.layer=t,this.handles.add([this.autoUpdateAsync("rendererFields",(function(){var t=e.layer,r=t.fieldsIndex,i=t.renderer;return i?w((function(e){return i.collectRequiredFields(e,r)})):null})),this.autoUpdateAsync("labelingFields",(function(){var t=e.layer;return t.labelsVisible?w((function(e){return Object(j.g)(e,t)})):null})),this.autoUpdateAsync("viewFilterFields",(function(){var t=e.layerView,r=t.layer,i=t.filter;return w((function(e){return Object(j.f)(e,r,i)}))}))])}}]),r}(g(m.a));function w(e){return C.apply(this,arguments)}function C(){return(C=Object(a.a)(n.a.mark((function e(t){var r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Set,e.prev=1,e.next=4,t(r);case 4:return e.abrupt("return",Array.from(r).sort());case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",(x.error(e.t0),null));case 10:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}Object(d.a)([Object(_.b)()],k.prototype,"layerView",void 0),Object(d.a)([Object(_.b)()],k.prototype,"layer",void 0),Object(d.a)([Object(_.b)()],k.prototype,"requiredFields",null),Object(d.a)([Object(_.b)()],k.prototype,"rendererFields",void 0),Object(d.a)([Object(_.b)()],k.prototype,"labelingFields",void 0),Object(d.a)([Object(_.b)()],k.prototype,"viewFilterFields",void 0),k=Object(d.a)([Object(v.a)("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],k)},1220:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return ee}));var i=r(11),n=r(14),a=r(8),s=r.n(a),o=r(42),u=r(15),c=r(2),l=r(3),d=r(23),h=r(22),f=r(6),b=r(7),v=r(0),p=r(146),g=r(16),y=r(4),m=r(36),O=r(1),_=(r(17),r(18),r(12)),j=r(5),x=r(10),k=r(49),w=r(43),C=r(191),I=r(204),N=r(381),D=r(859),S=r(501),F=r(414),M=r(171),A=function(e){Object(f.a)(r,e);var t=Object(b.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,"SceneLayerWorker","dracoDecompressPointCloudData",e,{hasInitialize:!0})}return Object(l.a)(r,[{key:"getTransferList",value:function(e){return[e.geometryBuffer]}}]),r}(r(496).a),E=r(631),P=r(861),L=r(851),V=r(975),T=r(860),R=r(801),U=r(900),q=r(976),G=r(902),B=r(1004),z=r(89),H=r(857),Q=r(410),W=r(458),K=r(977),Y=r(808),X=r(103),Z=g.a.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),J=Object(q.a)(),$=function(e){Object(f.a)(a,e);var t=Object(b.a)(a);function a(){var e;return Object(c.a)(this,a),(e=t.apply(this,arguments)).type="scene-layer-graphics-3d",e._nodesAddedToStage=new Map,e.drapeSourceType=1,e._queryEngine=null,e._memCache=null,e._interactiveEditingSessions=new Map,e.loadedGraphics=new H.a,e.holeFilling="always",e.progressiveLoadFactor=1,e.supportsHeightUnitConversion=!0,e._coordinatesOutsideExtentErrors=0,e._maxCoordinatesOutsideExtentErrors=20,e}return Object(l.a)(a,[{key:"initialize",value:function(){var e,t=this,i=this.layer;this.addResolvingPromise(i.indexInfo),this._attributeOverrides=new T.a(this.layer,null==(e=this.view.resourceController)?void 0:e.memoryController),Object(R.g)(i,this.view.spatialReference,this.view.viewingMode),this.fieldsHelper=new B.a({layerView:this}),this.updatingHandles.add(i,"rangeInfos",(function(e){return t._rangeInfosChanged(e)}),2),this.updatingHandles.add(i,"renderer",(function(e,r){return t._rendererChange(e,r)})),this.updatingHandles.add(this,"parsedDefinitionExpression",(function(){return t._filterChange()})),this.updatingHandles.add(this,"view.floors",(function(){return t.graphics3d.filterVisibility.filterChanged()})),this.handles.add(Object(m.a)(z.a,"I3S_TREE_SHOW_TILES",(function(e){if(e&&!t._treeDebugger){var i=t._controller.crsIndex;r.e(37).then(r.bind(null,1192)).then((function(e){var r=e.I3STreeDebugger;!t._treeDebugger&&z.a.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new r({lv:t,view:t.view,nodeSR:i}))}))}else e||!t._treeDebugger||z.a.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)}))),this._set("graphics3d",new P.a({owner:this,layer:i,preferredUpdatePolicy:0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:i.fullExtent,updateClippingExtent:function(e){return t._updateClippingExtent(e)}})),this.graphics3d.elevationAlignment&&this.graphics3d.elevationAlignment.events.on("invalidate-elevation",(function(e){return t._invalidateElevation(e)})),this.supportsHeightUnitConversion&&(this._verticalScale=Object(F.a)("point",i.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.graphics3d.setup()),this._memCache=this.view.resourceController.memoryController.getMemCache(i.uid),this._controller=new D.a({layerView:this,scaleVisibilityEnabled:!1}),Object(R.i)(this.layer.geometryDefinitions)&&(this._worker=new A((function(e){return t.view.resourceController.schedule(e)}))),this.handles.add(this.layer.on("apply-edits",(function(e){return t.updatingHandles.addPromise(e.result)}))),this.handles.add(this.layer.on("edits",(function(e){return t._handleEdits(e)}))),this.when((function(){t._queryEngine=new L.a({layerView:t,priority:X.b.FEATURE_QUERY_ENGINE}),t.updatingHandles.add(t,"maximumNumberOfFeatures",(function(e){return t._controller.featureTarget=e}),2),t.updatingHandles.add(t,"suspended",(function(e){e&&t._removeAllNodeData()}))}))}},{key:"destroy",value:function(){this._treeDebugger=Object(y.e)(this._treeDebugger),this._attributeOverrides=Object(y.e)(this._attributeOverrides),this._set("graphics3d",Object(y.e)(this.graphics3d)),this._controller=Object(y.e)(this._controller),this._queryEngine=Object(y.e)(this._queryEngine),this._worker=Object(y.e)(this._worker),this._memCache=Object(y.e)(this._memCache),this._nodesAddedToStage.clear(),this.fieldsHelper=Object(y.e)(this.fieldsHelper)}},{key:"requiredFields",get:function(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}},{key:"maximumNumberOfFeatures",get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!this.suspended&&!!this._controller&&!this._controller.leavesReached}},{key:"hasM",get:function(){return!1}},{key:"hasZ",get:function(){return!0}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"whenGraphicAttributes",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var i=this;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(R.x)(this.layer,t,this._getObjectIdField(),r,(function(){return Object(o.a)(i._nodesAddedToStage.values())})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"getGraphicFromGraphicUid",value:function(e){if(!this.loadedGraphics)return null;var t=Object(N.c)(this.loadedGraphics.find((function(t){return t.uid===e})),this.layer),r=this._getObjectIdField();return t&&t.attributes&&t.attributes[r]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null}},{key:"whenGraphicBounds",value:function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){return this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t)}},{key:"canResume",value:function(){return Object(d.a)(Object(h.a)(a.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)}},{key:"isUpdating",value:function(){return!!(this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating)}},{key:"getRenderingInfo",value:function(e,t,r){var i=Object(S.c)(e,{renderer:t,arcade:r});if(Object(y.k)(i)&&i.color){var n=i.color;n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255}return i}},{key:"getRenderingInfoAsync",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r,i,a){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(S.d)(t,Object(n.a)({renderer:r,arcade:i},a)));case 1:case"end":return e.stop()}}),e)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"symbolUpdateType",get:function(){return this.graphics3d.graphicsCore.symbolUpdateType}},{key:"highlight",value:function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}},{key:"updatePolicy",get:function(){return this.graphics3d.graphicsCore.effectiveUpdatePolicy}},{key:"createInteractiveEditSession",value:function(e){return Object(V.a)(this.attributeEditingContext,e)}},{key:"extractBinaryPointData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var i,n=this;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={geometryBuffer:t.geometryBuffer},e.abrupt("return",(Object(y.j)(this._worker)&&(this._worker=new A((function(e){return n.view.resourceController.schedule(e)}))),this._worker.invoke(i,r).then((function(e){if(Object(y.k)(e))return{positionData:e.positions,featureIds:e.featureIds};throw new Error("Failed to decompress Draco point data")}))));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"checkExtent",value:function(e,t){e&&!Object(C.b)(e,t)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&Z.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&Z.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++)}},{key:"addNode",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r,n){var a,o,u,c,l,d,h,f;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(re(r)||te(r)){e.next=2;break}return e.abrupt("return",Promise.reject());case 2:if(!this._nodesAddedToStage.has(t.index)){e.next=4;break}return e.abrupt("return",void Z.error("I3S node "+t.id+" already added"));case 4:if(a=this.layer.fullExtent,o=a&&ne(a.clone(),.5),u=this._controller.crsVertex,c=[],l={graphics:null,featureIds:null,attributeInfo:r.attributeDataInfo,node:t},!re(r)){e.next=10;break}return e.next=8,this._addNodeBinaryPointData(t,l,r,o,c,n);case 8:e.next=11;break;case 10:te(r)&&this._addNodeLegacyPointData(t,l,r,o,c);case 11:return e.next=13,this._attributeOverrides.apply(l.featureIds,r.attributeDataInfo,n);case 13:if(t.numFeatures=l.graphics.length,this._updateNodeMemory(t),ie(l),c.length>0&&(this.computeObb(t,c,u),this._controller.updateVisibility(t.index)),this._controller.isGeometryVisible(t)){e.next=19;break}return e.abrupt("return",(this._cacheNodeData(l),Promise.resolve()));case 19:if(this._verticalScale){d=Object(i.a)(l.graphics);try{for(d.s();!(h=d.n()).done;)f=h.value,this._verticalScale(f.geometry)}catch(s){d.e(s)}finally{d.f()}}return e.abrupt("return",(this._nodesAddedToStage.set(t.index,l),this.loadedGraphics.addMany(l.graphics),this._filterNode(l),this._treeDebugger&&this._treeDebugger.update(),Promise.resolve()));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"computeObb",value:function(e,t,r){var i=this._controller.crsIndex,n=i.isGeographic?this.view.renderSpatialReference:i;Object(k.q)(t,r,0,t,n,0,t.length/3);var a={data:t,size:3};e.serviceObb=Object(Q.c)(a),i.isGeographic&&Object(k.z)(e.serviceObb.center,n,e.serviceObb.center,i)}},{key:"isNodeLoaded",value:function(e){return this._nodesAddedToStage.has(e)}},{key:"isNodeReloading",value:function(){return!1}},{key:"updateNodeState",value:function(){}},{key:"_addNodeBinaryPointData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r,i,n,a,o){var u,c,l,d,h,f,b,v,g,m,O,_,w,C,N,D,S,F,M;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.extractBinaryPointData(i,o);case 2:if(null!=(u=e.sent)){e.next=5;break}return e.abrupt("return",Promise.reject());case 5:for(c=this._getObjectIdField(),l=this._controller.crsVertex,d=this.view.spatialReference,h=this.graphics3d.graphicsCore,f=u.positionData,b=u.featureIds,3,v=f.length/3,g=new Array,m=0;m<v;m++)O=Object(y.k)(t.serviceObb)?t.serviceObb.center:[0,0,0],_=3*m,w=Object(x.g)(f[_+0],f[_+1],f[_+2]),Object(j.h)(w,w,O),t.serviceObb||a.push(w[0],w[1],w[2]),n&&this.checkExtent(n,w),C=b[m],N={},null!=C&&(N[c]=C),D=null==C?p.a.generateUID():C,Object(k.q)(w,l,0,se,d,0,1),S=Object(I.j)(se[0],se[1],se[2],d),F=this.loadedGraphics.get(D),Object(y.k)(F)?(F.level<t.level&&(oe.property="geometry",oe.graphic=F,oe.oldValue=Object(y.t)(F.geometry),oe.newValue=S,F.geometry=S,h.graphicUpdateHandler(oe)),g.push(F)):(M=p.a.generateUID(),g.push({objectId:D,uid:M,geometry:S,attributes:N,visible:!0,level:t.level}));r.graphics=g,r.featureIds=b;case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n,a,s){return e.apply(this,arguments)}}()},{key:"_addNodeLegacyPointData",value:function(e,t,r,n,a){var s,o=this._getObjectIdField(),u=this._controller.crsVertex,c=this.view.spatialReference,l=[0,0,0],d=new Array,h=new Array,f=Object(i.a)(r.pointData);try{for(f.s();!(s=f.n()).done;){var b=s.value,v=b.featureDataPosition,g=v.length,m=b.geometries&&b.geometries[0]||ae[g],O=b.featureIds[0];if("points"===m.params.type){n&&this.checkExtent(n,v);var _={};null!=O&&(_[o]=O);var j=null==O?p.a.generateUID():O,x=void 0;"Embedded"===m.type&&(x=m.params.vertexAttributes.position);for(var w=0;w<x.length;w+=g){for(var C=0;C<g;C++)l[C]=v[C]+x[w+C];var N=3===g;e.serviceObb||a.push(l[0],l[1],N?l[2]:0),Object(k.q)(l,u,0,se,c,0,1);var D=Object(I.j)(se[0],se[1],N?se[2]:void 0,c),S=this.loadedGraphics.get(j);Object(y.k)(S)?h.push(S):h.push({objectId:j,uid:p.a.generateUID(),geometry:D,attributes:_,visible:!0})}d.push(O)}}}catch(F){f.e(F)}finally{f.f()}t.graphics=h,t.featureIds=d}},{key:"_updateNodeMemory",value:function(e){e.memory=4096+(Object(y.k)(e.numFeatures)?e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic:0)}},{key:"_cacheNodeData",value:function(e){var t=e.graphics.reduce((function(e,t){return Object(I.e)(t)+e}),512+8*e.featureIds.length+1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)}},{key:"_getMemCacheKey",value:function(e){return"".concat(e.index)}},{key:"_removeAllNodeData",value:function(){var e=this;this._nodesAddedToStage.forEach((function(t){if(t){var r=t.node;e._updateNodeMemory(r),e._cacheNodeData(t)}})),this._nodesAddedToStage.clear(),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}},{key:"removeNode",value:function(e){var t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}},{key:"_removeNodeStageData",value:function(e){var t=this._nodesAddedToStage.get(e);return t?(this.loadedGraphics.removeMany(t.graphics),this._nodesAddedToStage.delete(e),this._treeDebugger&&this._treeDebugger.update(),t):null}},{key:"loadCachedNodeData",value:function(){var e=Object(u.a)(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._memCache.pop(this._getMemCacheKey(t)));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"addCachedNodeData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r,i,n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._nodesAddedToStage.has(t.index)){e.next=9;break}return this.loadedGraphics.addMany(r.graphics),this._nodesAddedToStage.set(t.index,r),this._updateNodeMemory(t),e.next=6,this.updateAttributes(t.index,i,n);case 6:return this._filterNode(r),this._treeDebugger&&this._treeDebugger.update(),e.abrupt("return",Promise.resolve());case 9:Z.error("I3S node "+t.id+" already added");case 10:case"end":return e.stop()}}),e,this)})));return function(t,r,i,n){return e.apply(this,arguments)}}()},{key:"getLoadedNodeIds",value:function(){var e=[];return this._nodesAddedToStage.forEach((function(t){return e.push(t.node.id)})),e.sort()}},{key:"getVisibleNodes",value:function(){var e=new Array;return this._nodesAddedToStage.forEach((function(t){return e.push(t.node)})),e}},{key:"getLoadedNodeIndices",value:function(e){this._nodesAddedToStage.forEach((function(t,r){return e.push(r)}))}},{key:"getLoadedAttributes",value:function(e){var t=this._nodesAddedToStage.get(e);if(t&&Object(y.k)(t.attributeInfo))return t.attributeInfo.loadedAttributes}},{key:"getAttributeData",value:function(e){var t=this._nodesAddedToStage.get(e);if(t&&Object(y.k)(t.attributeInfo))return t.attributeInfo.attributeData}},{key:"setAttributeData",value:function(e,t){var r=this._nodesAddedToStage.get(e);r&&!Object(y.j)(r.attributeInfo)&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}},{key:"updateAttributes",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r,i){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._nodesAddedToStage.get(t),e.t0=n,!e.t0){e.next=7;break}return e.next=5,this._attributeOverrides.apply(n.featureIds,r,i);case 5:n.attributeInfo=r,this._attributeValuesChanged(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_attributeValuesChanged",value:function(e){if(ie(e),this._filterNode(e),this.graphics3d.graphicsCore.labelsEnabled){var t=e.graphics.map((function(e){return e.uid}));this.graphics3d.graphicsCore.updateLabelingInfo(t)}}},{key:"_updateClippingExtent",value:function(e){return this._controller&&this._controller.updateClippingArea(e),!1}},{key:"_getObjectIdField",value:function(){return this.layer.objectIdField||"OBJECTID"}},{key:"_rendererChange",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var i,n,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.layer.fieldsIndex,n=new Set,!t){e.next=7;break}return e.next=4,t.collectRequiredFields(n,i);case 4:a=Array.from(n).sort(),e.next=8;break;case 7:a=[];case 8:if(n.clear(),!r){e.next=15;break}return e.next=12,r.collectRequiredFields(n,i);case 12:o=Array.from(n).sort(),e.next=16;break;case 15:o=[];case 16:a.length===o.length&&a.every((function(e,t){return a[t]===o[t]}))||this._reloadAllNodes();case 17:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_rangeInfosChanged",value:function(e){null!=e&&e.length>0&&Z.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}},{key:"_filterChange",value:function(){var e=this;this._nodesAddedToStage.forEach((function(t){return e._filterNode(t)}))}},{key:"_reloadAllNodes",value:function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}},{key:"_filterNode",value:function(e){var t,r=this.parsedDefinitionExpression,n=Object(i.a)(e.graphics);try{for(n.s();!(t=n.n()).done;){var a=t.value,s=a.visible;a.visible=!r||this._evaluateClause(r,a),s!==a.visible&&(oe.graphic=a,oe.property="visible",oe.oldValue=s,oe.newValue=a.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(oe))}}catch(o){n.e(o)}finally{n.f()}}},{key:"_invalidateElevation",value:function(e){var t=this._controller.crsIndex;Object(k.o)(e.extent,e.spatialReference,ue,t),this._controller.updateElevationChanged(ue,t)}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return Object(y.k)(this.filter)?this.filter.createQuery(e):new M.a(e)}},{key:"queryFeatures",value:function(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryObjectIds",value:function(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatureCount",value:function(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryExtent",value:function(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"_ensureQuery",value:function(e){return this._addDefinitionExpressionToQuery(Object(y.j)(e)?this.createQuery():M.a.from(e))}},{key:"getUsedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0}},{key:"getUnloadedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))}},{key:"ignoresMemoryFactor",value:function(){return this._controller&&this._controller.fixedFeatureTarget}},{key:"_handleEdits",value:function(e){Object(V.b)(this.attributeEditingContext,e)}},{key:"attributeEditingContext",get:function(){var e=this,t=this._getObjectIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:t,forEachNode:function(t){return e._nodesAddedToStage.forEach((function(e){return t(e.node,e.featureIds)}))},attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this._attributeOverrides,getAttributeData:function(t){return e.getAttributeData(t)},setAttributeData:function(r,i,n){e.setAttributeData(r,i);var a=e._nodesAddedToStage.get(r);if(Object(y.k)(n)){var s=e.loadedGraphics.get(n.attributes[t]);Object(y.k)(s)&&e.graphics3d.graphicsCore.recreateGraphics([s])}else Object(y.k)(a)&&e.graphics3d.graphicsCore.recreateGraphics(a.graphics)},clearMemCache:function(){}}}},{key:"performanceInfo",get:function(){var e={displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:this.maximumNumberOfFeatures,totalNumberOfFeatures:-1,nodes:this._nodesAddedToStage.size,core:this.graphics3d.graphicsCore.performanceInfo};return this._controller&&this._controller.updateStats(e),e}},{key:"test",get:function(){return{controller:this._controller,numNodes:this._nodesAddedToStage.size,numFeatures:this.loadedGraphics.length}}}]),a}(Object(U.a)(Object(G.a)(Object(E.a)(K.a))));Object(v.a)([Object(O.b)()],$.prototype,"graphics3d",void 0),Object(v.a)([Object(O.b)({type:Y.a})],$.prototype,"filter",void 0),Object(v.a)([Object(O.b)()],$.prototype,"loadedGraphics",void 0),Object(v.a)([Object(O.b)({aliasOf:"layer"})],$.prototype,"i3slayer",void 0),Object(v.a)([Object(O.b)()],$.prototype,"_controller",void 0),Object(v.a)([Object(O.b)()],$.prototype,"updating",void 0),Object(v.a)([Object(O.b)()],$.prototype,"suspended",void 0),Object(v.a)([Object(O.b)()],$.prototype,"holeFilling",void 0),Object(v.a)([Object(O.b)(W.a)],$.prototype,"updatingProgress",void 0),Object(v.a)([Object(O.b)({aliasOf:"_controller.updatingProgress"})],$.prototype,"updatingProgressValue",void 0),Object(v.a)([Object(O.b)(J.requiredFields)],$.prototype,"requiredFields",null),Object(v.a)([Object(O.b)(J.availableFields)],$.prototype,"availableFields",void 0),Object(v.a)([Object(O.b)()],$.prototype,"fieldsHelper",void 0),Object(v.a)([Object(O.b)({type:Number})],$.prototype,"maximumNumberOfFeatures",null),Object(v.a)([Object(O.b)({readOnly:!0})],$.prototype,"maximumNumberOfFeaturesExceeded",null),Object(v.a)([Object(O.b)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],$.prototype,"lodFactor",void 0),Object(v.a)([Object(O.b)({readOnly:!0})],$.prototype,"hasM",null),Object(v.a)([Object(O.b)({readOnly:!0})],$.prototype,"hasZ",null);var ee=$=Object(v.a)([Object(_.a)("esri.views.3d.layers.SceneLayerGraphicsView3D")],$);function te(e){return"pointData"in e}function re(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function ie(e){for(var t=e.attributeInfo,r=0;r<e.graphics.length;r++){var n=e.graphics[r];if(n.attributes||(n.attributes={}),Object(y.k)(t)&&Object(y.k)(t.loadedAttributes)){var a,s=Object(i.a)(t.loadedAttributes);try{for(s.s();!(a=s.n()).done;){var o=a.value.name;t.attributeData[o]&&(n.attributes[o]=Object(R.n)(t.attributeData[o],r))}}catch(u){s.e(u)}finally{s.f()}}}}function ne(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var ae={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},se=Object(x.e)(),oe={graphic:null,property:null,oldValue:null,newValue:null},ue=Object(w.l)()},801:function(e,t,r){"use strict";r.d(t,"a",(function(){return ve})),r.d(t,"b",(function(){return ce})),r.d(t,"c",(function(){return ue})),r.d(t,"d",(function(){return oe})),r.d(t,"e",(function(){return se})),r.d(t,"f",(function(){return ne})),r.d(t,"g",(function(){return ae})),r.d(t,"h",(function(){return we})),r.d(t,"i",(function(){return V})),r.d(t,"j",(function(){return R})),r.d(t,"k",(function(){return H})),r.d(t,"l",(function(){return T})),r.d(t,"m",(function(){return ie})),r.d(t,"n",(function(){return ee})),r.d(t,"o",(function(){return G})),r.d(t,"p",(function(){return te})),r.d(t,"q",(function(){return be})),r.d(t,"r",(function(){return re})),r.d(t,"s",(function(){return z})),r.d(t,"t",(function(){return U})),r.d(t,"u",(function(){return de})),r.d(t,"v",(function(){return pe})),r.d(t,"w",(function(){return he})),r.d(t,"x",(function(){return Q}));var i=r(8),n=r.n(i),a=r(2),s=r(15),o=r(11),u=r(107),c=r(115),l=r(24),d=r(17),h=r(4),f=r(25),b=r(104),v=r(68),p=r(99),g=r(28),y=r(33),m=r(217),O=r(609),_=r(5),j=r(10),x=r(46),k=r(49),w=r(70),C=r(56),I=r(37),N=r(43),D=r(58),S=r(171),F=r(840),M=r(873),A=r(421),E=r(465),P=r(410);function L(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function V(e){if(Object(d.a)("disable-feature:i3s-draco")||!e)return!1;var t,r=Object(o.a)(e);try{for(r.s();!(t=r.n()).done;){var i,n=t.value,a=Object(o.a)(n.geometryBuffers);try{for(a.s();!(i=a.n()).done;){var s;if("draco"===(null==(s=i.value.compressedAttributes)?void 0:s.encoding))return!0}}catch(u){a.e(u)}finally{a.f()}}}catch(u){r.e(u)}finally{r.f()}return!1}function T(e,t,r,i,n,a){n.traverse(r,(function(r){var n=r.mbs;t!==i&&(n=B,Object(k.p)(r.mbs,i,n,t));var s=function(e,t){var r=t[0],i=t[1],n=t[3],a=e[0]-r,s=r-e[2],o=e[1]-i,u=i-e[3],c=Math.max(a,s,0),l=Math.max(o,u,0),d=c*c+l*l;return d>n*n?0:d>0?1:-Math.max(a,s,o,u)>n?3:2}(e,n);return 0!==s&&(a(r,s),!0)}))}function R(e,t,r){for(var i=0,n=0,a=0;a<t.length&&i<e.length;a++)e[i]===t[a]&&(r(a)&&(e[n]=e[i],n++),i++);e.length=n}function U(e,t,r){for(var i=0,n=0;i<r.length;)Object(c.b)(e,r[i])>=0===t&&(r[n]=r[i],n++),i++;r.length=n}var q=Object(I.h)();function G(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return q[0]=(e[0]-t.position[0])/t.rotationScale[0],q[1]=(e[1]-t.position[1])/t.rotationScale[4],q[2]=(e[2]-t.position[2])/t.rotationScale[8],q[3]=(e[3]-t.position[0])/t.rotationScale[0],q[4]=(e[4]-t.position[1])/t.rotationScale[4],q[5]=(e[5]-t.position[2])/t.rotationScale[8],q}var B=Object(x.e)();function z(e,t){var r=t[0],i=t[1],n=t[2],a=t[3],s=e[0]-r,o=r-e[3],u=e[1]-i,c=i-e[4],l=e[2]-n,d=n-e[5],h=Math.max(s,o,0),f=Math.max(u,c,0),b=Math.max(l,d,0),v=h*h+f*f+b*b;return v>a*a?0:v>0?1:-Math.max(s,o,u,c,l,d)>a?3:2}function H(e,t,r){var i,n=[],a=r&&r.missingFields,s=r&&r.originalFields,u=Object(o.a)(e);try{for(u.s();!(i=u.n()).done;){var c,l=i.value,d=l.toLowerCase(),h=!1,f=Object(o.a)(t);try{for(f.s();!(c=f.n()).done;){var b=c.value;if(d===b.name.toLowerCase()){n.push(b.name),h=!0,s&&s.push(l);break}}}catch(v){f.e(v)}finally{f.f()}!h&&a&&a.push(l)}}catch(v){u.e(v)}finally{u.f()}return n}function Q(e,t,r,i,n){return W.apply(this,arguments)}function W(){return(W=Object(s.a)(n.a.mark((function e(t,r,i,a,s){var o,u,d,f;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==r.length){e.next=2;break}return e.abrupt("return",[]);case 2:if(o=t.attributeStorageInfo,!Object(h.k)(t.associatedLayer)){e.next=14;break}return e.prev=4,e.next=7,Y(t.associatedLayer,r,i,a);case 7:return e.abrupt("return",e.sent);case 10:if(e.prev=10,e.t0=e.catch(4),!t.associatedLayer.loaded){e.next=14;break}throw e.t0;case 14:if(!o){e.next=23;break}if(u=K(r,i,s),!Object(h.j)(u)){e.next=18;break}throw new l.a("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");case 18:return d=t.parsedUrl.path,e.next=21,Promise.all(u.map((function(e){return J(d,o,e.node,e.indices,a).then((function(t){for(var r=0;r<e.graphics.length;r++){var i=e.graphics[r],n=t[r];if(i.attributes)for(var a in i.attributes)a in n||(n[a]=i.attributes[a]);i.attributes=n}return e.graphics}))})));case 21:return f=e.sent,e.abrupt("return",Object(c.f)(f));case 23:throw new l.a("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available");case 24:case"end":return e.stop()}}),e,null,[[4,10]])})))).apply(this,arguments)}function K(e,t,r){var i,n=new Map,a=[],s=r(),u=Object(o.a)(e);try{for(u.s();!(i=u.n()).done;)for(var c=i.value,l=c.attributes[t],d=0;d<s.length;d++){var h=s[d],f=h.featureIds.indexOf(l);if(f>=0){var b=n.get(h.node);b||(b={node:h.node,indices:[],graphics:[]},a.push(b),n.set(h.node,b)),b.indices.push(f),b.graphics.push(c);for(var v=d;v>0;v--)s[v]=s[v-1];s[0]=h;break}}}catch(p){u.e(p)}finally{u.f()}return a}function Y(e,t,r,i){return X.apply(this,arguments)}function X(){return(X=Object(s.a)(n.a.mark((function e(t,r,i,a){var s,o,u,c,l,d,h,f,b,v;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.sort((function(e,t){return e.attributes[i]-t.attributes[i]})),s=r.map((function(e){return e.attributes[i]})),o=[],u=H(a,t.fields,{originalFields:o}),e.next=6,Z(t,s,u);case 6:for(c=e.sent,l=0;l<r.length;l++){if(d=r[l],h=c[l],f={},d.attributes)for(b in d.attributes)f[b]=d.attributes[b];for(v=0;v<o.length;v++)f[o[v]]=h[u[v]];d.attributes=f}return e.abrupt("return",r);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Z(e,t,r){var i=e.capabilities.query.maxRecordCount;if(null!=i&&t.length>i){var n=Object(c.n)(t,i);return Promise.all(n.map((function(t){return Z(e,t,r)}))).then(c.f)}var a=new S.a({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return e.queryFeatures(a).then((function(e){if(e&&e.features&&e.features.length===t.length)return e.features.map((function(e){return e.attributes}));throw new l.a("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}function J(e,t,r,i,n){var a,s=[],c=Object(o.a)(t);try{for(c.s();!(a=c.n()).done;){var l=a.value;if(l&&-1!==n.indexOf(l.name)){var d="".concat(e,"/nodes/").concat(r.resources.attributes,"/attributes/").concat(l.key,"/0");s.push({url:d,storageInfo:l})}}}catch(h){c.e(h)}finally{c.f()}return Object(f.k)(s.map((function(e){return Object(u.default)(e.url,{responseType:"array-buffer"}).then((function(t){return Object(F.d)(e.storageInfo,t.data)}))}))).then((function(e){var t,r=[],n=Object(o.a)(i);try{for(n.s();!(t=n.n()).done;){for(var a=t.value,u={},c=0;c<e.length;c++)null!=e[c].value&&(u[s[c].storageInfo.name]=ee(e[c].value,a));r.push(u)}}catch(h){n.e(h)}finally{n.f()}return r}))}var $=-Math.pow(2,31);function ee(e,t){if(!e)return null;var r=e[t];return Object(b.f)(e)?-32768===r?null:r:Object(b.g)(e)?r===$?null:r:r!=r?null:r}function te(e){var t=e.store.indexCRS||e.store.geographicCRS,r=void 0===t?e.store.indexWKT:void 0;if(r){if(!e.spatialReference)throw new l.a("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new l.a("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}var i=t?new C.a(L(t)):e.spatialReference;return i.equals(e.spatialReference)?e.spatialReference:i}function re(e){var t=e.store.vertexCRS||e.store.projectedCRS,r=void 0===t?e.store.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new l.a("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new l.a("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}var i=t?new C.a(L(t)):e.spatialReference;return i.equals(e.spatialReference)?e.spatialReference:i}function ie(e,t){return Object(h.j)(t)?"@null":t===Object(w.g)(t)?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null}function ne(e,t,r){if(!Object(k.b)(e,t))throw new l.a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&!function(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator}(e,t))throw new l.a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function ae(e,t,r){var i=te(e),n=re(e);ne(i,t,r),ne(n,t,r)}function se(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return(null==e.geometryType||"triangles"===e.geometryType)&&(null==e.topology||"PerAttributeArray"===e.topology)&&null!=e.vertexAttributes&&null!=e.vertexAttributes.position}(e.store.defaultGeometrySchema))throw new l.a("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function oe(e,t){ae(e,t.spatialReference,t.viewingMode)}function ue(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return null!=e.geometryType&&"points"===e.geometryType&&(null==e.topology||"PerAttributeArray"===e.topology)&&(null==e.encoding||""===e.encoding||"lepcc-xyz"===e.encoding)&&null!=e.vertexAttributes&&null!=e.vertexAttributes.position}(e.store.defaultGeometrySchema))throw new l.a("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function ce(e,t){ne(e.spatialReference,t.spatialReference,t.viewingMode)}function le(e){return"mesh-3d"===e.type}function de(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;var r,i=Object(o.a)(t);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(!le(n)||0===n.symbolLayers.length)return!0;var a,s=Object(o.a)(n.symbolLayers.items);try{for(s.s();!(a=s.n()).done;){var u=a.value;if("fill"!==u.type||Object(h.j)(u.material)||Object(h.j)(u.material.color)||"replace"!==u.material.colorMixMode)return!0}}catch(c){s.e(c)}finally{s.f()}}}catch(c){i.e(c)}finally{i.f()}return!1}var he=Object(A.c)({color:[0,0,0,0],opacity:0}),fe=function e(){Object(a.a)(this,e),this.edgeMaterial=null,this.material=null,this.castShadows=!0};function be(e){var t,r=new fe,i=!1,n=!1,a=Object(o.a)(e.symbolLayers.items);try{for(a.s();!(t=a.n()).done;){var s=t.value;if("fill"===s.type&&s.enabled){var u=s.material,c=s.edges;if(Object(h.k)(u)&&!i){var l=u.color,d=Object(E.b)(u.colorMixMode);Object(h.k)(l)?r.material={color:[l.r/255,l.g/255,l.b/255],alpha:l.a,colorMixMode:d}:r.material={color:[1,1,1],alpha:1,colorMixMode:1},r.castShadows=s.castShadows,i=!0}Object(h.k)(c)&&!n&&(r.edgeMaterial=Object(A.b)(c,{}),n=!0)}}}catch(f){a.e(f)}finally{a.f()}return r.material||(r.material={color:[1,1,1],alpha:1,colorMixMode:1}),r}function ve(e,t){return(0|e)+(0|t)|0}function pe(e,t,r,i){var n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;i===Object(w.g)(i)?t.isGeographic?ke(e,r,t,n):xe(e,r,t,n):t.isWGS84&&(i.isWebMercator||Object(D.k)(i))?ge(t,e,i,r,n):e===r?(r.center[2]+=n,Object(k.q)(r.center,t,0,r.center,i,0,1)):(Object(_.y)(r.center,e.center[0],e.center[1],e.center[2]+n),Object(k.q)(r.center,t,0,r.center,i,0,1),Object(m.a)(r.quaternion,e.quaternion),Object(_.m)(r.halfSize,e.halfSize))}function ge(e,t,r,i,n){var a=Object(v.h)(je,t.quaternion);Object(_.m)(_e,t.center),_e[2]+=n;var s=Object(w.g)(r);Object(k.q)(_e,e,0,_e,s,0,1);for(var o=0;o<8;++o){for(var u=0;u<3;++u)Oe[u]=t.halfSize[u]*(0!=(o&1<<u)?-1:1);for(var c=0;c<3;++c){for(var l=_e[c],d=0;d<3;++d)l+=Oe[d]*a[3*d+c];ye[3*o+c]=l}}Object(k.q)(ye,s,0,ye,r,0,8),Object(P.c)(me,i)}var ye=new Float64Array(24),me={data:ye,size:3},Oe=Object(j.e)(),_e=Object(j.e)(),je=Object(p.b)();function xe(e,t,r,i){Object(P.d)(e,Ne),Object(_.y)(t.center,e.center[0],e.center[1],e.center[2]+i),Object(k.d)(r,t.center,Ce,Object(w.g)(r)),Object(_.y)(t.center,Ce[12],Ce[13],Ce[14]);var n=2*Math.sqrt(1+Ce[0]+Ce[5]+Ce[10]);Ie[0]=(Ce[6]-Ce[9])/n,Ie[1]=(Ce[8]-Ce[2])/n,Ie[2]=(Ce[1]-Ce[4])/n,Ie[3]=.25*n,Object(m.f)(t.quaternion,Ie,e.quaternion),Object(m.b)(Ie,t.quaternion);var a,s=0,u=0,c=0,l=Object(o.a)(Ne);try{for(l.s();!(a=l.n()).done;){var d=a.value;d[2]+=i,Object(k.q)(d,r,0,d,Object(w.g)(r),0,1),Object(_.C)(Me,d,t.center),Object(_.w)(Me,Me,Ie),s=Math.max(s,Math.abs(Me[0])),u=Math.max(u,Math.abs(Me[1])),c=Math.max(c,Math.abs(Me[2]))}}catch(h){l.e(h)}finally{l.f()}Object(_.y)(t.halfSize,s,u,c)}function ke(e,t,r,i){var n=Object(w.e)(r),a=1+Math.max(0,i)/(n.radius+e.center[2]);Object(_.y)(t.center,e.center[0],e.center[1],e.center[2]+i),Object(k.q)(t.center,r,0,t.center,Object(w.g)(r),0,1),Object(m.a)(t.quaternion,e.quaternion),Object(m.b)(Ie,e.quaternion),Object(_.y)(Me,0,0,1),Object(_.w)(Me,Me,Ie),Object(_.y)(Me,e.halfSize[0]*Math.abs(Me[0]),e.halfSize[1]*Math.abs(Me[1]),e.halfSize[2]*Math.abs(Me[2])),Object(_.g)(Me,Me,n.inverseFlattening),Object(_.h)(t.halfSize,e.halfSize,Me),Object(_.g)(t.halfSize,t.halfSize,a)}function we(e,t,r,i,n,a){if(!a||0===a.length||Object(h.j)(t))return null;var s,u=Object(M.a)(e.mbs,n,r,t);Object(g.b)(Ee,u);var c=function(){if(!s)if(s=Ne,Object(N.n)(Se),Object(h.k)(e.serviceObb)){pe(e.serviceObb,r,Fe,t,n),Object(P.d)(Fe,s);var i,a=Object(o.a)(s);try{for(a.s();!(i=a.n()).done;){var u=i.value;Object(_.s)(u,u,Ee),Object(N.q)(Se,u)}}catch(g){a.e(g)}finally{a.f()}}else{var c=e.mbs,l=c[3];Object(k.z)(c,r,Me,t),Object(_.s)(Me,Me,Ee),Me[2]+=n;for(var d=0;d<8;++d){var f=1&d?l:-l,b=2&d?l:-l,v=4&d?l:-l,p=s[d];Object(_.m)(p,[Me[0]+f,Me[1]+b,Me[2]+v]),Object(N.q)(Se,p)}}},l=1/0,d=-1/0;if(a.forEach((function(e){return function(e){if("replace"===e.type){var r=e.geometry;if(r.hasZ){Object(N.n)(De);var n=r.spatialReference||i,a=r.rings.reduce((function(e,r){return r.reduce((function(e,r){return Object(k.z)(r,n,Me,t),Object(_.s)(Me,Me,Ee),Object(N.q)(De,Me),Math.min(Me[2],e)}),e)}),1/0);c(),Object(N.w)(Se,De)&&(l=Math.min(l,a),d=Math.max(d,a))}}}(e)})),l===1/0)return null;for(var f=function(e,t,r){Object(_.s)(Me,r,u),e[t+0]=Me[0],e[t+1]=Me[1],e[t+2]=Me[2],t+=24,r[2]=l,Object(_.s)(Me,r,u),e[t+0]=Me[0],e[t+1]=Me[1],e[t+2]=Me[2],t+=24,r[2]=d,Object(_.s)(Me,r,u),e[t+0]=Me[0],e[t+1]=Me[1],e[t+2]=Me[2]},b=0;b<8;++b)f(Ae.data,3*b,s[b]);return Object(P.c)(Ae)}var Ce=Object(y.d)(),Ie=Object(O.b)(),Ne=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],De=Object(N.l)(),Se=Object(N.l)(),Fe=Object(P.e)(),Me=[0,0,0],Ae={data:new Array(72),size:3},Ee=Object(y.d)()},803:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return c}));var i=r(8),n=r.n(i),a=r(42),s=r(15),o=r(4),u=r(112);function c(e){return l.apply(this,arguments)}function l(){return l=Object(s.a)(n.a.mark((function e(t){var r,i,s,c,l,d,h,f,b,v=arguments;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=v.length>1&&void 0!==v[1]?v[1]:t.popupTemplate,Object(o.k)(r)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,r.getRequiredFields(t.fieldsIndex);case 5:if(i=e.sent,s=r.lastEditInfoEnabled,c=t.objectIdField,l=t.typeIdField,d=t.globalIdField,h=t.relationships,!i.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,Object(u.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,b=Object(u.j)(t.fieldsIndex,[].concat(Object(a.a)(i),Object(a.a)(f))),e.abrupt("return",(l&&b.push(l),b&&c&&t.fieldsIndex.has(c)&&-1===b.indexOf(c)&&b.push(c),b&&d&&t.fieldsIndex.has(d)&&-1===b.indexOf(d)&&b.push(d),h&&h.forEach((function(e){var r=e.keyField;b&&r&&t.fieldsIndex.has(r)&&-1===b.indexOf(r)&&b.push(r)})),b));case 23:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}function d(e,t){return e.popupTemplate?e.popupTemplate:Object(o.k)(t)&&t.defaultPopupTemplateEnabled&&Object(o.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},836:function(e,t,r){"use strict";r.d(t,"a",(function(){return k})),r.d(t,"b",(function(){return _})),r.d(t,"c",(function(){return v})),r.d(t,"d",(function(){return m})),r.d(t,"e",(function(){return w})),r.d(t,"f",(function(){return C}));var i=r(20),n=r(17),a=r(21),s=r(4),o=r(2),u=r(3),c=function(){function e(t,r){var i=this;Object(o.a)(this,e),this._textureRep=t,this._textureId=r,this._textureRef=Object(s.c)(this._textureId,(function(e){return i._textureRep.acquire(e)}))}return Object(u.a)(e,[{key:"dispose",value:function(){var e=this;this._textureRef=Object(s.c)(this._textureId,(function(t){e._textureRep.release(t)}))}},{key:"bind",value:function(e,t,r){if(Object(s.k)(this._textureRef)){var i=this._textureRef.glTexture;e.bindTexture(i,t),e.setUniform2f(r,i.descriptor.width,i.descriptor.height)}}}]),e}(),l=r(307),d=r(121),h=r(58);var f,b=r(234);function v(e,t){var r=new Map,i=function(e,t){if(Object(s.j)(e))return-1;if(r.has(e.id)){var i=r.get(e.id);return i.usage|=t,i.id}var n=r.size;return r.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,o=t.emissiveFactor,u=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),c=u?l.a[0]:n?n.metallicFactor:1,d=u?l.a[1]:n?n.roughnessFactor:1,h="mask"===t.alphaMode?33:1,f={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:i(n&&n.baseColorTexture,h),metallicRoughnessTextureId:i(n&&n.metallicRoughnessTexture,2),metallicFactor:c,roughnessFactor:d},b={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:i(t.normalTexture,4),emissiveTextureId:i(t.emissiveTexture,16),occlusionTextureId:i(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:u},v=[];return r.forEach((function(t,r){var i=t.usage,n=Object(s.k)(e)&&e[r]&&e[r].formats,a=n?p(n.map((function(e){var t=e.name,r=e.format;return{name:t,encoding:g[r]}}))):[];v.push({id:r,usage:i,encodings:a})})),{material:b,textures:v}}function p(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var g={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},y=(f={},Object(i.a)(f,b.a.KTX2_ENCODING,2),Object(i.a)(f,b.a.BASIS_ENCODING,2),Object(i.a)(f,b.a.DDS_ENCODING,4),Object(i.a)(f,"image/png",8),Object(i.a)(f,"image/jpg",16),Object(i.a)(f,"image/jpeg",16),Object(i.a)(f,"image/ktx",32),f);function m(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,i=t&&e.materialDefinitions[t],n=r&&e.textureDefinitions[r],s=O();if(null!=i){var o=i.params;o.diffuse&&(s.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(s.doubleSided=o.doubleSided,s.cullFace=o.doubleSided?0:2),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(s.cullFace="none"===o.cullFace?0:"back"===o.cullFace?2:1),o.transparency&&(s.metallicRoughness.baseColorFactor[3]=Object(a.f)(1-o.transparency,0,1)),(o.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}var u=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(s.wrapTextures=!0);var c=1;"rgba"===n.channels&&(s.alphaMode="blend",c|=32);var l=n.images.length-1,d=n.images[l],h=function(e){return e&&e.split("/").pop()},f=Array.isArray(n.encoding)?p(n.encoding.map((function(e,t){return{name:h(d.href[t]),encoding:y[e]||0}}))):[{name:h(d.href),encoding:y[n.encoding]||0}];u.push({id:0,usage:c,encodings:f}),s.metallicRoughness.baseColorTextureId=0}return{material:s,textures:u}}var O=function(){return{alphaMode:"opaque",alphaCutoff:d.b,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function _(e,t,r,i){if(Object(s.j)(e)||null==e.data)return null;var n=e.data,o=!(n instanceof HTMLImageElement)||Object(a.l)(n.width)&&Object(a.l)(n.height),u=i.renderingContext.parameters.maxMaxAnisotropy,c=r&&!i.capabilities.shaderTextureLOD?1:u,l=o&&!e.downsampled&&c>1,d=r||!t.wrapTextures?j:x,h=function(e){switch(e){case 1:return b.a.KTX2_ENCODING;case 2:return b.a.BASIS_ENCODING;case 4:return b.a.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),f=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new b.a(n,{mipmap:l,maxAnisotropy:c,encoding:h,wrap:d,components:f,noUnpackFlip:!0})}var j={s:33071,t:33071},x={s:10497,t:10497};function k(e,t,r,i,n,o){var u=o.rendererTextureUsage,l=function(e){return function(e,t,r){if(Object(s.j)(e)||0===r)return null;for(var i=0;i<e.length;i++){var n=e[i];if(Object(s.k)(n)&&0!=(n.usage&r))return t[i].id}return null}(i,r,e&u)},f=t.metallicRoughness.baseColorFactor,b=Object(a.f)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[f[0],f[1],f[2],b],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=o.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=o.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:d.b,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var v=l(33);v&&(e.baseColorTexture=new c(n,v));var p=l(2);p&&(e.metallicRoughnessTexture=new c(n,p));var g=l(16);g&&(e.emissionTexture=new c(n,g));var y=l(8);y&&(e.occlusionTexture=new c(n,y));var m=l(4);m&&(e.normalTexture=new c(n,m)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&Object(h.i)(e)?2:e&&Object(h.j)(e)?3:1}(o.viewSpatialReference)}function w(e){var t=!!e.compressedTextureS3TC,r=!!e.compressedTextureETC,i=Object(n.a)("disable-feature:i3s-basis")?0:3;return 24|(t?4|i:0)|(r?i:0)}function C(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}},840:function(e,t,r){"use strict";r.d(t,"a",(function(){return g})),r.d(t,"b",(function(){return p})),r.d(t,"c",(function(){return f})),r.d(t,"d",(function(){return m}));var i=r(14),n=r(11),a=r(24),s=r(27),o=r(16),u=r(869),c=o.a.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function l(e,t,r){for(var i="",n=0;n<r;){var s=e[t+n];if(s<128)i+=String.fromCharCode(s),n++;else if(s>=192&&s<224){if(n+1>=r)throw new a.a("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var o=(31&s)<<6|63&e[t+n+1];i+=String.fromCharCode(o),n+=2}else if(s>=224&&s<240){if(n+2>=r)throw new a.a("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");var u=(15&s)<<12|(63&e[t+n+1])<<6|63&e[t+n+2];i+=String.fromCharCode(u),n+=3}else{if(!(s>=240&&s<248))throw new a.a("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(n+3>=r)throw new a.a("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");var c=(7&s)<<18|(63&e[t+n+1])<<12|(63&e[t+n+2])<<6|63&e[t+n+3];if(c>=65536){var l=55296+(c-65536>>10),d=56320+(1023&c);i+=String.fromCharCode(l,d)}else i+=String.fromCharCode(c);n+=4}}return i}function d(e,t){for(var r={byteOffset:0,byteCount:0,fields:Object.create(null)},i=0,n=0;n<t.length;n++){var a=t[n],s=a.valueType||a.type,o=_[s];r.fields[a.property]=o(e,i),i+=O[s].BYTES_PER_ELEMENT}return r.byteCount=i,r}function h(e,t,r){var i,n,s=[],o=0;for(n=0;n<e;n+=1){if((i=t[n])>0){if(s.push(l(r,o,i-1)),0!==r[o+i-1])throw new a.a("string-array-error","Invalid string array: missing null termination.")}else s.push(null);o+=i}return s}function f(e,t){return new(0,O[t.valueType])(e,t.byteOffset,t.count*t.valuesPerElement)}function b(e,t,r){for(var i=null!=t.header?d(e,t.header):{byteOffset:0,byteCount:0,fields:{count:r}},n={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)},o=i.byteCount,u=0;u<t.ordering.length;u++){var c=t.ordering[u],l=Object(s.a)(t[c]);if(l.count=i.fields.count,"String"===l.valueType){if(l.byteOffset=o,l.byteCount=i.fields[c+"ByteCount"],"UTF-8"!==l.encoding)throw new a.a("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding})}else{if(!j(l.valueType))throw new a.a("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});var h=x(l.valueType);o+=o%h!=0?h-o%h:0,l.byteOffset=o,l.byteCount=h*l.valuesPerElement*l.count}o+=l.byteCount,n.entries[c]=l}return n.byteCount=o-n.byteOffset,n}function v(e,t,r){if(t!==e&&c.error("Invalid ".concat(r," buffer size\n expected: ").concat(e,", actual: ").concat(t,")")),t<e)throw new a.a("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function p(e,t){var r,a=d(e,t&&t.header),s=a.byteCount,o={isDraco:!1,header:a,byteOffset:a.byteCount,byteCount:0,vertexAttributes:{}},u=a.fields,c=null!=u.vertexCount?u.vertexCount:u.count,l=Object(n.a)(t.ordering);try{for(l.s();!(r=l.n()).done;){var h=r.value;if(t.vertexAttributes[h]){var f=Object(i.a)(Object(i.a)({},t.vertexAttributes[h]),{},{byteOffset:s,count:c}),b=y[h]?y[h]:"_"+h;o.vertexAttributes[b]=f,s+=x(f.valueType)*f.valuesPerElement*c}}}catch(N){l.e(N)}finally{l.f()}var p=u.faceCount;if(t.faces&&p){o.faces={};var g,m=Object(n.a)(t.ordering);try{for(m.s();!(g=m.n()).done;){var O=g.value;if(t.faces[O]){var _=Object(i.a)(Object(i.a)({},t.faces[O]),{},{byteOffset:s,count:p});o.faces[O]=_,s+=x(_.valueType)*_.valuesPerElement*p}}}catch(N){m.e(N)}finally{m.f()}}var j=u.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&j){o.featureAttributes={};var k,w=Object(n.a)(t.featureAttributeOrder);try{for(w.s();!(k=w.n()).done;){var C=k.value;if(t.featureAttributes[C]){var I=Object(i.a)(Object(i.a)({},t.featureAttributes[C]),{},{byteOffset:s,count:j});o.featureAttributes[C]=I,s+=("UInt64"===I.valueType?8:x(I.valueType))*I.valuesPerElement*j}}}catch(N){w.e(N)}finally{w.f()}}return v(s,e.byteLength,"geometry"),o.byteCount=s-o.byteOffset,o}function g(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?function(e){var t,r={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){switch(t.value){case"position":break;case"normal":r.normal=!0;break;case"uv0":r.uv0=!0;break;case"color":r.color=!0;break;case"uv-region":r.uvRegion=!0;break;case"feature-index":r.featureIndex=!0}}}catch(a){i.e(a)}finally{i.f()}return r}(e.compressedAttributes.attributes):e?function(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}(e):function(e){var t,r={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},i=Object(n.a)(e.ordering);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(e.vertexAttributes[a])switch(a){case"position":break;case"normal":r.normal=!0;break;case"color":r.color=!0;break;case"uv0":r.uv0=!0;break;case"region":r.uvRegion=!0}}}catch(s){i.e(s)}finally{i.f()}return e.featureAttributes&&e.featureAttributeOrder&&(r.featureIndex=!0),r}(t)}var y={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function m(e,t,r){if("lepcc-rgb"===e.encoding)return Object(u.b)(t);if("lepcc-intensity"===e.encoding)return Object(u.a)(t);if(null!=e.encoding&&""!==e.encoding)throw new a.a("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(c.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(c.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var i=b(t,e,r);v(i.byteOffset+i.byteCount,t.byteLength,"attribute");var n=i.entries.attributeValues||i.entries.objectIds;if(n){if("String"===n.valueType){var s=i.entries.attributeByteCounts,o=f(t,s),l=function(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}(t,n);return h(s.count,o,l)}return f(t,n)}throw new a.a("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}var O={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},_={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}};function j(e){return O.hasOwnProperty(e)}function x(e){return j(e)?O[e].BYTES_PER_ELEMENT:0}},857:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var i=r(42),n=r(11),a=r(2),s=r(3),o=r(6),u=r(7),c=r(94),l=r(127),d=function(e){Object(o.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(a.a)(this,r),(e=t.apply(this,arguments))._map=new Map,e}return Object(s.a)(r,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,r=0;r<e.length;r++){var i=e[r],n=i.objectId,a=this._map.get(n);a?(t.add(n),i!==a&&(e[r]=a),++a.refCount):(i.refCount=1,this._map.set(n,i))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,r=[],i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),r.push(a))}}catch(u){i.e(u)}finally{i.f()}r.length>0&&this.emit("change",{added:[],removed:r})}},{key:"removeManyByObjectId",value:function(e){var t,r=[],i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),r.push(s))}}catch(o){i.e(o)}finally{i.f()}r.length>0&&this.emit("change",{added:[],removed:r})}},{key:"toArray",value:function(){return Object(i.a)(this._map.values())}},{key:"find",value:function(e){var t;return Object(l.c)(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),r}(c.a)},859:function(e,t,r){"use strict";r.d(t,"a",(function(){return Te}));var i=r(42),n=r(29),a=r(2),s=r(3),o=r(6),u=r(7),c=r(0),l=r(34),d=r(61),h=r(17),f=r(16),b=r(4),v=r(73),p=r(268),g=r(25),y=r(36),m=r(1),O=(r(18),r(12)),_=r(49),j=r(37),x=r(43),k=r(204),w=r(649),C=r(11),I=r(115),N=r(103),D=function(){function e(t){Object(a.a)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(N.b.I3S_CONTROLLER,this)}return Object(s.a)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=Object(C.a)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(r){t.e(r)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i}},{key:"sort",value:function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){Object(I.k)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}]),e}(),S=new Map;function F(e,t){var r=S.get(e);return null==r&&(r=new D(e),S.set(e,r)),r.add(t),{remove:function(){null!=r&&(r.remove(t),r.callbacks.length>0||(S.delete(e),r.destroy()),r=null)}}}var M=r(5),A=r(46),E=function e(t,r){Object(a.a)(this,e),this.id=t,this.mbs=r,this.renderMbs=Object(A.d)([0,0,0,-1]),this.imModificationImpact=4},P=function(e){Object(o.a)(r,e);var t=Object(u.a)(r);function r(e,i,n,s,o,u,c,l,d,h){var f;return Object(a.a)(this,r),(f=t.call(this,e,n)).index=i,f.childCount=s,f.level=o,f.resources=u,f.version=c,f.lodMetric=l,f.maxError=d,f.numFeatures=h,f.failed=!1,f.hasModifications=!1,f.cacheState=0,f.vertexCount=0,f.memory=0,f}return r}(E),L=function e(t,r,i,n){Object(a.a)(this,e),this.nodeHasLOD=t,this.isChosen=r,this.lodLevel=i,this.version=n},V=r(801),T=r(410),R=function e(t,r,i,n,s){Object(a.a)(this,e),this.childOffset=t,this.childCount=r,this.visibilityCache=i,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=2},U=function(){function e(t,r,i,n,s,o,u,c,l,d,h,f,b,p){Object(a.a)(this,e),this.streamDataController=i,this.viewportQueries=n,this.logger=s,this.holeFilling=o,this._isLoaded=u,this._isReloading=c,this._isSelected=l,this._enable=d,this._needsUpdate=h,this._canRequest=f,this._computeVisibilityObb=b,this._computeNodeFiltering=p,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=H(0),this._visibilityCacheVersion=H(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new v.a({deallocator:null}),this._prefetch=new v.a({deallocator:null}),this._updates=new G,this._imModificationUncategorized=new v.a({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(r)}return Object(s.a)(e,[{key:"init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=$}this.addPage(Y(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new E(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}},{key:"loadPage",value:function(e){var t=this;this._loading.add(e);var r=this.urlPrefix+e;this.streamDataController.request(r,"json").then((function(r){t._loading.delete(e),t.addPage(e,r)})).catch((function(r){t._loading.delete(e),Object(g.n)(r)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),r))}))}},{key:"addPage",value:function(e,t){for(var r=this,i=this._nodePages.length;i<e;i++)this._nodePages[i]=null;var n=[],a=[],s=t.nodes.map((function(t,i){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var u=0;u<o;u++)n.push(t.children[u]);var c="".concat(t.index),l=Object(T.b)(t.obb),d=Object(A.d)([l.center[0],l.center[1],l.center[2],Object(M.r)(l.halfSize)]),h=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,v={hasSharedResource:!1,hasFeatureData:!!f,attributes:h&&null!=h.resource?"".concat(h.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:b&&null!=b.resource?"".concat(b.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:b?b.definition:-1},p=new P(c,e*r.nodesPerPage+i,d,o,0,v,r.lastUpdate,r.lodMetric,r.lodConversion(t.lodThreshold),f?f.featureCount:null);return p.serviceObb=l,p.visibilityObb=r._computeVisibilityObb(p),p.vertexCount=f?f.vertexCount:0,new R(s,o,z(r._visibilityCacheVersion),null,p)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length,this.updateParentsAndLevel()}},{key:"updateParentsAndLevel",value:function(){var e=this,t=new Array,r=function(r,i,n){var a=e.getPage(r);if(Object(b.k)(a)){var s=X(r,e.nodesPerPage);a.parents[s]=i;var o=a.nodes[s].node;Object(b.k)(o)&&(o.level=n,t.push(r))}};for(r(this.rootIndex,-1,0);t.length;){var i=t.pop(),n=this.getNode(i);if(Object(b.k)(n))for(var a=0;a<n.childCount;a++)r(this.getChildIndex(n,a),i,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"getPage",value:function(e){return this._nodePages[Y(e,this.nodesPerPage)]}},{key:"getNodeInternal",value:function(e){var t=this.getPage(e);return Object(b.j)(t)?null:t.nodes[X(e,this.nodesPerPage)]}},{key:"addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var r=this.getParent(t),i=Object(b.k)(r)?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?i+1:i);var n=function(e){if(e)for(var t=0;t<e.length;t++){var r,i=Object(C.a)(Z);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){i.e(a)}finally{i.f()}}return{lodMetric:0,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=Object(b.t)(this.getNodeInternal(t));return o.node=new P(e.id,t,Object(A.d)(e.mbs),o.childCount,i,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=Object(T.b)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),Object(b.k)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"makeRefNode",value:function(e,t){var r=this._nodePages[0],i=r.nodes.length;return r.nodes.push(new R(0,0,z(this._visibilityCacheVersion),e,null)),this.nodeCount++,r.parents.push(t),e.renderMbs[3]=-1,Object(b.k)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),i}},{key:"populateChildren",value:function(e,t){var r=Object(b.t)(this.getNodeInternal(e)),i=Object(b.t)(this.getPage(e));r.childOffset=i.children.length,r.childCount=t.length;for(var n=0;n<t.length;n++){var a=this.makeRefNode(t[n],e);i.children.push(a)}}},{key:"getNode",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this.forAllNodes((function(r,i){(Object(b.k)(r.node)&&r.node.id===e||Object(b.k)(r.ref)&&r.ref.id===e)&&(t=i)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var r=this.getPage(e.index);if(Object(b.j)(r))return-1;var i=r.nodes[X(e.index,this.nodesPerPage)];return r.children[i.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this.getPage(e);return Object(b.k)(t)?t.parents[X(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=H(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=z(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&(B(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"invalidateGeometryVisibility",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&Object(b.k)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,Object(b.k)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;Object(b.j)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"isNodeVisible",value:function(e){var t=this.getNodeInternal(e);if(Object(b.j)(t)||Object(b.k)(t.ref)&&!t.ref.mbs)return!0;if(!W(t.visibilityCache,this._visibilityCacheVersion)){var r=t.node,i=Object(b.k)(r)&&(Object(b.j)(t.ref)||Object(b.k)(r.visibilityObb))?r:Object(b.k)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(Object(b.k)(r)||Object(b.k)(t.ref))&&2===t.filterImpact){var n=Object(b.k)(r)?r.mbs:Object(b.k)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):0}var a=Object(b.k)(r)&&1===t.filterImpact,s=!(Object(b.k)(r)&&2===r.imModificationImpact)&&(!i||this.viewportQueries.isNodeVisible(i))&&!a;return t.visibilityCache=Q(s,this._visibilityCacheVersion),s}return K(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(Object(b.k)(t)&&Object(b.k)(t.node)&&Object(b.k)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,r,i,n){var a=this.getPage(e);if(!Object(b.j)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,u=t.childOffset;u<s;++u){var c=a.children[u],l=this.getNodeInternal(c);Object(b.k)(l)&&Object(b.k)(l.node)&&this.isGeometryVisible(c)&&o.push(l)}i/=o.length;for(var d=0,h=o;d<h.length;d++){var f=h[d],v=Object(b.t)(f.node).index;this._isLoaded(v)||this._isReloading(v)?(n.delta=Math.max(n.delta,r),n.coverage+=i):this._traverseCoverage(v,f,r+1,i,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(Object(b.j)(t))return!1;if("always"===this.holeFilling)return!0;if(W(t.useAsHole,this._version))return K(t.useAsHole);var r={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,r);var i=r.delta*r.coverage<=.5;return t.useAsHole=Q(i,this._version),i}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=H(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var r=e.node;Object(b.k)(r)&&(r.imModificationImpact=4,r.visibilityObb=t._computeVisibilityObb(r),r.hasModifications&&t.invalidateGeometryVisibility(r.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this.forAllNodes((function(e){if(Object(b.k)(e)){e.filterImpact=2;var r=e.node;Object(b.k)(r)&&t.invalidateNodeVisibilityCache(r.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,r){var i=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),q.clear();var n=!0,a=new J,s=new J,o=this._imModificationUncategorized;o.clear();var u=new Set;this.traverseVisible((function(c,l,d){if(Object(b.j)(l)){var h=i.entryPriority(c);h===1/0&&(h=i.entryPriority(d));var f=Y(c,i.nodesPerPage);return q.set(f,Math.max(h,q.get(f)||0)),i._loading.has(f)||i._failedPages.has(f)||i._missing.push(f),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,h))}var v=l.node;if(i._updateNodeFeatureEstimate(v,s),Object(b.j)(v)){var p=i.entryPriority(c);return i._loading.has(c)||i._failedNodes.has(c)||(i._missing.push(c),q.set(c,p)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,p))}var g=Object(b.t)(i.getPage(c));if(0===i._missing.length&&0===i.nodesPerPage)for(var y=0;y<l.childCount;y++){var m=g.children[l.childOffset+y],O=i.getNodeInternal(m);!Object(b.k)(O)||O.node||i._loading.has(m)||i._failedNodes.has(m)||(q.set(m,i.entryPriority(m)),i._prefetch.push(m))}if(!v.failed&&v.resources.hasFeatureData)if(u.add(v.id),i._isLoaded(c)){if(a.known+=v.memory,++a.knownNodes,i._isSelected(v)?l.childCount>0&&(n=!1):(a.unremoved+=v.memory,n=!1),i._needsUpdate(v)){var _=i.entryPriority(c);q.set(c,_),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,_),i._updates.update.push(c)}}else if(v.memory&&(a.known+=v.memory,++a.knownNodes),i._isSelected(v)){if(l.childCount>0&&(n=!1),v.memory?(a.missing+=v.memory,a.known+=v.memory,++a.knownNodes):++a.missingNodes,e.indexOf(v.index)>=0)return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i.entryPriority(c)),void(i._updates.cancel=i._updates.cancel.filter((function(e){return e!==v.index})));if(t.done||!i._enable(v)){var j=i.entryPriority(c);q.set(c,j),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,j),i._updates.add.push(c),i.layerHasModifications&&r&&Object(b.k)(v)&&4===v.imModificationImpact&&o.push(c)}else t.madeProgress()}else i._isReloading(c)&&i._updates.remove.push(c)}));var c=this._updates.add;c.length>0&&this.layerHasModifications&&(o.length>0&&r(o),c.filterInPlace((function(e){var t=i.getNodeInternal(e),r=Object(b.j)(t)||Object(b.j)(t.node)||2!==t.node.imModificationImpact;return r||i.invalidateNodeVisibilityCache(e),r}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||i._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return q.get(e)-q.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=q.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return q.get(e)>=i._maxUnloadedPrio})).sort((function(e,t){return q.get(e)-q.get(t)})),this._updates.update.sort((function(e,t){return q.get(e)-q.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,q.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,a=r,s=10;s--;){var o=new J;if(this._updateFeatureEstimate(i,o),this._computeFeatureEstimate(o)<=e){if(i>=t||o.missingNodes>0||0===s)break;a=i,i=.5*(i+n)}else n=i,i=.5*(i+a)}return this._version=H(this._version),this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)}},{key:"_updateFeatureEstimate",value:function(e,t){var r=this;this._version=H(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,i){return r._updateNodeFeatureEstimate(Object(b.k)(i)&&i.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!(Object(b.j)(e)||e.failed||Object(b.j)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(Object(b.k)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return q.get(e)-q.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if(Object(b.j)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&W(t.version,this._version))return t;var r=this.viewportQueries.getLodLevel(e),i=this.viewportQueries.hasLOD(e),n=!0;if(i){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&r>s.lodLevel}else n=r>0}else n=0===e.childCount;return t?(t.lodLevel=r,t.isChosen=n,t.version=Q(!0,this._version),t):(t=new L(i,n,r,Q(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var r=Object(b.t)(this.getNodeInternal(e)).ref;if(Object(b.j)(r))this._failedNodes.add(e);else{var i=r.id,n=this.urlPrefix+i,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(r){a();var n=t._validateNode(i,r);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t.addNode(n,e);t.nodeTraversalState(s)}}),(function(r){a(),Object(g.n)(r)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var i=function(t){return r.logger.error("#validateNode()",r.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)i("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&r.logger.error("#validateNode()",r.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!r.ignoreServiceObb?t.obb:null,a=new E("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=r._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:i,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){Object(b.k)(e.node)&&(e.node.failed=!1)}))}},{key:"entryPriority",value:function(e){var t=this.getNodeInternal(e),r=this.getParentIndex(e);if(Object(b.j)(t)||r<0&&null==t.node)return r<0?1/0:this.entryPriority(r);var i=0;if(t.node&&r>=0){var n=this._nodeTraversalState.get(r);null!=n&&(i=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=Object(b.k)(t.ref)?this.viewportQueries.distToPOI(t.ref):Object(b.k)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-i*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this.getNodeInternal(this.rootIndex);Object(b.j)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,r,i){if(r.node&&0===r.childCount)this.isGeometryVisible(e)&&i(e,r,t);else if(this.isNodeVisible(e)&&(i(e,r,t),null!=r.node)){var n=this.nodeTraversalState(r.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=Object(b.t)(this.getPage(e)),s=0;s<r.childCount;s++){var o=a.children[r.childOffset+s],u=this.getNodeInternal(o);Object(b.k)(u)?this._traverseVisible(o,e,u,i):i(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var r=e.index,i=this.getNodeInternal(r);Object(b.k)(i)&&this._traverseChildren(r,i,t)}},{key:"_traverseChildren",value:function(e,t,r){var i=this.getPage(e);if(!Object(b.j)(i))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=i.children[a],o=this.getNodeInternal(s);Object(b.k)(o)&&Object(b.k)(o.node)&&r(o.node)&&this._traverseChildren(s,o,r)}}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e){this.forAllNodes(B),this.viewportQueries.updateElevationInfo(e)}},{key:"forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var r=this._nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}}}]),e}(),q=new Map,G=function(){function e(){Object(a.a)(this,e),this.update=new v.a({deallocator:null}),this.add=new v.a({deallocator:null}),this.remove=new v.a({deallocator:null}),this.cancel=[]}return Object(s.a)(e,[{key:"reset",value:function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}]),e}();function B(e){Object(b.k)(e.node)&&(e.node.renderMbs[3]=-1,Object(b.k)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),Object(b.k)(e.ref)&&(e.ref.renderMbs[3]=-1,Object(b.k)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function z(e){return Object(V.a)(e,-2)}function H(e){return Object(V.a)(e,2)}function Q(e,t){return t+(e?1:0)}function W(e,t){return(-2&e)===t}function K(e){return 1==(1&e)}function Y(e,t){return 0===t?0:e/t|0}function X(e,t){return 0===t?e:e%t}var Z=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];var J=function e(){Object(a.a)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function $(e){return Math.sqrt(e*(4/Math.PI))}var ee=function(){function e(t){Object(a.a)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return Object(s.a)(e,[{key:"startNodeLoading",value:function(e,t,r,i){this._maxLodLevel=i.maxLodLevel,this._index=r,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if(Object(b.j)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));te.clear(),this._lodGlobalHandling(this._index.rootNode,r,!1);var i=te.length;this._removeNodes(te,e);var n=te.length<i;return 0!==te.length&&(this._lodGlobalDirty=!0),te.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,r){if(Object(b.j)(e))return!1;var i=e.index,n=this._index,a=this.layerView,s=n.nodeTraversalState(e),o=this.isChosenMaxLOD(s),u=a.isNodeLoaded(i),c=a.nodeCrossfadingEnabled;if(c&&u&&o){var l=!r&&this.hasNoVisibleChildren(e);a.fadeNode(i,0,!l)}var d=u&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(i));if(u&&(a.updateNodeState(i,o?1:0),o))return d&&this._removeChildrenRecursive(e),d;var h=e.childCount>0,f=h;if(h)for(var v=0;v<e.childCount;v++){var p=n.getChildIndex(e,v),g=n.getNode(p);Object(b.k)(g)?n.isGeometryVisible(p)&&!this._lodGlobalHandling(g,t,r||d)&&this._isNodeInScaleBounds(g)&&(f=!1):n.isNodeVisible(p)&&(f=!1)}var y=u&&!o&&(f||te.length<t);y&&te.push(i),!c||y||!u||r||f||a.fadeNode(i,0,!1);var m=!e.resources.hasFeatureData;return f||d&&!y||m}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&te.push(e.index),!0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,r=!0;return this._index.traverseChildren(e,(function(e){return!(!r||!t._index.isNodeVisible(e.index))&&(!t.layerView.isNodeLoaded(e.index)||(r=!1,!1))})),r}},{key:"_childrenRequireLoading",value:function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,(function(e){if(!i||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)})),i&&r}},{key:"isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),te=new v.a({deallocator:null}),re=r(8),ie=r.n(re),ne=r(15),ae=r(142),se=r(27),oe=r(44),ue=r(840),ce=r(836),le=function(){function e(t,r,i,n,s,o){if(Object(a.a)(this,e),this.streamDataController=r,this.logger=i,this.defaultGeometrySchema=n,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var u=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return Object(ce.c)(u,e)}))}}return Object(s.a)(e,[{key:"load",value:function(e,t,r){return this.streamDataController.request(e,t,r)}},{key:"loadAttribute",value:function(e,t,r){var i="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this.load(i,"binary",r).then((function(e){return Object(ue.d)(t,e)}))}},{key:"loadAttributes",value:function(e,t,r){var i=this;return Object(g.k)(t.map((function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var n={},a=0;a<t.length;++a)if(r[a].value)n[t[a].name]=r[a].value;else{if(Object(g.n)(r[a].error))throw r[a].error;i.logger.error("#loadAttributes",i.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),r[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=Object(ne.a)(ie.a.mark((function e(t,r){var i,n,a,s,o,u,c,l,d,h,f,v,p,g,y,m,O,_,j,x,k,w;return ie.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null!=this.requiredAttributes&&t.resources.attributes?Object(ae.d)(this.loadAttributes(t,this.requiredAttributes,r)):null,n=be(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,u=o?Object(ae.d)(this.loadGeometry(t.resources.geometry,s,r)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this.loadShared(t,r);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(c=e.t0,l=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=c?Object(ce.d)(c):null,d=l&&l.material,h=l&&l.textures,f="".concat(t.id),!(v=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this.loadFeatureData(f,r);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(p=e.t1,g=v?de(p):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:d}}],featureDataPosition:[0,0,0]},y=Object(b.j)(g)&&he(p),m=null!=h&&h.length>0?Object(ae.d)(this.loadTextures(t,h,r)):null,O=null,_=null,!u){e.next=39;break}return e.t2=ae.a,e.next=35,u;case 35:e.t3=e.sent,O=(0,e.t2)(e.t3),j=fe(this.defaultGeometrySchema,c),_=Object(ue.a)(a,j);case 39:if(!m){e.next=47;break}return e.t5=ae.a,e.next=43,m;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(x=e.t4,!i){e.next=57;break}return e.t8=ae.a,e.next=53,i;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:return k=e.t7,w=k?{attributeData:k,loadedAttributes:this.requiredAttributes}:null,e.abrupt("return",Object(b.k)(g)?{geometryData:g,attributeDataInfo:w,geometryBuffer:O,geometryDescriptor:_,requiredTextures:h,textureData:x}:Object(b.k)(y)?{pointData:y,attributeDataInfo:w,geometryBuffer:O,geometryDescriptor:_,requiredTextures:h,textureData:x}:Promise.reject());case 61:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"loadShared",value:function(t,r){var i="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this.load(i,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t}))}},{key:"loadTexture",value:function(e,t,r,i,n,a){var s=!1;return 4===n||1===n||2===n?this.load(e,"binary",a).then((function(e){return{id:t,usage:r,data:e,encoding:n,downsampled:s}})):this.load(e,"image",a).then((function(e){var a=e;if(i&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),u=Math.ceil(e.height/2),c=document.createElement("canvas");c.width=o,c.height=u,c.getContext("2d").drawImage(e,0,0,o,u),a=c,s=!0}return{id:t,usage:r,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,r){var i=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Object(ce.f)(t.encodings,i.options.textureEncodings);if(null==s)return i.logger.error("#loadTextures",i.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,u="".concat(i.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return i.loadTexture(u,t.id,t.usage,n,s.encoding,r)})))}},{key:"loadFeatureData",value:function(e,t){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this.load(r,"json",t)}},{key:"loadGeometry",value:function(e,t,r){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this.load(i,"binary",r)}}],[{key:"addAbsoluteHrefTexture",value:function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++){var a,s=n[i],o=Object(C.a)(r[s].images);try{for(o.s();!(a=o.n()).done;){var u=a.value;Array.isArray(u.href)?u.hrefConcat=u.href.map((function(e){return Object(oe.A)(e,t)})):u.hrefConcat=Object(oe.A)(u.href,t)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var a=i.encoding[n];"data:"===a.substring(0,5)&&(i.encoding[n]=a.substring(5))}else{var s=i.encoding;"data:"===s.substring(0,5)&&(i.encoding=s.substring(5))}}}}]),e}();function de(e){var t,r=Object(C.a)(e.featureData);try{for(r.s();!(t=r.n()).done;){var i=t.value,n=i.geometries;if(null!=n){var a,s=Object(C.a)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[i.id],featureDataPosition:i.position,geometries:[o]}}}catch(u){s.e(u)}finally{s.f()}}}}catch(u){r.e(u)}finally{r.f()}return null}function he(e){var t,r=new Array,i=Object(C.a)(e.featureData);try{for(i.s();!(t=i.n()).done;){var n=t.value;null!=n.position&&r.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){i.e(a)}finally{i.f()}return r}function fe(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Object(se.a)(e)).vertexAttributes.region,e}function be(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var n=0;n<i.length;n++){var a=i[n];if(null==a.compressedAttributes)r.bufferIndex=n,r.bufferDefinition=i[n];else if("draco"===a.compressedAttributes.encoding&&!Object(h.a)("disable-feature:i3s-draco"))return r.bufferIndex=n,r.bufferDefinition=a,r}return r}var ve=function(){function e(t,r){Object(a.a)(this,e),this.requester=t,this.apiKey=r,this.activeRequests=new Set}return Object(s.a)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,r){var i=this,n=Object(g.e)(),a=Object(g.t)(r,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),u={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(u),Object(g.c)(o,(function(){var e;u.abortController=null,null==(e=u.abortHandle)||e.remove(),u.abortHandle=null,i.activeRequests.delete(u)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,r;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(r=e.abortHandle)||r.remove()})),this.activeRequests.clear()}}]),e}(),pe=r(10),ge=r(55),ye=r(70),me=r(135),Oe=r(74),_e=r(71),je=r(173),xe=r(261),ke=1e5,we=function(){function e(t,r,i,n,s,o,u){var c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};Object(a.a)(this,e),this.indexSR=t,this._renderCoordsHelper=r,this.extent=s,this.elevationProvider=o,this.options=c,this._frustum=Object(me.c)(),this._useFrustumCulling=!1,this._poi=Object(pe.e)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=Object(pe.e)(),this._tmp2=Object(pe.e)(),this._tmp3=Object(pe.e)(),this._tmp0=Object(pe.e)(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(i,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(u),this.tmpPoint=Object(k.j)(0,0,0,t)}return Object(s.a)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=je.a.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Object(xe.c)(Object(xe.f)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&Object(me.e)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}},{key:"updateExtent",value:function(e){this.extent=e}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return t[3]<0&&(Object(ge.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=Object(_e.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),Object(_.p)(t,this.indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if(Object(b.k)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb;return Object(b.j)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,r){if(Object(b.j)(t)&&(t=Object(T.e)()),t.halfSize[0]<0){var i=0;this._elevationContext&&r<ke&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],i=Object(_e.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),Object(V.v)(e,this.indexSR,t,this.engineSR,i)}return t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;var r=this.getVisibilityObb(e);return Object(b.k)(r)?Object(T.h)(r,this._frustum):Object(me.j)(this._frustum,Object(Oe.n)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return Object(b.k)(t)?Object(T.h)(t,this._frustum):this.isNodeVisible(e)}},{key:"isMBSinExtent",value:function(e){return!this.extent||0!==Object(V.s)(this.extent,e)}},{key:"screenSpaceDiameterMbs",value:function(e,t){var r=this.getRenderMbs(e),i=Math.sqrt(Object(M.n)(r,this._camPos)),n=i-r[3];return this._updateMinMaxDistance(i),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),r=Object(M.o)(t,this._camPos);return this._updateMinMaxDistance(r),r}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),r=t[3],i=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/Object(M.r)(t)+r)/Object(M.o)(t,this._camPos);return Math.min(1,i)}},{key:"hasLOD",value:function(e){return 0!==e.lodMetric}},{key:"getDistancePlanarMode",value:function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],a=r*r+i*i,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"getDistanceGlobeMode",value:function(e,t){var r=Object(M.r)(t),i=Object(M.r)(e)-r;Object(M.g)(this._tmp0,e,Object(M.j)(e,t)/Object(M.v)(e));var n=Object(M.n)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(i);var s=Object(M.g)(this._tmp0,t,1/r),o=r,u=a*a/2/o,c=Object(M.g)(this._tmp1,s,o-u),l=e,d=Object(M.l)(this._tmp2,l,c),h=Object(M.l)(this._tmp2,d,Object(M.g)(this._tmp3,s,Object(M.j)(s,d))),f=Object(M.h)(this._tmp2,c,Object(M.g)(this._tmp2,h,a/Object(M.r)(h))),b=Object(M.o)(l,f);if(i>=2e5){var v=Object(M.l)(this._tmp1,l,f),p=Object(M.j)(v,s)/Object(M.r)(v);p<.08&&(p=1e-4),b/=p}return b}},{key:"getDistance",value:function(e,t){return this.engineSR===Object(ye.g)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,a=i+r[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case 1:var s=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return Object(M.o)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return Object(M.o)(this._camPos,this._poi)}}]),e}(),Ce=r(498),Ie=r(603),Ne=r(504),De=f.a.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Se=1e-4,Fe=function(e){Object(o.a)(r,e);var t=Object(u.a)(r);function r(e){var i;return Object(a.a)(this,r),(i=t.call(this,e)).screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingProgress=1,i.leavesReached=!1,i.scaleVisibilityEnabled=!0,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._newLoadingNodes=new v.a({deallocator:null}),i._loadedNodeScales=new Map,i._modificationsNodeFilteringArray=new v.a,i._downloadingCount=0,i._loadingNodes=new Map,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._requiredAttributes=new Array,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i._disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new d.a,i._idleQueue=new w.a,i._elevationUpdateNodes=new v.a({deallocator:null}),i._errorCount=0,i}return Object(s.a)(r,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new ve(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(3);return new ve(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return Object(V.r)(this.layer)}},{key:"crsIndex",get:function(){return Object(V.p)(this.layer)}},{key:"rootNodeVisible",get:function(){if(Object(b.k)(this._index)){var e=this._index.rootNode;if(Object(b.k)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new ee(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=Object(h.a)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((function(r){var i,a=Object(n.a)(r,1)[0];if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var s=e.layerView.view;e._setClippingArea(s.clippingArea);var o=e.layerView.view.resourceController;e._handles.add([Object(y.a)(s,"pointsOfInterest.focus.renderLocation",(function(t){return e._pointOfInterestChanged(t)})),o.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),Object(y.a)(e.layerView,"suspended",(function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},i=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=i):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(r,i)})),F(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),s.state.watch("contentCamera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return Object(b.k)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new we(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,s.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new U(t,a,e.indexStreamController,e._viewportQueries,De,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}),null!=(i=e.layerView)&&i.computeNodeFiltering?function(t){return e.layerView.computeNodeFiltering(t)}:void 0);var u=Object(b.k)(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(u),e._startNodeLoading()}}))),this._tmpPoint=Object(k.j)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,r=this._index,i=this.layerView;Object(b.k)(r)&&i&&i.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var i=r.getNode(e);Object(b.k)(i)&&t._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Ae.prune(),Object(b.k)(Me)&&(Me.hide(),Me=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map((function(r){var i=Pe(e,r),n=Pe(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null})).filter((function(e){return null!=e&&e.name!==r}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Ee(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=Object(j.h)();Object(Ce.a)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){Object(b.k)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),Object(b.k)(this._index)&&(this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),Object(b.k)(this._viewportQueries)&&Object(b.k)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var r=this,i=this._index;if(!Object(b.j)(i)){var n=i.rootNode;if(!Object(b.j)(n)){var a=this._elevationUpdateNodes;a.clear(),Object(V.l)(e,t,n,this.crsIndex,i,(function(e){return a.push(e.index)})),a.forAll((function(e){i.invalidateBoundingVolumeCache(e),e===n.index&&r.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}}},{key:"getParentIndex",value:function(e){return Object(b.k)(this._index)&&this._index.getParentIndex(e)}},{key:"_elevationInfoChanged",value:function(){Object(b.k)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t,r){var i=this,n=this._index;if(!Object(b.j)(n)){var a=n.rootNode;!Object(b.j)(a)&&Object(_.o)(t,r,Ve,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,r){var a=n.getNode(r);Object(b.k)(a)&&Object(x.h)(Ve,a.mbs)&&i._loadedNodeScales.set(r,e)}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=Object(Ne.a)(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)}},{key:"unloadedMemoryEstimate",get:function(){return Object(b.j)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return Object(b.k)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||Object(b.j)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(r){this._errorCount<50?De.error("Error during processing: "+r):50===this._errorCount&&De.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var r=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!Object(b.j)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return r._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return r._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return r._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return r._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return r._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}}},{key:"_processIndex",value:function(e){var t=this;if(Object(b.j)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Object(i.a)(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var r=this._index.featureEstimate.leavesReached;this._index.isLoading()||r===this._get("leavesReached")||this._set("leavesReached",r)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(Object(b.j)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.isGraphics3D&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.featureEstimate;if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Se)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=Se)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Se,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(Object(b.j)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=t.getParent(r);Object(b.k)(i)&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=t.getParent(i.index))if(this._enableFromGPUCache(i,0)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(Object(b.j)(this._index))return!1;var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!e.done;)this.layerView.removeNode(i.remove.pop()),e.madeProgress();for(;i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());Object(b.k)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0;){--r;var a=this._index.getNode(i.add.back());if(Object(b.j)(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Ie.b&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var r=(Object(b.k)(this._index)?this._index.getIndexMissing():0)+3*(Object(b.k)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=this.layerView.view,t=e.state,r=t.contentCamera,i=t.fixedContentCamera;this.screenSizeFactor=1/(r.perScreenPixelRatio/2),this._viewportQueries.updateCamera(r,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"updateBoundingVolume",value:function(e){Object(b.k)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){Object(b.k)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){if(Object(b.k)(this._index)){var e=Object(b.k)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"_shouldDropNode",value:function(e){if(Object(b.j)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||Object(b.j)(t)||Object(b.j)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var r={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new le(this.layer,this.dataStreamController,De,this._defaultGeometrySchema,this._requiredAttributes,r),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,r){return e._removeNodes(t,r,1)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,r=this._index;if(Object(b.j)(r)||Object(b.j)(this._viewportQueries))return!1;Ae.clear(),this.layerView.getLoadedNodeIndices(Ae);var i=0===this._viewportQueries.maxDistance,n=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return Ae.filterInPlace((function(e){var i=r.getNode(e);return Object(b.j)(i)||!r.isGeometryVisible(e)||n(i)||!t._isNodeInScaleBounds(i)})),Ae.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Ae,e,0),!(i&&this.lodDropFactor<1)&&(0===Ae.length||(Ae.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Ae.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Ae,N.d,0)}},{key:"_removeNodes",value:function(e,t,r){var i=e.length;if(0!==i&&!t.done){for(Object(b.k)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;1===r&&this.layerView.nodeFadeoutEnabled&&Object(b.k)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,1,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<i;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,r=Object(g.e)();this._updatingNodes.set(e.index,r),(Ee(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,r.signal)).then((function(i){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:i},r.signal)}),r.signal)})).catch((function(i){if(!Object(g.n)(i))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},r.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))De.error("already loading node "+e.index);else{var r=Object(g.e)();this._loadingNodes.set(e.index,r);var i=function(){t._loadingNodes.get(e.index)===r&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,r.signal).then(i).catch((function(e){if(i(),!Object(g.n)(e))throw e}))}}},{key:"_loadAndAddNode",value:function(e,t){var r=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,Object(b.k)(r._index)&&r._index.updates.add.push(e.index))})).catch((function(t){if(!Object(g.n)(t))throw e.cacheState=1,t}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||Object(b.j)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return Object(b.k)(t)&&Object(b.k)(t.attributeInfo)&&Ee(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){Object(b.k)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_loadCached",value:function(e,t){var r=this;if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((function(){return i.loadCachedNodeData(e,t,(function(t,i){return r._nodeLoader.loadTextures(e,t,i)}))}),t).then((function(n){if(Object(b.j)(n))return!1;var a=r._requiredAttributes;return r.reschedule((function(){return r._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return r.reschedule((function(){return i.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return r._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var r=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw r._downloadingCount--,e})).then((function(i){return r._downloadingCount--,r.schedule((function(){return r.layerView.addNode(e,i,t)}),t)})).then((function(){r._nodeAdded(),e.cacheState=2})).catch((function(t){if(!Object(g.n)(t))throw De.error("#loadNodeData()",r.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,Object(b.k)(r._index)&&r._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&Object(b.k)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=Object(Ne.a)(this.layer),i=r.minScale,n=r.maxScale;return Object(Ne.d)(t,i,n)}},{key:"updateStats",value:function(e){e.index=Object(b.k)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),Object(b.k)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){Object(b.k)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),Object(b.k)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;Object(b.k)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),r}(Object(p.b)(l.a));Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"isMeshPyramid",null),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"isGraphics3D",null),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"indexStreamController",null),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"dataStreamController",null),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"crsVertex",null),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"crsIndex",null),Object(c.a)([Object(m.b)()],Fe.prototype,"screenSizeFactor",void 0),Object(c.a)([Object(m.b)()],Fe.prototype,"featureTarget",void 0),Object(c.a)([Object(m.b)()],Fe.prototype,"fixedFeatureTarget",void 0),Object(c.a)([Object(m.b)()],Fe.prototype,"layerView",void 0),Object(c.a)([Object(m.b)()],Fe.prototype,"layer",void 0),Object(c.a)([Object(m.b)({})],Fe.prototype,"updating",void 0),Object(c.a)([Object(m.b)({})],Fe.prototype,"updatingProgress",void 0),Object(c.a)([Object(m.b)({readOnly:!0})],Fe.prototype,"leavesReached",void 0),Object(c.a)([Object(m.b)({constructOnly:!0})],Fe.prototype,"scaleVisibilityEnabled",void 0),Object(c.a)([Object(m.b)({readOnly:!0,dependsOn:[]})],Fe.prototype,"rootNodeVisible",null),Fe=Object(c.a)([Object(O.a)("esri.layers.graphics.controllers.I3SOnDemandController")],Fe);var Me,Ae=new v.a({deallocator:null});function Ee(e,t){return Object(b.k)(e)&&e.length===t.length&&e.every((function(e){return Pe(t,e.name)>=0}))}function Pe(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}var Le={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ve=Object(x.l)(),Te=Fe},860:function(e,t,r){"use strict";r.d(t,"a",(function(){return w}));var i=r(42),n=r(8),a=r.n(n),s=r(15),o=r(29),u=r(11),c=r(2),l=r(3),d=r(107),h=r(115),f=r(142),b=r(505),v=r(16),p=r(4),g=r(25),y=r(187),m=r(171);function O(e,t,r){return _.apply(this,arguments)}function _(){return(_=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,o,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=r.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(r.maxRecordCountFactor=x(t)),n=j(t),s=t.capabilities.query.supportsPagination,r.start=0,r.num=n,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(r,i);case 6:if(u=e.sent,Object(p.j)(o)?o=u:o.features=o.features.concat(u.features),o.exceededTransferLimit=u.exceededTransferLimit,s&&u.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:r.start+=n;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return x(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function x(e){return e.capabilities.query.supportsMaxRecordCountFactor?m.a.MAX_MAX_RECORD_COUNT_FACTOR:1}var k=v.a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),w=function(){function e(t,r){var i=this;Object(c.a)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=Object(g.e)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=N,this.memCache=r.getMemCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return i.pendingFetchAbortController=null}))}return Object(l.a)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),Object(p.j)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var r=this.interactiveEditingSessions,i=new C(e,{rollback:function(){Object(h.j)(r,i),0===r.length&&(t.interactiveEditingSessions=null)},commit:function(r){var i,n=Object(u.a)(r);try{for(n.s();!(i=n.n()).done;){var a=Object(o.a)(i.value,2),s=a[0],c=a[1];t.updateValue(e,s,c)}}catch(l){n.e(l)}finally{n.f()}}});return r.unshift(i),i}},{key:"apply",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,o,u,c,l,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(p.j)(r)){e.next=2;break}return e.abrupt("return");case 2:if(n=r.loadedAttributes,s=r.attributeData,!Object(p.j)(n)&&0!==n.length&&!Object(p.j)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(g.A)(this.pendingFetchChangedObjectIds,i);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:n,attributeData:s},u=this.getOverridesFromCache(t,o,this.changedObjectIds),c=u.objectIds,l=u.fieldNames,e.next=15,this.queryOverridesFromAssociatedLayer(c,l,i);case 15:d=e.sent,Object(p.j)(d)||this.processOverridesFromAssociatedLayer(t,d,l,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,r){this.changedObjectIds.add(e),this.cacheValue(e,t,r)}},{key:"cacheValue",value:function(e,t,r){this.memCache.put(this.getCacheKey(e,t),r,this.memCacheValueSize(r))}},{key:"getOverridesFromCache",value:function(e,t,r){var i,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,c=Object(u.a)(n);try{for(c.s();!(i=c.n()).done;){var l=i.value;o[l.index]=a[l.name]}}catch(y){c.e(y)}finally{c.f()}for(var d=new Set,h=0;h<e.length;h++){var f=e[h];if(r.has(f)){var b,v=Object(u.a)(n);try{for(v.s();!(b=v.n()).done;){var p=b.value,g=this.fromCache(f,p.index);void 0===g?(s.add(f),d.add(p.name)):o[p.index][h]=g}}catch(y){v.e(y)}finally{v.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(d)}}},{key:"fromCache",value:function(e,t){var r=this.fromInteractiveEditingSession(e,t);if(void 0!==r)return r;var i=this.getCacheKey(e,t);return this.memCache.get(i)}},{key:"fromInteractiveEditingSession",value:function(e,t){if(!Object(p.j)(this.interactiveEditingSessions)){var r,i=Object(u.a)(this.interactiveEditingSessions);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){i.e(s)}finally{i.f()}}}},{key:"getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"queryOverridesFromAssociatedLayer",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,n){var s,o,u,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==r.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning()),s=Object(p.t)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat(Object(i.a)(r)),o.cacheHint=!0,o.objectIds=t,u=j(s),c=t.length>u?Object(h.n)(t,u).map((function(e){var t=o.clone();return t.objectIds=e,Object(f.e)(O(s,t,{signal:n}))})):[Object(f.e)(O(s,o,{signal:n}))],e.next=8,Promise.all(c);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat(Object(y.b)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),k.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"processOverridesFromAssociatedLayer",value:function(e,t,r,i){var n,a=i.loadedAttributes,s=i.attributeData,o=Object(p.t)(this.layer.associatedLayer).objectIdField,c=r.map((function(e){return s[e]})),l=new Map(a.map((function(e){return[e.name,e.index]}))),d=r.map((function(e){return l.get(e)})),h=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=Object(u.a)(t);try{for(f.s();!(n=f.n()).done;)for(var b=n.value,v=b.attributes[o],g=0;g<r.length;g++){var y=d[g],m=h.get(v),O=b.attributes[r[g]];c[g][m]=O,this.cacheValue(v,y,O)}}catch(_){f.e(_)}finally{f.f()}}},{key:"memCacheValueSize",value:function(e){return"string"==typeof e?Object(b.d)(e):Object(b.c)()}},{key:"fetchChangedObjectIds",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,n,s,o,u,c,l,h,b,v;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!Object(p.j)(s.associatedLayer)&&null!=(r=s.associatedLayer.capabilities)&&null!=(i=r.operations)&&i.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this.getFetchChangedObjectIdsServerGen(),!Object(p.j)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return u=s.associatedLayer.layerId,e.next=12,Object(f.d)(Object(d.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(u),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:u,serverGen:o}])},timeout:I,signal:t}));case 12:if(c=e.sent,l=c.ok&&null!=(n=c.value.data)&&n.edits?Object(p.i)(c.value.data.edits[0],"objectIds","updates"):null,Object(p.k)(l))for((h=Math.min(this._maximumNumberOfEditOVerrides,l.length))<l.length&&(this.warnMaximumChangedObjectsExceeded=!0),b=l.sort((function(e,t){return e-t})),v=0;v<h;v++)this.changedObjectIds.add(b[v]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if(Object(p.k)(e.serviceUpdateTimeStamp)&&Object(p.k)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return Object(p.k)(t)&&Object(p.k)(t.serverGens)&&Object(p.k)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,r=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return r._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){r._maximumNumberOfEditOVerrides=e}}}}]),e}(),C=function(){function e(t,r){Object(c.a)(this,e),this.objectId=t,this.options=r,this.updates=new Map,this.state=0}return Object(l.a)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=2,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return 0===this.state}}]),e}(),I=1e4,N=5e4},869:function(e,t,r){"use strict";r.d(t,"a",(function(){return Q})),r.d(t,"b",(function(){return V})),r.d(t,"c",(function(){return C}));var i=r(24),n=!0,a=0,s=10,o=10,u=12,c=16;function l(e,t,r){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,r+a,s)),version:t.getUint16(r+o,n),checksum:t.getUint32(r+u,n)}}var d=0,h=4,f=8,b=16,v=24,p=32,g=40,y=48,m=56,O=64,_=72,j=80,x=84,k=88;function w(e,t){return{sizeLo:e.getUint32(t+d,n),sizeHi:e.getUint32(t+h,n),minX:e.getFloat64(t+f,n),minY:e.getFloat64(t+b,n),minZ:e.getFloat64(t+v,n),maxX:e.getFloat64(t+p,n),maxY:e.getFloat64(t+g,n),maxZ:e.getFloat64(t+y,n),errorX:e.getFloat64(t+m,n),errorY:e.getFloat64(t+O,n),errorZ:e.getFloat64(t+_,n),count:e.getUint32(t+j,n),reserved:e.getUint32(t+x,n)}}function C(e){var t=new DataView(e,0),r=0,n=l(e,t,r),a=n.identifier,s=n.version;if(r+=c,"LEPCC     "!==a)throw new i.a("lepcc-decode-error","Bad identifier");if(s>1)throw new i.a("lepcc-decode-error","Unknown version");var o=w(t,r);if(r+=k,o.sizeHi*Math.pow(2,32)+o.sizeLo!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");var u=new Float64Array(3*o.count),d=[],h=[],f=[],b=[];if(r=I(e,r,d),r=I(e,r,h),r=I(e,r,f),(r=I(e,r,b))!==e.byteLength)throw new i.a("lepcc-decode-error","Bad length");for(var v=0,p=0,g=0;g<d.length;g++){p+=d[g];for(var y=0,m=0;m<h[g];m++){y+=f[v];var O=b[v];u[3*v]=Math.min(o.maxX,o.minX+2*o.errorX*y),u[3*v+1]=Math.min(o.maxY,o.minY+2*o.errorY*p),u[3*v+2]=Math.min(o.maxZ,o.minZ+2*o.errorZ*O),v++}}return{errorX:o.errorX,errorY:o.errorY,errorZ:o.errorZ,result:u}}function I(e,t,r){var i=[];t=N(e,t,i);for(var n=[],a=0;a<i.length;a++){n.length=0,t=N(e,t,n);for(var s=0;s<n.length;s++)r.push(n[s]+i[a])}return t}function N(e,t,r){var a=new DataView(e,t),s=a.getUint8(0),o=31&s,u=!!(32&s),c=(192&s)>>6,l=0;if(0===c)l=a.getUint32(1,n),t+=5;else if(1===c)l=a.getUint16(1,n),t+=3;else{if(2!==c)throw new i.a("lepcc-decode-error","Bad count type");l=a.getUint8(1),t+=2}if(u)throw new i.a("lepcc-decode-error","LUT not implemented");for(var d=Math.ceil(l*o/8),h=new Uint8Array(e,t,d),f=0,b=0,v=0,p=-1>>>32-o,g=0;g<l;g++){for(;b<o;)f|=h[v]<<b,b+=8,v+=1;r[g]=f&p,f>>>=o,(b-=o)+o>32&&(f|=h[v-1]>>8-b)}return t+v}var D=0,S=4,F=8,M=12,A=14,E=15,P=16;function L(e,t){return{sizeLo:e.getUint32(t+D,n),sizeHi:e.getUint32(t+S,n),count:e.getUint32(t+F,n),colorMapCount:e.getUint16(t+M,n),lookupMethod:e.getUint8(t+A),compressionMethod:e.getUint8(t+E)}}function V(e){var t=new DataView(e,0),r=0,n=l(e,t,r),a=n.identifier,s=n.version;if(r+=c,"ClusterRGB"!==a)throw new i.a("lepcc-decode-error","Bad identifier");if(s>1)throw new i.a("lepcc-decode-error","Unknown version");var o=L(t,r);if(r+=P,o.sizeHi*Math.pow(2,32)+o.sizeLo!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");if((2===o.lookupMethod||1===o.lookupMethod)&&0===o.compressionMethod){if(3*o.colorMapCount+o.count+r!==e.byteLength||o.colorMapCount>256)throw new i.a("lepcc-decode-error","Bad count");for(var u=new Uint8Array(e,r,3*o.colorMapCount),d=new Uint8Array(e,r+3*o.colorMapCount,o.count),h=new Uint8Array(3*o.count),f=0;f<o.count;f++){var b=d[f];h[3*f]=u[3*b],h[3*f+1]=u[3*b+1],h[3*f+2]=u[3*b+2]}return h}if(0===o.lookupMethod&&0===o.compressionMethod){if(3*o.count+r!==e.byteLength||0!==o.colorMapCount)throw new i.a("lepcc-decode-error","Bad count");return new Uint8Array(e,r).slice()}if(o.lookupMethod<=2&&1===o.compressionMethod){if(r+3!==e.byteLength||1!==o.colorMapCount)throw new i.a("lepcc-decode-error","Bad count");for(var v=t.getUint8(r),p=t.getUint8(r+1),g=t.getUint8(r+2),y=new Uint8Array(3*o.count),m=0;m<o.count;m++)y[3*m]=v,y[3*m+1]=p,y[3*m+2]=g;return y}throw new i.a("lepcc-decode-error","Bad method "+o.lookupMethod+","+o.compressionMethod)}var T=0,R=4,U=8,q=12,G=14,B=15,z=16;function H(e,t){return{sizeLo:e.getUint32(t+T,n),sizeHi:e.getUint32(t+R,n),count:e.getUint32(t+U,n),scaleFactor:e.getUint16(t+q,n),bitsPerPoint:e.getUint8(t+G),reserved:e.getUint8(t+B)}}function Q(e){var t=new DataView(e,0),r=0,n=l(e,t,r),a=n.identifier,s=n.version;if(r+=c,"Intensity "!==a)throw new i.a("lepcc-decode-error","Bad identifier");if(s>1)throw new i.a("lepcc-decode-error","Unknown version");var o=H(t,r);if(r+=z,o.sizeHi*Math.pow(2,32)+o.sizeLo!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");var u=new Uint16Array(o.count);if(8===o.bitsPerPoint){if(o.count+r!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");for(var d=new Uint8Array(e,r,o.count),h=0;h<o.count;h++)u[h]=d[h]*o.scaleFactor}else if(16===o.bitsPerPoint){if(2*o.count+r!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");for(var f=new Uint16Array(e,r,o.count),b=0;b<o.count;b++)u[b]=f[b]*o.scaleFactor}else{var v=[];if(N(e,r,v)!==e.byteLength)throw new i.a("lepcc-decode-error","Bad size");for(var p=0;p<o.count;p++)u[p]=v[p]*o.scaleFactor}return u}},873:function(e,t,r){"use strict";r.d(t,"a",(function(){return o})),r.d(t,"b",(function(){return u}));var i=r(33),n=r(10),a=r(49),s=r(70);function o(e,t,r,n){var s=u(e,t,r),o=Object(i.d)();return Object(a.d)(r,s,o,n),o}function u(e,t,r){var i=Object(n.e)(),a=e[3],o=Math.pow(2,4*Math.ceil(Math.log(a)*Math.LOG2E/4)+1);if(r.isGeographic){var u=o/Object(s.e)(r).radius*180/Math.PI,c=Math.round(e[1]/u),l=Math.max(-90,Math.min(90,c*u)),d=u/Math.cos((Math.abs(l)-u/2)/180*Math.PI),h=Math.round(e[0]/d)*d;i[0]=h,i[1]=l}else{var f=Math.round(e[0]/o),b=Math.round(e[1]/o);i[0]=f*o,i[1]=b*o}var v=e[2]+t,p=Math.round(v/o);return i[2]=p*o,i}},900:function(e,t,r){"use strict";r.d(t,"a",(function(){return b}));var i=r(2),n=r(3),a=r(6),s=r(7),o=r(0),u=r(16),c=r(1),l=(r(17),r(18),r(12)),d=r(773),h=r(801),f=u.a.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),b=function(e){var t=function(e){Object(a.a)(r,e);var t=Object(s.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e.logError=function(t){e._definitionExpressionErrors<e._maxDefinitionExpressionErrors&&f.error("Error while evaluating definitionExpression: "+t),e._definitionExpressionErrors++,e._definitionExpressionErrors===e._maxDefinitionExpressionErrors&&f.error("Further errors are ignored")},e}return Object(n.a)(r,[{key:"parsedDefinitionExpression",get:function(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{var e=d.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return f.error("definitionExpression is using non standard function"),null;var t=[],r=e.fieldNames;return Object(h.k)(r,this.i3slayer.fields,{missingFields:t}),t.length>0?(f.error("definitionExpression references unknown fields: ".concat(t.join(", "))),null):(this._definitionExpressionErrors=0,e)}catch(i){return f.error("Failed to parse definitionExpression: "+i),null}}},{key:"definitionExpressionFields",get:function(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}},{key:"_evaluateClause",value:function(e,t){try{return e.testFeature(t)}catch(r){return this.logError(r),!1}}},{key:"_addDefinitionExpressionToQuery",value:function(e){if(!this.parsedDefinitionExpression)return e;var t=this.i3slayer.definitionExpression,r=e.clone();return r.where?r.where="(".concat(t,") AND (").concat(r.where,")"):r.where=t,r}}]),r}(e);return Object(o.a)([Object(c.b)()],t.prototype,"i3slayer",void 0),Object(o.a)([Object(c.b)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),Object(o.a)([Object(c.b)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=Object(o.a)([Object(l.a)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},902:function(e,t,r){"use strict";r.d(t,"a",(function(){return y}));var i=r(42),n=r(11),a=r(8),s=r.n(a),o=r(15),u=r(2),c=r(3),l=r(6),d=r(7),h=r(0),f=r(24),b=r(4),v=(r(1),r(17),r(18),r(16),r(12)),p=r(112),g=r(803),y=function(e){var t=function(e){Object(l.a)(r,e);var t=Object(d.a)(r);function r(){return Object(u.a)(this,r),t.apply(this,arguments)}return Object(c.a)(r,[{key:"_validateFetchPopupFeatures",value:function(e){var t=this.layer;return t.popupEnabled?Object(g.a)(t,e)?void 0:new f.a("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new f.a("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}},{key:"prepareFetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t,r){var a,o,u,c,l,d,h,f,v,y;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=this._validateFetchPopupFeatures(r))){e.next=3;break}return e.abrupt("return",Promise.reject(a));case 3:if((o=Object(b.k)(r)?r.clientGraphics:null)&&0!==o.length){e.next=6;break}return e.abrupt("return",Promise.resolve([]));case 6:return u=[],c=[],l="scene"===this.layer.type&&Object(b.k)(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,e.t0=p.u,e.t1=this.layer.fieldsIndex,e.next=13,Object(g.b)(l,Object(g.a)(this.layer,r));case 13:return e.t2=e.sent,d=(0,e.t0)(e.t1,e.t2),e.next=17,this.prepareFetchPopupFeatures(d);case 17:h=new Set,f=Object(n.a)(o);try{for(f.s();!(v=f.n()).done;)y=v.value,Object(p.s)(d,y,h)?c.push(y):u.push(y)}catch(t){f.e(t)}finally{f.f()}return e.abrupt("return",0===c.length?Promise.resolve(u):this.whenGraphicAttributes(c,Object(i.a)(h)).catch((function(){return c})).then((function(e){return u.concat(e)})));case 21:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(e);return t=Object(h.a)([Object(v.a)("esri.views.3d.layers.support.PopupSceneLayerView")],t)}},975:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return c}));var i=r(11),n=r(27),a=r(4),s=r(842),o={setAttribute:function(){},rollback:function(){},commit:function(){}};function u(e,t){var r=t.attributes[e.objectIdField],s=e.sessions.get(r);if(s)return s;var u=Object(n.a)(t.attributes),c=new Set;if(null==r)return o;var l=e.attributeOverrides.createInteractiveEditSession(r),d=new Map,h=function(e,t){var i=d.get(e);if(null==i){var n=t.indexOf(r);return d.set(e,n),n}return i},f=0,b={setAttribute:function(r,i){if(0===f){var n=e.fieldsIndex.get(r);if(!Object(a.j)(n)){var s=e.attributeStorageInfo.findIndex((function(e){return e.name===n.name}));if(!(s<0)){l.set(s,i);var o=e.attributeStorageInfo[s],u=!1;c.add(r),e.forEachNode((function(r,n){var a=h(r,n);if(-1!==a){var s=e.getAttributeData(r.index);if(s){var c=s[o.name];c&&(c[a]=i,e.setAttributeData(r.index,s,t),u=!0)}}})),u&&e.clearMemCache()}}}},rollback:function(){if(0===f){var t,n=Object(i.a)(c);try{for(n.s();!(t=n.n()).done;){var a=t.value;this.setAttribute(a,u[a])}}catch(s){n.e(s)}finally{n.f()}l.rollback(),f=1,e.sessions.delete(r)}},commit:function(){0===f&&(l.commit(),f=2,e.sessions.delete(r))}};return e.sessions.set(r,b),b}function c(e,t){var r=function(e,t){var r=t.edits.updateFeatures;if(!r||0===r.length)return new h;for(var n=function(e){var t=new Set;if(!e.updatedFeatures)return t;var r,n=Object(i.a)(e.updatedFeatures);try{for(n.s();!(r=n.n()).done;){var a=r.value;null!=a.objectId&&null==a.error&&t.add(a.objectId)}}catch(s){n.e(s)}finally{n.f()}return t}(t),a=new h,o=new Map,u=0;u<e.attributeStorageInfo.length;u++)o.set(e.attributeStorageInfo[u].name,u);var c=e.fieldsIndex,d=e.objectIdField,f=r.filter((function(e){var t=Object(s.a)(c,e.attributes,d);return n.has(t)}));return e.forEachNode((function(t,r){var n,o=new Set(r),u=Object(i.a)(f);try{for(u.s();!(n=u.n()).done;){var h=n.value,b=Object(s.a)(c,h.attributes,d);if(o.has(b)){var v=r.indexOf(b);for(var p in h.attributes){var g=e.fieldsIndex.normalizeFieldName(p),y=l(a,t.index,g),m=h.attributes[p];y.push({featureIndex:v,featureId:b,value:m})}}}}catch(O){u.e(O)}finally{u.f()}})),a}(e,t);if(0!==r.size){for(var n=new Map,o=0;o<e.attributeStorageInfo.length;o++)n.set(e.attributeStorageInfo[o].name,o);var u=!1;r.forEach((function(t,r){var s=e.getAttributeData(r),o=!1;t.forEach((function(t,r){var c,l=Object(a.k)(s)?s[r]:null,d=n.get(r),h=Object(i.a)(t);try{for(h.s();!(c=h.n()).done;){var f=c.value,b=f.featureIndex,v=f.value,p=f.featureId;l&&(l[b]=v,o=!0,u=!0),e.attributeOverrides.updateValue(p,d,v)}}catch(g){h.e(g)}finally{h.f()}})),o&&e.setAttributeData(r,s,null)})),u&&e.clearMemCache()}}function l(e,t,r){var i=function(e,t){var r=e.get(t);if(r)return r;var i=new d;return e.set(t,i),i}(e,t),n=i.get(r);if(n)return n;var a=new Array;return i.set(r,a),a}var d=Map,h=Map},976:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var i=r(42),n=r(112);function a(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){var e=this.layer,t=this.layer.fieldsIndex,r=this.requiredFields;return e.outFields?Object(n.j)(t,[].concat(Object(i.a)(Object(n.u)(t,e.outFields)),Object(i.a)(r))):Object(n.j)(t,r)}}}}},977:function(e,t,r){"use strict";r.d(t,"a",(function(){return c}));var i=r(2),n=r(3),a=r(6),s=r(7),o=r(0),u=r(1),c=(r(17),r(18),r(16),r(286),r(87),function(e){Object(a.a)(r,e);var t=Object(s.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).layer=null,e.filter=null,e}return Object(n.a)(r,[{key:"availableFields",get:function(){return[]}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){throw new Error("Not implemented")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("Not implemented")}},{key:"queryFeatures",value:function(e,t){throw new Error("Not implemented")}},{key:"queryObjectIds",value:function(e,t){throw new Error("Not implemented")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("Not implemented")}},{key:"createQuery",value:function(){throw new Error("Not implemented")}},{key:"queryExtent",value:function(e,t){throw new Error("Not implemented")}}]),r}(r(630).a));Object(o.a)([Object(u.b)()],c.prototype,"layer",void 0),Object(o.a)([Object(u.b)()],c.prototype,"availableFields",null),Object(o.a)([Object(u.b)()],c.prototype,"maximumNumberOfFeatures",null),Object(o.a)([Object(u.b)({readOnly:!0})],c.prototype,"maximumNumberOfFeaturesExceeded",null),Object(o.a)([Object(u.b)()],c.prototype,"filter",void 0)}}]);
//# sourceMappingURL=49.e3350608.chunk.js.map