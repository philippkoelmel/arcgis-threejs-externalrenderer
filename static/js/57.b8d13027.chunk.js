(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[57],{1219:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return f}));var i=r(2),a=r(6),n=r(7),s=r(0),u=r(1),c=(r(17),r(18),r(16),r(12)),o=r(844),l=r(3),h=r(24),d=function(e){Object(a.a)(r,e);var t=Object(n.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).type="ogc-feature-3d",e}return r}(function(e){var t=function(e){Object(a.a)(r,e);var t=Object(n.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return Object(l.a)(r,[{key:"initialize",value:function(){var e=this.layer,t=this.view;e.source.supportsSpatialReference(t.spatialReference)||this.addResolvingPromise(Promise.reject(new h.a("layerview:spatial-reference-incompatible","The spatial references supported by this OGC layer are incompatible with the spatial reference of the view",{layer:e})))}},{key:"availableFields",get:function(){return this.layer.fieldsIndex.fields.map((function(e){return e.name}))}}]),r}(e);return Object(s.a)([Object(u.b)()],t.prototype,"layer",void 0),Object(s.a)([Object(u.b)({readOnly:!0})],t.prototype,"availableFields",null),t=Object(s.a)([Object(c.a)("esri.views.layers.OGCFeatureLayerView")],t)}(o.a));Object(s.a)([Object(u.b)()],d.prototype,"layer",void 0);var f=d=Object(s.a)([Object(c.a)("esri.views.3d.layers.OGCFeatureLayerView3D")],d)},803:function(e,t,r){"use strict";r.d(t,"a",(function(){return h})),r.d(t,"b",(function(){return o}));var i=r(8),a=r.n(i),n=r(42),s=r(15),u=r(4),c=r(112);function o(e){return l.apply(this,arguments)}function l(){return l=Object(s.a)(a.a.mark((function e(t){var r,i,s,o,l,h,d,f,p,y=arguments;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=y.length>1&&void 0!==y[1]?y[1]:t.popupTemplate,Object(u.k)(r)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,r.getRequiredFields(t.fieldsIndex);case 5:if(i=e.sent,s=r.lastEditInfoEnabled,o=t.objectIdField,l=t.typeIdField,h=t.globalIdField,d=t.relationships,!i.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,Object(c.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,p=Object(c.j)(t.fieldsIndex,[].concat(Object(n.a)(i),Object(n.a)(f))),e.abrupt("return",(l&&p.push(l),p&&o&&t.fieldsIndex.has(o)&&-1===p.indexOf(o)&&p.push(o),p&&h&&t.fieldsIndex.has(h)&&-1===p.indexOf(h)&&p.push(h),d&&d.forEach((function(e){var r=e.keyField;p&&r&&t.fieldsIndex.has(r)&&-1===p.indexOf(r)&&p.push(r)})),p));case 23:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}function h(e,t){return e.popupTemplate?e.popupTemplate:Object(u.k)(t)&&t.defaultPopupTemplateEnabled&&Object(u.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},810:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var i=r(2),a=r(3),n=r(6),s=r(7),u=r(0),c=r(16),o=r(25),l=r(36),h=r(1),d=(r(17),r(18),r(12)),f=function(e){var t=function(e){Object(n.a)(r,e);var t=Object(s.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return Object(a.a)(r,[{key:"initialize",value:function(){var e=this;this.handles.add(Object(l.b)(this,"layer","refresh",(function(){e.doRefresh().catch((function(t){Object(o.n)(t)||c.a.getLogger(e.declaredClass).error(t)}))})),"RefreshableLayerView")}}]),r}(e);return Object(u.a)([Object(h.b)()],t.prototype,"layer",void 0),t=Object(u.a)([Object(d.a)("esri.layers.mixins.RefreshableLayerView")],t)}},811:function(e,t,r){"use strict";r.d(t,"a",(function(){return N})),r.d(t,"b",(function(){return U}));var i=r(11),a=r(8),n=r.n(a),s=r(15),u=r(2),c=r(3),o=r(6),l=r(7),h=r(0),d=r(34),f=r(61),p=r(16),y=r(127),b=r(4),m=r(25),v=r(154),g=r(36),O=r(1),j=(r(17),r(18),r(12)),F=r(43),x=r(204),k=r(642),w=r(171),T=r(646),E=function(){function e(t,r){Object(u.a)(this,e),this.highestResolutionVersion=null,this.versions=[],this.ref(t,r)}return Object(c.a)(e,[{key:"isReferenced",get:function(){return 0!==this.versions.length}},{key:"isSingle",get:function(){return 1===this.versions.length&&1===this.versions[0].refCount}},{key:"ref",value:function(e,t){var r=this.feature;C.oldVersion=r,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0});var a,n=Object(i.a)(this.versions);try{for(n.s();!(a=n.n()).done;){var s=a.value;if(s.resolution===t){s.refCount++;var u=this.highestResolutionVersion===s&&!Object(T.a)(e,s.feature);return(u||this.highestResolutionVersion!==s)&&(s.feature=e),C.newVersion=u?e:r,C}}}catch(o){n.e(o)}finally{n.f()}var c={feature:e,resolution:t,refCount:1};return this.versions.push(c),!this.highestResolutionVersion||t<this.highestResolutionVersion.resolution?(C.newVersion=e,this.highestResolutionVersion=c):C.newVersion=r,C}},{key:"unref",value:function(e){for(var t=0;t<this.versions.length;t++){var r=this.versions[t];if(r.resolution===e)return r.refCount--,C.oldVersion=this.feature,0===r.refCount&&(this.versions[t]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===r&&(this.recalculateHighestResolutionVersion(),C.oldVersion=r.feature)),C.newVersion=this.feature,C}return null}},{key:"feature",get:function(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}},{key:"recalculateHighestResolutionVersion",value:function(){if(0!==this.versions.length){for(var e=this.versions[0],t=1;t<this.versions.length;t++){var r=this.versions[t];r.resolution<e.resolution&&(e=r)}this.highestResolutionVersion=e}else this.highestResolutionVersion=null}}]),e}(),_=function(){function e(t){Object(u.a)(this,e),this._feature=t,this.refCount=1}return Object(c.a)(e,[{key:"isReferenced",get:function(){return 0!==this.refCount}},{key:"isSingle",get:function(){return 1===this.refCount}},{key:"ref",value:function(e){return++this.refCount,C.oldVersion=this._feature,this.feature&&Object.defineProperty(e,"uid",{value:this.feature.uid,configurable:!0}),Object(T.a)(this._feature,e)||(this._feature=e),C.newVersion=this._feature,C}},{key:"unref",value:function(){return C.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(C.newVersion=null,C):(C.newVersion=this._feature,C)}},{key:"feature",get:function(){return this._feature}}]),e}(),C={oldVersion:null,newVersion:null},R=r(115),S=new Set,D=function(){function e(t){Object(u.a)(this,e),this.descriptor=t,this.fetchStatus=0,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=I,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=S,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}return Object(c.a)(e,[{key:"displayingFeatures",get:function(){return this._displayingFeatures},set:function(e){this._displayingFeatures=e,this.extentIncludingBorrowedFeatures=null}},{key:"perTileMaximumNumberOfFeaturesExceeded",get:function(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}},{key:"features",get:function(){return this._features}},{key:"featureLimit",get:function(){return this._featureLimit},set:function(e){this._featureLimit!==e&&(this._featureLimit=e,this._estimatedUnusedSizeDirty=!0)}},{key:"availableFields",get:function(){return this._availableFields}},{key:"setFeatures",value:function(e,t,r){this._availableFields=Object(b.u)(r,S),this._features=e,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,e&&e.length>0?(this._emptyFeatureRatio=t/(e.length+t),this._numVertices=e.reduce((function(e,t){return e+Object(x.k)(t.geometry)}),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}},{key:"emptyFeatureRatio",get:function(){return this._emptyFeatureRatio}},{key:"numFeatures",get:function(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0},set:function(e){this._numFeatures=e}},{key:"hasPreciseFeatureCount",get:function(){return this._numFeatures>I}},{key:"needsFeatureCount",get:function(){return this._numFeatures===I}},{key:"numVertices",get:function(){return this._numVertices}},{key:"id",get:function(){return this.descriptor.id}},{key:"estimatedSize",get:function(){return this.updateMemoryEstimates(),this._estimatedSize}},{key:"estimatedUnusedSize",get:function(){return this._estimatedUnusedSize}},{key:"updateMemoryEstimates",value:function(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(var e=0;e<this._features.length;++e){var t=Object(x.e)(this._features[e]);this._estimatedSize+=t,e>=this.featureLimit&&(this._estimatedUnusedSize+=t)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(var r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=Object(x.e)(this._features[r]);return!0}return!1}},{key:"isFetching",get:function(){return 2===this.fetchStatus||3===this.fetchStatus}},{key:"isRefetching",get:function(){return 3===this.fetchStatus}},{key:"needsFetching",get:function(){return 0===this.fetchStatus||1===this.fetchStatus}},{key:"needsRefetching",get:function(){return 1===this.fetchStatus}},{key:"isFetched",get:function(){return 4===this.fetchStatus||5===this.fetchStatus}},{key:"resetFetching",value:function(){this.fetchStatus=3===this.fetchStatus?1:0}},{key:"needsDisplayUpdate",get:function(){return!!this._features&&!function(e,t,r){if(Object(b.j)(t)||Object(b.j)(e)||r!==t.length||r>e.length)return!1;for(var i=0;i<r;++i)if(e[i]!==t[i])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}},{key:"intersects",value:function(e){return!e||!this.descriptor.extent||(Object(F.s)(e,M),Object(F.w)(this.descriptor.extent,M))}},{key:"intersectionIncludingBorrowed",value:function(e,t){var r=Object(b.k)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return e||r?(e?(Object(F.s)(e,t),Object(F.v)(t,r,t)):Object(F.k)(t,r),t):(Object(F.k)(t,F.b),t)}},{key:"_shuffle",value:function(e){this._features.sort((function(t,r){return Object(x.g)(t,e)-Object(x.g)(r,e)})),Object(R.m)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}},{key:"reduceFeatures",value:function(e,t,r){if(e<=0)return!1;if(!this._features)return this.featureLimit=0,!1;var i=!1;this.featureLimit=Math.ceil(this.numFeatures*e),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,4===this.fetchStatus&&this._features.length>0&&(this.fetchStatus=1,i=!0)),!this._shuffled&&e<1&&this._shuffle(r);var a=Math.max(this.featureLimit,Math.ceil(t*this.numFeatures));return this._features.length>a&&(this._features.length=a,this.featuresMissing=!0,5===this.fetchStatus&&(this.fetchStatus=4)),i}},{key:"cache",get:function(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}},set:function(e){this.requestController=null,this._availableFields=e.availableFields,this._features=e.features,this._numFeatures=e.numFeatures,this._emptyFeatureRatio=e.emptyFeatureRatio,this.fetchStatus=e.fetchStatus,this.featuresMissing=e.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}]),e}(),I=-1;var M=Object(F.l)(),V=r(152),P=r(103),q=p.a.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D"),N=function(e){Object(o.a)(r,e);var t=Object(l.a)(r);function r(e){var i;return Object(u.a)(this,r),(i=t.call(this,e))._useTileCount=!1,i.updating=!1,i.updatingTotal=0,i.updatingRemaining=0,i.expectedFeatureDiff=0,i.maximumNumberOfFeaturesExceeded=!1,i.maximumNumberOfFeaturesExceededThrottle=1e3,i._fullRatio=1,i._farRatio=1,i.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},i.handles=new f.a,i._frameTask=P.a,i._dirty=!1,i.featureTiles=new Map,i.displayingFeatureReferences=new Map,i.numDisplayingFeatureReferences=0,i.suspended=!0,i.pendingEdits=null,i}return Object(c.a)(r,[{key:"maximumNumberOfFeatures",set:function(e){e=e||1/0;var t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this.maximumFeaturesUpdated(t,e))}},{key:"memoryFactor",set:function(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this.setDirty())}},{key:"lodFactor",set:function(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&Object(b.k)(this.context.query.queryFeatureCount)},set:function(e){this._useTileCount=e,this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.estimatedUnusedSize})),e}},{key:"totalVertices",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.numVertices})),e}},{key:"totalFeatures",get:function(){var e=0;return this.featureTiles.forEach((function(t){return e+=t.numFeatures})),e}},{key:"filterExtent",set:function(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))q.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");else{var t=this._get("filterExtent");if(!(t===e||t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("filterExtent",r),this.reclip(r,t)}}}},{key:"initialize",value:function(){var e=this;this.handles.add(Object(g.b)(this,"tileDescriptors","change",(function(){return e.setDirty()}),(function(){return e.setDirty()}))),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?E:_;var t=this.context.scheduler;Object(b.k)(t)&&(this._frameTask=t.registerTask(P.b.FEATURE_TILE_FETCHER,this)),this.setDirty()}},{key:"destroy",value:function(){var e=this;this._frameTask.remove(),this.handles=Object(b.e)(this.handles),this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.removeTile(t)})),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}},{key:"paused",get:function(){return this.suspended||!!this.pendingEdits}},{key:"restart",value:function(){var e=this;this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.clearTile(t),e.resetFetchTile(t)})),Object(b.k)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}},{key:"refetch",value:function(){var e=this;this.featureTiles.forEach((function(t){e.cancelFetchTile(t),e.resetFetchTile(t)})),Object(b.k)(this.context.memoryCache)&&this.context.memoryCache.clear(),this.setDirty()}},{key:"suspend",value:function(){this.suspended||(this.suspended=!0,this.pause(),this.setDirty())}},{key:"resume",value:function(){this.suspended&&(this.suspended=!1,this.unpause())}},{key:"pause",value:function(){var e=this;this.paused&&(this.featureTiles.forEach((function(t){return e.cancelFetchTile(t)})),this.updated())}},{key:"unpause",value:function(){this.paused||(this.setDirty(),this.updated())}},{key:"availableFields",get:function(){var e=null;return this.featureTiles.forEach((function(t){Object(b.j)(t.displayingFeatures)||0===t.displayingFeatures.length||(Object(b.j)(e)?e=new Set(t.availableFields):e.forEach((function(r){t.availableFields.has(r)||Object(b.t)(e).delete(r)})))})),Object(b.k)(e)?e:new Set}},{key:"applyEdits",value:function(e){var t=this;this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:Object(m.e)()},this.pause());var r=this.pendingEdits;r.count++;var i=r.edits.then((function(){return e.result.catch((function(e){if(Object(m.n)(e))throw e;return null})).then((function(e){return e?(t.applyEditsDeleteFeatures(e.deletedFeatures),t.applyEditsAddUpdateFeatures(e.addedFeatures,e.updatedFeatures,r.controller.signal).then((function(){return e}))):e})).then((function(e){return 0==--r.count&&(t.pendingEdits===r&&(t.pendingEdits=null),Object(b.k)(t.context.memoryCache)&&t.context.memoryCache.clear(),t.unpause(),t.updated()),e}))}));return r.edits=i,this.updated(),i}},{key:"applyEditsDeleteFeatures",value:function(e){var t=this;if(0!==e.length){var r=this.context.globalIdField,i=r&&this.availableFields.has(r),a=new Set,n=this.objectIdField;e.forEach((function(e){var s=e.objectId,u=e.globalId;if((!s||s<0)&&r){i||q.errorOncePerTick("Editing the specified service requires the layer's globalIdField, ".concat(r," to be included the layer's outFields for updates to be reflected in the view"));var c=t.features.find((function(e){return e.attributes&&e.attributes[r]===u}));c&&a.add(Object(x.g)(c,n))}else a.add(s)})),this.featureTiles.forEach((function(e){if(e.features){var r=e.features.filter((function(e){return!a.has(Object(x.g)(e,t.objectIdField))}));r.length!==e.features.length&&(e.setFeatures(r,0,e.availableFields),t.invalidateCounts())}}))}}},{key:"applyEditsAddUpdateFeatures",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r,i){var a,s,u,c=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=[],s=new Set,t.forEach((function(e){return a.push(e.objectId)})),r.forEach((function(e){a.push(e.objectId),s.add(e.objectId)})),0!==a.length){e.next=3;break}return e.abrupt("return");case 3:return u=[],this.featureTiles.forEach((function(e){var t=c.applyEditsAddUpdateTile(e,a,s,i);t&&u.push(t)})),e.next=7,Object(m.k)(u);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"applyEditsAddUpdateTile",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r,a,s){var u,c,o,l,h,d,f,p=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.features){e.next=2;break}return e.abrupt("return");case 2:return(u=this.createQuery(t)).resultType=void 0,u.cacheHint=!1,u.objectIds=r,e.next=6,this.queryFeatures(u,s);case 6:if(c=e.sent,o=null,a.size>0&&(l=t.features.filter((function(e){return!a.has(Object(x.g)(e,p.objectIdField))}))).length!==t.features.length&&(o=l),c.features.length>0){o||(o=t.features.slice()),h=Object(i.a)(c.features);try{for(h.s();!(d=h.n()).done;)f=d.value,o.push(f)}catch(n){h.e(n)}finally{h.f()}}o&&(t.hasPreciseFeatureCount&&(t.numFeatures=Math.max(t.numFeatures,o.length)),t.setFeatures(o,0,G(t.availableFields,c.fields)),this.invalidateCounts());case 11:case"end":return e.stop()}}),e,this)})));return function(t,r,i,a){return e.apply(this,arguments)}}()},{key:"queryFeatures",value:function(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:X})}},{key:"setDirty",value:function(){this._dirty=!0,this.updated()}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(e){var t=this;if(this._frameTask.processQueue(e),this._dirty&&this.constructed){this._dirty=!1;var r=this.getListOfTiles();if(this.markTilesNotAlive(r),e.run((function(){return t.addTiles(r,e)}))&&e.run((function(){return t.filterExtentTiles(r,e)}))&&e.run((function(){return t.removeTiles(r,e)}))&&!e.done){var i=this.sortTiles(r);e.run((function(){return t.displayTiles(i,e)}))&&e.run((function(){return t.fetchTiles(i,e)}))&&e.run((function(){return t.updateMemoryEstimates(i,e)}))||this.setDirty(),this.updated(),this.updating||this.updateMaximumNumberOfFeaturesExceeded()}else this.setDirty()}}},{key:"markTilesNotAlive",value:function(e){var t,r=Object(i.a)(e);try{for(r.s();!(t=r.n()).done;){t.value.alive=!1}}catch(a){r.e(a)}finally{r.f()}}},{key:"addTiles",value:function(e,t){var r=this;return!this.suspended&&(this.tileDescriptors.forEach((function(i){var a=r.featureTiles.get(i.id);a?a.alive=!0:t.done||(e.push(r.addTile(i)),t.madeProgress())})),t.hasProgressed)}},{key:"filterExtentTiles",value:function(e,t){var r,a=Object(i.a)(e);try{for(a.s();!(r=a.n()).done;){var n=r.value;if(t.done)break;n.alive&&(n.filtered=!n.intersects(this.filterExtent),n.filtered&&(this.clearTile(n),t.madeProgress()))}}catch(s){a.e(s)}finally{a.f()}return t.hasProgressed}},{key:"removeTiles",value:function(e,t){for(var r=e.length-1;r>=0&&!t.done;r--){var i=e[r];i.alive||(this.removeTile(i),r!==e.length-1&&(e[r]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}},{key:"sortTiles",value:function(e){return e.sort((function(e,t){return e.descriptor.loadPriority-t.descriptor.loadPriority})),e}},{key:"displayTiles",value:function(e,t){var r,a=this,n=this.updateRatio(e),s=Object(i.a)(e);try{var u=function(){var e=r.value;if(!t.run((function(){return function(e){var t=a._fullRatio<1?n(e)*a._farRatio:1;return e.reduceFeatures(t,a.memoryFactor,a.objectIdField)&&a.setDirty(),a.showTile(e)}(e)})))return a.setDirty(),"break"};for(s.s();!(r=s.n()).done;){if("break"===u())break}}catch(c){s.e(c)}finally{s.f()}return t.hasProgressed}},{key:"fetchTiles",value:function(e,t){var r=this;if(this.paused)return!1;var a,n=!1,s=Object(i.a)(e);try{var u=function(){var e=a.value;if(!e.needsFetching)return"continue";var i=Object(b.k)(r.context.memoryCache)?r.context.memoryCache.pop(e.id):null;if(Object(b.k)(i))e.cache=i,r.setDirty(),r.scheduleUpdated(),t.madeProgress();else{if(r.needsNumFeatures(e)){var s=Object(m.e)(),u=r.fetchTileCount(e,s.signal);r._handleRequest(e,u,s,(function(){return e.numFeatures=-2})),n=!0,t.madeProgress()}if(t.done)return{v:!0}}};for(s.s();!(a=s.n()).done;){var c=u();if("continue"!==c&&"object"===typeof c)return c.v}}catch(f){s.e(f)}finally{s.f()}if(n)return t.hasProgressed;var o,l=Object(i.a)(e);try{var h=function(){var e=o.value;if(e.needsFetching){var i=Object(m.e)(),a=r.fetchTile(e,i.signal);if(r._handleRequest(e,a,i,(function(t){e.setFeatures([],0,null),r.invalidateCounts(),e.featuresMissing=!1,r.context.logFetchError(q,t)})),t.madeProgress(),t.done)return{v:!0}}};for(l.s();!(o=l.n()).done;){var d=h();if("object"===typeof d)return d.v}}catch(f){l.e(f)}finally{l.f()}return t.hasProgressed}},{key:"updateMemoryEstimates",value:function(e,t){var r=this;return e.some((function(e){return!t.run((function(){return e.updateMemoryEstimates()}))&&(r.setDirty(),!0)})),t.hasProgressed}},{key:"reclip",value:function(e,t){if(this.constructed){var r=new Array;this.featureTiles.forEach((function(i){Object(b.j)(i.displayingFeatures)||0===i.displayingFeatures.length||(i.intersectionIncludingBorrowed(t,B),i.intersectionIncludingBorrowed(e,Z),Object(F.o)(B,Z)||r.push(i))})),this.refreshDisplayingFeatures(r),this.updated()}}},{key:"refreshDisplayingFeatures",value:function(e){var t,r=new Set,a=this.changes.updates,n=Object(i.a)(e);try{for(n.s();!(t=n.n()).done;){var s=t.value;if(!Object(b.j)(s.displayingFeatures)){var u,c=Object(i.a)(s.displayingFeatures);try{for(c.s();!(u=c.n()).done;){var o=u.value,l=Object(x.g)(o,this.objectIdField);if(!r.has(l)){r.add(l);var h=this.displayingFeatureReferences.get(l).feature;a.removes.push(h),a.adds.push(h)}}}catch(d){c.e(d)}finally{c.f()}}}}catch(d){n.e(d)}finally{n.f()}this.applyChanges()}},{key:"updated",value:function(){var e=this,t=0;this.paused||this.featureTiles.forEach((function(e){return e.isFetching?++t:0}));var r=this._dirty||t>0||!!this.pendingEdits;if(this._set("updating",r),r){var i=0,a=0,n=0,s=0,u=0,c=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach((function(t){if(++a,t.isFetching&&t.hasPreciseFeatureCount){var r=e.maximumFeaturesForTile(t)*(1-t.emptyFeatureRatio),o=Object(b.k)(t.displayingFeatures)?t.displayingFeatures.length*c:0;u+=r-o}t.needsFetching?++s:t.numFeatures>0&&(++n,i+=t.numFeatures)})),s+=t;var o=0,l=0;i?(l=i,o=Math.min(s*i/n,i)):(l=a,o=s),u=Math.min(this.maximumNumberOfFeatures-this.features.length,u),this._set("updatingTotal",l),this._set("updatingRemaining",o),this._set("expectedFeatureDiff",u)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}},{key:"updateMaximumNumberOfFeaturesExceeded",value:function(){var e=Object(y.c)(this.featureTiles,(function(e){return e.perTileMaximumNumberOfFeaturesExceeded}));this._set("maximumNumberOfFeaturesExceeded",e)}},{key:"updateRatio",value:function(e){var t,r=function(e){var t,r=0,a=Object(i.a)(e);try{for(a.s();!(t=a.n()).done;){var n=t.value;n.features&&n.features.length>0&&n.alive&&(r=Math.max(r,n.descriptor.lij[0]))}}catch(s){a.e(s)}finally{a.f()}return r}(e),a=function(e){return 1/(1<<Math.max(0,r-e.descriptor.lij[0]))},n=0,s=0,u=Object(i.a)(e);try{for(u.s();!(t=u.n()).done;){var c=t.value,o=c.numFeatures;n+=o,s+=o*a(c)}}catch(l){u.e(l)}finally{u.f()}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/n),this._farRatio=this.maximumNumberOfFeatures/s,this.scheduleUpdated(),a}},{key:"maximumFeaturesUpdated",value:function(e,t){var r=this;e!==t&&(t>e&&this.featureTiles.forEach((function(e){if(e.featuresMissing){var t=r.maximumFeaturesForTile(e);e.features&&(e.features.length>=t||5===e.fetchStatus)||(r.cancelFetchTile(e),r.resetFetchTile(e))}})),this.setDirty())}},{key:"addTile",value:function(e){var t=new D(e);return this.featureTiles.set(t.id,t),this.resetFetchTile(t),this.referenceDisplayingFeaturesFromRelatedTiles(t),t}},{key:"referenceDisplayingFeaturesFromRelatedTiles",value:function(e){var t=this,r=e.descriptor.resolution;this.featureTiles.forEach((function(a){if(!(Object(b.j)(a.displayingFeatures)||e===a||e.descriptor.lij&&a.descriptor.lij&&!Object(V.j)(e.descriptor.lij,a.descriptor.lij))){Object(b.j)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&a.descriptor.extent&&(Object(b.j)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=Object(F.f)(e.descriptor.extent)),Object(F.p)(e.extentIncludingBorrowedFeatures,a.descriptor.extent,e.extentIncludingBorrowedFeatures));var n,s=Object(i.a)(a.displayingFeatures);try{for(s.s();!(n=s.n()).done;){var u=n.value;e.displayingFeatures.push(u);var c=t.displayingFeatureReferences.get(Object(x.g)(u,t.objectIdField));c.ref(c.feature,r),t.numDisplayingFeatureReferences++}}catch(o){s.e(o)}finally{s.f()}}})),e.featureLimit=Object(b.k)(e.displayingFeatures)?e.displayingFeatures.length:0}},{key:"removeTile",value:function(e){this.clearTile(e),this.featureTiles.delete(e.id)}},{key:"resetFetchTile",value:function(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=4):e.fetchStatus=0}},{key:"cancelFetchTile",value:function(e){var t=e.requestController;Object(b.k)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}},{key:"fetchTileCount",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.fetchCount(t,r);case 2:return t.numFeatures=e.sent,this.updateRatio(this.getListOfTiles()),e.abrupt("return",3===t.fetchStatus?1:0);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchTile",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r){var i,a,s,u,c,o,l,h,d,f,p=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((i=this.maximumFeaturesForTile(t))<=0)){e.next=3;break}return e.abrupt("return",Q(t));case 3:if(a=this.getMaxRecordCount(t),s=Math.ceil(i/a),!(L(t)||!this.context.capabilities.supportsMaxRecordCountFactor||t.numFeatures<=i&&s>w.a.MAX_MAX_RECORD_COUNT_FACTOR)){e.next=6;break}return e.abrupt("return",this.fetchPagedTile(t,r));case 6:return(u=this.createQuery(t)).maxRecordCountFactor=Math.ceil(i/a),t.isRefetching&&t.features&&t.features.length>0&&(c=Math.ceil(t.features.length/(1-t.emptyFeatureRatio)/a),u.maxRecordCountFactor=Math.max(c+1,u.maxRecordCountFactor)),e.next=10,this.queryFeatures(u,r);case 10:return o=e.sent,l=o.features,h=o.exceededTransferLimit,d=o.fields,f=h?u.maxRecordCountFactor>=w.a.MAX_MAX_RECORD_COUNT_FACTOR?5:4:5,e.next=17,this._frameTask.schedule((function(){t.featuresMissing=l.length<t.numFeatures||h;var e=p._removeEmptyFeatures(l);t.setFeatures(l,e,z(d))}),r);case 17:return this.invalidateCounts(),e.abrupt("return",f);case 19:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchCount",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.context.query.queryFeatureCount(this.createFeatureCountQuery(t),{signal:r}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchPagedTile",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r){var i,a,s,u,c,o,l,h,d,f=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=0,s=0,u=0,c=this.maximumFeaturesForTile(t)-u,o=this.getMaxRecordCount(t),l=null,h=n.a.mark((function e(){var h,d,p,y,m,v;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=f.createQuery(t),d=f.setPagingParameters(h,a,c,o),e.next=4,f.queryFeatures(h,r);case 4:return p=e.sent,y=p.features,m=p.exceededTransferLimit,v=p.fields,e.next=10,f._frameTask.schedule((function(){d&&(a+=Object(b.t)(h.num)),u+=y.length,s+=f._removeEmptyFeatures(y),t.featuresMissing=a<t.numFeatures||m,i=i?i.concat(y):y,l=G(l,v),t.setFeatures(i,s,l)}),r);case 10:if(f.invalidateCounts(),f.setDirty(),c=f.maximumFeaturesForTile(t)-u,d&&m&&!(c<=0)){e.next=15;break}return e.abrupt("return",{v:m?4:5});case 15:case"end":return e.stop()}}),e)}));case 4:return e.delegateYield(h(),"t0",5);case 5:if("object"!==typeof(d=e.t0)){e.next=8;break}return e.abrupt("return",d.v);case 8:e.next=4;break;case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"createFeatureCountQuery",value:function(e){var t=this.createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}},{key:"createQuery",value:function(e){var t=this.context.createQuery(),r=e.descriptor.extent;if(r){var i=this.context.tilingScheme.spatialReference;t.geometry=Object(F.z)(r,i)}return this.setResolutionParams(t,e),this.useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"setPagingParameters",value:function(e,t,r,i){return!!this.context.capabilities.supportsPagination&&(e.start=t,r>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(r/i),e.num=Math.min(e.maxRecordCountFactor*i,r)):e.num=Math.min(i),!0)}},{key:"getEffectiveTileResolution",value:function(e){if(null==e.descriptor.resolution)return null;var t=1===this.context.viewingMode?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}},{key:"supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"setResolutionParams",value:function(e,t){if(this.supportsResolution){var r=this.getEffectiveTileResolution(t);null!=r&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new k.a({mode:"view",originPosition:"upper-left",tolerance:r,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=r))}}},{key:"_removeEmptyFeatures",value:function(e){for(var t=e.length,r=0;r<e.length;){var i=e[r];Object(x.i)(i.geometry)?++r:(e[r]=e[e.length-1],--e.length)}return t-e.length}},{key:"needsNumFeatures",value:function(e){return this.useTileCount&&e.needsFeatureCount&&!L(e)}},{key:"getMaxRecordCount",value:function(e){var t=this.context,r=t.tileMaxRecordCount,i=t.maxRecordCount;return this.useTileQuery(e)&&Object(b.k)(r)&&r>0&&this.context.capabilities.supportsResultType?r:Object(b.k)(i)&&i>0?i:H}},{key:"useTileQuery",value:function(e){return(!L(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}},{key:"_handleRequest",value:function(e,t,r,i){var a=this;e.fetchStatus=e.needsRefetching?3:2,e.requestController=r;var n=!1;t.then((function(t){e.requestController=null,e.fetchStatus=t})).catch((function(t){e.requestController===r&&(e.requestController=null,e.fetchStatus=4),Object(m.n)(t)?n=!0:i(t)})).then((function(){n||a.setDirty(),a.scheduleUpdated()}))}},{key:"scheduleUpdated",value:function(){var e=this;this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add(Object(v.b)((function(){e.handles.remove("scheduleUpdated"),e.updated()})),"scheduleUpdated")}},{key:"showTile",value:function(e){if(Object(b.k)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;var t=e.features;if(0===e.featureLimit||!t){var r=Object(b.k)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this.hideTileFeatures(e),e.displayingFeatures=[],r}var i=e.descriptor.resolution,a=this.changes.updates,n=this.changes.adds,s=Math.min(e.featureLimit,t.length);e.featureLimit=s;for(var u=0;u<s;++u){var c=t[u],o=Object(x.g)(c,this.objectIdField),l=this.displayingFeatureReferences.get(o);if(l){var h=l.ref(c,i);h.oldVersion!==h.newVersion&&(a.removes.push(h.oldVersion),a.adds.push(h.newVersion))}else this.displayingFeatureReferences.set(o,new this.FeatureReferenceClass(c,i)),n.push(c);this.numDisplayingFeatureReferences++}return this.hideTileFeatures(e),this.applyChanges(),e.displayingFeatures=t.slice(0,s),!0}},{key:"hideTile",value:function(e){this.cancelFetchTile(e),this.hideTileFeatures(e)}},{key:"hideTileFeatures",value:function(e){if(!Object(b.j)(e.displayingFeatures)){var t,r=this.changes.updates,a=this.changes.removes,n=Object(i.a)(e.displayingFeatures);try{for(n.s();!(t=n.n()).done;){var s=t.value,u=Object(x.g)(s,this.objectIdField),c=this.displayingFeatureReferences.get(u);if(c){var o=c.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,o?o.oldVersion!==o.newVersion&&(null==o.newVersion?(this.displayingFeatureReferences.delete(u),a.push(o.oldVersion)):(r.adds.push(o.newVersion),r.removes.push(o.oldVersion))):console.error("Hiding unreferenced feature")}}}catch(l){n.e(l)}finally{n.f()}this.applyChanges(),e.displayingFeatures=null}}},{key:"applyChanges",value:function(){var e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);for(var t=this.changes.adds,r=this.changes.removes,i=Math.min(t.length,r.length),a=0;a<i;){var n=Math.min(a+J,i);this.features.addMany(t.slice(a,n)),this.features.removeMany(r.slice(a,n)),a=n}t.length>i&&this.features.addMany(0===a?t:t.slice(a)),r.length>i&&this.features.removeMany(0===a?r:r.slice(a)),t.length=0,r.length=0}},{key:"clearTile",value:function(e){if(this.hideTile(e),e.features&&Object(b.k)(this.context.memoryCache)){var t=16+e.estimatedSize;this.context.memoryCache.put(e.id,e.cache,t)}e.setFeatures(null,0,null),this.invalidateCounts()}},{key:"invalidateCounts",value:function(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}},{key:"getListOfTiles",value:function(){return Array.from(this.featureTiles.values())}},{key:"storedFeatures",get:function(){return this.getListOfTiles().reduce((function(e,t){return e+(t.features?t.features.length:0)}),0)}},{key:"maximumFeaturesForTile",value:function(e){var t=e.hasPreciseFeatureCount?e.numFeatures:1/0,r=e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures,i=this._fullRatio<1?this._farRatio:1;return Math.min(Math.ceil(r*i/(1-e.emptyFeatureRatio)),t)}},{key:"test",get:function(){var e=this;return{process:function(t){return e.runTask(t)},getFeatureTileById:function(t){return e.featureTiles.get(t)},forEachFeatureTile:function(t){return e.featureTiles.forEach(t)}}}}]),r}(d.a);function L(e){return"dummy-tile-full-extent"===e.id}function U(e){var t=e.capabilities.query;return{supportsMultipleResolutions:A(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function A(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function Q(e){return e.setFeatures([],0,null),e.featuresMissing=!1,4}function z(e){return Object(b.j)(e)?new Set:new Set(e.map((function(e){return e.name})))}function G(e,t){if(Object(b.j)(e)||Object(b.j)(t))return z(t);var r,a=new Set,n=Object(i.a)(t);try{for(n.s();!(r=n.n()).done;){var s=r.value.name;e.has(s)&&a.add(s)}}catch(u){n.e(u)}finally{n.f()}return a}Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"features",void 0),Object(h.a)([Object(O.b)()],N.prototype,"tileDescriptors",void 0),Object(h.a)([Object(O.b)({value:1/0})],N.prototype,"maximumNumberOfFeatures",null),Object(h.a)([Object(O.b)({value:1})],N.prototype,"memoryFactor",null),Object(h.a)([Object(O.b)({value:1})],N.prototype,"lodFactor",null),Object(h.a)([Object(O.b)()],N.prototype,"useTileCount",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updating",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updatingTotal",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"updatingRemaining",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"expectedFeatureDiff",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"memoryForUnusedFeatures",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"maximumNumberOfFeaturesExceeded",void 0),Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"totalVertices",null),Object(h.a)([Object(O.b)({readOnly:!0})],N.prototype,"totalFeatures",null),Object(h.a)([Object(O.b)()],N.prototype,"filterExtent",null),Object(h.a)([Object(O.b)({constructOnly:!0})],N.prototype,"context",void 0),N=Object(h.a)([Object(j.a)("esri.views.3d.layers.support.FeatureTileFetcher3D")],N);var H=2e3,B=Object(F.l)(),Z=Object(F.l)(),X=6e5,J=200},812:function(e,t,r){"use strict";r.d(t,"a",(function(){return Q}));var i=r(11),a=r(8),n=r.n(a),s=r(15),u=r(2),c=r(3),o=r(6),l=r(7),h=r(0),d=r(34),f=r(142),p=r(54),y=(r(17),r(24)),b=r(61),m=r(27),v=r(16),g=r(4),O=r(268),j=r(25),F=r(36),x=r(1),k=(r(18),r(12)),w=r(285),T=r(634),E=r(500),_=r(811),C=r(29),R=r(146),S=r(163),D=r(272),I=r(227),M=r(259),V=r(228),P=r(232),q=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],N=function(){function e(t,r,i){Object(u.a)(this,e),this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=t,this.view=i,this.tilingScheme=new P.a(r),this.loadedSymbols=q.map((function(e){return new M.a(new D.a({material:{color:[e[0],e[1],e[2],.6]},outline:{color:"black",size:1}}))})),this.loadingSymbols=[new M.a(new D.a({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new M.a(new D.a({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new M.a(new D.a({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}return Object(c.a)(e,[{key:"destroy",value:function(){this.enabled=!1}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e,this.update()}},{key:"update",value:function(){var e=this;this._enabled?(this.synchronizeMaps(this.loadingGraphics,{filter:function(e){return e.isFetching},symbols:this.loadingSymbols}),this.synchronizeMaps(this.loadedGraphics,{filter:function(e){return!e.isFetching},symbols:this.loadedSymbols}),this.synchronizeMaps(this.pendingGraphics,{filter:function(e){return!e.isFetching},symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.loadingGraphics.clear(),this.loadedGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.loadedGraphics.clear(),this.pendingGraphics.forEach((function(t){e.view.graphics.removeMany(t)})),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}},{key:"showDataExtent",value:function(e){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),e){var t=S.a.fromExtent(e);this.dataExtentGraphic=new R.a({geometry:t,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}}},{key:"synchronizeMaps",value:function(e,t){var r=this,i=[];e.forEach((function(e,a){var n=r.tileFetcher.test.getFeatureTileById(a);n&&t.filter(n)||(r.view.graphics.removeMany(e),i.push(a))})),i.forEach((function(t){return e.delete(t)})),this.tileFetcher.test.forEachFeatureTile((function(i){if(t.filter(i)&&!e.has(i.id)){var a=Object(C.a)(i.descriptor.lij,3),n=a[0],s=a[1],u=a[2];r.tilingScheme.ensureMaxLod(n);var c=r.tilingScheme.getExtentGeometry(n,s,u),o=[new R.a({geometry:c,symbol:t.symbols[n%t.symbols.length]}),new R.a({geometry:c.center,symbol:new I.a({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new V.a({text:"".concat(n,"/").concat(s,"/").concat(u),halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];e.set(i.id,o),r.view.graphics.addMany(o)}}))}}]),e}(),L=r(89),U=r(270),A=v.a.getLogger("esri.layers.graphics.controllers.FeatureTileController3D"),Q=function(e){Object(o.a)(r,e);var t=Object(l.a)(r);function r(e){var i;return Object(u.a)(this,r),(i=t.call(this,e)).type="feature-tile-3d",i.watchUpdatingTracking=new U.a,i.serviceDataExtent=null,i.serviceDataCount=z.NO_SERVICE_DATA_COUNT,i.vertexLimitExceeded=!1,i.displayFeatureLimit=null,i.suspended=!1,i.tileFetcher=null,i.handles=new b.a,i.fetchDataInfoPromise=null,i.fetchDataInfoAbortController=null,i.lifeCycleAbortController=Object(j.e)(),i}return Object(c.a)(r,[{key:"extent",set:function(e){if(!e||e.spatialReference.equals(this.layerView.view.spatialReference)){var t=this._get("extent");if(t!==e&&!(t&&e&&t.equals(e))){var r=e?e.clone():null;this._set("extent",r)}}else A.error("#extent=","extent needs to be in the same spatial reference as the view")}},{key:"updating",get:function(){return!!(Object(g.k)(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&Object(g.k)(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return Object(g.k)(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!Object(g.k)(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return Object(g.k)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(e){e!==this.maximumNumberOfFeatures&&(null==e?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",e))}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var e=this.layerView.layer;if("feature"===e.type&&Object(g.k)(e.infoFor3D))return"snapshot";if(this.serviceDataCount===z.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var t=this.layerView.view,r=t&&t.featureTiles,i=r&&r.tilingScheme;if(e&&e.minScale&&this.serviceDataExtent&&i){var a=this.approximateExtentSizeAtScale(e.minScale,i);if((this.serviceDataExtent.width/a+this.serviceDataExtent.height/a)/2>z.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){var e=this._get("maxTotalSnapshotVertices")||0,t="snapshot"===this.mode&&Object(g.k)(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(e,t)}},{key:"approximateExtentSizeAtScale",value:function(e,t){var r=this.layerView.view,i=Math.ceil((r.width/t.pixelSize+r.height/t.pixelSize)/2),a=t.levels[0];return i*((a.tileSize[0]/(a.scale/e)+a.tileSize[1]/(a.scale/e))/2)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new p.a([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new p.a}},{key:"test",get:function(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}},{key:"initialize",value:function(){var e=this;this.watchUpdatingTracking.add(this,"vertexLimitInfo",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))})),this.watchUpdatingTracking.add(this,"mode",(function(){return e.modeChanged()}),2),this.addResolvingPromise(Promise.resolve().then((function(){return e.verifyCapabilities()})).then((function(){return e.watchUpdatingTracking.addPromise(e.fetchServiceDataInfo())})).then((function(){return e.initializeTileFetcher()})))}},{key:"verifyCapabilities",value:function(){var e=this.layerView.layer;if(!e.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==e.type)throw new y.a("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:e})}},{key:"destroy",value:function(){this.cancelFetchServiceDataInfo(),this.tileFetcher=Object(g.e)(this.tileFetcher),this.handles=Object(g.e)(this.handles),this.tilesHandle=Object(g.s)(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}},{key:"suspend",value:function(){this.suspended||(this.suspended=!0,Object(g.k)(this.tileFetcher)&&this.tileFetcher.suspend())}},{key:"resume",value:function(){this.suspended&&(this.suspended=!1,Object(g.k)(this.tileFetcher)&&this.tileFetcher.resume())}},{key:"restart",value:function(){var e=this,t=function(){Object(g.k)(e.tileFetcher)&&e.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))}},{key:"refetch",value:function(){var e=this,t=function(){Object(g.k)(e.tileFetcher)&&e.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this.fetchServiceDataInfo().then(t,t))}},{key:"initializeTileFetcher",value:function(){var e=this,t=this.layerView.view;if(t){var r=Object(F.j)(t.featureTiles,"tilingScheme",this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(r),r.then((function(){var r=e.layerView,i=e.tileDescriptors,a=r.layer,n=new _.a({context:e.context,filterExtent:e.extent,tileDescriptors:i,features:e.graphics});e.tileFetcher=n,e.suspended?e.tileFetcher.suspend():e.tileFetcher.resume();var s=e.layerView.view.resourceController;s&&(e.handles.add(s.memoryController.events.on("quality-changed",(function(e){n.memoryFactor=e}))),e.tileFetcher.memoryFactor=s.memoryController.memoryFactor);var u="polygon"===e.context.geometryType?"polygonLodFactor":"polyline"===e.context.geometryType?"polylineLodFactor":null;u&&e.handles.add(Object(F.a)(e.layerView.view,"qualitySettings.graphics3D."+u,(function(e){n.lodFactor=e||1})));e.watchUpdatingTracking.add(a,"createQueryVersion",(function(){return e.dataFilterChanged()})),e.watchUpdatingTracking.add(r,"availableFields",(function(t,r){return e.availableFieldsChanged(r,t)})),e.watchUpdatingTracking.add(r,"requiredFields",(function(t,r){return e.requiredFieldsChanged(r,t)})),e.handles.add([a.on("apply-edits",(function(t){return e.applyEdits(t)})),e.watch("extent",(function(e){return n.filterExtent=e}),!0),e.watch("tileDescriptors",(function(e){return n.tileDescriptors=e}),!0),Object(F.a)(e,"maximumNumberOfFeatures",(function(t){n.maximumNumberOfFeatures=t,n.useTileCount=e.serviceDataCount>t}),!0),Object(F.a)(e,"serviceDataCount",(function(t){return n.useTileCount=t>e.maximumNumberOfFeatures}),!0),Object(F.a)(L.a,"FEATURE_TILE_FETCH_SHOW_TILES",(function(r){r&&n&&!n.debugger?(n.debugger=new N(n,t.featureTiles.tilingScheme.toTileInfo(),t),n.debugger.update()):!r&&e.tileFetcher&&n.debugger&&(n.debugger.destroy(),n.debugger=null)}))]),e.supportsExceedsLimitQuery||e.watchUpdatingTracking.add(e,"maxTotalSnapshotVertices",(function(){return e.watchUpdatingTracking.addPromise(e.updateVertexLimitExceeded(null,e.lifeCycleAbortController.signal))}))})).catch((function(){}))}}},{key:"modeChanged",value:function(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:A.warn("Unhandled feature layer mode "+this.mode);case"snapshot":Object(g.k)(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}},{key:"dataFilterChanged",value:function(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}},{key:"applyEdits",value:function(e){var t=this;Object(g.j)(this.tileFetcher)||this.tileFetcher.applyEdits(e).then((function(e){e&&(e.deletedFeatures.length||e.updatedFeatures.length||e.addedFeatures.length)&&t.watchUpdatingTracking.addPromise(t.updateServiceDataExtent(t.lifeCycleAbortController.signal))})).catch((function(e){if(!Object(j.n)(e))throw e}))}},{key:"availableFieldsChanged",value:function(e,t){Object(g.k)(this.tileFetcher)&&B(this.tileFetcher.availableFields,t)&&this.refetch()}},{key:"requiredFieldsChanged",value:function(e,t){Object(g.k)(this.tileFetcher)&&B(this.tileFetcher.availableFields,t)&&this.restart()}},{key:"createVertexLimitExceededQuery",value:function(e){var t=this.layerView.layer,r=t.createQuery();return r.outStatistics=[new E.a({statisticType:"exceedslimit",maxVertexCount:e,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],t.capabilities.query.supportsCacheHint&&(r.cacheHint=!0),r}},{key:"createDataInfoQuery",value:function(){var e=this.layerView.layer,t=e.createQuery();return t.outSpatialReference=this.layerView.view.spatialReference,e.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}},{key:"fullExtentIsAccurate",value:function(){var e=this.layerView.layer;if(e.definitionExpression)return!1;switch(e.type){case"feature":return Object(w.c)(e.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}},{key:"updateServiceDataExtent",value:function(){var e=Object(s.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.tryUpdateServiceDataExtent(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),Object(j.n)(e.t0)||this._set("serviceDataExtent",Object(m.a)(this.layerView.fullExtentInLocalViewSpatialReference));case 8:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"tryUpdateServiceDataExtent",value:function(){var e=Object(s.a)(n.a.mark((function e(t){var r,i,a,s,u,c,o,l,h,d,f;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.layerView,i=r.layer,a=i.capabilities.query.supportsExtent,s=Object(m.a)(r.fullExtentInLocalViewSpatialReference),u=i.fullExtent,c=this.fullExtentIsAccurate(),o=this.serviceDataCount,!(a&&o<=z.MAX_FEATURE_COUNT_FOR_EXTENT)||s&&c||!("queryExtent"in i)){e.next=9;break}return l=this.createDataInfoQuery(),e.next=5,i.queryExtent(l,{timeout:z.QUERY_EXTENT_TIMEOUT,signal:t});case 5:h=e.sent,this._set("serviceDataExtent",h.extent),e.next=22;break;case 9:if(!s){e.next=13;break}this._set("serviceDataExtent",s),e.next=22;break;case 13:if(!u){e.next=21;break}return d="portalItem"in i?i.portalItem:null,e.next=17,Object(T.projectGeometry)(u,r.view.spatialReference,d,t);case 17:f=e.sent,this._set("serviceDataExtent",f),e.next=22;break;case 21:this._set("serviceDataExtent",null);case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateServiceDataCount",value:function(){var e=Object(s.a)(n.a.mark((function e(t){var r,i;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("queryFeatureCount"in(r=this.layerView.layer)){e.next=3;break}return e.abrupt("return",void this._set("serviceDataCount",z.NO_SERVICE_DATA_COUNT));case 3:return e.next=5,Object(f.d)(r.queryFeatureCount(this.createDataInfoQuery(),{timeout:z.QUERY_STATISTICS_TIMEOUT,signal:t}));case 5:if(!0!==(i=e.sent).ok){e.next=10;break}this._set("serviceDataCount",i.value),e.next=13;break;case 10:if(!Object(j.n)(i.error)){e.next=12;break}throw i.error;case 12:this._set("serviceDataCount",z.NO_SERVICE_DATA_COUNT);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"vertexLimitInfo",get:function(){if(Object(g.j)(this.displayFeatureLimit)||Object(g.j)(this.displayFeatureLimit.averageSymbolComplexity))return null;var e=this.displayFeatureLimit,t=e.averageSymbolComplexity,r=e.maximumTotalNumberOfPrimitives,i=t.primitivesPerCoordinate,a=t.primitivesPerFeature,n=this._get("vertexLimitInfo");return Object(g.j)(n)||n.maximumTotalNumberOfPrimitives!==r||n.primitivesPerCoordinate!==i||n.primitivesPerFeature!==a?{primitivesPerCoordinate:i,primitivesPerFeature:a,maximumTotalNumberOfPrimitives:r}:n}},{key:"supportsExceedsLimitQuery",get:function(){var e=this.layerView.layer;return e.capabilities&&e.capabilities.operations&&e.capabilities.operations.supportsExceedsLimitStatistics}},{key:"minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}},{key:"updateVertexLimitExceeded",value:function(){var e=Object(s.a)(n.a.mark((function e(t,r){var i,a,s,u,c,o,l,h,d,p,y;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.vertexLimitInfo,!Object(g.j)(i)){e.next=3;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 3:if(a=i.primitivesPerFeature<=0,s=this.minimumNumberOfVerticesForGeometry>1,a||s){e.next=6;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 6:if(u=i.primitivesPerFeature,c=i.primitivesPerCoordinate,o=i.maximumTotalNumberOfPrimitives,e.t0=0!==u&&Object(g.k)(t),!e.t0){e.next=11;break}return e.next=11,t;case 11:if(h=this.serviceDataCount,d=h!==z.NO_SERVICE_DATA_COUNT,l=d?Math.ceil((o-h*u)/(c||1)):Math.ceil(o/(c||1)),s&&(l=Math.min(l,H)),!(d&&this.minimumNumberOfVerticesForGeometry*h>l)){e.next=14;break}return e.abrupt("return",void this._set("vertexLimitExceeded",!0));case 14:if(this.supportsExceedsLimitQuery){e.next=16;break}return e.abrupt("return",void this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>l));case 16:return e.next=18,Object(f.d)(this.layerView.layer.queryFeatures(this.createVertexLimitExceededQuery(l),{timeout:z.QUERY_STATISTICS_TIMEOUT,signal:r}));case 18:if(!1!==(p=e.sent).ok){e.next=23;break}if(!Object(j.n)(p.error)){e.next=22;break}throw p.error;case 22:return e.abrupt("return",void this._set("vertexLimitExceeded",!1));case 23:(y=p.value.features[0])&&y.attributes?this._set("vertexLimitExceeded",!!y.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);case 25:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"fetchServiceDataInfo",value:function(){var e=Object(s.a)(n.a.mark((function e(){var t,r,i,a,s,u=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.cancelFetchServiceDataInfo(),t=Object(j.e)(),r=t.signal,i=this.updateServiceDataCount(r),a=Object(j.k)([i,this.updateVertexLimitExceeded(i,r)]),s=a.then((function(){return u.updateServiceDataExtent(r)})).catch((function(e){Object(j.n)(e)||A.error("#fetchServiceDataInfo()",e)})).then((function(){s===u.fetchDataInfoPromise&&(u.fetchDataInfoPromise=null,u.fetchDataInfoAbortController=null),t=null})),e.abrupt("return",(t&&(this.fetchDataInfoPromise=s),this.fetchDataInfoAbortController=t,a.then((function(){}),(function(){}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"cancelFetchServiceDataInfo",value:function(){var e=this.fetchDataInfoAbortController;e&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,e.abort())}},{key:"debug",get:function(){return{storedFeatures:Object(g.k)(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:Object(g.k)(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:Object(g.k)(this.tileFetcher)?this.tileFetcher.totalVertices:0}}}]),r}(Object(O.b)(d.a));Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"type",void 0),Object(h.a)([Object(x.b)({constructOnly:!0})],Q.prototype,"graphics",void 0),Object(h.a)([Object(x.b)({constructOnly:!0})],Q.prototype,"layerView",void 0),Object(h.a)([Object(x.b)({constructOnly:!0})],Q.prototype,"context",void 0),Object(h.a)([Object(x.b)()],Q.prototype,"extent",null),Object(h.a)([Object(x.b)()],Q.prototype,"updating",null),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"watchUpdatingTracking",void 0),Object(h.a)([Object(x.b)()],Q.prototype,"updatingTotal",null),Object(h.a)([Object(x.b)()],Q.prototype,"updatingRemaining",null),Object(h.a)([Object(x.b)()],Q.prototype,"expectedFeatureDiff",null),Object(h.a)([Object(x.b)()],Q.prototype,"memoryForUnusedFeatures",null),Object(h.a)([Object(x.b)()],Q.prototype,"maximumNumberOfFeaturesExceeded",null),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"serviceDataExtent",void 0),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"serviceDataCount",void 0),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"vertexLimitExceeded",void 0),Object(h.a)([Object(x.b)()],Q.prototype,"displayFeatureLimit",void 0),Object(h.a)([Object(x.b)({type:Number})],Q.prototype,"maximumNumberOfFeatures",null),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"mode",null),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"maxTotalSnapshotVertices",null),Object(h.a)([Object(x.b)({readOnly:!0,dependsOn:["mode"]})],Q.prototype,"tileDescriptors",null),Object(h.a)([Object(x.b)()],Q.prototype,"tileFetcher",void 0),Object(h.a)([Object(x.b)()],Q.prototype,"fetchDataInfoPromise",void 0),Object(h.a)([Object(x.b)({readOnly:!0})],Q.prototype,"vertexLimitInfo",null),Q=Object(h.a)([Object(k.a)("esri.layers.graphics.controllers.FeatureTileController3D")],Q);var z,G,H=5e6;function B(e,t){if(!t)return!1;var r,a=Object(i.a)(t);try{for(a.s();!(r=a.n()).done;){var n=r.value;if(!e.has(n))return!0}}catch(s){a.e(s)}finally{a.f()}return!1}(G=z||(z={})).NO_SERVICE_DATA_COUNT=1/0,G.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,G.reset=function(){G.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,G.QUERY_STATISTICS_TIMEOUT=12e3,G.QUERY_EXTENT_TIMEOUT=1e4},z.reset()},814:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var i=r(4),a=r(77),n=r(634);function s(e){var t=e.view.spatialReference,r=e.layer.fullExtent,s=r&&r.spatialReference;if(!s)return Promise.resolve(null);if(s.equals(t))return Promise.resolve(r.clone());var u=Object(a.d)(r,t);return Object(i.k)(u)?Promise.resolve(u):e.view.state.isLocal?Object(n.projectGeometry)(r,t,e.layer.portalItem).then((function(t){return!e.destroyed&&t?t:void 0})).catch((function(){return null})):Promise.resolve(null)}},828:function(e,t,r){"use strict";r.d(t,"a",(function(){return E}));var i=r(8),a=r.n(i),n=r(14),s=r(15),u=r(2),c=r(3),o=r(23),l=r(22),h=r(6),d=r(7),f=r(0),p=r(24),y=r(4),b=r(36),m=r(1),v=(r(17),r(18),r(16),r(12)),g=r(381),O=r(812),j=r(501),F=r(171),x=r(861),k=r(851),w=r(814),T=r(103),E=function(e){var t=function(e){Object(h.a)(r,e);var t=Object(d.a)(r);function r(){var e;return Object(u.a)(this,r),(e=t.apply(this,arguments)).controller=null,e.updatePolicy=1,e.suspendResumeExtentMode="computed",e.slicePlaneEnabled=!1,e.drapeSourceType=1,e.fullExtentInLocalViewSpatialReference=null,e.suspendResumeExtent=null,e._controllerCreated=!1,e.clippingExtent=null,e.supportsHeightUnitConversion=!0,e.pendingController=null,e.queryEngine=null,e}return Object(c.a)(r,[{key:"initialize",value:function(){var e=this,t=this.layer;"isTable"in t&&t.isTable?this.addResolvingPromise(Promise.reject(new p.a("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t}))):(this._set("graphics3d",new x.a({owner:this,layer:t,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,suspendResumeExtentMode:this.suspendResumeExtentMode,updateClippingExtent:function(t){return e.updateClippingExtent(t)}})),this.updatingHandles.add(this,"updatePolicy",(function(t){return e.graphics3d.graphicsCore.preferredUpdatePolicy=t})),this.updatingHandles.add(this,"suspendResumeExtentMode",(function(t){e.graphics3d.suspendResumeExtentMode=t})),this.addResolvingPromise(this.graphics3d.setup().then((function(){return e.validateGeometryType()})).then((function(){return e.queryEngine=new k.a({layerView:e,priority:T.b.FEATURE_QUERY_ENGINE})})).then((function(){return Object(w.a)(e)})).then((function(t){return e.fullExtentInLocalViewSpatialReference=t})).then((function(){return e.initializeController()}))),this.notifyChange("updating"))}},{key:"destroy",value:function(){this.destroyPendingController(),this.controller=Object(y.e)(this.controller),this._set("graphics3d",Object(y.e)(this.graphics3d)),this.queryEngine=Object(y.e)(this.queryEngine),this.loadedGraphics=null}},{key:"destroyPendingController",value:function(){this.pendingController&&(this.pendingController.destroy(),this.pendingController=null)}},{key:"legendEnabled",get:function(){var e,t;return this.canResume()&&!(null!=(e=this.graphics3d)&&null!=(t=e.frustumVisibility)&&t.suspended)}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"getRenderingInfo",value:function(e,t,r){var i=Object(j.c)(e,{renderer:t,arcade:r});if(Object(y.k)(i)&&i.color){var a=i.color;a[0]=a[0]/255,a[1]=a[1]/255,a[2]=a[2]/255}return i}},{key:"getRenderingInfoAsync",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i,s){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(j.d)(t,Object(n.a)({renderer:r,arcade:i},s)));case 1:case"end":return e.stop()}}),e)})));return function(t,r,i,a){return e.apply(this,arguments)}}()},{key:"getGraphicFromGraphicUid",value:function(e){var t,r=this,i=null;return null==(t=this.loadedGraphics)||t.forEach((function(t){t.uid===e&&(i=Object(g.c)(t,r.layer))})),i}},{key:"graphics3DGraphics",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphics:null}},{key:"graphics3DGraphicsByObjectID",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}},{key:"symbolUpdateType",get:function(){return this.graphics3d?this.graphics3d.graphicsCore.symbolUpdateType:null}},{key:"whenGraphicBounds",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.whenGraphicBounds(e,t):null}},{key:"computeAttachmentOrigin",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null}},{key:"getSymbolLayerSize",value:function(e,t){return this.graphics3d?this.graphics3d.graphicsCore.getSymbolLayerSize(e,t):null}},{key:"queryFeatures",value:function(e,t){return this.queryEngine.executeQuery(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryObjectIds",value:function(e,t){return this.queryEngine.executeQueryForIds(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryFeatureCount",value:function(e,t){return this.queryEngine.executeQueryForCount(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"queryExtent",value:function(e,t){return this.queryEngine.executeQueryForExtent(this._ensureQuery(e),Object(y.i)(t,"signal"))}},{key:"_ensureQuery",value:function(e){return Object(y.j)(e)?this.createQuery():F.a.from(e)}},{key:"highlight",value:function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}},{key:"maskOccludee",value:function(e){return this.graphics3d.maskOccludee(e)}},{key:"canResume",value:function(){return Object(o.a)(Object(l.a)(r.prototype),"canResume",this).call(this)&&(!this.graphics3d||!this.graphics3d.suspended)}},{key:"getSuspendInfo",value:function(){var e=Object(o.a)(Object(l.a)(r.prototype),"getSuspendInfo",this).call(this);return this.graphics3d?Object(n.a)(Object(n.a)({},e),this.graphics3d.suspendInfo):e}},{key:"isUpdating",value:function(){var e,t;return!(!this.graphics3d||this.graphics3d.destroyed)&&!(this._controllerCreated&&(null==(e=this.controller)||!e.updating)&&null!=(t=this.view.basemapTerrain)&&t.ready&&!this.graphics3d.updating)}},{key:"initializeController",value:function(){var e=Object(s.a)(a.a.mark((function e(){var t;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.createController(),this.pendingController=t,e.next=4,t.when();case 4:this.setControllerWhenInitialized(t);case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"setControllerWhenInitialized",value:function(){var e=Object(s.a)(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.when();case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:if(this._controllerCreated=!0,this.notifyChange("updating"),!this.isResolved()||this.destroyed){e.next=19;break}return e.next=12,Object(b.l)(this.view,"basemapTerrain.ready");case 12:this.beforeSetController(t),this.pendingController=null,this.controller=t,this.loadedGraphics=t.graphics,this.notifyChange("updating"),e.next=20;break;case 19:this.destroyPendingController();case 20:case"end":return e.stop()}}),e,this,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()},{key:"updateClippingExtent",value:function(e){if(this.clippingExtent=e,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=e,!0}}},{key:"validateGeometryType",value:function(){switch(this.layer.geometryType){case"multipatch":case"multipoint":return Promise.reject(new p.a("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:this.layer.geometryType}))}}},{key:"_getResourceInfo",value:function(){var e=this.controller&&this.controller instanceof O.a?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:e?e.maximumNumberOfFeatures:-1,totalNumberOfFeatures:e?e.serviceDataCount:-1,nodes:0,core:this.graphics3d.graphicsCore.performanceInfo,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.graphics3d.frustumVisibility.suspended,visibilityScale:!this.graphics3d.scaleVisibility.suspended}}},{key:"performanceInfo",get:function(){return this._getResourceInfo()}}]),r}(e);return Object(f.a)([Object(m.b)()],t.prototype,"loadedGraphics",void 0),Object(f.a)([Object(m.b)()],t.prototype,"suspended",void 0),Object(f.a)([Object(m.b)({readOnly:!0})],t.prototype,"legendEnabled",null),Object(f.a)([Object(m.b)()],t.prototype,"updating",void 0),Object(f.a)([Object(m.b)()],t.prototype,"controller",void 0),Object(f.a)([Object(m.b)()],t.prototype,"graphics3d",void 0),Object(f.a)([Object(m.b)({readOnly:!0})],t.prototype,"updatePolicy",void 0),Object(f.a)([Object(m.b)({readOnly:!0})],t.prototype,"suspendResumeExtentMode",void 0),Object(f.a)([Object(m.b)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),Object(f.a)([Object(m.b)({readOnly:!0})],t.prototype,"suspendInfo",void 0),t=Object(f.a)([Object(v.a)("esri.views.3d.layers.FeatureLikeLayerView3D")],t)}},829:function(e,t,r){"use strict";r.d(t,"a",(function(){return h}));var i=r(42),a=r(11),n=r(2),s=r(3),u=r(6),c=r(7),o=r(94),l=r(502),h=function(e){Object(u.a)(r,e);var t=Object(c.a)(r);function r(){var e;return Object(n.a)(this,r),(e=t.apply(this,arguments))._set=new Set,e}return Object(s.a)(r,[{key:"clear",value:function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._set.size}},{key:"addMany",value:function(e){if(0!==e.length){var t,r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._set.add(i)}}catch(n){r.e(n)}finally{r.f()}this.emit("after-changes",{type:1}),this.emit("change",{added:e,removed:[]})}}},{key:"remove",value:function(e){this._set.delete(e)&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[e]}))}},{key:"removeMany",value:function(e){var t,r=[],i=Object(a.a)(e);try{for(i.s();!(t=i.n()).done;){var n=t.value;this._set.delete(n)&&r.push(n)}}catch(s){i.e(s)}finally{i.f()}r.length>0&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:r}))}},{key:"toArray",value:function(){return Object(i.a)(this._set)}},{key:"find",value:function(e){var t;return Object(l.a)(this._set,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._set.forEach((function(t){return e(t)}))}}]),r}(o.a)},844:function(e,t,r){"use strict";r.d(t,"a",(function(){return se}));var i=r(11),a=r(14),n=r(8),s=r.n(n),u=r(15),c=r(2),o=r(3),l=r(23),h=r(22),d=r(6),f=r(7),p=r(0),y=r(24),b=r(4),m=r(36),v=r(1),g=(r(17),r(18),r(16)),O=r(12),j=r(381),F=r(812),x=r(828),k=r(631),w=r(811),T=r(34),E=r(25),_=r(204),C=r(305),R=r(146),S=r(496),D=r(56),I=r(349),M=function(){function e(t){Object(c.a)(this,e),this._schedule=t,this._handle=new V(t)}return Object(o.a)(e,[{key:"destroy",value:function(){this._handle.destroy()}},{key:"invoke",value:function(e,t){var r=this;return e.buffer&&0!==e.buffer.byteLength?(e.options.sourceSpatialReference&&e.options.sourceSpatialReference instanceof D.a&&(e.options=Object(a.a)(Object(a.a)({},e.options),{},{sourceSpatialReference:e.options.sourceSpatialReference.toJSON()})),this._handle.invoke(e,t).then((function(e){return r._schedule((function(){if(e.spatialReference=D.a.fromJSON(e.spatialReference),e.fields)for(var t=0;t<e.fields.length;t++)e.fields[t]=I.a.fromJSON(e.fields[t]);var r,a=e.spatialReference,n=Object(i.a)(e.features);try{for(n.s();!(r=n.n()).done;){var s=r.value;s.uid=R.a.generateUID(),Object(b.k)(s.geometry)&&(s.geometry.spatialReference=a)}}catch(u){n.e(u)}finally{n.f()}return e}))}))):Promise.resolve(null)}}]),e}(),V=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,"PBFDecoderWorker","_parseFeatureQuery",e)}return Object(o.a)(r,[{key:"getTransferList",value:function(e){return[e.buffer]}}]),r}(S.a),P=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,e)}return Object(o.a)(r,[{key:"queryFeaturesDehydrated",get:function(){var e=this,t=this.layer.capabilities,r=t&&t.query;if(r&&r.supportsFormatPBF){var i,a;Object(b.j)(this._decoder)&&(this._decoder=new M(this.schedule));var n={sourceSpatialReference:null!=(i=null==(a=this.layer.spatialReference)?void 0:a.toJSON())?i:null,applyTransform:!0,maxStringAttributeLength:1024};return function(t,r){return Object(C.runQuery)(e.layer.parsedUrl,t,"pbf",e._createRequestOptions(r)).then((function(t){return Object(E.x)(r),Object(b.k)(e._decoder)?e._decoder.invoke({buffer:t.data,options:n},r.signal):Promise.reject(Object(E.f)())}))}}return function(t,r){return Object(C.executeQuery)(e.layer.parsedUrl,t,e.layer.spatialReference,e._createRequestOptions(r)).then((function(e){return Object(_.f)(e.data)}))}}},{key:"queryFeatureCount",value:function(e,t){return this.layer.queryFeatureCount(e,t)}},{key:"destroy",value:function(){this._decoder=Object(b.e)(this._decoder)}},{key:"_createRequestOptions",value:function(e){return Object(a.a)(Object(a.a)({},e),{},{query:Object(a.a)(Object(a.a)({},this.layer.customParameters),{},{token:this.layer.apiKey},null==e?void 0:e.query)})}}]),r}(T.a);Object(p.a)([Object(v.b)({constructOnly:!0})],P.prototype,"layer",void 0),Object(p.a)([Object(v.b)({constructOnly:!0})],P.prototype,"schedule",void 0),Object(p.a)([Object(v.b)({readOnly:!0})],P.prototype,"queryFeaturesDehydrated",null),P=Object(p.a)([Object(O.a)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],P);var q=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,e)}return Object(o.a)(r,[{key:"queryFeaturesDehydrated",value:function(e,t){return this.layer.queryFeatures(e,t)}},{key:"queryFeatureCount",value:function(e,t){return this.layer.queryFeatureCount(e,t)}}]),r}(T.a);Object(p.a)([Object(v.b)({constructOnly:!0})],q.prototype,"layer",void 0),Object(p.a)([Object(v.b)({readOnly:!0})],q.prototype,"queryFeaturesDehydrated",null),q=Object(p.a)([Object(O.a)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],q);var N=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,e)}return Object(o.a)(r,[{key:"queryFeaturesDehydrated",value:function(e,t){return this.layer.queryFeatures(e,t)}}]),r}(T.a);Object(p.a)([Object(v.b)({constructOnly:!0})],N.prototype,"layer",void 0),N=Object(p.a)([Object(O.a)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],N);var L=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){return Object(c.a)(this,r),t.call(this,e)}return Object(o.a)(r,[{key:"queryFeaturesDehydrated",value:function(e,t){var r=this;return this.source.queryFeaturesJSON(e,t).then(_.f,(function(i){if(i&&"query-features-json:unsupported"===i.name)return r.layer.queryFeatures(e,t);throw i}))}},{key:"queryFeatureCount",value:function(e,t){return this.layer.queryFeatureCount(e,t)}}]),r}(T.a);Object(p.a)([Object(v.b)({constructOnly:!0})],L.prototype,"layer",void 0),Object(p.a)([Object(v.b)({constructOnly:!0})],L.prototype,"source",void 0),L=Object(p.a)([Object(O.a)("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],L);var U,A=function(){function e(t){Object(c.a)(this,e),this._memoryCache=null,this._capabilities=null;var r=t.layerView.layer;this.layerView=t.layerView,this.objectIdField=r.objectIdField,this.globalIdField="globalIdField"in r?r.globalIdField:null,this.returnZ=t.returnZ,this.returnM=t.returnM;var i=this.layerView.view.resourceController;this.query=function(e,t){return"feature"===e.type&&"feature-layer"===e.source.type?Object(b.k)(e.infoFor3D)?new q({layer:e}):new P({layer:e,schedule:t}):"feature"===e.type&&"memory"===e.source.type||"csv"===e.type||"geojson"===e.type||"wfs"===e.type?new L({layer:e,source:e.source}):"ogc-feature"===e.type?new N({layer:e}):null}(r,(function(e){return i.schedule(e)})),i&&this.memoryCacheEnabled&&(this._memoryCache=i.memoryController.getMemCache(r.uid))}return Object(o.a)(e,[{key:"memoryCacheEnabled",get:function(){switch(this.layerView.layer.source.type){case"feature-layer":case"ogc-feature":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}},{key:"destroy",value:function(){this._memoryCache=Object(b.e)(this._memoryCache),this.query.destroy()}},{key:"createQuery",value:function(){var e=this.layerView.layer.createQuery();return e.outFields=this.layerView.availableFields,e.returnZ=this.returnZ,e.returnM=this.returnM,e.outSpatialReference=this.tilingScheme.spatialReference,e}},{key:"memoryCache",get:function(){return this._memoryCache}},{key:"viewingMode",get:function(){return this.layerView.view.state.viewingMode}},{key:"tilingScheme",get:function(){return this.layerView.view.featureTiles.tilingScheme}},{key:"scheduler",get:function(){var e=this.layerView.view.resourceController;return e?e.scheduler:null}},{key:"geometryType",get:function(){return this.layerView.layer.geometryType}},{key:"fullExtent",get:function(){return this.layerView.layer.fullExtent}},{key:"tileMaxRecordCount",get:function(){return this.layerView.layer.capabilities.query.tileMaxRecordCount}},{key:"maxRecordCount",get:function(){return this.layerView.layer.capabilities.query.maxRecordCount}},{key:"capabilities",get:function(){return Object(b.k)(this._capabilities)||(this._capabilities=Object(w.b)(this.layerView.layer)),this._capabilities}},{key:"logFetchError",value:function(e,t){e.error("#fetchTile()",this.layerView.layer,t&&t.message?t.message:t)}}]),e}(),Q=r(829),z=r(458),G=r(42),H=r(212),B=r(112),Z=r(171),X=r(172),J=r(30),Y=r(808),W=U=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(){var e;return Object(c.a)(this,r),(e=t.apply(this,arguments)).filter=null,e.includedEffect=null,e.excludedEffect=null,e.excludedLabelsVisible=!1,e}return Object(o.a)(r,[{key:"clone",value:function(){return new U({filter:this.filter&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}}]),r}(J.a);Object(p.a)([Object(v.b)({type:Y.a,json:{write:!0}})],W.prototype,"filter",void 0),Object(p.a)([Object(v.b)({json:{write:!0}})],W.prototype,"includedEffect",void 0),Object(p.a)([Object(v.b)({json:{write:!0}})],W.prototype,"excludedEffect",void 0),Object(p.a)([Object(v.b)({type:Boolean,json:{write:!0}})],W.prototype,"excludedLabelsVisible",void 0);var K=W=U=Object(p.a)([Object(O.a)("esri.views.layers.support.FeatureEffect")],W),$=r(803),ee=r(809),te=g.a.getLogger("esri.views.layers.FeatureLayerView"),re=r(630),ie=r(810),ae=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(e){var i;return Object(c.a)(this,r),(i=t.call(this,e))._controllerTotal=0,i._graphicsCoreTotal=0,i.suspendResumeExtentMode="data",i}return Object(o.a)(r,[{key:"initialize",value:function(){var e=this;this.updatingHandles.add(this,"view.floors",(function(){return e.graphics3d.filterVisibility.filterChanged()}))}},{key:"destroy",value:function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)}},{key:"maximumNumberOfFeatures",get:function(){var e,t;return null!=(e=null==(t=this.controller)?void 0:t.maximumNumberOfFeatures)?e:this._get("maximumNumberOfFeatures")},set:function(e){this._set("maximumNumberOfFeatures",e),this.controller&&(this.controller.maximumNumberOfFeatures=e)}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}},{key:"updatingProgressValue",get:function(){var e,t,r,i=0;if(null!=(e=this.controller)&&e.updating){var a=this.controller.updatingRemaining,n=Math.max(this.controller.updatingTotal,this._controllerTotal);n>0&&(i=(n-a)/n,this._controllerTotal=n)}var s=0;if(null!=(t=this.graphics3d)&&null!=(r=t.graphicsCore)&&r.updating){var u=this.graphics3d.graphicsCore.updatingRemaining,c=Math.max(u,this._graphicsCoreTotal);c>0&&(s=(c-u)/c,this._graphicsCoreTotal=c)}return.5*(i+s)}},{key:"updatePolicy",get:function(){if(!this.controller)return 0;switch(this.controller.mode){case"snapshot":var e=ne[this.layer.geometryType];return null==e||this.controller.serviceDataCount>e?0:1;case"tiles":return 0}}},{key:"hasZ",get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsZ)&&("returnZ"in e&&null!=e.returnZ?e.returnZ:t.supportsZ)}},{key:"hasM",get:function(){var e=this.layer,t=e.capabilities&&e.capabilities.data;return!(!t||!t.supportsM)&&"returnM"in e&&null!=e.returnM&&e.returnM}},{key:"fetchPopupFeatures",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var i;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.validateFetchPopupFeatures(r),e.abrupt("return",i?Promise.reject(i):this.fetchClientPopupFeatures(r));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"setVisibility",value:function(e,t){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(e,t)}},{key:"createQuery",value:function(){return Object(l.a)(Object(h.a)(r.prototype),"createQuery",this).call(this)}},{key:"queryFeatures",value:function(e,t){var i=this,a=function(){return Object(l.a)(Object(h.a)(r.prototype),"queryFeatures",i).call(i,e,t)};return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(e),a):a()}},{key:"beforeSetController",value:function(e){e.maximumNumberOfFeatures=this.maximumNumberOfFeatures}},{key:"createController",value:function(){var e=this;this.fetcherContext=new A({layerView:this,returnZ:this.hasZ,returnM:this.hasM});var t=new F.a({layerView:this,context:this.fetcherContext,graphics:new Q.a,extent:this.clippingExtent});return this.updatingHandles.add(t,"serviceDataExtent",(function(t){e.graphics3d&&(e.graphics3d.dataExtent=t)}),2),this.handles.add(Object(m.a)(this,"suspended",(function(e){e?t.suspend():t.resume()}),!0)),this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",(function(){return e.updateDisplayFeatureLimit(t)}),2),this.handles.add([this.view.resourceController.memoryController.events.on("quality-changed",(function(){return e.updateDisplayFeatureLimit()})),Object(m.g)(this,"updating",(function(){e._controllerTotal=0,e._graphicsCoreTotal=0,e.notifyChange("updatingProgressValue")}))]),t}},{key:"doRefresh",value:function(){var e=Object(u.a)(s.a.mark((function e(){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:!this.suspended&&this.controller&&this.controller.refetch();case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getUsedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.usedMemory:0)+(this.controller?this.controller.memoryForUnusedFeatures:0)}},{key:"getUnloadedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return(e?e.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*e.usedMemoryPerGraphic:0)}},{key:"ignoresMemoryFactor",value:function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride}},{key:"updateDisplayFeatureLimit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.controller;if(e&&this.graphics3d&&this.graphics3d.graphicsCore){var t=this.graphics3d.graphicsCore.displayFeatureLimit,r=this.view.resourceController.memoryController.memoryFactor;if(1===r)e.displayFeatureLimit=t;else{var i=Math.ceil(t.maximumNumberOfFeatures*r),n=Math.ceil(t.maximumTotalNumberOfFeatures*r),s=Math.ceil(t.minimumTotalNumberOfFeatures*r);e.displayFeatureLimit=Object(a.a)(Object(a.a)({},t),{},{maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:n,minimumTotalNumberOfFeatures:s})}}}},{key:"_queryFeaturesMesh",value:function(){var e=Object(u.a)(s.a.mark((function e(t,r){var a,n,u,c,o,l,h,d;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._validateQueryFeaturesMesh(t);case 2:return e.next=4,r();case 4:if(a=e.sent,!t||!t.outStatistics){e.next=7;break}return e.abrupt("return",a);case 7:n=this.layer.objectIdField,u=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID,c=[],o=Object(i.a)(a.features);try{for(o.s();!(l=o.n()).done;)(h=l.value).geometry?(d=u.get(h.attributes[n]))&&(h.geometry=Object(j.b)(d.graphic.geometry),c.push(h)):c.push(h)}catch(s){o.e(s)}finally{o.f()}return e.abrupt("return",(a.features=c,a));case 11:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_validateQueryFeaturesMesh",value:function(){var e=Object(u.a)(s.a.mark((function e(t){var r,i,a,n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:for(r=function(e){throw new y.a("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '".concat(e,"'"))},i=0,a=["quantizationParameters","geometryPrecision","maxAllowableOffset"];i<a.length;i++)null!=t[n=a[i]]&&r(n);"returnM"in t&&t.returnM&&r("returnM"),"returnCentroid"in t&&t.returnCentroid&&r("returnCentroid"),Object(b.k)(t.outSpatialReference)&&!t.outSpatialReference.equals(this.view.spatialReference)&&r("outSpatialReference");case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"performanceInfo",get:function(){var e=this.controller&&this.controller.displayFeatureLimit,t=Object(b.k)(e)&&e.averageSymbolComplexity,r=Object(b.k)(t)?"f:".concat(t.primitivesPerFeature,",v:").concat(t.primitivesPerCoordinate):"n/a",i=Object(a.a)(Object(a.a)({},this._getResourceInfo()),{},{storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,mode:this.controller?this.controller.mode:"n/a",symbolComplexity:r,nodes:this.controller?this.controller.tileDescriptors.length:0});if(this.controller&&i.displayedNumberOfFeatures){var n=this.controller.debug;i.storedFeatures=n.storedFeatures,i.totalVertices=n.totalVertices}return i}},{key:"test",get:function(){return{updatePolicy:this.updatePolicy,controller:this.controller}}}]),r}(Object(ie.a)(Object(x.a)(function(e){var t=function(e){Object(d.a)(r,e);var t=Object(f.a)(r);function r(){var e;Object(c.a)(this,r);for(var i=arguments.length,a=new Array(i),n=0;n<i;n++)a[n]=arguments[n];return(e=t.call.apply(t,[this].concat(a)))._updatingRequiredFieldsPromise=null,e.effect=null,e.filter=null,e.timeExtent=null,e.layer=null,e.requiredFields=[],e.view=null,e}return Object(o.a)(r,[{key:"initialize",value:function(){var e=this;Object(m.a)(this,["layer.renderer","layer.labelingInfo","layer.elevationInfo.featureExpressionInfo","layer.displayField","filter","effect","layer.timeInfo","layer.floorInfo","timeExtent"],(function(){return e._handleRequiredFieldsChange()}),!0),Object(m.b)(this,"view.floors","change",(function(){return e._handleRequiredFieldsChange()})),Object(m.b)(this,"layer.sublayer","change",(function(){return e._handleRequiredFieldsChange()}))}},{key:"availableFields",get:function(){var e=this.layer,t=this.layer.fieldsIndex,r=this.requiredFields;return"outFields"in e&&e.outFields?Object(B.j)(t,[].concat(Object(G.a)(Object(B.u)(t,e.outFields)),Object(G.a)(r))):Object(B.j)(t,r)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){te.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("missing implementation")}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},t=Object(b.k)(this.filter)?this.filter.createQuery(e):new Z.a(e);if("feature"===this.layer.type){var r=Object(ee.b)(this);Object(b.k)(r)&&(t.where=t.where?"(".concat(t.where,") AND (").concat(r,")"):r)}return Object(b.k)(this.timeExtent)&&(t.timeExtent=Object(b.k)(t.timeExtent)?t.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),t}},{key:"queryFeatures",value:function(e,t){throw new Error("missing implementation")}},{key:"queryObjectIds",value:function(e,t){throw new Error("missing implementation")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("missing implementation")}},{key:"queryExtent",value:function(e,t){throw new Error("missing implementation")}},{key:"_loadArcadeModules",value:function(e){if(e.get("expressionInfos.length"))return Object(X.e)()}},{key:"_handleRequiredFieldsChange",value:function(){var e=this,t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then((function(){e._updatingRequiredFieldsPromise===t&&e._set("_updatingRequiredFieldsPromise",null)}))}},{key:"_updateRequiredFields",value:function(){var e=Object(u.a)(s.a.mark((function e(){var t,r,a,n,u,c,o,l,h,d,f,p,y,m,v;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.layer&&this.view){e.next=2;break}return e.abrupt("return");case 2:return t="3d"===this.view.type,r=this.layer,a=this.layer,n=a.fieldsIndex,u=a.objectIdField,c="renderer"in r&&r.renderer,o="orderBy"in r&&r.orderBy,l=r.featureReduction,h=new Set,e.next=13,Object(E.k)([c?c.collectRequiredFields(h,n):null,Object(B.g)(h,r),t?Object(B.b)(h,r):null,Object(b.k)(this.filter)?Object(B.f)(h,r,this.filter):null,this.effect?Object(B.f)(h,r,this.effect.filter):null,l?Object(B.c)(h,r,l):null,o?Object(B.h)(h,r,o):null]);case 13:if(d=e.sent,r.timeInfo&&this.timeExtent&&Object(B.e)(h,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),"feature"===r.type&&r.floorInfo&&Object(B.e)(h,r.fieldsIndex,[r.floorInfo.floorField]),"subtype-group"!==r.type){e.next=19;break}return Object(B.d)(h,n,r.subtypeField),f=r.sublayers.map((function(e){var t;return Promise.all([null==(t=e.renderer)?void 0:t.collectRequiredFields(h,n),Object(B.g)(h,e)])})),e.next=19,Object(E.k)(f);case 19:p=Object(i.a)(d);try{for(p.s();!(y=p.n()).done;)(m=y.value).error&&te.error(m.error)}catch(s){p.e(s)}finally{p.f()}Object(B.d)(h,n,u),t&&"displayField"in r&&r.displayField&&Object(B.d)(h,n,r.displayField),v=Array.from(h).sort(),this._set("requiredFields",v);case 24:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"validateFetchPopupFeatures",value:function(e){if(Object(b.j)(e))return null;var t,r=Object(i.a)(e.clientGraphics);try{for(r.s();!(t=r.n()).done;){var a=t.value.layer;if("popupEnabled"in a&&!a.popupEnabled)return new y.a("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if("popupTemplate"in a&&!Object($.a)(a,e))return new y.a("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}}catch(n){r.e(n)}finally{r.f()}}},{key:"fetchClientPopupFeatures",value:function(){var e=Object(u.a)(s.a.mark((function e(t){var r,a,n,u,c,o,l,h,d,f,p,y=this;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=Object(b.k)(t)?t.clientGraphics:null)&&0!==r.length){e.next=3;break}return e.abrupt("return",Promise.resolve([]));case 3:return a=[],n=[],e.next=7,this.createPopupQuery(t);case 7:u=e.sent,c=Object(i.a)(r),e.prev=9,c.s();case 11:if((o=c.n()).done){e.next=25;break}if(l=o.value,"popupEnabled"in(h=l.layer)){e.next=16;break}return e.abrupt("continue",23);case 16:if(d=Object(B.u)(this.layer.fieldsIndex,u.outFields),f=Object($.a)(h,t),Object(b.k)(f)){e.next=19;break}return e.abrupt("continue",23);case 19:return e.next=21,this._loadArcadeModules(f);case 21:(p=e.sent)&&p.arcadeUtils.hasGeometryOperations(f)||!Object(B.i)(d,l)?n.push(l):a.push(l);case 23:e.next=11;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(9),c.e(e.t0);case 30:return e.prev=30,c.f(),e.finish(30);case 33:return e.abrupt("return","stream"===this.layer.type||0===n.length?Promise.resolve(a):(u.objectIds=n.map((function(e){return e.attributes[y.layer.objectIdField]})),this.layer.queryFeatures(u).then((function(e){return a.concat(e.features)})).catch((function(){return n}))));case 34:case"end":return e.stop()}}),e,this,[[9,27,30,33]])})));return function(t){return e.apply(this,arguments)}}()},{key:"createPopupQuery",value:function(){var e=Object(u.a)(s.a.mark((function e(t){var r,a,n,u,c,o,l,h,d,f,p,y,m,v,g;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.layer.createQuery(),a=new Set,n=!1,u=Object(b.k)(t)&&t.clientGraphics?t.clientGraphics.map((function(e){return e.layer})):[this.layer],c=Object(i.a)(u),e.prev=4,c.s();case 6:if((o=c.n()).done){e.next=25;break}if("popupEnabled"in(l=o.value)){e.next=10;break}return e.abrupt("continue",23);case 10:if(h=Object($.a)(l,t),Object(b.k)(h)){e.next=13;break}return e.abrupt("continue",23);case 13:return e.next=15,this._loadArcadeModules(h);case 15:return d=e.sent,f=d&&d.arcadeUtils.hasGeometryOperations(h),n=!("point"!==this.layer.geometryType&&!f),e.next=20,Object($.b)(this.layer,h);case 20:p=e.sent,y=Object(i.a)(p);try{for(y.s();!(m=y.n()).done;)v=m.value,a.add(v)}catch(s){y.e(s)}finally{y.f()}case 23:e.next=6;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(4),c.e(e.t0);case 30:return e.prev=30,c.f(),e.finish(30);case 33:return r.returnGeometry=n,r.returnZ=n,r.returnM=n,r.outFields=Array.from(a),r.outSpatialReference=this.view.spatialReference,"feature"===this.layer.type&&(g=Object(ee.b)(this),Object(b.k)(g)&&(r.where=r.where?"(".concat(r.where,") AND (").concat(g,")"):g)),e.abrupt("return",r);case 35:case"end":return e.stop()}}),e,this,[[4,27,30,33]])})));return function(t){return e.apply(this,arguments)}}()},{key:"canResume",value:function(){return!!Object(l.a)(Object(h.a)(r.prototype),"canResume",this).call(this)&&(!Object(b.k)(this.timeExtent)||!this.timeExtent.isEmpty)}}]),r}(e);return Object(p.a)([Object(v.b)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),Object(p.a)([Object(v.b)({readOnly:!0})],t.prototype,"availableFields",null),Object(p.a)([Object(v.b)({type:K})],t.prototype,"effect",void 0),Object(p.a)([Object(v.b)({type:Y.a})],t.prototype,"filter",void 0),Object(p.a)([Object(v.b)(H.a)],t.prototype,"timeExtent",void 0),Object(p.a)([Object(v.b)()],t.prototype,"layer",void 0),Object(p.a)([Object(v.b)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),Object(p.a)([Object(v.b)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),Object(p.a)([Object(v.b)({readOnly:!0})],t.prototype,"requiredFields",void 0),Object(p.a)([Object(v.b)()],t.prototype,"suspended",void 0),Object(p.a)([Object(v.b)()],t.prototype,"view",void 0),t=Object(p.a)([Object(O.a)("esri.views.layers.FeatureLayerView")],t),t}(Object(k.a)(re.a)))));Object(p.a)([Object(v.b)()],ae.prototype,"layer",void 0),Object(p.a)([Object(v.b)()],ae.prototype,"controller",void 0),Object(p.a)([Object(v.b)()],ae.prototype,"maximumNumberOfFeatures",null),Object(p.a)([Object(v.b)()],ae.prototype,"maximumNumberOfFeaturesExceeded",null),Object(p.a)([Object(v.b)(z.a)],ae.prototype,"updatingProgress",void 0),Object(p.a)([Object(v.b)({readOnly:!0,dependsOn:["controller.updatingRemaining","controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining"]})],ae.prototype,"updatingProgressValue",null),Object(p.a)([Object(v.b)({readOnly:!0})],ae.prototype,"updatePolicy",null),Object(p.a)([Object(v.b)({readOnly:!0})],ae.prototype,"hasZ",null),Object(p.a)([Object(v.b)({readOnly:!0})],ae.prototype,"hasM",null),Object(p.a)([Object(v.b)()],ae.prototype,"suspendResumeExtentMode",void 0),ae=Object(p.a)([Object(O.a)("esri.views.3d.layers.FeatureLayerViewBase3D")],ae);var ne={point:5e3,polygon:500,polyline:1e3},se=ae}}]);
//# sourceMappingURL=57.b8d13027.chunk.js.map