(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[46,32,194],{1211:function(e,t,r){"use strict";r.r(t),r.d(t,"default",(function(){return ce}));var i=r(8),n=r.n(i),a=r(15),s=r(11),o=r(2),c=r(3),l=r(6),u=r(7),d=r(0),h=r(146),b=r(34),f=r(54),p=r(215),y=r(16),v=r(4),g=r(25),O=r(36),m=r(1),j=(r(17),r(18),r(12)),_=(r(963),r(42)),x=r(29),k=r(23),w=r(22),I=r(24),C=r(773),S=(r(872),r(112)),F=r(171),N=r(94),M=r(213),E=r(413),D=r(268),P=function(e,t){var r=function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(e){var i;return Object(o.a)(this,r),(i=t.call(this,e)).sublayer=null,i.parent=null,i.view=null,i}return Object(c.a)(r,[{key:"initialize",value:function(){}},{key:"suspended",get:function(){return!this.canResume()}},{key:"updating",get:function(){return!this.suspended&&this.isUpdating()}},{key:"visible",get:function(){return!0===this.get("sublayer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}},{key:"fullOpacity",get:function(){var e=function(e){return null!=e?e:1};return e(this.get("sublayer.opacity"))*e(this.get("parent.fullOpacity"))}},{key:"canResume",value:function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.visible||!1}},{key:"isUpdating",value:function(){return!1}}]),r}(Object(D.b)(Object(M.b)(Object(E.a)(N.a.EventedMixin(e)))));return Object(d.a)([Object(m.b)()],r.prototype,"sublayer",void 0),Object(d.a)([Object(m.b)()],r.prototype,"parent",void 0),Object(d.a)([Object(m.b)({readOnly:!0})],r.prototype,"suspended",null),Object(d.a)([Object(m.b)({type:Boolean,readOnly:!0})],r.prototype,"updating",null),Object(d.a)([Object(m.b)()],r.prototype,"view",void 0),Object(d.a)([Object(m.b)()],r.prototype,"visible",null),Object(d.a)([Object(m.b)()],r.prototype,"fullOpacity",null),r=Object(d.a)([Object(j.a)("esri.views.3d.layers.BuildingSublayerView3D")],r)},R=r(905),L=r(14),A=r(46),V=r(421);function T(e){switch(e.filterMode.type){case"solid":return{mode:0};case"wire-frame":return{mode:1,edgeMaterial:Object(V.b)(e.filterMode.edges,{})};case"x-ray":return{mode:2}}}function U(e,t){if(Object(v.j)(t))return e.color[3]=0,e.edgeMaterial=null,void(e.pickable=!1);switch(t.mode){case 0:return;case 1:return e.color[3]=0,e.edgeMaterial=t.edgeMaterial,void(e.pickable=!1);case 2:return e.color[0]=1,e.color[1]=1,e.color[2]=1,e.color[3]*=.15,e.colorMixMode=3,e.castShadows=!1,e.pickable=!1,void(e.edgeMaterial=function(e){return Object(v.j)(e)?null:(G.lastMaterial!==e&&(G.cachedMaterial=function(e){var t=Object(A.f)(e.color);return t[3]*=.075,Object(L.a)(Object(L.a)({},e),{},{color:t})}(e),G.lastMaterial=e),G.cachedMaterial)}(e.edgeMaterial))}}var G={cachedMaterial:null,lastMaterial:null},q=r(835),H=r(964),B=r(965),z=r(966),Q=r(967),W=r(801),K=r(900),J=(r(286),r(87),function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).sublayer=null,e}return Object(c.a)(r,[{key:"updating",get:function(){return!1}},{key:"suspended",get:function(){return!1}},{key:"availableFields",get:function(){return[]}},{key:"filter",get:function(){return null},set:function(e){throw new Error("Not implemented")}},{key:"queryFeatures",value:function(e,t){throw new Error("Not implemented")}},{key:"queryObjectIds",value:function(e,t){throw new Error("Not implemented")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("Not implemented")}},{key:"createQuery",value:function(){throw new Error("Not implemented")}},{key:"queryExtent",value:function(e,t){throw new Error("Not implemented")}},{key:"highlight",value:function(e){throw new Error("Not implemented")}}]),r}(b.a));Object(d.a)([Object(m.b)()],J.prototype,"sublayer",void 0),Object(d.a)([Object(m.b)()],J.prototype,"availableFields",null),Object(d.a)([Object(m.b)()],J.prototype,"filter",null);var Y=r(808),Z=r(803),X=r(103),$=y.a.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D"),ee=function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).type="building-component-sublayer-3d",e.layerView=null,e._elevationContext="scene",e._isIntegratedMesh=!1,e._supportsLabeling=!1,e.lodFactor=1,e.progressiveLoadFactor=1,e._queryEngine=null,e}return Object(c.a)(r,[{key:"layerUid",get:function(){return this.sublayer.layer.uid}},{key:"sublayerUid",get:function(){return this.sublayer.uid}},{key:"initialize",value:function(){var e=this;this.updatingHandles.add(this,"sublayer.renderer,definitionExpressionFields,filterExpressionFields",(function(){return e._updateRequiredFields()})),this.updatingHandles.add(this.sublayer,"renderer",(function(t){return e._rendererChange(t)}),2);for(var t=0,r=["parsedDefinitionExpression","filter","viewFilter.parsedWhereClause","viewFilter.parsedGeometry","viewFilter.sortedObjectIds"];t<r.length;t++){var i=r[t];this.updatingHandles.add(this,i,(function(){return e._filterChange()}))}this.updatingHandles.add(this,"parsedFilterExpressions",(function(){return e._updateSymbologyOverride()}),2),this.addResolvingPromise(this._updateRequiredFields())}},{key:"parsedFilterExpressions",get:function(){var e=this;return"Overview"===this.sublayer.modelName?[]:this.layerView.filterExpressions.map((function(t){var r,i=Object(x.a)(t,2),n=i[0],a=i[1];try{r=C.WhereClause.create(n,e.sublayer.fieldsIndex)}catch(c){return $.error("Failed to parse filterExpression: "+c),null}if(!r.isStandardized)return $.error("filterExpression is using non standard function"),null;var s=[],o=r.fieldNames;return Object(W.k)(o,e.sublayer.fields,{missingFields:s}),s.length>0?($.error("filterExpression references unknown fields: ".concat(s.join(", "))),null):[r,a]})).filter((function(e){return null!=e}))}},{key:"filter",get:function(){return Object(v.k)(this.viewFilter)?this.viewFilter.filter:null},set:function(e){var t=this;!Object(v.j)(e)&&H.a.checkSupport(e)?Object(v.k)(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new H.a({filter:e,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:function(e){return t._loadAsyncModule(e)},applyFilters:function(){return t._applyFilters(!0)},addSqlFilter:function(e,r){return t.addSqlFilter(e,r,t.logError)}}):this.viewFilter=null}},{key:"_updateSymbologyOverride",value:function(){var e=this,t=this.parsedFilterExpressions;t.length>0?this._setSymbologyOverride((function(r,i){var n,a=Object(s.a)(t);try{for(a.s();!(n=a.n()).done;){var o=Object(x.a)(n.value,2),c=o[0],l=o[1];try{if(c.testFeature(r))return U(i,l)}catch(u){e.logError(u)}}}catch(d){a.e(d)}finally{a.f()}return U(i,null)}),this.filterExpressionFields):this._setSymbologyOverride(null,null)}},{key:"filterExpressionFields",get:function(){return Object(S.j)(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce((function(e,t){var r=Object(x.a)(t,1)[0];return e.concat(r.fieldNames)}),[]))}},{key:"availableFields",get:function(){var e=this.sublayer,t=e.fieldsIndex,r=this.requiredFields;if(e.outFields||e.layer.outFields){var i=[].concat(Object(_.a)(e.outFields||[]),Object(_.a)(e.layer.outFields||[]));r=[].concat(Object(_.a)(Object(S.u)(t,i)),Object(_.a)(r))}return Object(S.j)(t,r)}},{key:"_createLayerGraphic",value:function(e){var t=new h.a(null,null,e);return t.layer=this.sublayer.layer,t.sourceLayer=this.sublayer,t}},{key:"canResume",value:function(){return Object(k.a)(Object(w.a)(r.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)}},{key:"fetchPopupFeatures",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){var i,a,o,c,l,u,d,h,b;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=this._validateFetchPopupFeatures(r))){e.next=3;break}return e.abrupt("return",Promise.reject(i));case 3:if(Object(v.k)(r)&&r.clientGraphics&&0!==r.clientGraphics.length){e.next=5;break}return e.abrupt("return",[]);case 5:if(a=[],o=[],!Object(v.k)(this.sublayer.associatedLayer)){e.next=13;break}return e.next=10,this.sublayer.associatedLayer.load();case 10:e.t0=e.sent,e.next=14;break;case 13:e.t0=this.sublayer;case 14:return c=e.t0,e.t1=S.u,e.t2=this.sublayer.fieldsIndex,e.next=19,Object(Z.b)(c,Object(Z.a)(this.sublayer,r));case 19:e.t3=e.sent,l=(0,e.t1)(e.t2,e.t3),u=new Set,d=Object(s.a)(r.clientGraphics);try{for(d.s();!(h=d.n()).done;)b=h.value,Object(S.s)(l,b,u)?o.push(b):a.push(b)}catch(t){d.e(t)}finally{d.f()}if(0!==o.length){e.next=28;break}e.t4=Promise.resolve(a),e.next=33;break;case 28:if(e.t5=Object(v.k)(this.sublayer.associatedLayer),!e.t5){e.next=32;break}return e.next=32,this.sublayer.associatedLayer.load().catch((function(){return $.warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes.")}));case 32:e.t4=this.whenGraphicAttributes(o,Array.from(u)).catch((function(){return o})).then((function(e){return a.concat(e)}));case 33:return e.abrupt("return",e.t4);case 34:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_updateRequiredFields",value:function(){var e=Object(a.a)(n.a.mark((function e(){var t;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=S.j,e.t1=this.sublayer.fieldsIndex,e.t2=[],e.t3=_.a,!this.sublayer.renderer){e.next=10;break}return e.next=7,this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex);case 7:e.t4=e.sent,e.next=11;break;case 10:e.t4=[];case 11:e.t5=e.t4,e.t6=(0,e.t3)(e.t5),e.t7=Object(_.a)(this.definitionExpressionFields||[]),e.t8=Object(_.a)(this.filterExpressionFields||[]),e.t9=e.t2.concat.call(e.t2,e.t6,e.t7,e.t8),t=(0,e.t0)(e.t1,e.t9),this._set("requiredFields",t);case 18:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_validateFetchPopupFeatures",value:function(e){var t=this.sublayer;return t.popupEnabled?Object(Z.a)(t,e)?void 0:new I.a("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:t}):new I.a("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:t})}},{key:"getFilters",value:function(){var e=Object(k.a)(Object(w.a)(r.prototype),"getFilters",this).call(this);return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),Object(v.k)(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return Object(v.k)(this.filter)?this.filter.createQuery(e):new F.a(e)}},{key:"queryExtent",value:function(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatureCount",value:function(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatures",value:function(e,t){var r=this;return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==t?void 0:t.signal).then((function(e){if(null==e||!e.features)return e;var t,i=r.sublayer,n=i.layer,a=Object(s.a)(e.features);try{for(a.s();!(t=a.n()).done;){var o=t.value;o.layer=n,o.sourceLayer=i}}catch(c){a.e(c)}finally{a.f()}return e}))}},{key:"queryObjectIds",value:function(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"_ensureQueryEngine",value:function(){return Object(v.j)(this._queryEngine)&&(this._queryEngine=this._createQueryEngine()),this._queryEngine}},{key:"_createQueryEngine",value:function(){var e=this,t=Object(q.c)(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new B.a({layerView:this,priority:X.b.FEATURE_QUERY_ENGINE,spatialIndex:new Q.a({featureAdapter:new z.a({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:t}),forAllFeatures:function(t,r){return e._forAllFeatures((function(e,r,i){return t({id:e,index:r,meta:i})}),r,2)},getFeatureExtent:t,sourceSpatialReference:Object(W.p)(this.sublayer),viewSpatialReference:this.view.spatialReference})})}},{key:"_ensureQuery",value:function(e){return this._addDefinitionExpressionToQuery(Object(v.j)(e)?this.createQuery():F.a.from(e))}}]),r}(Object(K.a)(Object(R.a)(P(J))));Object(d.a)([Object(m.b)({aliasOf:"sublayer"})],ee.prototype,"i3slayer",void 0),Object(d.a)([Object(m.b)()],ee.prototype,"layerView",void 0),Object(d.a)([Object(m.b)()],ee.prototype,"suspended",void 0),Object(d.a)([Object(m.b)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],ee.prototype,"lodFactor",void 0),Object(d.a)([Object(m.b)({readOnly:!0})],ee.prototype,"parsedFilterExpressions",null),Object(d.a)([Object(m.b)({type:Y.a})],ee.prototype,"filter",null),Object(d.a)([Object(m.b)()],ee.prototype,"viewFilter",void 0),Object(d.a)([Object(m.b)({type:[String],readOnly:!0})],ee.prototype,"filterExpressionFields",null),Object(d.a)([Object(m.b)({type:[String],readOnly:!0})],ee.prototype,"requiredFields",void 0),Object(d.a)([Object(m.b)({type:[String],readOnly:!0})],ee.prototype,"availableFields",null);var te=ee=Object(d.a)([Object(j.a)("esri.views.3d.layers.BuildingComponentSublayerView3D")],ee),re=r(631),ie=r(458),ne=function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).layer=null,e.sublayerViews=null,e}return Object(c.a)(r,[{key:"highlight",value:function(e){throw new Error("Not implemented")}}]),r}(r(630).a);Object(d.a)([Object(m.b)()],ne.prototype,"layer",void 0),Object(d.a)([Object(m.b)()],ne.prototype,"sublayerViews",void 0);var ae=y.a.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),se=P(b.a),oe=function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(){var e;return Object(o.a)(this,r),(e=t.apply(this,arguments)).type="building-scene-3d",e.sublayerViews=new f.a,e._abortController=Object(g.e)(),e._loadingComponents=0,e}return Object(c.a)(r,[{key:"filterExpression",get:function(){var e=this.layer.activeFilterId,t=null!=e?this.layer.filters.find((function(t){return t.id===e})):null,r=null!=t?t.filterBlocks.find((function(e){return"solid"===e.filterMode.type})):null;return r?r.filterExpression:null}},{key:"filterExpressions",get:function(){var e=this.layer.activeFilterId,t=null!=e?this.layer.filters.find((function(t){return t.id===e})):null;return t&&t.filterBlocks?t.filterBlocks.toArray().map((function(e){return[e.filterExpression,T(e)]})):[]}},{key:"updatingProgressValue",get:function(){var e=this.sublayerViews,t=this._loadingComponents+(e?e.length:0);return e.reduce((function(e,t){return e+t.updatingProgress}),0)/t}},{key:"isUpdating",value:function(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((function(e){return e.updating}))}},{key:"initialize",value:function(){Object(W.f)(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this.initializeSubLayerViews(this.layer.sublayers,this)}},{key:"destroy",value:function(){this.sublayerViews&&(this.sublayerViews.forEach((function(e){return e.destroy()})),this.sublayerViews=null),this._abortController.abort(),this._abortController=null}},{key:"initializeSubLayerViews",value:function(e,t){var r=this,i=this,n=this.view;e.forEach((function(e){if(!e.isEmpty)if("building-group"===e.type){var a=new se({sublayer:e,view:n,parent:t});r.initializeSubLayerViews(e.sublayers,a)}else"mesh"===e.geometryType&&(r._loadingComponents++,e.load({signal:r._abortController.signal}).then((function(){var a=new te({sublayer:e,layerView:i,view:n,parent:t});r.sublayerViews.push(a),r.handles.add([Object(O.a)(a,"updating",(function(){return r.notifyChange("updating")}),!0),Object(O.a)(a,"updatingProgress",(function(){return r.notifyChange("updatingProgressValue")}),!0)])})).catch((function(t){Object(g.n)(t)||ae.error("Error while creating view for sublayer ".concat(e.id,"\nLayer: ").concat(r.layer.url,"\n"),t)})).then((function(){r._loadingComponents--,r.notifyChange("updating"),r.notifyChange("updatingProgressValue")})))}))}},{key:"getGraphicFromIntersectorMetadata",value:function(e){var t,r=Object(s.a)(this.sublayerViews.items);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(i.sublayer.uid===e.sublayerUid)return i.getGraphicFromIntersectorMetadata(e)}}catch(n){r.e(n)}finally{r.f()}return null}},{key:"fetchPopupFeatures",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){var i;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Object(v.k)(r)&&r.clientGraphics&&0!==r.clientGraphics.length){e.next=2;break}return e.abrupt("return");case 2:return i=this._findComponent(r.clientGraphics[0].sourceLayer),e.abrupt("return",Object(v.j)(i)?void 0:i.fetchPopupFeatures(t,r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"whenGraphicBounds",value:function(e){var t=this._findComponent(e.sourceLayer);return Object(v.j)(t)?Promise.reject():t.whenGraphicBounds(e)}},{key:"_findComponent",value:function(e){return this.sublayerViews.find((function(t){return e===t.sublayer}))}},{key:"highlight",value:function(e){e instanceof h.a?e=[e]:e instanceof f.a&&(e=e.toArray());var t=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof h.a){var r,i=e,n=new Map,a=Object(s.a)(i);try{for(a.s();!(r=a.n()).done;){var o=r.value,c=n.get(o.sourceLayer);null==c&&(c=[],n.set(o.sourceLayer,c)),c.push(o)}}catch(l){a.e(l)}finally{a.f()}this.sublayerViews.forEach((function(e){var r=n.get(e.sublayer);r&&t.push(e.highlight(r))}))}return Object(p.a)(t)}},{key:"getUsedMemory",value:function(){return this.sublayerViews.reduce((function(e,t){return e+t.getUsedMemory()}),0)}},{key:"getUnloadedMemory",value:function(){return this.sublayerViews.reduce((function(e,t){return e+t.getUnloadedMemory()}),0)}},{key:"ignoresMemoryFactor",value:function(){return!1}}]),r}(Object(re.a)(ne));Object(d.a)([Object(m.b)()],oe.prototype,"sublayerViews",void 0),Object(d.a)([Object(m.b)({readOnly:!0})],oe.prototype,"filterExpression",null),Object(d.a)([Object(m.b)({readOnly:!0})],oe.prototype,"filterExpressions",null),Object(d.a)([Object(m.b)(ie.a)],oe.prototype,"updatingProgress",void 0),Object(d.a)([Object(m.b)({readOnly:!0,dependsOn:[]})],oe.prototype,"updatingProgressValue",null);var ce=oe=Object(d.a)([Object(j.a)("esri.views.3d.layers.BuildingSceneLayerView3D")],oe)},774:function(e,t,r){"use strict";r.r(t),r.d(t,"destroyContext",(function(){return x})),r.d(t,"dracoDecompressPointCloudData",(function(){return p})),r.d(t,"filterObbsForModifications",(function(){return v})),r.d(t,"filterObbsForModificationsSync",(function(){return C})),r.d(t,"initialize",(function(){return N})),r.d(t,"interpretObbModificationResults",(function(){return I})),r.d(t,"process",(function(){return b})),r.d(t,"setLegacySchema",(function(){return j})),r.d(t,"setModifications",(function(){return O})),r.d(t,"setModificationsSync",(function(){return k})),r.d(t,"test",(function(){return M}));var i,n,a,s=r(8),o=r.n(s),c=r(15),l=r(4),u=r(104),d=r(101);function h(e){return Object(d.b)("esri/libs/i3s/".concat(e))}function b(e){return f.apply(this,arguments)}function f(){return(f=Object(c.a)(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:return r=[t.geometryBuffer],e.abrupt("return",{result:w(t,r),transferList:r});case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function p(e){return y.apply(this,arguments)}function y(){return(y=Object(c.a)(o.a.mark((function e(t){var r,i,n,s,c,l,d,h,b;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:if(i=[t.geometryBuffer],n=t.geometryBuffer,s=n.byteLength,c=a._malloc(s),(l=new Uint8Array(a.HEAPU8.buffer,c,s)).set(new Uint8Array(n)),d=a.dracoDecompressPointCloudData(c,l.byteLength),a._free(c),!(d.error.length>0)){e.next=7;break}throw"i3s.wasm: ".concat(d.error);case 7:return h=(null==(r=d.featureIds)?void 0:r.length)>0?Object(u.m)(d.featureIds):null,b=Object(u.m)(d.positions),h&&i.push(h.buffer),i.push(b.buffer),e.abrupt("return",{result:{positions:b,featureIds:h},transferList:i});case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e){return g.apply(this,arguments)}function g(){return(g=Object(c.a)(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:return C(t),r={buffer:t.buffer},e.abrupt("return",{result:r,transferList:[r.buffer]});case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function O(e){return m.apply(this,arguments)}function m(){return(m=Object(c.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:k(t);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return _.apply(this,arguments)}function _(){return(_=Object(c.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N();case 2:a.setLegacySchema(t.context,t.jsonSchema);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function x(e){S(e)}function k(e){for(var t=e.modifications,r=a._malloc(8*t.length),i=new Float64Array(a.HEAPU8.buffer,r,t.length),n=0;n<t.length;++n)i[n]=t[n];a.setModifications(e.context,r,t.length,e.isGeodetic),a._free(r)}function w(e,t){if(!a)return null;var r=e.context,i=e.localOrigin,n=e.globalTrafo,s=e.mbs,o=e.obb,c=e.elevationOffset,d=e.geometryBuffer,h=e.geometryDescriptor,b=e.indexToVertexProjector,f=e.vertexToRenderProjector,p=a._malloc(d.byteLength),y=a._malloc(33*Float64Array.BYTES_PER_ELEMENT),v=new Uint8Array(a.HEAPU8.buffer,p,d.byteLength);v.set(new Uint8Array(d));var g=new Float64Array(a.HEAPU8.buffer,y,33);F(g,i);var O=g.byteOffset+3*g.BYTES_PER_ELEMENT,m=new Float64Array(g.buffer,O);F(m,n),O+=16*g.BYTES_PER_ELEMENT,F(m=new Float64Array(g.buffer,O),s),O+=4*g.BYTES_PER_ELEMENT,Object(l.k)(o)&&(F(m=new Float64Array(g.buffer,O),o.center),O+=3*g.BYTES_PER_ELEMENT,F(m=new Float64Array(g.buffer,O),o.halfSize),O+=3*g.BYTES_PER_ELEMENT,F(m=new Float64Array(g.buffer,O),o.quaternion));var j=h,_={isDraco:!1,isLegacy:!1,color:e.layouts.some((function(e){return e.some((function(e){return"color"===e.name}))})),normal:e.needNormals&&e.layouts.some((function(e){return e.some((function(e){return"normalCompressed"===e.name}))})),uv0:e.layouts.some((function(e){return e.some((function(e){return"uv0"===e.name}))})),uvRegion:e.layouts.some((function(e){return e.some((function(e){return"uvRegion"===e.name}))})),featureIndex:j.featureIndex},x=a.process(r,!!e.obb,p,v.byteLength,j,_,y,c,b,f,e.normalReferenceFrame);if(a._free(y),a._free(p),x.error.length>0)throw"i3s.wasm: ".concat(x.error);if(x.discarded)return null;var k=x.componentOffsets.length>0?Object(u.m)(x.componentOffsets):null,w=x.featureIds.length>0?Object(u.m)(x.featureIds):null,I=Object(u.m)(x.interleavedVertedData).buffer,C=1===x.indicesType?Object(u.m)(new Uint16Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/2)):Object(u.m)(new Uint32Array(x.indices.buffer,x.indices.byteOffset,x.indices.byteLength/4)),S=Object(u.m)(x.positions),N=1===x.positionIndicesType?Object(u.m)(new Uint16Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/2)):Object(u.m)(new Uint32Array(x.positionIndices.buffer,x.positionIndices.byteOffset,x.positionIndices.byteLength/4)),M={layout:e.layouts[0],interleavedVertexData:I,indices:C,hasColors:x.hasColors,hasModifications:x.hasModifications,positionData:{data:S,indices:N}};return w&&t.push(w.buffer),k&&t.push(k.buffer),t.push(I),t.push(C.buffer),t.push(S.buffer),t.push(N.buffer),{componentOffsets:k,featureIds:w,transformedGeometry:M,obb:x.obb}}function I(e){return 0===e?0:1===e?1:2===e?2:3}function C(e){var t=e.context,r=e.buffer,i=a._malloc(r.byteLength),n=r.byteLength/Float64Array.BYTES_PER_ELEMENT,s=new Float64Array(a.HEAPU8.buffer,i,n),o=new Float64Array(r);s.set(o),a.filterOBBs(t,i,n),o.set(s),a._free(i)}function S(e){a&&a.destroy(e)}function F(e,t){for(var r=0;r<t.length;++r)e[r]=t[r]}function N(){return a?Promise.resolve():(n||(n=(i||(i=new Promise((function(e){return r.e(95).then(r.bind(null,1189)).then((function(e){return e.i})).then((function(t){var r=(0,t.default)({locateFile:h,onRuntimeInitialized:function(){return e(r)}});delete r.then}))})).catch((function(e){return Promise.reject(e)}))),i).then((function(e){a=e,n=null}))),n)}var M={transform:w,destroy:S}},803:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return l}));var i=r(8),n=r.n(i),a=r(42),s=r(15),o=r(4),c=r(112);function l(e){return u.apply(this,arguments)}function u(){return u=Object(s.a)(n.a.mark((function e(t){var r,i,s,l,u,d,h,b,f,p=arguments;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=p.length>1&&void 0!==p[1]?p[1]:t.popupTemplate,Object(o.k)(r)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,r.getRequiredFields(t.fieldsIndex);case 5:if(i=e.sent,s=r.lastEditInfoEnabled,l=t.objectIdField,u=t.typeIdField,d=t.globalIdField,h=t.relationships,!i.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,Object(c.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return b=e.t0,f=Object(c.j)(t.fieldsIndex,[].concat(Object(a.a)(i),Object(a.a)(b))),e.abrupt("return",(u&&f.push(u),f&&l&&t.fieldsIndex.has(l)&&-1===f.indexOf(l)&&f.push(l),f&&d&&t.fieldsIndex.has(d)&&-1===f.indexOf(d)&&f.push(d),h&&h.forEach((function(e){var r=e.keyField;f&&r&&t.fieldsIndex.has(r)&&-1===f.indexOf(r)&&f.push(r)})),f));case 23:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}function d(e,t){return e.popupTemplate?e.popupTemplate:Object(o.k)(t)&&t.defaultPopupTemplateEnabled&&Object(o.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},808:function(e,t,r){"use strict";r.d(t,"a",(function(){return x}));var i,n=r(14),a=r(2),s=r(3),o=r(6),c=r(7),l=r(0),u=r(140),d=r(193),h=r(60),b=r(30),f=r(27),p=r(1),y=(r(18),r(17),r(16),r(12)),v=r(45),g=r(108),O=r(171),m=new h.a({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),j=new h.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),_=i=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var i;return Object(a.a)(this,r),(i=t.call(this,e)).where=null,i.geometry=null,i.spatialRelationship="intersects",i.hiddenIds=new Set,i.distance=void 0,i.objectIds=null,i.units=null,i.timeExtent=null,i.enabled=!1,i}return Object(s.a)(r,[{key:"writeWhere",value:function(e,t){t.where=e||"1=1"}},{key:"enable",value:function(){this._set("enabled",!0)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.where,r=this.geometry,i=this.spatialRelationship,a=this.timeExtent,s=this.objectIds,o=this.units,c=this.distance;return new O.a(Object(n.a)({geometry:Object(f.a)(r),objectIds:Object(f.a)(s),spatialRelationship:i,timeExtent:Object(f.a)(a),where:t,units:o,distance:c},e))}},{key:"clone",value:function(){var e=this.where,t=this.geometry,r=this.spatialRelationship,n=this.hiddenIds,a=this.timeExtent,s=this.objectIds,o=this.units,c=this.distance,l=new Set;return n.forEach((function(e){return l.add(e)})),new i({geometry:Object(f.a)(t),hiddenIds:l,objectIds:Object(f.a)(s),spatialRelationship:r,timeExtent:Object(f.a)(a),where:e,units:o,distance:c})}}]),r}(b.a);Object(l.a)([Object(p.b)({type:String})],_.prototype,"where",void 0),Object(l.a)([Object(v.a)("where")],_.prototype,"writeWhere",null),Object(l.a)([Object(p.b)({types:u.a,json:{read:g.a,write:!0}})],_.prototype,"geometry",void 0),Object(l.a)([Object(p.b)({type:String,json:{read:{source:"spatialRel",reader:m.read},write:{target:"spatialRel",writer:m.write}}})],_.prototype,"spatialRelationship",void 0),Object(l.a)([Object(p.b)({json:{write:function(e,t,r){return t[r]=Array.from(e)},read:function(e){return new Set(e)}}})],_.prototype,"hiddenIds",void 0),Object(l.a)([Object(p.b)({type:Number,json:{write:{overridePolicy:function(e){return{enabled:e>0}}}}})],_.prototype,"distance",void 0),Object(l.a)([Object(p.b)({type:[Number],json:{write:!0}})],_.prototype,"objectIds",void 0),Object(l.a)([Object(p.b)({type:String,json:{read:j.read,write:{writer:j.write,overridePolicy:function(e){return{enabled:e&&this.distance>0}}}}})],_.prototype,"units",void 0),Object(l.a)([Object(p.b)({type:d.a,json:{write:!0}})],_.prototype,"timeExtent",void 0),Object(l.a)([Object(p.b)({readOnly:!0})],_.prototype,"enabled",void 0);var x=_=i=Object(l.a)([Object(y.a)("esri.views.layers.support.FeatureFilter")],_)},834:function(e,t,r){"use strict";function i(e){return e&&"getAtOrigin"in e&&"originOf"in e}r.d(t,"a",(function(){return i}))},835:function(e,t,r){"use strict";r.d(t,"a",(function(){return c})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return l}));var i=r(4),n=r(5),a=r(10),s=r(49),o=r(37);function c(e,t,r,i){for(var a=t.getComponentAabb(r,e,d),s=t.getObjectTransform(r),o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=4&o?a[2]:a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),i[3*o]=h[0],i[3*o+1]=h[1],i[3*o+2]=h[2];return i}function l(e,t,r){var n=new Float64Array(24);return function(a){var l=a.meta.featureExtents;if(Object(i.j)(l)){l=new Float64Array(6*a.meta.featureIds.length),a.meta.featureExtents=l;for(var u=0;u<l.length;u+=6)l[u]=Number.POSITIVE_INFINITY}var d=new Float64Array(l.buffer,6*a.index*Float64Array.BYTES_PER_ELEMENT,6);return d[0]===Number.POSITIVE_INFINITY&&(c(a.index,r,a.meta.objectHandle,n),Object(s.q)(n,t,0,n,e,0,8)?(Object(o.B)(d,o.a),Object(o.n)(d,n,0,8)):Object(o.B)(d,o.c)),d}}function u(e,t,r,i){var a=t.getComponentAabb(r,e,d),s=t.getObjectTransform(r);i[0]=0,i[1]=0,i[2]=0;for(var o=0;o<8;++o)h[0]=1&o?a[0]:a[3],h[1]=2&o?a[1]:a[4],h[2]=a[5],Object(n.z)(h,h,s.rotationScale),Object(n.h)(h,h,s.position),i[0]+=h[0],i[1]+=h[1],i[2]+=h[2];return i[0]/=8,i[1]/=8,i[2]/=8,i}var d=Object(o.h)(),h=Object(a.e)()},836:function(e,t,r){"use strict";r.d(t,"a",(function(){return k})),r.d(t,"b",(function(){return j})),r.d(t,"c",(function(){return p})),r.d(t,"d",(function(){return O})),r.d(t,"e",(function(){return w})),r.d(t,"f",(function(){return I}));var i=r(20),n=r(17),a=r(21),s=r(4),o=r(2),c=r(3),l=function(){function e(t,r){var i=this;Object(o.a)(this,e),this._textureRep=t,this._textureId=r,this._textureRef=Object(s.c)(this._textureId,(function(e){return i._textureRep.acquire(e)}))}return Object(c.a)(e,[{key:"dispose",value:function(){var e=this;this._textureRef=Object(s.c)(this._textureId,(function(t){e._textureRep.release(t)}))}},{key:"bind",value:function(e,t,r){if(Object(s.k)(this._textureRef)){var i=this._textureRef.glTexture;e.bindTexture(i,t),e.setUniform2f(r,i.descriptor.width,i.descriptor.height)}}}]),e}(),u=r(307),d=r(121),h=r(58);var b,f=r(234);function p(e,t){var r=new Map,i=function(e,t){if(Object(s.j)(e))return-1;if(r.has(e.id)){var i=r.get(e.id);return i.usage|=t,i.id}var n=r.size;return r.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,o=t.emissiveFactor,c=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),l=c?u.a[0]:n?n.metallicFactor:1,d=c?u.a[1]:n?n.roughnessFactor:1,h="mask"===t.alphaMode?33:1,b={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:i(n&&n.baseColorTexture,h),metallicRoughnessTextureId:i(n&&n.metallicRoughnessTexture,2),metallicFactor:l,roughnessFactor:d},f={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:i(t.normalTexture,4),emissiveTextureId:i(t.emissiveTexture,16),occlusionTextureId:i(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:b,wrapTextures:!1,hasParametersFromSource:c},p=[];return r.forEach((function(t,r){var i=t.usage,n=Object(s.k)(e)&&e[r]&&e[r].formats,a=n?y(n.map((function(e){var t=e.name,r=e.format;return{name:t,encoding:v[r]}}))):[];p.push({id:r,usage:i,encodings:a})})),{material:f,textures:p}}function y(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var v={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},g=(b={},Object(i.a)(b,f.a.KTX2_ENCODING,2),Object(i.a)(b,f.a.BASIS_ENCODING,2),Object(i.a)(b,f.a.DDS_ENCODING,4),Object(i.a)(b,"image/png",8),Object(i.a)(b,"image/jpg",16),Object(i.a)(b,"image/jpeg",16),Object(i.a)(b,"image/ktx",32),b);function O(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,r=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,i=t&&e.materialDefinitions[t],n=r&&e.textureDefinitions[r],s=m();if(null!=i){var o=i.params;o.diffuse&&(s.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(s.doubleSided=o.doubleSided,s.cullFace=o.doubleSided?0:2),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(s.cullFace="none"===o.cullFace?0:"back"===o.cullFace?2:1),o.transparency&&(s.metallicRoughness.baseColorFactor[3]=Object(a.f)(1-o.transparency,0,1)),(o.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}var c=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(s.wrapTextures=!0);var l=1;"rgba"===n.channels&&(s.alphaMode="blend",l|=32);var u=n.images.length-1,d=n.images[u],h=function(e){return e&&e.split("/").pop()},b=Array.isArray(n.encoding)?y(n.encoding.map((function(e,t){return{name:h(d.href[t]),encoding:g[e]||0}}))):[{name:h(d.href),encoding:g[n.encoding]||0}];c.push({id:0,usage:l,encodings:b}),s.metallicRoughness.baseColorTextureId=0}return{material:s,textures:c}}var m=function(){return{alphaMode:"opaque",alphaCutoff:d.b,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function j(e,t,r,i){if(Object(s.j)(e)||null==e.data)return null;var n=e.data,o=!(n instanceof HTMLImageElement)||Object(a.l)(n.width)&&Object(a.l)(n.height),c=i.renderingContext.parameters.maxMaxAnisotropy,l=r&&!i.capabilities.shaderTextureLOD?1:c,u=o&&!e.downsampled&&l>1,d=r||!t.wrapTextures?_:x,h=function(e){switch(e){case 1:return f.a.KTX2_ENCODING;case 2:return f.a.BASIS_ENCODING;case 4:return f.a.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),b=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new f.a(n,{mipmap:u,maxAnisotropy:l,encoding:h,wrap:d,components:b,noUnpackFlip:!0})}var _={s:33071,t:33071},x={s:10497,t:10497};function k(e,t,r,i,n,o){var c=o.rendererTextureUsage,u=function(e){return function(e,t,r){if(Object(s.j)(e)||0===r)return null;for(var i=0;i<e.length;i++){var n=e[i];if(Object(s.k)(n)&&0!=(n.usage&r))return t[i].id}return null}(i,r,e&c)},b=t.metallicRoughness.baseColorFactor,f=Object(a.f)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[b[0],b[1],b[2],f],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=o.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=o.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:d.b,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var p=u(33);p&&(e.baseColorTexture=new l(n,p));var y=u(2);y&&(e.metallicRoughnessTexture=new l(n,y));var v=u(16);v&&(e.emissionTexture=new l(n,v));var g=u(8);g&&(e.occlusionTexture=new l(n,g));var O=u(4);O&&(e.normalTexture=new l(n,O)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&Object(h.i)(e)?2:e&&Object(h.j)(e)?3:1}(o.viewSpatialReference)}function w(e){var t=!!e.compressedTextureS3TC,r=!!e.compressedTextureETC,i=Object(n.a)("disable-feature:i3s-basis")?0:3;return 24|(t?4|i:0)|(r?i:0)}function I(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}},837:function(e,t,r){"use strict";r.d(t,"a",(function(){return _}));var i=r(8),n=r.n(i),a=r(15),s=r(14),o=r(11),c=r(4),l=r(834),u=r(44),d=r(641),h=r(231),b=r(185),f=r(1);function p(e){return y[function(e){return e instanceof Blob?e.type:function(e){var t=Object(u.n)(e);return O[t]||v}(e.url)}(e)]||g}var y={},v="text/plain",g=y[v],O={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(var m in O)y[O[m]]=m;var j=r(144);function _(e){var t=Object(c.k)(e)&&e.origins?e.origins:[void 0];return function(r,i){var n,a=function(e,t,r){if(Object(c.k)(e)&&"resource"===e.type)return function(e,t,r){var i=Object(h.b)(t,r);return{type:String,read:function(e,t,r){var n=Object(j.d)(e,t,r);return i.type===String?n:"function"==typeof i.type?new i.type({url:n}):void 0},write:{writer:function(t,n,a,o){if(!o||!o.resources)return"string"==typeof t?void(n[a]=Object(j.e)(t,o)):void(n[a]=t.write({},o));var d=function(e){return Object(c.j)(e)?null:"string"==typeof e?e:e.url}(t),h=d?Object(j.e)(d,Object(s.a)(Object(s.a)({},o),{},{verifyItemRelativeUrls:o&&o.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null}),1):null,f=i.type!==String&&(!Object(l.a)(this)||o&&o.origin&&this.originIdOf(r)>Object(b.d)(o.origin));o&&o.portalItem&&Object(c.k)(h)&&!Object(u.s)(h)?f?function(e,t,r,i,n,a,s,o){var c=s.portalItem.resourceFromPath(i),l=w(r,i,s);p(l)===Object(u.n)(c.path)?(k(e,t,c,l,s.resources.toUpdate),n[a]=i):x(e,t,r,i,n,a,s,o)}(this,r,t,h,n,a,o,e):function(e,t,r,i){i.resources.toKeep.push({resource:i.portalItem.resourceFromPath(e)}),t[r]=e}(h,n,a,o):o&&o.portalItem&&(Object(c.j)(h)||Object(c.k)(Object(j.b)(h))||Object(u.t)(h)||f)?x(this,r,t,h,n,a,o,e):n[a]=h}}}}(e,t,r);switch(Object(c.k)(e)&&e.type?e.type:"other"){case"other":return{read:!0,write:!0};case"url":return{read:j.c.read,write:j.c.write}}}(e,r,i),d=Object(o.a)(t);try{for(d.s();!(n=d.n()).done;){var y=n.value,v=Object(f.c)(r,y,i);for(var g in a)v[g]=a[g]}}catch(O){d.e(O)}finally{d.f()}}}function x(e,t,r,i,n,a,s,o){var l=Object(d.a)(),h=w(r,i,s),b=Object(u.z)(Object(c.i)(o,"prefix"),l),f="".concat(b,".").concat(p(h)),y=s.portalItem.resourceFromPath(f);Object(u.t)(i)&&s.resources.pendingOperations.push(function(e){return I.apply(this,arguments)}(i).then((function(e){y.path="".concat(b,".").concat(p(e)),n[a]=y.itemRelativeUrl})).catch((function(){}))),k(e,t,y,h,s.resources.toAdd),n[a]=y.itemRelativeUrl}function k(e,t,r,i,n){n.push({resource:r,content:i,finish:function(r){!function(e,t,r){"string"==typeof e[t]?e[t]=r.url:e[t].url=r.url}(e,t,r)}})}function w(e,t,r){return"string"==typeof e?{url:t}:new Blob([JSON.stringify(e.toJSON(r))],{type:"application/json"})}function I(){return(I=Object(a.a)(n.a.mark((function e(t){var i,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,107));case 2:return i=e.sent.default,e.next=5,i(t,{responseType:"blob"});case 5:return a=e.sent,s=a.data,e.abrupt("return",s);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}},842:function(e,t,r){"use strict";function i(e,t,r){if(!r||null==t)return null;if(!e)return function(e,t){var r=t.toLowerCase();for(var i in e)if(i.toLowerCase()===r)return e[i];return null}(t,r);var i=e.get(r);return i?t[i.name]:null}r.d(t,"a",(function(){return i}))},855:function(e,t,r){"use strict";r.d(t,"a",(function(){return m})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return d})),r.d(t,"d",(function(){return y}));var i=r(2),n=r(6),a=r(7),s=r(0),o=r(30),c=r(1),l=(r(17),r(18),r(16),r(53)),u=r(12),d=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).nodesPerPage=null,e.rootIndex=0,e.lodSelectionMetricType=null,e}return r}(o.a);Object(s.a)([Object(c.b)({type:Number})],d.prototype,"nodesPerPage",void 0),Object(s.a)([Object(c.b)({type:Number})],d.prototype,"rootIndex",void 0),Object(s.a)([Object(c.b)({type:String})],d.prototype,"lodSelectionMetricType",void 0),d=Object(s.a)([Object(u.a)("esri.layer.support.I3SNodePageDefinition")],d);var h=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).factor=1,e}return r}(o.a);Object(s.a)([Object(c.b)({type:Number,json:{read:{source:"textureSetDefinitionId"}}})],h.prototype,"id",void 0),Object(s.a)([Object(c.b)({type:Number})],h.prototype,"factor",void 0),h=Object(s.a)([Object(u.a)("esri.layer.support.I3SMaterialTexture")],h);var b=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).baseColorFactor=[1,1,1,1],e.baseColorTexture=null,e.metallicRoughnessTexture=null,e.metallicFactor=1,e.roughnessFactor=1,e}return r}(o.a);Object(s.a)([Object(c.b)({type:[Number]})],b.prototype,"baseColorFactor",void 0),Object(s.a)([Object(c.b)({type:h})],b.prototype,"baseColorTexture",void 0),Object(s.a)([Object(c.b)({type:h})],b.prototype,"metallicRoughnessTexture",void 0),Object(s.a)([Object(c.b)({type:Number})],b.prototype,"metallicFactor",void 0),Object(s.a)([Object(c.b)({type:Number})],b.prototype,"roughnessFactor",void 0),b=Object(s.a)([Object(u.a)("esri.layer.support.I3SMaterialPBRMetallicRoughness")],b);var f=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).alphaMode="opaque",e.alphaCutoff=.25,e.doubleSided=!1,e.cullFace="none",e.normalTexture=null,e.occlusionTexture=null,e.emissiveTexture=null,e.emissiveFactor=null,e.pbrMetallicRoughness=null,e}return r}(o.a);Object(s.a)([Object(l.a)({opaque:"opaque",mask:"mask",blend:"blend"})],f.prototype,"alphaMode",void 0),Object(s.a)([Object(c.b)({type:Number})],f.prototype,"alphaCutoff",void 0),Object(s.a)([Object(c.b)({type:Boolean})],f.prototype,"doubleSided",void 0),Object(s.a)([Object(l.a)({none:"none",back:"back",front:"front"})],f.prototype,"cullFace",void 0),Object(s.a)([Object(c.b)({type:h})],f.prototype,"normalTexture",void 0),Object(s.a)([Object(c.b)({type:h})],f.prototype,"occlusionTexture",void 0),Object(s.a)([Object(c.b)({type:h})],f.prototype,"emissiveTexture",void 0),Object(s.a)([Object(c.b)({type:[Number]})],f.prototype,"emissiveFactor",void 0),Object(s.a)([Object(c.b)({type:b})],f.prototype,"pbrMetallicRoughness",void 0),f=Object(s.a)([Object(u.a)("esri.layer.support.I3SMaterialDefinition")],f);var p=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return r}(o.a);Object(s.a)([Object(c.b)({type:String,json:{read:{source:["name","index"],reader:function(e,t){return null!=e?e:"".concat(t.index)}}}})],p.prototype,"name",void 0),Object(s.a)([Object(l.a)({jpg:"jpg",png:"png",dds:"dds","ktx-etc2":"ktx-etc2",ktx2:"ktx2",basis:"basis"})],p.prototype,"format",void 0),p=Object(s.a)([Object(u.a)("esri.layer.support.I3STextureFormat")],p);var y=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).atlas=!1,e}return r}(o.a);Object(s.a)([Object(c.b)({type:[p]})],y.prototype,"formats",void 0),Object(s.a)([Object(c.b)({type:Boolean})],y.prototype,"atlas",void 0),y=Object(s.a)([Object(u.a)("esri.layer.support.I3STextureSetDefinition")],y);var v=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return r}(o.a);Object(s.a)([Object(l.a)({Float32:"Float32",UInt64:"UInt64",UInt32:"UInt32",UInt16:"UInt16",UInt8:"UInt8"})],v.prototype,"type",void 0),Object(s.a)([Object(c.b)({type:Number})],v.prototype,"component",void 0),v=Object(s.a)([Object(u.a)("esri.layer.support.I3SGeometryAttribute")],v);var g=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return r}(o.a);Object(s.a)([Object(l.a)({draco:"draco"})],g.prototype,"encoding",void 0),Object(s.a)([Object(c.b)({type:[String]})],g.prototype,"attributes",void 0),g=Object(s.a)([Object(u.a)("esri.layer.support.I3SGeometryCompressedAttributes")],g);var O=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments)).offset=0,e}return r}(o.a);Object(s.a)([Object(c.b)({type:Number})],O.prototype,"offset",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"position",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"normal",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"uv0",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"color",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"uvRegion",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"featureId",void 0),Object(s.a)([Object(c.b)({type:v})],O.prototype,"faceRange",void 0),Object(s.a)([Object(c.b)({type:g})],O.prototype,"compressedAttributes",void 0),O=Object(s.a)([Object(u.a)("esri.layer.support.I3SGeometryBuffer")],O);var m=function(e){Object(n.a)(r,e);var t=Object(a.a)(r);function r(){return Object(i.a)(this,r),t.apply(this,arguments)}return r}(o.a);Object(s.a)([Object(l.a)({triangle:"triangle"})],m.prototype,"topology",void 0),Object(s.a)([Object(c.b)()],m.prototype,"geometryBuffers",void 0),m=Object(s.a)([Object(u.a)("esri.layer.support.I3SGeometryDefinition")],m)},856:function(e,t,r){"use strict";r.d(t,"a",(function(){return O}));var i,n=r(2),a=r(3),s=r(6),o=r(7),c=r(0),l=(r(140),r(30)),u=r(27),d=r(216),h=r(1),b=(r(18),r(17),r(16),r(12)),f=r(45),p=r(837),y=r(49),v=r(163),g=i=function(e){Object(s.a)(r,e);var t=Object(o.a)(r);function r(e){var i;return Object(n.a)(this,r),(i=t.call(this,e)).geometry=null,i.type="clip",i}return Object(a.a)(r,[{key:"writeGeometry",value:function(e,t,r,i){if(i.layer&&i.layer.spatialReference&&!i.layer.spatialReference.equals(this.geometry.spatialReference)){if(!Object(y.b)(e.spatialReference,i.layer.spatialReference))return void(i&&i.messages&&i.messages.push(new d.a("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:i.layer.spatialReference,context:i})));var n=new v.a;Object(y.w)(e,n,i.layer.spatialReference),t[r]=n.toJSON(i)}else t[r]=e.toJSON(i);delete t[r].spatialReference}},{key:"clone",value:function(){return new i({geometry:Object(u.a)(this.geometry),type:this.type})}}]),r}(l.a);Object(c.a)([Object(h.b)({type:v.a}),Object(p.a)()],g.prototype,"geometry",void 0),Object(c.a)([Object(f.a)(["web-scene","portal-item"],"geometry")],g.prototype,"writeGeometry",null),Object(c.a)([Object(h.b)({type:["clip","mask","replace"],nonNullable:!0}),Object(p.a)()],g.prototype,"type",void 0);var O=g=i=Object(c.a)([Object(b.a)("esri.layers.support.SceneModification")],g)},857:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var i=r(42),n=r(11),a=r(2),s=r(3),o=r(6),c=r(7),l=r(94),u=r(127),d=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(){var e;return Object(a.a)(this,r),(e=t.apply(this,arguments))._map=new Map,e}return Object(s.a)(r,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,r=0;r<e.length;r++){var i=e[r],n=i.objectId,a=this._map.get(n);a?(t.add(n),i!==a&&(e[r]=a),++a.refCount):(i.refCount=1,this._map.set(n,i))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,r=[],i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),r.push(a))}}catch(c){i.e(c)}finally{i.f()}r.length>0&&this.emit("change",{added:[],removed:r})}},{key:"removeManyByObjectId",value:function(e){var t,r=[],i=Object(n.a)(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),r.push(s))}}catch(o){i.e(o)}finally{i.f()}r.length>0&&this.emit("change",{added:[],removed:r})}},{key:"toArray",value:function(){return Object(i.a)(this._map.values())}},{key:"find",value:function(e){var t;return Object(u.c)(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),r}(l.a)},859:function(e,t,r){"use strict";r.d(t,"a",(function(){return Ve}));var i=r(42),n=r(29),a=r(2),s=r(3),o=r(6),c=r(7),l=r(0),u=r(34),d=r(61),h=r(17),b=r(16),f=r(4),p=r(73),y=r(268),v=r(25),g=r(36),O=r(1),m=(r(18),r(12)),j=r(49),_=r(37),x=r(43),k=r(204),w=r(649),I=r(11),C=r(115),S=r(103),F=function(){function e(t){Object(a.a)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(S.b.I3S_CONTROLLER,this)}return Object(s.a)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=Object(I.a)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(r){t.e(r)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i}},{key:"sort",value:function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){Object(C.k)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}]),e}(),N=new Map;function M(e,t){var r=N.get(e);return null==r&&(r=new F(e),N.set(e,r)),r.add(t),{remove:function(){null!=r&&(r.remove(t),r.callbacks.length>0||(N.delete(e),r.destroy()),r=null)}}}var E=r(5),D=r(46),P=function e(t,r){Object(a.a)(this,e),this.id=t,this.mbs=r,this.renderMbs=Object(D.d)([0,0,0,-1]),this.imModificationImpact=4},R=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e,i,n,s,o,c,l,u,d,h){var b;return Object(a.a)(this,r),(b=t.call(this,e,n)).index=i,b.childCount=s,b.level=o,b.resources=c,b.version=l,b.lodMetric=u,b.maxError=d,b.numFeatures=h,b.failed=!1,b.hasModifications=!1,b.cacheState=0,b.vertexCount=0,b.memory=0,b}return r}(P),L=function e(t,r,i,n){Object(a.a)(this,e),this.nodeHasLOD=t,this.isChosen=r,this.lodLevel=i,this.version=n},A=r(801),V=r(410),T=function e(t,r,i,n,s){Object(a.a)(this,e),this.childOffset=t,this.childCount=r,this.visibilityCache=i,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=2},U=function(){function e(t,r,i,n,s,o,c,l,u,d,h,b,f,y){Object(a.a)(this,e),this.streamDataController=i,this.viewportQueries=n,this.logger=s,this.holeFilling=o,this._isLoaded=c,this._isReloading=l,this._isSelected=u,this._enable=d,this._needsUpdate=h,this._canRequest=b,this._computeVisibilityObb=f,this._computeNodeFiltering=y,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=z(0),this._visibilityCacheVersion=z(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new p.a({deallocator:null}),this._prefetch=new p.a({deallocator:null}),this._updates=new q,this._imModificationUncategorized=new p.a({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(r)}return Object(s.a)(e,[{key:"init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=$}this.addPage(J(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new P(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}},{key:"loadPage",value:function(e){var t=this;this._loading.add(e);var r=this.urlPrefix+e;this.streamDataController.request(r,"json").then((function(r){t._loading.delete(e),t.addPage(e,r)})).catch((function(r){t._loading.delete(e),Object(v.n)(r)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),r))}))}},{key:"addPage",value:function(e,t){for(var r=this,i=this._nodePages.length;i<e;i++)this._nodePages[i]=null;var n=[],a=[],s=t.nodes.map((function(t,i){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var c=0;c<o;c++)n.push(t.children[c]);var l="".concat(t.index),u=Object(V.b)(t.obb),d=Object(D.d)([u.center[0],u.center[1],u.center[2],Object(E.r)(u.halfSize)]),h=t.mesh&&t.mesh.attribute,b=t.mesh&&t.mesh.geometry,f=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!b,attributes:h&&null!=h.resource?"".concat(h.resource):null,geometry:b&&null!=b.resource?"".concat(b.resource):null,texture:f&&null!=f.resource?"".concat(f.resource):null,geometryDefinition:b?b.definition:-1,materialDefinition:f?f.definition:-1},y=new R(l,e*r.nodesPerPage+i,d,o,0,p,r.lastUpdate,r.lodMetric,r.lodConversion(t.lodThreshold),b?b.featureCount:null);return y.serviceObb=u,y.visibilityObb=r._computeVisibilityObb(y),y.vertexCount=b?b.vertexCount:0,new T(s,o,B(r._visibilityCacheVersion),null,y)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length,this.updateParentsAndLevel()}},{key:"updateParentsAndLevel",value:function(){var e=this,t=new Array,r=function(r,i,n){var a=e.getPage(r);if(Object(f.k)(a)){var s=Y(r,e.nodesPerPage);a.parents[s]=i;var o=a.nodes[s].node;Object(f.k)(o)&&(o.level=n,t.push(r))}};for(r(this.rootIndex,-1,0);t.length;){var i=t.pop(),n=this.getNode(i);if(Object(f.k)(n))for(var a=0;a<n.childCount;a++)r(this.getChildIndex(n,a),i,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"getPage",value:function(e){return this._nodePages[J(e,this.nodesPerPage)]}},{key:"getNodeInternal",value:function(e){var t=this.getPage(e);return Object(f.j)(t)?null:t.nodes[Y(e,this.nodesPerPage)]}},{key:"addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var r=this.getParent(t),i=Object(f.k)(r)?r.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?i+1:i);var n=function(e){if(e)for(var t=0;t<e.length;t++){var r,i=Object(I.a)(Z);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){i.e(a)}finally{i.f()}}return{lodMetric:0,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=Object(f.t)(this.getNodeInternal(t));return o.node=new R(e.id,t,Object(D.d)(e.mbs),o.childCount,i,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=Object(V.b)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),Object(f.k)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"makeRefNode",value:function(e,t){var r=this._nodePages[0],i=r.nodes.length;return r.nodes.push(new T(0,0,B(this._visibilityCacheVersion),e,null)),this.nodeCount++,r.parents.push(t),e.renderMbs[3]=-1,Object(f.k)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),i}},{key:"populateChildren",value:function(e,t){var r=Object(f.t)(this.getNodeInternal(e)),i=Object(f.t)(this.getPage(e));r.childOffset=i.children.length,r.childCount=t.length;for(var n=0;n<t.length;n++){var a=this.makeRefNode(t[n],e);i.children.push(a)}}},{key:"getNode",value:function(e){var t=this.getNodeInternal(e);return Object(f.k)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this.forAllNodes((function(r,i){(Object(f.k)(r.node)&&r.node.id===e||Object(f.k)(r.ref)&&r.ref.id===e)&&(t=i)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var r=this.getPage(e.index);if(Object(f.j)(r))return-1;var i=r.nodes[Y(e.index,this.nodesPerPage)];return r.children[i.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this.getPage(e);return Object(f.k)(t)?t.parents[Y(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this.getNodeInternal(e);return Object(f.k)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=z(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this.getNodeInternal(e);Object(f.k)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=B(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this.getNodeInternal(e);Object(f.k)(t)&&(H(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"invalidateGeometryVisibility",value:function(e){var t=this.getNodeInternal(e);Object(f.k)(t)&&Object(f.k)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,Object(f.k)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;Object(f.j)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"isNodeVisible",value:function(e){var t=this.getNodeInternal(e);if(Object(f.j)(t)||Object(f.k)(t.ref)&&!t.ref.mbs)return!0;if(!W(t.visibilityCache,this._visibilityCacheVersion)){var r=t.node,i=Object(f.k)(r)&&(Object(f.j)(t.ref)||Object(f.k)(r.visibilityObb))?r:Object(f.k)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(Object(f.k)(r)||Object(f.k)(t.ref))&&2===t.filterImpact){var n=Object(f.k)(r)?r.mbs:Object(f.k)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):0}var a=Object(f.k)(r)&&1===t.filterImpact,s=!(Object(f.k)(r)&&2===r.imModificationImpact)&&(!i||this.viewportQueries.isNodeVisible(i))&&!a;return t.visibilityCache=Q(s,this._visibilityCacheVersion),s}return K(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(Object(f.k)(t)&&Object(f.k)(t.node)&&Object(f.k)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,r,i,n){var a=this.getPage(e);if(!Object(f.j)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,c=t.childOffset;c<s;++c){var l=a.children[c],u=this.getNodeInternal(l);Object(f.k)(u)&&Object(f.k)(u.node)&&this.isGeometryVisible(l)&&o.push(u)}i/=o.length;for(var d=0,h=o;d<h.length;d++){var b=h[d],p=Object(f.t)(b.node).index;this._isLoaded(p)||this._isReloading(p)?(n.delta=Math.max(n.delta,r),n.coverage+=i):this._traverseCoverage(p,b,r+1,i,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(Object(f.j)(t))return!1;if("always"===this.holeFilling)return!0;if(W(t.useAsHole,this._version))return K(t.useAsHole);var r={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,r);var i=r.delta*r.coverage<=.5;return t.useAsHole=Q(i,this._version),i}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=z(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var r=e.node;Object(f.k)(r)&&(r.imModificationImpact=4,r.visibilityObb=t._computeVisibilityObb(r),r.hasModifications&&t.invalidateGeometryVisibility(r.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this.forAllNodes((function(e){if(Object(f.k)(e)){e.filterImpact=2;var r=e.node;Object(f.k)(r)&&t.invalidateNodeVisibilityCache(r.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,r){var i=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),G.clear();var n=!0,a=new X,s=new X,o=this._imModificationUncategorized;o.clear();var c=new Set;this.traverseVisible((function(l,u,d){if(Object(f.j)(u)){var h=i.entryPriority(l);h===1/0&&(h=i.entryPriority(d));var b=J(l,i.nodesPerPage);return G.set(b,Math.max(h,G.get(b)||0)),i._loading.has(b)||i._failedPages.has(b)||i._missing.push(b),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,h))}var p=u.node;if(i._updateNodeFeatureEstimate(p,s),Object(f.j)(p)){var y=i.entryPriority(l);return i._loading.has(l)||i._failedNodes.has(l)||(i._missing.push(l),G.set(l,y)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,y))}var v=Object(f.t)(i.getPage(l));if(0===i._missing.length&&0===i.nodesPerPage)for(var g=0;g<u.childCount;g++){var O=v.children[u.childOffset+g],m=i.getNodeInternal(O);!Object(f.k)(m)||m.node||i._loading.has(O)||i._failedNodes.has(O)||(G.set(O,i.entryPriority(O)),i._prefetch.push(O))}if(!p.failed&&p.resources.hasFeatureData)if(c.add(p.id),i._isLoaded(l)){if(a.known+=p.memory,++a.knownNodes,i._isSelected(p)?u.childCount>0&&(n=!1):(a.unremoved+=p.memory,n=!1),i._needsUpdate(p)){var j=i.entryPriority(l);G.set(l,j),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,j),i._updates.update.push(l)}}else if(p.memory&&(a.known+=p.memory,++a.knownNodes),i._isSelected(p)){if(u.childCount>0&&(n=!1),p.memory?(a.missing+=p.memory,a.known+=p.memory,++a.knownNodes):++a.missingNodes,e.indexOf(p.index)>=0)return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i.entryPriority(l)),void(i._updates.cancel=i._updates.cancel.filter((function(e){return e!==p.index})));if(t.done||!i._enable(p)){var _=i.entryPriority(l);G.set(l,_),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,_),i._updates.add.push(l),i.layerHasModifications&&r&&Object(f.k)(p)&&4===p.imModificationImpact&&o.push(l)}else t.madeProgress()}else i._isReloading(l)&&i._updates.remove.push(l)}));var l=this._updates.add;l.length>0&&this.layerHasModifications&&(o.length>0&&r(o),l.filterInPlace((function(e){var t=i.getNodeInternal(e),r=Object(f.j)(t)||Object(f.j)(t.node)||2!==t.node.imModificationImpact;return r||i.invalidateNodeVisibilityCache(e),r}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||i._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return G.get(e)-G.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=G.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return G.get(e)>=i._maxUnloadedPrio})).sort((function(e,t){return G.get(e)-G.get(t)})),this._updates.update.sort((function(e,t){return G.get(e)-G.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,G.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,a=r,s=10;s--;){var o=new X;if(this._updateFeatureEstimate(i,o),this._computeFeatureEstimate(o)<=e){if(i>=t||o.missingNodes>0||0===s)break;a=i,i=.5*(i+n)}else n=i,i=.5*(i+a)}return this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)}},{key:"_updateFeatureEstimate",value:function(e,t){var r=this;this._version=z(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,i){return r._updateNodeFeatureEstimate(Object(f.k)(i)&&i.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!(Object(f.j)(e)||e.failed||Object(f.j)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(Object(f.k)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return G.get(e)-G.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if(Object(f.j)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&W(t.version,this._version))return t;var r=this.viewportQueries.getLodLevel(e),i=this.viewportQueries.hasLOD(e),n=!0;if(i){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&r>s.lodLevel}else n=r>0}else n=0===e.childCount;return t?(t.lodLevel=r,t.isChosen=n,t.version=Q(!0,this._version),t):(t=new L(i,n,r,Q(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var r=Object(f.t)(this.getNodeInternal(e)).ref;if(Object(f.j)(r))this._failedNodes.add(e);else{var i=r.id,n=this.urlPrefix+i,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(r){a();var n=t._validateNode(i,r);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t.addNode(n,e);t.nodeTraversalState(s)}}),(function(r){a(),Object(v.n)(r)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var i=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var i=function(t){return r.logger.error("#validateNode()",r.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)i("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&r.logger.error("#validateNode()",r.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!r.ignoreServiceObb?t.obb:null,a=new P("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=r._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:i,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){Object(f.k)(e.node)&&(e.node.failed=!1)}))}},{key:"entryPriority",value:function(e){var t=this.getNodeInternal(e),r=this.getParentIndex(e);if(Object(f.j)(t)||r<0&&null==t.node)return r<0?1/0:this.entryPriority(r);var i=0;if(t.node&&r>=0){var n=this._nodeTraversalState.get(r);null!=n&&(i=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=Object(f.k)(t.ref)?this.viewportQueries.distToPOI(t.ref):Object(f.k)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-i*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this.getNodeInternal(this.rootIndex);Object(f.j)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,r,i){if(r.node&&0===r.childCount)this.isGeometryVisible(e)&&i(e,r,t);else if(this.isNodeVisible(e)&&(i(e,r,t),null!=r.node)){var n=this.nodeTraversalState(r.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=Object(f.t)(this.getPage(e)),s=0;s<r.childCount;s++){var o=a.children[r.childOffset+s],c=this.getNodeInternal(o);Object(f.k)(c)?this._traverseVisible(o,e,c,i):i(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var r=e.index,i=this.getNodeInternal(r);Object(f.k)(i)&&this._traverseChildren(r,i,t)}},{key:"_traverseChildren",value:function(e,t,r){var i=this.getPage(e);if(!Object(f.j)(i))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=i.children[a],o=this.getNodeInternal(s);Object(f.k)(o)&&Object(f.k)(o.node)&&r(o.node)&&this._traverseChildren(s,o,r)}}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e){this.forAllNodes(H),this.viewportQueries.updateElevationInfo(e)}},{key:"forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var r=this._nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}}}]),e}(),G=new Map,q=function(){function e(){Object(a.a)(this,e),this.update=new p.a({deallocator:null}),this.add=new p.a({deallocator:null}),this.remove=new p.a({deallocator:null}),this.cancel=[]}return Object(s.a)(e,[{key:"reset",value:function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}]),e}();function H(e){Object(f.k)(e.node)&&(e.node.renderMbs[3]=-1,Object(f.k)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),Object(f.k)(e.ref)&&(e.ref.renderMbs[3]=-1,Object(f.k)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function B(e){return Object(A.a)(e,-2)}function z(e){return Object(A.a)(e,2)}function Q(e,t){return t+(e?1:0)}function W(e,t){return(-2&e)===t}function K(e){return 1==(1&e)}function J(e,t){return 0===t?0:e/t|0}function Y(e,t){return 0===t?e:e%t}var Z=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];var X=function e(){Object(a.a)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function $(e){return Math.sqrt(e*(4/Math.PI))}var ee=function(){function e(t){Object(a.a)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return Object(s.a)(e,[{key:"startNodeLoading",value:function(e,t,r,i){this._maxLodLevel=i.maxLodLevel,this._index=r,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if(Object(f.j)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));te.clear(),this._lodGlobalHandling(this._index.rootNode,r,!1);var i=te.length;this._removeNodes(te,e);var n=te.length<i;return 0!==te.length&&(this._lodGlobalDirty=!0),te.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,r){if(Object(f.j)(e))return!1;var i=e.index,n=this._index,a=this.layerView,s=n.nodeTraversalState(e),o=this.isChosenMaxLOD(s),c=a.isNodeLoaded(i),l=a.nodeCrossfadingEnabled;if(l&&c&&o){var u=!r&&this.hasNoVisibleChildren(e);a.fadeNode(i,0,!u)}var d=c&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(i));if(c&&(a.updateNodeState(i,o?1:0),o))return d&&this._removeChildrenRecursive(e),d;var h=e.childCount>0,b=h;if(h)for(var p=0;p<e.childCount;p++){var y=n.getChildIndex(e,p),v=n.getNode(y);Object(f.k)(v)?n.isGeometryVisible(y)&&!this._lodGlobalHandling(v,t,r||d)&&this._isNodeInScaleBounds(v)&&(b=!1):n.isNodeVisible(y)&&(b=!1)}var g=c&&!o&&(b||te.length<t);g&&te.push(i),!l||g||!c||r||b||a.fadeNode(i,0,!1);var O=!e.resources.hasFeatureData;return b||d&&!g||O}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&te.push(e.index),!0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,r=!0;return this._index.traverseChildren(e,(function(e){return!(!r||!t._index.isNodeVisible(e.index))&&(!t.layerView.isNodeLoaded(e.index)||(r=!1,!1))})),r}},{key:"_childrenRequireLoading",value:function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,(function(e){if(!i||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)})),i&&r}},{key:"isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),te=new p.a({deallocator:null}),re=r(8),ie=r.n(re),ne=r(15),ae=r(142),se=r(27),oe=r(44),ce=r(840),le=r(836),ue=function(){function e(t,r,i,n,s,o){if(Object(a.a)(this,e),this.streamDataController=r,this.logger=i,this.defaultGeometrySchema=n,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var c=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return Object(le.c)(c,e)}))}}return Object(s.a)(e,[{key:"load",value:function(e,t,r){return this.streamDataController.request(e,t,r)}},{key:"loadAttribute",value:function(e,t,r){var i="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this.load(i,"binary",r).then((function(e){return Object(ce.d)(t,e)}))}},{key:"loadAttributes",value:function(e,t,r){var i=this;return Object(v.k)(t.map((function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var n={},a=0;a<t.length;++a)if(r[a].value)n[t[a].name]=r[a].value;else{if(Object(v.n)(r[a].error))throw r[a].error;i.logger.error("#loadAttributes",i.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),r[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=Object(ne.a)(ie.a.mark((function e(t,r){var i,n,a,s,o,c,l,u,d,h,b,p,y,v,g,O,m,j,_,x,k,w;return ie.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null!=this.requiredAttributes&&t.resources.attributes?Object(ae.d)(this.loadAttributes(t,this.requiredAttributes,r)):null,n=fe(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,c=o?Object(ae.d)(this.loadGeometry(t.resources.geometry,s,r)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this.loadShared(t,r);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(l=e.t0,u=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=l?Object(le.d)(l):null,d=u&&u.material,h=u&&u.textures,b="".concat(t.id),!(p=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this.loadFeatureData(b,r);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(y=e.t1,v=p?de(y):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:d}}],featureDataPosition:[0,0,0]},g=Object(f.j)(v)&&he(y),O=null!=h&&h.length>0?Object(ae.d)(this.loadTextures(t,h,r)):null,m=null,j=null,!c){e.next=39;break}return e.t2=ae.a,e.next=35,c;case 35:e.t3=e.sent,m=(0,e.t2)(e.t3),_=be(this.defaultGeometrySchema,l),j=Object(ce.a)(a,_);case 39:if(!O){e.next=47;break}return e.t5=ae.a,e.next=43,O;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(x=e.t4,!i){e.next=57;break}return e.t8=ae.a,e.next=53,i;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:return k=e.t7,w=k?{attributeData:k,loadedAttributes:this.requiredAttributes}:null,e.abrupt("return",Object(f.k)(v)?{geometryData:v,attributeDataInfo:w,geometryBuffer:m,geometryDescriptor:j,requiredTextures:h,textureData:x}:Object(f.k)(g)?{pointData:g,attributeDataInfo:w,geometryBuffer:m,geometryDescriptor:j,requiredTextures:h,textureData:x}:Promise.reject());case 61:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"loadShared",value:function(t,r){var i="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this.load(i,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t}))}},{key:"loadTexture",value:function(e,t,r,i,n,a){var s=!1;return 4===n||1===n||2===n?this.load(e,"binary",a).then((function(e){return{id:t,usage:r,data:e,encoding:n,downsampled:s}})):this.load(e,"image",a).then((function(e){var a=e;if(i&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),c=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=o,l.height=c,l.getContext("2d").drawImage(e,0,0,o,c),a=l,s=!0}return{id:t,usage:r,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,r){var i=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Object(le.f)(t.encodings,i.options.textureEncodings);if(null==s)return i.logger.error("#loadTextures",i.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,c="".concat(i.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return i.loadTexture(c,t.id,t.usage,n,s.encoding,r)})))}},{key:"loadFeatureData",value:function(e,t){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this.load(r,"json",t)}},{key:"loadGeometry",value:function(e,t,r){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this.load(i,"binary",r)}}],[{key:"addAbsoluteHrefTexture",value:function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++){var a,s=n[i],o=Object(I.a)(r[s].images);try{for(o.s();!(a=o.n()).done;){var c=a.value;Array.isArray(c.href)?c.hrefConcat=c.href.map((function(e){return Object(oe.A)(e,t)})):c.hrefConcat=Object(oe.A)(c.href,t)}}catch(l){o.e(l)}finally{o.f()}}}},{key:"fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var a=i.encoding[n];"data:"===a.substring(0,5)&&(i.encoding[n]=a.substring(5))}else{var s=i.encoding;"data:"===s.substring(0,5)&&(i.encoding=s.substring(5))}}}}]),e}();function de(e){var t,r=Object(I.a)(e.featureData);try{for(r.s();!(t=r.n()).done;){var i=t.value,n=i.geometries;if(null!=n){var a,s=Object(I.a)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[i.id],featureDataPosition:i.position,geometries:[o]}}}catch(c){s.e(c)}finally{s.f()}}}}catch(c){r.e(c)}finally{r.f()}return null}function he(e){var t,r=new Array,i=Object(I.a)(e.featureData);try{for(i.s();!(t=i.n()).done;){var n=t.value;null!=n.position&&r.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){i.e(a)}finally{i.f()}return r}function be(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Object(se.a)(e)).vertexAttributes.region,e}function fe(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var n=0;n<i.length;n++){var a=i[n];if(null==a.compressedAttributes)r.bufferIndex=n,r.bufferDefinition=i[n];else if("draco"===a.compressedAttributes.encoding&&!Object(h.a)("disable-feature:i3s-draco"))return r.bufferIndex=n,r.bufferDefinition=a,r}return r}var pe=function(){function e(t,r){Object(a.a)(this,e),this.requester=t,this.apiKey=r,this.activeRequests=new Set}return Object(s.a)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,r){var i=this,n=Object(v.e)(),a=Object(v.t)(r,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),c={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(c),Object(v.c)(o,(function(){var e;c.abortController=null,null==(e=c.abortHandle)||e.remove(),c.abortHandle=null,i.activeRequests.delete(c)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,r;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(r=e.abortHandle)||r.remove()})),this.activeRequests.clear()}}]),e}(),ye=r(10),ve=r(55),ge=r(70),Oe=r(135),me=r(74),je=r(71),_e=r(173),xe=r(261),ke=1e5,we=function(){function e(t,r,i,n,s,o,c){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};Object(a.a)(this,e),this.indexSR=t,this._renderCoordsHelper=r,this.extent=s,this.elevationProvider=o,this.options=l,this._frustum=Object(Oe.c)(),this._useFrustumCulling=!1,this._poi=Object(ye.e)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=Object(ye.e)(),this._tmp2=Object(ye.e)(),this._tmp3=Object(ye.e)(),this._tmp0=Object(ye.e)(),this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(i,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(c),this.tmpPoint=Object(k.j)(0,0,0,t)}return Object(s.a)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=_e.a.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Object(xe.c)(Object(xe.f)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&Object(Oe.e)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}},{key:"updateExtent",value:function(e){this.extent=e}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return t[3]<0&&(Object(ve.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=Object(je.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),Object(j.p)(t,this.indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if(Object(f.k)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb;return Object(f.j)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,r){if(Object(f.j)(t)&&(t=Object(V.e)()),t.halfSize[0]<0){var i=0;this._elevationContext&&r<ke&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],i=Object(je.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),Object(A.v)(e,this.indexSR,t,this.engineSR,i)}return t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;var r=this.getVisibilityObb(e);return Object(f.k)(r)?Object(V.h)(r,this._frustum):Object(Oe.j)(this._frustum,Object(me.n)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return Object(f.k)(t)?Object(V.h)(t,this._frustum):this.isNodeVisible(e)}},{key:"isMBSinExtent",value:function(e){return!this.extent||0!==Object(A.s)(this.extent,e)}},{key:"screenSpaceDiameterMbs",value:function(e,t){var r=this.getRenderMbs(e),i=Math.sqrt(Object(E.n)(r,this._camPos)),n=i-r[3];return this._updateMinMaxDistance(i),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),r=Object(E.o)(t,this._camPos);return this._updateMinMaxDistance(r),r}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),r=t[3],i=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/Object(E.r)(t)+r)/Object(E.o)(t,this._camPos);return Math.min(1,i)}},{key:"hasLOD",value:function(e){return 0!==e.lodMetric}},{key:"getDistancePlanarMode",value:function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],a=r*r+i*i,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"getDistanceGlobeMode",value:function(e,t){var r=Object(E.r)(t),i=Object(E.r)(e)-r;Object(E.g)(this._tmp0,e,Object(E.j)(e,t)/Object(E.v)(e));var n=Object(E.n)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(i);var s=Object(E.g)(this._tmp0,t,1/r),o=r,c=a*a/2/o,l=Object(E.g)(this._tmp1,s,o-c),u=e,d=Object(E.l)(this._tmp2,u,l),h=Object(E.l)(this._tmp2,d,Object(E.g)(this._tmp3,s,Object(E.j)(s,d))),b=Object(E.h)(this._tmp2,l,Object(E.g)(this._tmp2,h,a/Object(E.r)(h))),f=Object(E.o)(u,b);if(i>=2e5){var p=Object(E.l)(this._tmp1,u,b),y=Object(E.j)(p,s)/Object(E.r)(p);y<.08&&(y=1e-4),f/=y}return f}},{key:"getDistance",value:function(e,t){return this.engineSR===Object(ge.g)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,a=i+r[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case 1:var s=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return Object(E.o)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return Object(E.o)(this._camPos,this._poi)}}]),e}(),Ie=r(498),Ce=r(603),Se=r(504),Fe=b.a.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Ne=1e-4,Me=function(e){Object(o.a)(r,e);var t=Object(c.a)(r);function r(e){var i;return Object(a.a)(this,r),(i=t.call(this,e)).screenSizeFactor=0,i.featureTarget=5e4,i.fixedFeatureTarget=!1,i.updating=!0,i.updatingProgress=1,i.leavesReached=!1,i.scaleVisibilityEnabled=!0,i._featureLOD=1,i._stableFeatureLOD=!1,i._isIdle=!1,i._cameraDirty=!0,i._invisibleDirty=!1,i._newLoadingNodes=new p.a({deallocator:null}),i._loadedNodeScales=new Map,i._modificationsNodeFilteringArray=new p.a,i._downloadingCount=0,i._loadingNodes=new Map,i._updatingNodes=new Map,i._progressMaxNumNodes=1,i._requiredAttributes=new Array,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableIDBCache=!1,i._disableMemCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new d.a,i._idleQueue=new w.a,i._elevationUpdateNodes=new p.a({deallocator:null}),i._errorCount=0,i}return Object(s.a)(r,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new pe(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(3);return new pe(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return Object(A.r)(this.layer)}},{key:"crsIndex",get:function(){return Object(A.p)(this.layer)}},{key:"rootNodeVisible",get:function(){if(Object(f.k)(this._index)){var e=this._index.rootNode;if(Object(f.k)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new ee(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=Object(h.a)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((function(r){var i,a=Object(n.a)(r,1)[0];if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var s=e.layerView.view;e._setClippingArea(s.clippingArea);var o=e.layerView.view.resourceController;e._handles.add([Object(g.a)(s,"pointsOfInterest.focus.renderLocation",(function(t){return e._pointOfInterestChanged(t)})),o.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),Object(g.a)(e.layerView,"suspended",(function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},i=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=i):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(r,i)})),M(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),s.state.watch("contentCamera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return Object(f.k)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new we(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,s.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new U(t,a,e.indexStreamController,e._viewportQueries,Fe,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}),null!=(i=e.layerView)&&i.computeNodeFiltering?function(t){return e.layerView.computeNodeFiltering(t)}:void 0);var c=Object(f.k)(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(c),e._startNodeLoading()}}))),this._tmpPoint=Object(k.j)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,r=this._index,i=this.layerView;Object(f.k)(r)&&i&&i.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var i=r.getNode(e);Object(f.k)(i)&&t._modificationsNodeFilteringArray.push(i)})),i.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,De.prune(),Object(f.k)(Ee)&&(Ee.hide(),Ee=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map((function(r){var i=Re(e,r),n=Re(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null})).filter((function(e){return null!=e&&e.name!==r}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Pe(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=Object(_.h)();Object(Ie.a)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){Object(f.k)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),Object(f.k)(this._index)&&(this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),Object(f.k)(this._viewportQueries)&&Object(f.k)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var r=this,i=this._index;if(!Object(f.j)(i)){var n=i.rootNode;if(!Object(f.j)(n)){var a=this._elevationUpdateNodes;a.clear(),Object(A.l)(e,t,n,this.crsIndex,i,(function(e){return a.push(e.index)})),a.forAll((function(e){i.invalidateBoundingVolumeCache(e),e===n.index&&r.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}}},{key:"getParentIndex",value:function(e){return Object(f.k)(this._index)&&this._index.getParentIndex(e)}},{key:"_elevationInfoChanged",value:function(){Object(f.k)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t,r){var i=this,n=this._index;if(!Object(f.j)(n)){var a=n.rootNode;!Object(f.j)(a)&&Object(j.o)(t,r,Ae,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,r){var a=n.getNode(r);Object(f.k)(a)&&Object(x.h)(Ae,a.mbs)&&i._loadedNodeScales.set(r,e)}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=Object(Se.a)(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)}},{key:"unloadedMemoryEstimate",get:function(){return Object(f.j)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return Object(f.k)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||Object(f.j)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(r){this._errorCount<50?Fe.error("Error during processing: "+r):50===this._errorCount&&Fe.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var r=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!Object(f.j)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return r._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return r._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return r._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return r._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return r._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}}},{key:"_processIndex",value:function(e){var t=this;if(Object(f.j)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Object(i.a)(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var r=this._index.featureEstimate.leavesReached;this._index.isLoading()||r===this._get("leavesReached")||this._set("leavesReached",r)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(Object(f.j)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.isGraphics3D&&!Object(f.j)(this._index)&&!Object(f.j)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.featureEstimate;if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Ne)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=Ne)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ne,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(Object(f.j)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=t.getParent(r);Object(f.k)(i)&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=t.getParent(i.index))if(this._enableFromGPUCache(i,0)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(Object(f.j)(this._index))return!1;var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!e.done;)this.layerView.removeNode(i.remove.pop()),e.madeProgress();for(;i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());Object(f.k)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0;){--r;var a=this._index.getNode(i.add.back());if(Object(f.j)(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;i.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Ce.b&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var r=(Object(f.k)(this._index)?this._index.getIndexMissing():0)+3*(Object(f.k)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!Object(f.j)(this._index)&&!Object(f.j)(this._viewportQueries)){var e=this.layerView.view,t=e.state,r=t.contentCamera,i=t.fixedContentCamera;this.screenSizeFactor=1/(r.perScreenPixelRatio/2),this._viewportQueries.updateCamera(r,!i||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return Object(f.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){Object(f.k)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"updateBoundingVolume",value:function(e){Object(f.k)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){Object(f.k)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){Object(f.k)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){if(Object(f.k)(this._index)){var e=Object(f.k)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!Object(f.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"_shouldDropNode",value:function(e){if(Object(f.j)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||Object(f.j)(t)||Object(f.j)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var r={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new ue(this.layer,this.dataStreamController,Fe,this._defaultGeometrySchema,this._requiredAttributes,r),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,r){return e._removeNodes(t,r,1)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,r=this._index;if(Object(f.j)(r)||Object(f.j)(this._viewportQueries))return!1;De.clear(),this.layerView.getLoadedNodeIndices(De);var i=0===this._viewportQueries.maxDistance,n=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return De.filterInPlace((function(e){var i=r.getNode(e);return Object(f.j)(i)||!r.isGeometryVisible(e)||n(i)||!t._isNodeInScaleBounds(i)})),De.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(De,e,0),!(i&&this.lodDropFactor<1)&&(0===De.length||(De.clear(),!1))}},{key:"markNodeToRemove",value:function(e){De.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(De,S.d,0)}},{key:"_removeNodes",value:function(e,t,r){var i=e.length;if(0!==i&&!t.done){for(Object(f.k)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;1===r&&this.layerView.nodeFadeoutEnabled&&Object(f.k)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,1,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<i;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,r=Object(v.e)();this._updatingNodes.set(e.index,r),(Pe(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,r.signal)).then((function(i){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:i},r.signal)}),r.signal)})).catch((function(i){if(!Object(v.n)(i))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},r.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Fe.error("already loading node "+e.index);else{var r=Object(v.e)();this._loadingNodes.set(e.index,r);var i=function(){t._loadingNodes.get(e.index)===r&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,r.signal).then(i).catch((function(e){if(i(),!Object(v.n)(e))throw e}))}}},{key:"_loadAndAddNode",value:function(e,t){var r=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,Object(f.k)(r._index)&&r._index.updates.add.push(e.index))})).catch((function(t){if(!Object(v.n)(t))throw e.cacheState=1,t}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||Object(f.j)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return Object(f.k)(t)&&Object(f.k)(t.attributeInfo)&&Pe(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){Object(f.k)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_loadCached",value:function(e,t){var r=this;if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule((function(){return i.loadCachedNodeData(e,t,(function(t,i){return r._nodeLoader.loadTextures(e,t,i)}))}),t).then((function(n){if(Object(f.j)(n))return!1;var a=r._requiredAttributes;return r.reschedule((function(){return r._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return r.reschedule((function(){return i.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return r._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var r=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw r._downloadingCount--,e})).then((function(i){return r._downloadingCount--,r.schedule((function(){return r.layerView.addNode(e,i,t)}),t)})).then((function(){r._nodeAdded(),e.cacheState=2})).catch((function(t){if(!Object(v.n)(t))throw Fe.error("#loadNodeData()",r.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,Object(f.k)(r._index)&&r._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&Object(f.k)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=Object(Se.a)(this.layer),i=r.minScale,n=r.maxScale;return Object(Se.d)(t,i,n)}},{key:"updateStats",value:function(e){e.index=Object(f.k)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),Object(f.k)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){Object(f.k)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),Object(f.k)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;Object(f.k)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),r}(Object(y.b)(u.a));Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"isMeshPyramid",null),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"isGraphics3D",null),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"indexStreamController",null),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"dataStreamController",null),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"crsVertex",null),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"crsIndex",null),Object(l.a)([Object(O.b)()],Me.prototype,"screenSizeFactor",void 0),Object(l.a)([Object(O.b)()],Me.prototype,"featureTarget",void 0),Object(l.a)([Object(O.b)()],Me.prototype,"fixedFeatureTarget",void 0),Object(l.a)([Object(O.b)()],Me.prototype,"layerView",void 0),Object(l.a)([Object(O.b)()],Me.prototype,"layer",void 0),Object(l.a)([Object(O.b)({})],Me.prototype,"updating",void 0),Object(l.a)([Object(O.b)({})],Me.prototype,"updatingProgress",void 0),Object(l.a)([Object(O.b)({readOnly:!0})],Me.prototype,"leavesReached",void 0),Object(l.a)([Object(O.b)({constructOnly:!0})],Me.prototype,"scaleVisibilityEnabled",void 0),Object(l.a)([Object(O.b)({readOnly:!0,dependsOn:[]})],Me.prototype,"rootNodeVisible",null),Me=Object(l.a)([Object(m.a)("esri.layers.graphics.controllers.I3SOnDemandController")],Me);var Ee,De=new p.a({deallocator:null});function Pe(e,t){return Object(f.k)(e)&&e.length===t.length&&e.every((function(e){return Re(t,e.name)>=0}))}function Re(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}var Le={factorIM:.2,factor3dObject:.05,distancePenalty:10},Ae=Object(x.l)(),Ve=Me},860:function(e,t,r){"use strict";r.d(t,"a",(function(){return w}));var i=r(42),n=r(8),a=r.n(n),s=r(15),o=r(29),c=r(11),l=r(2),u=r(3),d=r(107),h=r(115),b=r(142),f=r(505),p=r(16),y=r(4),v=r(25),g=r(187),O=r(171);function m(e,t,r){return j.apply(this,arguments)}function j(){return(j=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,o,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=r.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(r.maxRecordCountFactor=x(t)),n=_(t),s=t.capabilities.query.supportsPagination,r.start=0,r.num=n,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(r,i);case 6:if(c=e.sent,Object(y.j)(o)?o=c:o.features=o.features.concat(c.features),o.exceededTransferLimit=c.exceededTransferLimit,s&&c.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:r.start+=n;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _(e){return x(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function x(e){return e.capabilities.query.supportsMaxRecordCountFactor?O.a.MAX_MAX_RECORD_COUNT_FACTOR:1}var k=p.a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),w=function(){function e(t,r){var i=this;Object(l.a)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=Object(v.e)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=S,this.memCache=r.getMemCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return i.pendingFetchAbortController=null}))}return Object(u.a)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),Object(y.j)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var r=this.interactiveEditingSessions,i=new I(e,{rollback:function(){Object(h.j)(r,i),0===r.length&&(t.interactiveEditingSessions=null)},commit:function(r){var i,n=Object(c.a)(r);try{for(n.s();!(i=n.n()).done;){var a=Object(o.a)(i.value,2),s=a[0],l=a[1];t.updateValue(e,s,l)}}catch(u){n.e(u)}finally{n.f()}}});return r.unshift(i),i}},{key:"apply",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,o,c,l,u,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(y.j)(r)){e.next=2;break}return e.abrupt("return");case 2:if(n=r.loadedAttributes,s=r.attributeData,!Object(y.j)(n)&&0!==n.length&&!Object(y.j)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(v.A)(this.pendingFetchChangedObjectIds,i);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:n,attributeData:s},c=this.getOverridesFromCache(t,o,this.changedObjectIds),l=c.objectIds,u=c.fieldNames,e.next=15,this.queryOverridesFromAssociatedLayer(l,u,i);case 15:d=e.sent,Object(y.j)(d)||this.processOverridesFromAssociatedLayer(t,d,u,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,r){this.changedObjectIds.add(e),this.cacheValue(e,t,r)}},{key:"cacheValue",value:function(e,t,r){this.memCache.put(this.getCacheKey(e,t),r,this.memCacheValueSize(r))}},{key:"getOverridesFromCache",value:function(e,t,r){var i,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,l=Object(c.a)(n);try{for(l.s();!(i=l.n()).done;){var u=i.value;o[u.index]=a[u.name]}}catch(g){l.e(g)}finally{l.f()}for(var d=new Set,h=0;h<e.length;h++){var b=e[h];if(r.has(b)){var f,p=Object(c.a)(n);try{for(p.s();!(f=p.n()).done;){var y=f.value,v=this.fromCache(b,y.index);void 0===v?(s.add(b),d.add(y.name)):o[y.index][h]=v}}catch(g){p.e(g)}finally{p.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(d)}}},{key:"fromCache",value:function(e,t){var r=this.fromInteractiveEditingSession(e,t);if(void 0!==r)return r;var i=this.getCacheKey(e,t);return this.memCache.get(i)}},{key:"fromInteractiveEditingSession",value:function(e,t){if(!Object(y.j)(this.interactiveEditingSessions)){var r,i=Object(c.a)(this.interactiveEditingSessions);try{for(i.s();!(r=i.n()).done;){var n=r.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){i.e(s)}finally{i.f()}}}},{key:"getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"queryOverridesFromAssociatedLayer",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,n){var s,o,c,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==r.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning()),s=Object(y.t)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat(Object(i.a)(r)),o.cacheHint=!0,o.objectIds=t,c=_(s),l=t.length>c?Object(h.n)(t,c).map((function(e){var t=o.clone();return t.objectIds=e,Object(b.e)(m(s,t,{signal:n}))})):[Object(b.e)(m(s,o,{signal:n}))],e.next=8,Promise.all(l);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat(Object(g.b)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),k.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"processOverridesFromAssociatedLayer",value:function(e,t,r,i){var n,a=i.loadedAttributes,s=i.attributeData,o=Object(y.t)(this.layer.associatedLayer).objectIdField,l=r.map((function(e){return s[e]})),u=new Map(a.map((function(e){return[e.name,e.index]}))),d=r.map((function(e){return u.get(e)})),h=new Map(Array.from(e,(function(e,t){return[e,t]}))),b=Object(c.a)(t);try{for(b.s();!(n=b.n()).done;)for(var f=n.value,p=f.attributes[o],v=0;v<r.length;v++){var g=d[v],O=h.get(p),m=f.attributes[r[v]];l[v][O]=m,this.cacheValue(p,g,m)}}catch(j){b.e(j)}finally{b.f()}}},{key:"memCacheValueSize",value:function(e){return"string"==typeof e?Object(f.d)(e):Object(f.c)()}},{key:"fetchChangedObjectIds",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,n,s,o,c,l,u,h,f,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!Object(y.j)(s.associatedLayer)&&null!=(r=s.associatedLayer.capabilities)&&null!=(i=r.operations)&&i.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this.getFetchChangedObjectIdsServerGen(),!Object(y.j)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return c=s.associatedLayer.layerId,e.next=12,Object(b.d)(Object(d.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(c),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:c,serverGen:o}])},timeout:C,signal:t}));case 12:if(l=e.sent,u=l.ok&&null!=(n=l.value.data)&&n.edits?Object(y.i)(l.value.data.edits[0],"objectIds","updates"):null,Object(y.k)(u))for((h=Math.min(this._maximumNumberOfEditOVerrides,u.length))<u.length&&(this.warnMaximumChangedObjectsExceeded=!0),f=u.sort((function(e,t){return e-t})),p=0;p<h;p++)this.changedObjectIds.add(f[p]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if(Object(y.k)(e.serviceUpdateTimeStamp)&&Object(y.k)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return Object(y.k)(t)&&Object(y.k)(t.serverGens)&&Object(y.k)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,r=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return r._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){r._maximumNumberOfEditOVerrides=e}}}}]),e}(),I=function(){function e(t,r){Object(l.a)(this,e),this.objectId=t,this.options=r,this.updates=new Map,this.state=0}return Object(u.a)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=2,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return 0===this.state}}]),e}(),C=1e4,S=5e4},872:function(e,t,r){"use strict";r.d(t,"a",(function(){return G}));var i=r(8),n=r.n(i),a=r(15),s=r(11),o=r(2),c=r(3),l=r(6),u=r(7),d=r(0),h=r(350),b=(r(493),r(599),r(600),r(601),r(214),r(459),r(457),r(497),r(461)),f=r(107),p=r(24),y=r(60),v=r(205),g=r(16),O=r(4),m=r(268),j=r(1),_=(r(17),r(18),r(53)),x=r(50),k=r(12),w=r(72),I=r(56),C=r(635),S=r(897),F=r(898),N=r(212),M=r(645),E=r(633),D=r(899),P=r(855),R=r(171),L=r(638),A=r(655),V=g.a.getLogger("esri.layers.buildingSublayers.BuildingComponentSublayer"),T=Object(M.a)(),U=function(e){Object(l.a)(r,e);var t=Object(u.a)(r);function r(e){var i;return Object(o.a)(this,r),(i=t.call(this,e)).type="building-component",i.nodePages=null,i.materialDefinitions=null,i.textureSetDefinitions=null,i.geometryDefinitions=null,i.serviceUpdateTimeStamp=null,i.fields=null,i.associatedLayer=null,i.outFields=null,i.listMode="show",i.renderer=null,i.definitionExpression=null,i.popupEnabled=!0,i.popupTemplate=null,i.layerType="3d-object",i}return Object(c.a)(r,[{key:"parsedUrl",get:function(){return this.layer?{path:"".concat(this.layer.parsedUrl.path,"/sublayers/").concat(this.id),query:this.layer.parsedUrl.query}:null}},{key:"fieldsIndex",get:function(){return new E.a(this.fields)}},{key:"readAssociatedLayer",value:function(e,t){var r=this.layer.associatedFeatureServiceItem,i=t.associatedLayerID;return Object(O.k)(r)&&"number"==typeof i?new C.default({portalItem:r,layerId:i}):null}},{key:"objectIdField",get:function(){if(null!=this.fields){var e,t=Object(s.a)(this.fields);try{for(t.s();!(e=t.n()).done;){var r=e.value;if("oid"===r.type)return r.name}}catch(i){t.e(i)}finally{t.f()}}return null}},{key:"displayField",get:function(){return Object(O.k)(this.associatedLayer)?this.associatedLayer.displayField:null}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"load",value:function(e){var t=this,r=Object(O.k)(e)?e.signal:null,i=this._fetchService(r).then((function(){t.indexInfo=Object(D.a)(t.parsedUrl.path,t.rootNode,t.nodePages,t.apiKey,V,r)}));return this.addResolvingPromise(i),Promise.resolve(this)}},{key:"createPopupTemplate",value:function(e){return Object(L.a)(this,e)}},{key:"_fetchService",value:function(){var e=Object(a.a)(n.a.mark((function e(t){var r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(f.default)(this.parsedUrl.path,{query:{f:"json",token:this.apiKey},responseType:"json",signal:t});case 2:r=e.sent.data,this.read(r,{origin:"service",url:this.parsedUrl});case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getField",value:function(e){return this.fieldsIndex.get(e)}},{key:"getFieldDomain",value:function(e,t){var r,i,n,a,s=null==(r=this.getFeatureType(null==t?void 0:t.feature))||null==(i=r.domains)?void 0:i[e];return s&&"inherited"!==s.type?s:null!=(n=null==(a=this.getField(e))?void 0:a.domain)?n:null}},{key:"getFeatureType",value:function(e){return e&&Object(O.k)(this.associatedLayer)?this.associatedLayer.getFeatureType(e):null}},{key:"types",get:function(){return Object(O.k)(this.associatedLayer)?this.associatedLayer.types:[]}},{key:"typeIdField",get:function(){return Object(O.k)(this.associatedLayer)?this.associatedLayer.typeIdField:null}},{key:"geometryType",get:function(){return"3d-object"===this.layerType?"mesh":"point"}},{key:"profile",get:function(){return"3d-object"===this.layerType?"mesh-pyramids":"points"}},{key:"capabilities",get:function(){var e=Object(O.k)(this.associatedLayer)&&this.associatedLayer.capabilities?this.associatedLayer.capabilities:F.a,t=e.query,r=e.data;return{query:t,data:{supportsZ:r.supportsZ,supportsM:r.supportsM,isVersioned:r.isVersioned}}}},{key:"createQuery",value:function(){var e=new R.a;return"mesh"!==this.geometryType&&(e.returnGeometry=!0,e.returnZ=!0),e.where=this.definitionExpression||"1=1",e.sqlFormat="standard",e}},{key:"queryExtent",value:function(e,t){var r=this;return this._getAssociatedLayerForQuery().then((function(i){return i.queryExtent(e||r.createQuery(),t)}))}},{key:"queryFeatureCount",value:function(e,t){var r=this;return this._getAssociatedLayerForQuery().then((function(i){return i.queryFeatureCount(e||r.createQuery(),t)}))}},{key:"queryFeatures",value:function(e,t){var r=this;return this._getAssociatedLayerForQuery().then((function(i){return i.queryFeatures(e||r.createQuery(),t)})).then((function(e){if(null!=e&&e.features){var t,i=Object(s.a)(e.features);try{for(i.s();!(t=i.n()).done;){var n=t.value;n.layer=r.layer,n.sourceLayer=r}}catch(a){i.e(a)}finally{i.f()}}return e}))}},{key:"queryObjectIds",value:function(e,t){var r=this;return this._getAssociatedLayerForQuery().then((function(i){return i.queryObjectIds(e||r.createQuery(),t)}))}},{key:"getFieldUsageInfo",value:function(e){return this.fieldsIndex.has(e)?{supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1}:{supportsLabelingInfo:!1,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:Object(O.k)(this.associatedLayer)}}},{key:"_getAssociatedLayerForQuery",value:function(){var e=this.associatedLayer;return Object(O.k)(e)&&e.loaded?Promise.resolve(e):this._loadAssociatedLayerForQuery()}},{key:"_loadAssociatedLayerForQuery",value:function(){var e=Object(a.a)(n.a.mark((function e(){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.load();case 2:if(!Object(O.j)(this.associatedLayer)){e.next=4;break}throw new p.a("buildingscenelayer:query-not-available","BuildingSceneLayer component layer queries are not available without an associated feature layer",{layer:this});case 4:return e.prev=4,e.next=7,this.associatedLayer.load();case 7:e.next=12;break;case 9:throw e.prev=9,e.t0=e.catch(4),new p.a("buildingscenelayer:query-not-available","BuildingSceneLayer associated feature layer could not be loaded",{layer:this,error:e.t0});case 12:return e.abrupt("return",this.associatedLayer);case 13:case"end":return e.stop()}}),e,this,[[4,9]])})));return function(){return e.apply(this,arguments)}}()}]),r}(v.a.LoadableMixin(Object(m.b)(S.a)));Object(d.a)([Object(j.b)({readOnly:!0})],U.prototype,"parsedUrl",null),Object(d.a)([Object(j.b)({type:P.c,readOnly:!0})],U.prototype,"nodePages",void 0),Object(d.a)([Object(j.b)({type:[P.b],readOnly:!0})],U.prototype,"materialDefinitions",void 0),Object(d.a)([Object(j.b)({type:[P.d],readOnly:!0})],U.prototype,"textureSetDefinitions",void 0),Object(d.a)([Object(j.b)({type:[P.a],readOnly:!0})],U.prototype,"geometryDefinitions",void 0),Object(d.a)([Object(j.b)({readOnly:!0})],U.prototype,"serviceUpdateTimeStamp",void 0),Object(d.a)([Object(j.b)({readOnly:!0})],U.prototype,"store",void 0),Object(d.a)([Object(j.b)({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],U.prototype,"rootNode",void 0),Object(d.a)([Object(j.b)({readOnly:!0})],U.prototype,"attributeStorageInfo",void 0),Object(d.a)([Object(j.b)(T.fields)],U.prototype,"fields",void 0),Object(d.a)([Object(j.b)({readOnly:!0})],U.prototype,"fieldsIndex",null),Object(d.a)([Object(j.b)({readOnly:!0,type:C.default})],U.prototype,"associatedLayer",void 0),Object(d.a)([Object(x.a)("service","associatedLayer",["associatedLayerID"])],U.prototype,"readAssociatedLayer",null),Object(d.a)([Object(j.b)(T.outFields)],U.prototype,"outFields",void 0),Object(d.a)([Object(j.b)({type:String,readOnly:!0})],U.prototype,"objectIdField",null),Object(d.a)([Object(j.b)({readOnly:!0,type:String,json:{read:!1}})],U.prototype,"displayField",null),Object(d.a)([Object(j.b)({readOnly:!0,type:String,aliasOf:"layer.apiKey"})],U.prototype,"apiKey",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:w.a,aliasOf:"layer.fullExtent"})],U.prototype,"fullExtent",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:I.a,aliasOf:"layer.spatialReference"})],U.prototype,"spatialReference",void 0),Object(d.a)([Object(j.b)({readOnly:!0,aliasOf:"layer.version"})],U.prototype,"version",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:A.a,aliasOf:"layer.elevationInfo"})],U.prototype,"elevationInfo",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:Number,aliasOf:"layer.minScale"})],U.prototype,"minScale",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:Number,aliasOf:"layer.maxScale"})],U.prototype,"maxScale",void 0),Object(d.a)([Object(j.b)({type:["hide","show"],json:{write:!0}})],U.prototype,"listMode",void 0),Object(d.a)([Object(j.b)({types:b.b,json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],U.prototype,"renderer",void 0),Object(d.a)([Object(j.b)({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],U.prototype,"definitionExpression",void 0),Object(d.a)([Object(j.b)(N.j)],U.prototype,"popupEnabled",void 0),Object(d.a)([Object(j.b)({type:h.a,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],U.prototype,"popupTemplate",void 0),Object(d.a)([Object(j.b)({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],U.prototype,"normalReferenceFrame",void 0),Object(d.a)([Object(j.b)({readOnly:!0,json:{read:!1}})],U.prototype,"defaultPopupTemplate",null),Object(d.a)([Object(j.b)()],U.prototype,"types",null),Object(d.a)([Object(j.b)()],U.prototype,"typeIdField",null),Object(d.a)([Object(j.b)({json:{write:!1}}),Object(_.a)(new y.a({"3DObject":"3d-object",Point:"point"}))],U.prototype,"layerType",void 0),Object(d.a)([Object(j.b)()],U.prototype,"geometryType",null),Object(d.a)([Object(j.b)()],U.prototype,"profile",null),Object(d.a)([Object(j.b)({readOnly:!0,json:{read:!1}})],U.prototype,"capabilities",null);var G=U=Object(d.a)([Object(k.a)("esri.layers.buildingSublayers.BuildingComponentSublayer")],U)},897:function(e,t,r){"use strict";r.d(t,"a",(function(){return y}));var i=r(2),n=r(3),a=r(6),s=r(7),o=r(0),c=r(413),l=r(626),u=r(1),d=(r(17),r(18)),h=(r(16),r(50)),b=r(12),f=r(212),p=function(e){Object(a.a)(r,e);var t=Object(s.a)(r);function r(e){var n;return Object(i.a)(this,r),(n=t.call(this,e)).title="",n.id=-1,n.modelName=null,n.isEmpty=null,n.visible=!0,n.opacity=1,n}return Object(n.a)(r,[{key:"readTitle",value:function(e,t){return"string"==typeof t.alias?t.alias:"string"==typeof t.name?t.name:""}},{key:"readIdOnlyOnce",value:function(e){return-1!==this.id?this.id:"number"==typeof e?e:void 0}}]),r}(Object(c.a)(l.b));Object(o.a)([Object(u.b)({type:String,json:{origins:{"web-scene":{write:!0},"portal-item":{write:!0}}}})],p.prototype,"title",void 0),Object(o.a)([Object(h.a)("service","title",["alias","name"])],p.prototype,"readTitle",null),Object(o.a)([Object(u.b)()],p.prototype,"layer",void 0),Object(o.a)([Object(u.b)({type:d.a,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],p.prototype,"id",void 0),Object(o.a)([Object(h.a)("service","id")],p.prototype,"readIdOnlyOnce",null),Object(o.a)([Object(u.b)(Object(f.k)(String))],p.prototype,"modelName",void 0),Object(o.a)([Object(u.b)(Object(f.k)(Boolean))],p.prototype,"isEmpty",void 0),Object(o.a)([Object(u.b)({type:Boolean,json:{name:"visibility",write:!0}})],p.prototype,"visible",void 0),Object(o.a)([Object(u.b)({type:Number,json:{write:!0}})],p.prototype,"opacity",void 0);var y=p=Object(o.a)([Object(b.a)("esri.layers.buildingSublayers.BuildingSublayer")],p)},898:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));var i={attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1},data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAttachments:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1},query:{maxRecordCount:0,maxRecordCountFactor:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:!1,tileMaxRecordCount:0}}},899:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var i=r(8),n=r.n(i),a=r(15),s=r(107),o=r(24),c=r(4);function l(e,t,r,i,n,a){return u.apply(this,arguments)}function u(){return u=Object(a.a)(n.a.mark((function e(t,r,i,a,l,u){var d,h,b,f,p;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(d=null,!Object(c.k)(i)){e.next=17;break}return h="".concat(t,"/nodepages/"),b=h+Math.floor(i.rootIndex/i.nodesPerPage),e.prev=3,e.next=6,Object(s.default)(b,{query:{f:"json",token:a},responseType:"json",signal:u});case 6:return e.t0=e.sent.data,e.t1=i.rootIndex,e.t2=i.nodesPerPage,e.t3=i.lodSelectionMetricType,e.t4=h,e.abrupt("return",{type:"page",rootPage:e.t0,rootIndex:e.t1,pageSize:e.t2,lodMetric:e.t3,urlPrefix:e.t4});case 14:e.prev=14,e.t5=e.catch(3),Object(c.k)(l)&&l.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",b,e.t5),d=e.t5;case 17:if(r){e.next=19;break}return e.abrupt("return",null);case 19:return f="".concat(t,"/nodes/"),p=f+(r&&r.split("/").pop()),e.prev=20,e.next=23,Object(s.default)(p,{query:{f:"json",token:a},responseType:"json",signal:u});case 23:return e.t6=e.sent.data,e.t7=f,e.abrupt("return",{type:"node",rootNode:e.t6,urlPrefix:e.t7});case 28:throw e.prev=28,e.t8=e.catch(20),new o.a("sceneservice:root-node-missing","Root node missing.",{pageError:d,nodeError:e.t8,url:p});case 31:case"end":return e.stop()}}),e,null,[[3,14],[20,28]])}))),u.apply(this,arguments)}},900:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var i=r(2),n=r(3),a=r(6),s=r(7),o=r(0),c=r(16),l=r(1),u=(r(17),r(18),r(12)),d=r(773),h=r(801),b=c.a.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),f=function(e){var t=function(e){Object(a.a)(r,e);var t=Object(s.a)(r);function r(){var e;return Object(i.a)(this,r),(e=t.apply(this,arguments))._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e.logError=function(t){e._definitionExpressionErrors<e._maxDefinitionExpressionErrors&&b.error("Error while evaluating definitionExpression: "+t),e._definitionExpressionErrors++,e._definitionExpressionErrors===e._maxDefinitionExpressionErrors&&b.error("Further errors are ignored")},e}return Object(n.a)(r,[{key:"parsedDefinitionExpression",get:function(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{var e=d.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return b.error("definitionExpression is using non standard function"),null;var t=[],r=e.fieldNames;return Object(h.k)(r,this.i3slayer.fields,{missingFields:t}),t.length>0?(b.error("definitionExpression references unknown fields: ".concat(t.join(", "))),null):(this._definitionExpressionErrors=0,e)}catch(i){return b.error("Failed to parse definitionExpression: "+i),null}}},{key:"definitionExpressionFields",get:function(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}},{key:"_evaluateClause",value:function(e,t){try{return e.testFeature(t)}catch(r){return this.logError(r),!1}}},{key:"_addDefinitionExpressionToQuery",value:function(e){if(!this.parsedDefinitionExpression)return e;var t=this.i3slayer.definitionExpression,r=e.clone();return r.where?r.where="(".concat(t,") AND (").concat(r.where,")"):r.where=t,r}}]),r}(e);return Object(o.a)([Object(l.b)()],t.prototype,"i3slayer",void 0),Object(o.a)([Object(l.b)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),Object(o.a)([Object(l.b)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=Object(o.a)([Object(u.a)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},905:function(e,t,r){"use strict";r.d(t,"a",(function(){return tt}));var i=r(42),n=r(8),a=r.n(n),s=r(15),o=r(14),c=r(11),l=r(3),u=r(19),d=r(2),h=r(6),b=r(7),f=r(0),p=r(52),y=r(146),v=r(54),g=r(17),O=r(16),m=r(127),j=r(4),_=r(73),x=r(25),k=r(154),w=r(104),I=r(78),C=r(36),S=r(1),F=(r(18),r(12)),N=r(68),M=r(260),E=r(28),D=r(33),P=r(5),R=r(10),L=r(55),A=r(49),V=r(37),T=r(859),U=r(112),G=r(250),q=r(856),H=r(462),B=r(172),z=r(248),Q=r(463),W=(r(105),r(34)),K=r(61),J=r(636),Y=r(204),Z=r(904),X=r(881),$=r(835),ee=r(94),te=r(857),re=function(e){Object(h.a)(r,e);var t=Object(b.a)(r);function r(e){var i;return Object(d.a)(this,r),(i=t.call(this))._limit=e,i._all=new te.a,i._active=new ne(Object(u.a)(i)),i._pending=new Map,i._handle=i._all.on("change",(function(e){return i._handleChanges(e)})),i}return Object(l.a)(r,[{key:"destroy",value:function(){this._handle.remove()}},{key:"length",get:function(){return this._active.length}},{key:"toArray",value:function(){return this._active.toArray()}},{key:"find",value:function(e){return this._active.find(e)}},{key:"forEach",value:function(e){this._active.forEach(e)}},{key:"addMany",value:function(e){this._all.addMany(e)}},{key:"removeManyByObjectId",value:function(e){this._all.removeManyByObjectId(e)}},{key:"_handleChanges",value:function(e){var t=this,r=e.removed;if(this._pending.size>0){r=new Array;var i,n=Object(c.a)(e.removed);try{for(n.s();!(i=n.n()).done;){var a=i.value;this._pending.delete(a.objectId)||r.push(a)}}catch(b){n.e(b)}finally{n.f()}}var s=this._limit-this._active.length+r.length;s<e.added.length&&(this._active.removeMany(r),r=[],ie.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((function(e){ie.sample()&&(r.push(e),t._pending.set(e.objectId,e))})),s=this._limit-this._active.length+r.length);var o=e.added;if(s<e.added.length){o=new Array,ie.reset(s/e.added.length);var l,u=Object(c.a)(e.added);try{for(u.s();!(l=u.n()).done;){var d=l.value;ie.sample()?o.push(d):this._pending.set(d.objectId,d)}}catch(b){u.e(b)}finally{u.f()}}var h=s-o.length;h>0&&this._pending.size>0&&(ie.reset(h/this._pending.size),this._pending.forEach((function(e){ie.sample()&&(o.push(e),t._pending.delete(e.objectId))}))),this._active.addAndRemove(o,r)}}]),r}(ee.a),ie=new(function(){function e(){Object(d.a)(this,e),this.percentage=1,this.last=-1,this.index=0}return Object(l.a)(e,[{key:"reset",value:function(e){this.percentage=e,this.last=-1}},{key:"sample",value:function(){var e=Math.floor(this.index*this.percentage);return++this.index,e!==this.last&&(this.last=e,!0)}}]),e}()),ne=function(){function e(t){Object(d.a)(this,e),this._parent=t,this._map=new Map}return Object(l.a)(e,[{key:"length",get:function(){return this._map.size}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}},{key:"find",value:function(e){var t;return Object(m.c)(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t}},{key:"toArray",value:function(){return Object(i.a)(this._map.values())}},{key:"addAndRemove",value:function(e,t){var r,i=Object(c.a)(e);try{for(i.s();!(r=i.n()).done;){var n=r.value;this._map.set(n.objectId,n)}}catch(l){i.e(l)}finally{i.f()}var a,s=Object(c.a)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._map.delete(o.objectId)}}catch(l){s.e(l)}finally{s.f()}(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})}},{key:"removeMany",value:function(e){var t,r=Object(c.a)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._map.delete(i.objectId)}}catch(n){r.e(n)}finally{r.f()}e.length>0&&this._parent.emit("change",{added:[],removed:e})}}]),e}(),ae=r(227),se=function(e){Object(h.a)(r,e);var t=Object(b.a)(r);function r(e){var i;return Object(d.a)(this,r),(i=t.call(this,e)).loadedGraphics=new re(5e4),i.slicePlaneEnabled=!1,i._renderingInfo={symbol:new ae.a},i._handles=new K.a,i._graphicsByNode=new Map,i._scaleVisibility=null,i}return Object(l.a)(r,[{key:"initialize",value:function(){var e=this;this._graphicsCore=new Z.a({owner:this,layer:this.layer,preferredUpdatePolicy:0,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});var t=this.view.basemapTerrain;this._scaleVisibility=new X.a({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,(function(t,r,i){return e._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,r,i)}),this._graphicsCore,t);var r=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),i=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:r,deconflictor:i,scaleVisibility:this._scaleVisibility}).then((function(){e._graphicsCore.startCreateGraphics()})).catch((function(){})),this._handles.add([this.layer.watch("labelingInfo",(function(t,r){Object(J.a)(t,r)&&e._graphicsCore.updateLabelingInfo()}))])}},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null}},{key:"addNodeMeta",value:function(e,t){var r=this,i=0,n=e.filteredIds,a=e.featureIds.map((function(a,s){Object($.b)(s,r.collection,e.objectHandle,ce);var o=Object(Y.j)(0,0,0,r.view.spatialReference);r.view.renderCoordsHelper.fromRenderCoords(ce,o);var c=t(s,e),l=!1;return Object(j.j)(n)?l=!0:i<n.length&&a===n[i]&&(l=!0,i++),{objectId:a,uid:y.a.generateUID(),attributes:c,visible:l,geometry:o}}));this.loadedGraphics.addMany(a),this._graphicsByNode.set(e.node.index,a)}},{key:"setNodeMetaAttributes",value:function(e,t){for(var r=this._graphicsByNode.get(e.node.index),i=new Array(r.length),n=0;n<r.length;n++){var a=r[n];a.attributes=t(n,e),i[n]=a.uid}this._graphicsCore.updateLabelingInfo(i)}},{key:"applyFilterChange",value:function(e){var t=this._graphicsByNode.get(e.node.index);if(t)if(Object(j.j)(e.filteredIds)){var r,i=Object(c.a)(t);try{for(i.s();!(r=i.n()).done;){var n=r.value;n.visible||(n.visible=!0,oe.graphic=n,oe.property="visible",oe.oldValue=!1,oe.newValue=!0,this._graphicsCore.graphicUpdateHandler(oe))}}catch(d){i.e(d)}finally{i.f()}}else{var a,s=0,o=Object(c.a)(t);try{for(o.s();!(a=o.n()).done;){var l=a.value,u=l.visible;s<e.filteredIds.length&&l.objectId===e.filteredIds[s]?(l.visible=!0,s++):l.visible=!1,u!==l.visible&&(oe.graphic=l,oe.property="visible",oe.oldValue=u,oe.newValue=l.visible,this._graphicsCore.graphicUpdateHandler(oe))}}catch(d){o.e(d)}finally{o.f()}}}},{key:"removeNodeMeta",value:function(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)}},{key:"getRenderingInfo",value:function(){return this._renderingInfo}},{key:"notifyGraphicGeometryChanged",value:function(){}},{key:"notifyGraphicVisibilityChanged",value:function(){}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]),r}(W.a);Object(f.a)([Object(S.b)()],se.prototype,"view",void 0),Object(f.a)([Object(S.b)()],se.prototype,"layer",void 0),Object(f.a)([Object(S.b)()],se.prototype,"collection",void 0),Object(f.a)([Object(S.b)()],se.prototype,"loadedGraphics",void 0),Object(f.a)([Object(S.b)({aliasOf:"_graphicsCore.updating"})],se.prototype,"updating",void 0),Object(f.a)([Object(S.b)()],se.prototype,"slicePlaneEnabled",void 0),Object(f.a)([Object(S.b)()],se.prototype,"_graphicsCore",void 0),se=Object(f.a)([Object(F.a)("esri.views.3d.layers.I3SMeshViewLabeler")],se);var oe={graphic:null,property:null,oldValue:null,newValue:null},ce=Object(R.e)(),le=se,ue=r(496),de=O.a.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle"),he=function(e){Object(h.a)(r,e);var t=Object(b.a)(r);function r(e){return Object(d.a)(this,r),t.call(this,"SceneLayerWorker","process",e,{hasInitialize:!0})}return Object(l.a)(r,[{key:"getTransferList",value:function(e){return[e.geometryBuffer]}},{key:"setModifications",value:function(e,t,r){var i={context:e,modifications:pe(t,r),isGeodetic:r.isGeographic};this.broadcast(i,"setModifications")}},{key:"setLegacySchema",value:function(e,t){var r=JSON.stringify(t);this.broadcast({context:e,jsonSchema:r},"setLegacySchema")}},{key:"destroyContext",value:function(e){return this.broadcast(e,"destroyContext")}}]),r}(ue.a),be=new _.a({deallocator:null}),fe=[0,0,0];function pe(e,t){be.clear();var r,i=Object(c.a)(e);try{var n=function(){var e=r.value,i="clip"===e.type?2:"mask"===e.type?1:0,n=e.geometry,a=function(e){return e};if(n.spatialReference){if(!Object(A.b)(n.spatialReference,t))return de.warn("Can't project modification polygon into layer spatial reference, ignoring modification"),"continue";a=function(e){return Object(A.z)(e,n.spatialReference,fe,t),fe}}else n.hasZ||(fe[2]=0,a=function(e){return fe[0]=e[0],fe[1]=e[1],fe});be.push(i),be.push(n.rings.length);var s,o=Object(c.a)(n.rings);try{for(o.s();!(s=o.n()).done;){var l=s.value;be.push(l.length);var u,d=Object(c.a)(l);try{for(d.s();!(u=d.n()).done;){var h=a(u.value);be.push(h[0]),be.push(h[1]),be.push(h[2])}}catch(b){d.e(b)}finally{d.f()}}}catch(b){o.e(b)}finally{o.f()}};for(i.s();!(r=i.n()).done;)n()}catch(o){i.e(o)}finally{i.f()}be.push(3);for(var a=new Float64Array(be.length),s=0;s<be.length;++s)a[s]=be.getItemAt(s);return a}var ye=r(774),ve=r(114),ge=r(115),Oe=function e(){Object(d.a)(this,e),this.ids=new Set,this.paused=!1},me=function(){function e(t){var r=t.collection,i=t.forAllFeatures,n=t.forAllFeaturesOfNode;Object(d.a)(this,e),this.highlights=[],this.collection=r,this.forAllFeatures=i,this.forAllFeaturesOfNode=n}return Object(l.a)(e,[{key:"destroy",value:function(){var e=this;this.highlights.forEach((function(t){return e.releaseSet(t)})),this.highlights=null}},{key:"acquireSet",value:function(){var e=this,t=new Oe;this.highlights.push(t);var r={remove:function(){e.releaseSet(t),Object(ge.k)(e.highlights,t)},pause:function(){e.releaseSet(t),t.paused=!0},resume:function(){t.paused=!1,e.initializeSet(t)}};return{set:t,handle:r}}},{key:"setFeatureIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)}},{key:"initializeSet",value:function(e){var t=this;this.forAllFeatures((function(r,i,n){return e.ids.has(r)&&t.collection.addComponentHighlight(n.objectHandle,i),1}))}},{key:"releaseSet",value:function(e){var t=this;this.forAllFeatures((function(r,i,n){return e.ids.has(r)&&t.collection.removeComponentHighlight(n.objectHandle,i),1}))}},{key:"objectCreated",value:function(e){var t=this;this.highlights.forEach((function(r){r.paused||t.forAllFeaturesOfNode(e,(function(i,n){return r.ids.has(i)&&t.collection.addComponentHighlight(e.objectHandle,n),1}))}))}},{key:"objectDeleted",value:function(e){this.collection.clearHighlights(e.objectHandle)}}]),e}(),je=r(860),_e=function e(){Object(d.a)(this,e),this.lodCrossfadeSignedDuration=0},xe=function(){function e(t){Object(d.a)(this,e),this.view=t,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}return Object(l.a)(e,[{key:"updating",get:function(){return this._numFadingNodes>0}},{key:"stopNodeFading",value:function(e){null!=e.lodCrossfadeProgress&&(this._numFadingNodes--,e.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=Object(j.s)(this._preRenderFrameTaskHandle)),this.view.notifyLODUpdate(),this.view.notifyUpdate()))}},{key:"_startNodeFading",value:function(e,t,r){var i=this;0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=Object(k.a)({preRender:function(e){return i._updateAllNodeFading(e)}}),this.view.notifyLODUpdate()),null==e.lodCrossfadeProgress&&(this._numFadingNodes++,this.view.notifyUpdate()),e.lodCrossfadeSignedDuration=r,e.lodCrossfadeProgress=t}},{key:"_updateAllNodeFading",value:function(e){var t=this,r=this.view.nodeCrossfadingEnabled;this.view.foreachCrossfadeNode((function(i,n){if(Object(j.k)(n)&&Object(j.k)(n.lodCrossfadeProgress)){var a=n.lodCrossfadeSignedDuration,s=a>0?t.view.fullOpacity:0,o=e.deltaTime/a,c=n.lodCrossfadeProgress+Math.abs(o),l=!r||c>=1||0===a,u=s-(l?0:a>0?1:-1)*(1-c);l?(t.stopNodeFading(n),a<0&&t.view.markNodeToRemove(i)):n.lodCrossfadeProgress=c,t.view.setNodeOpacityByIndex(i,u)}})),this.view.removeMarkedNodes()}},{key:"stopAllNodeFading",value:function(){var e=this;this.view.foreachCrossfadeNode((function(t,r){if(Object(j.k)(r)&&Object(j.k)(r.lodCrossfadeProgress)){e.stopNodeFading(r);var i=r.lodCrossfadeSignedDuration;i<0&&e.view.markNodeToRemove(t);var n=i>0?e.view.fullOpacity:0;e.view.setNodeOpacityByIndex(t,n)}})),this.view.removeMarkedNodes()}},{key:"fadeNode",value:function(e,t,r,i){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());var n=this.view,a=n.nodeCrossfadingEnabled,s=0===r?n.fullOpacity:0,o=a?i?0===r?n.lodCrossfadeinDuration:n.lodCrossfadeoutDuration:n.lodCrossfadeUncoveredDuration:0,c=this.view.getNodeOpacityByIndex(e);if(a&&c!==s&&o>0){var l=1-Math.abs(s-c);this._startNodeFading(t,l,function(e){return 0===e?1:-1}(r)*o)}else this.stopNodeFading(t),this.view.setNodeOpacityByIndex(e,s),1===r&&this.view.removeNode(e)}},{key:"isNodeFullyFadedIn",value:function(e){var t=this.view.getNodeCrossfadeMetaData(e);return Object(j.k)(t)&&null==t.lodCrossfadeProgress&&this.view.getNodeOpacityByIndex(e)===this.view.fullOpacity}}]),e}();var ke=r(43),we=r(161),Ie=Object(ke.n)(),Ce=Object(D.d)(),Se=Object(R.e)(),Fe=Object(R.e)(),Ne=Object(R.e)(),Me=O.a.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider"),Ee=function(e){Object(h.a)(r,e);var t=Object(b.a)(r);function r(e){var i;return Object(d.a)(this,r),(i=t.call(this,e)).tmpEvent={spatialReference:null,extent:Ie,context:"scene"},i}return Object(l.a)(r,[{key:"initialize",value:function(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new we.a(this.view.state.viewingMode),this.intersector.options.store=0;var e=this.layerView.i3slayer.fullExtent;this.zmin=e.zmin,this.zmax=e.zmax,this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}},{key:"getElevation",value:function(e,t,r,i){if(Se[0]=e,Se[1]=t,Se[2]=r,!this.renderCoordsHelper.toRenderCoords(Se,i,Se))return Me.error("could not project point to compute elevation"),null;var n=this.layerView.elevationOffset,a=this.zmin+n,s=this.zmax+n;return this.renderCoordsHelper.setAltitude(Fe,s,Se),this.renderCoordsHelper.setAltitude(Ne,a,Se),this.intersector.reset(Fe,Ne),this.intersectionHandler.intersect(this.intersector,null,Fe,Ne),this.intersector.results.min.getIntersectionPoint(Se)?this.renderCoordsHelper.getAltitude(Se):null}},{key:"layerChanged",value:function(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"objectChanged",value:function(e){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(e),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))}},{key:"computeObjectExtent",value:function(e){return Object(ke.n)(Ie),this._expandExtent(e,Ie),Ie}},{key:"computeLayerExtent",value:function(){Object(ke.n)(Ie);var e,t=Object(c.a)(this.layerView.getVisibleNodes());try{for(t.s();!(e=t.n()).done;){var r=e.value;this._expandExtent(r,Ie)}}catch(i){t.e(i)}finally{t.f()}return Ie}},{key:"_expandExtent",value:function(e,t){var r=e.visibilityObb||e.serviceObbInRenderSR;if(Object(j.k)(r)){Object(E.x)(Ce,r.quaternion),Ce[12]=r.center[0],Ce[13]=r.center[1],Ce[14]=r.center[2];for(var i=0;i<8;++i)Se[0]=1&i?r.halfSize[0]:-r.halfSize[0],Se[1]=2&i?r.halfSize[1]:-r.halfSize[1],Se[2]=4&i?r.halfSize[2]:-r.halfSize[2],Object(P.s)(Se,Se,Ce),this.renderCoordsHelper.fromRenderCoords(Se,Se,this.spatialReference),Object(ke.p)(t,Se,t)}else{var n=e.renderMbs[3],a=Object(P.m)(Fe,e.renderMbs);a[0]-=n,a[1]-=n,a[2]-=n;var s=Object(P.m)(Ne,e.renderMbs);s[0]+=n,s[1]+=n,s[2]+=n;for(var o=0;o<8;++o)Se[0]=1&o?a[0]:s[0],Se[1]=2&o?a[1]:s[1],Se[2]=4&o?a[2]:s[2],this.renderCoordsHelper.fromRenderCoords(Se,Se,this.spatialReference),Object(ke.p)(t,Se,t)}}}]),r}(ee.a.EventedMixin(W.a));Object(f.a)([Object(S.b)({constructOnly:!0})],Ee.prototype,"layerView",void 0),Object(f.a)([Object(S.b)({constructOnly:!0})],Ee.prototype,"intersectionHandler",void 0),Object(f.a)([Object(S.b)()],Ee.prototype,"view",void 0),Object(f.a)([Object(S.b)({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],Ee.prototype,"spatialReference",void 0);var De=Ee=Object(f.a)([Object(F.a)("esri.views.3d.layers.i3s.I3SElevationProvider")],Ee),Pe=r(410),Re=r(275),Le=r(207),Ae=function(){function e(t){Object(d.a)(this,e),this.type="I3S",this.layerUid=t.layerUid,this.sublayerUid=t.sublayerUid,this.collection=t.collection,this.traverseNodeHierarchy=t.traverseNodeHierarchy,this.slicePlane=t.slicePlaneEnabled,this.isGround=t.isGround}return Object(l.a)(e,[{key:"intersect",value:function(e,t,r,i){var n=this,a=e.results,s=2===e.options.store,o=e.ray.direction,c=e.tolerance,l=function(e){return e},u=function(e){return e},d=Object(Le.c)(e.verticalOffset);Object(j.k)(d)&&(l=function(e){return d.applyToMbs(e)},u=function(e){return d.applyToObb(e)}),this.traverseNodeHierarchy((function(h,b){return!(Object(j.k)(h.serviceObbInRenderSR)&&!Object(Pe.f)(u(h.serviceObbInRenderSR),r,o,c))&&(!b||Object(j.k)(h.geometryObb)&&!Object(Pe.f)(u(h.geometryObb),r,o,c)||!Object(j.k)(h.serviceObbInRenderSR)&&!function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=e[3]+i,a=t[0]-e[0],s=t[1]-e[1],o=t[2]-e[2],c=r[0],l=r[1],u=r[2],d=c*a+l*s+u*o;return d*d-(c*c+l*l+u*u)*(a*a+s*s+o*o-n*n)>=0}(l(h.renderMbs),r,o,c)||n.collection.intersect(b,r,i,c,d,(function(o,c,l,u){if(c>=0){if(null!=t&&!t(r,i,c))return;var d=function(e){e.intersector=n.type,e.target={type:"external",metadata:{layerUid:n.layerUid,sublayerUid:n.sublayerUid,nodeIndex:h.index,componentIndex:o}},e.dist=c,Object(P.m)(e.normal,l),e.triangleNr=u};if(n.isGround&&(null==a.ground.dist||c<a.ground.dist)&&d(a.ground),e.options.isFiltered)return;if((null==a.min.dist||c<a.min.dist)&&d(a.min),(null==a.max.dist||c>a.max.dist)&&d(a.max),s){var b=new Re.a(e.ray);d(b),e.results.all.push(b)}}})),!0)}))}},{key:"intersectionHandlerId",get:function(){return this.layerUid}}]),e}();var Ve=r(836),Te=r(873),Ue=r(801),Ge=r(24),qe=function(){function e(t,r){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:14;Object(d.a)(this,e),this._version=i,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=t,this._storeName=r}return Object(l.a)(e,[{key:"init",value:function(){var e=this;return Promise.resolve().then((function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(r){var i=t.result,n=t.transaction,a=i.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):i.createObjectStore(e._storeName),s=i.objectStoreNames.contains("last_access")?n.objectStore("last_access"):i.createObjectStore("last_access");s.indexNames.contains("date")||s.createIndex("date","date",{unique:!1}),s.indexNames.contains("byteSize")||s.createIndex("byteSize","byteSize",{unique:!1}),r.oldVersion<e._version&&(a.clear(),s.clear())},Be(t)})).then((function(t){e._destroyed?t.close():e._db=t}))}},{key:"destroy",value:function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}},{key:"initialized",get:function(){return null!=this._db}},{key:"getHitRate",value:function(){return this._hit/(this._hit+this._miss)}},{key:"put",value:function(e,t){var r=this;return null==this._db?Promise.reject(new Ge.a("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then((function(){return r._put(e,t)})).catch((function(i){if(i&&"QuotaExceededError"===i.name)return null==r._quotaReductionPromise&&(r._quotaReductionPromise=r._getCacheSize().then((function(e){return r._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*r.quotaReductionFactor))})),r._quotaReductionPromise.then((function(){return r._quotaReductionPromise=null}),(function(){return r._quotaReductionPromise=null}))),r._quotaReductionPromise.then((function(){return r._put(e,t)}));throw i})).then((function(){r._gcCounter--,r._gcCounter<0&&null!=r._db&&(r._gcCounter=r.gcFrequency,r._getCacheSize().then((function(e){return r._removeLeastRecentlyAccessed(e-r.maxByteSize)})))}))}},{key:"get",value:function(e,t){var r=this;if(null==this._db)return Promise.resolve(null);var i=null;return Promise.resolve().then((function(){var n=r._db.transaction(r._storeName,"readonly");return i=Object(x.s)(t,(function(){n.abort()})),Be(n.objectStore(r._storeName).get(e))})).then((function(t){return null==t?++r._miss:r._db&&(++r._hit,r._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),Object(j.k)(i)&&i.remove(),t})).catch((function(){return++r._miss,Object(x.x)(t),Object(j.k)(i)&&i.remove(),null}))}},{key:"remove",value:function(e){var t=this;return null==this._db?Promise.resolve():Promise.resolve().then(Object(s.a)(a.a.mark((function r(){var i,n,s,o,c;return a.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i=t._db.transaction([t._storeName,"last_access"],"readwrite"),n=i.objectStore(t._storeName),s=i.objectStore("last_access"),o=n.delete(e),c=s.delete(e),r.next=3,Promise.all([Be(o),Be(c),He(i)]);case 3:case"end":return r.stop()}}),r)}))))}},{key:"_put",value:function(e,t){var r=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=r.objectStore(this._storeName),n=r.objectStore("last_access"),a=i.put(t,e),s=n.put({date:Date.now(),byteSize:t.byteSize},e);return Promise.all([Be(a),Be(s),He(r)])}},{key:"_removeLeastRecentlyAccessed",value:function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),i=t.objectStore("last_access"),n=0,a=i.index("date").openCursor(null,"next");return a.onsuccess=function(){var t=a.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),r.delete(t.primaryKey),i.delete(t.primaryKey),n<e&&t.continue())},He(t)}}},{key:"_getCacheSize",value:function(){var e=this._db.transaction("last_access"),t=e.objectStore("last_access"),r=0,i=t.index("byteSize").openKeyCursor();return i.onsuccess=function(){var e=i.result;if(e){var t=e.key;null!=t&&(r+=t),e.continue()}},He(e).then((function(){return r}))}}]),e}();function He(e){return new Promise((function(t,r){e.oncomplete=function(){return t()},e.onerror=function(){return r(e.error)},e.onabort=function(){return r(e.error)}}))}function Be(e){return new Promise((function(t,r){"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return r(e.error)})}))}var ze=r(842),Qe=r(89),We=r(498),Ke=r(458),Je=r(160),Ye=r(661),Ze=r(469),Xe=O.a.getLogger("esri.views.3d.layers.SceneLayerView3D"),$e=[1,1,1,1],et=function(e){Object(h.a)(r,e);var t=Object(b.a)(r);function r(e,i,n,a,s,o,c){var l;return Object(d.a)(this,r),(l=t.call(this)).node=e,l.featureIds=i,l.objectHandle=n,l.cachedRendererVersion=a,l.attributeInfo=s,l.material=o,l.textures=c,l.cachedEdgeMaterials=new Array,l.cachedSymbology=null,l}return r}(_e),tt=function(e){var t=function(e){Object(h.a)(n,e);var t=Object(b.a)(n);function n(){var e;Object(d.a)(this,n);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(e=t.call(this,i))._elevationProvider=null,e._intersectionHandler=null,e._nodeId2Meta=new Map,e._nodeId2MetaReloading=new Map,e._i3sWasmLoaded=!1,e._hasLoadedPBRTextures=!1,e._asyncModuleLoading=0,e._addTasks=new Map,e._rendererVersion=0,e._colorVariable=null,e._opacityVariable=null,e._rendererFields=null,e._symbologyFields=null,e._symbologyOverride=null,e._symbologyOverrideFields=null,e._symbolInfos=new Map,e._idbCache=new qe("esri-scenelayer-cache","geometries"),e.holeFilling="auto",e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.slicePlaneEnabled=!1,e._modifications=new Array,e._layerUrl="",e._cacheKeySuffix=null,e._arcade=null,e._tmpAttributeOnlyGraphic=new y.a(null,null,{}),e._crossfadeHelper=new xe(Object(u.a)(e)),e}return Object(l.a)(n,[{key:"lodCrossfadeoutDuration",get:function(){return 0}},{key:"lodCrossfadeinDuration",get:function(){return 0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return 0}},{key:"layerUid",get:function(){return this.i3slayer&&this.i3slayer.uid}},{key:"sublayerUid",get:function(){return null}},{key:"hasTexturesOrVertexColors",get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}},{key:"rendererTextureUsage",get:function(){return Object(Ue.u)(this._currentRenderer)?this._usePBR()||this._hasLoadedPBRTextures?63:37:this._usePBR()||this._hasLoadedPBRTextures?44:36}},{key:"elevationOffset",get:function(){var e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=Object(I.g)(this.i3slayer.spatialReference),r=Object(Q.a)(e.unit);return Object(j.u)(e.offset,0)*r/t}return 0}},{key:"supportedTextureEncodings",get:function(){return Object(Ve.e)(this.view._stage.renderView.capabilities)}},{key:"uncompressedTextureDownsamplingEnabled",get:function(){var e,t=null==(e=this.view)?void 0:e.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled,r=0==(4&this.supportedTextureEncodings);return t&&r}},{key:"initialize",value:function(){var e=this;this.preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);var t=this.view.resourceController;if(this.attributeOverrides=new je.a(this.i3slayer,t.memoryController),this._worker=new he((function(e){return t.schedule(e)})),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema),Object(Ue.e)(this.i3slayer),Object(Ue.d)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new T.a({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new me({collection:this._collection,forAllFeatures:function(t){return e._forAllFeatures(t,null,1)},forAllFeaturesOfNode:function(t,r){return e._forAllFeaturesOfNode(t,r)}}),this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var i=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(i&&i.faceRange&&i.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,(function(t){return e._deleteComponentObject(t)}));this._intersectionHandler=new Ae({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:function(t){return Object(j.k)(e._controller.index)&&Object(j.k)(e._controller.index.rootNode)?e._controller.index.traverse(e._controller.index.rootNode,(function(r){var i=r.index,n=e._nodeId2Meta.get(i)||e._nodeId2MetaReloading.get(i);return t(r,Object(j.k)(n)?n.objectHandle:null)})):function(){}}}),this._elevationProvider=new De({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR(),this.updatingHandles.add(this,"view.clippingArea",(function(){return e._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(t){return e._opacityChange(t)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._slicePlaneEnabledChange(t)})),this.updatingHandles.add(this,"elevationOffset",(function(t,r){e._reloadAll(r),e._controller.invalidateVisibilityObbs()})),this.updatingHandles.add(this,"filter",(function(){return e._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return e._updatePBR()}));var n=function(){e._reloadAll(),e.clearMemCache()};this.updatingHandles.add(this,"rendererTextureUsage",n),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",n),this.updatingHandles.add(this,"suspended",(function(t){return e._suspendedChange(t)}),2),this.updatingHandles.add(this.i3slayer,"labelsVisible",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this.i3slayer,"labelingInfo",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this,"_modifications",(function(){return e._modificationsChanged()}),2),this.handles.add([Object(C.a)(Qe.a,"I3S_TREE_SHOW_TILES",(function(t){if(t&&!e._treeDebugger){var i=e._controller.crsIndex;r.e(37).then(r.bind(null,1192)).then((function(t){var r=t.I3STreeDebugger;!e._treeDebugger&&Qe.a.I3S_TREE_SHOW_TILES&&(e._treeDebugger=new r({lv:e,view:e.view,nodeSR:i}))}))}else t||Qe.a.I3S_TREE_SHOW_TILES||(e._treeDebugger=Object(j.e)(e._treeDebugger))})),Object(C.a)(Qe.a,"I3S_SHOW_MODIFICATIONS",(function(){return e._showModifications()}))]),this._cacheKeySuffix=Object(Ue.m)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return Xe.warn("Failed to initialize IndexedDB cache: ".concat(e))}))}},{key:"destroy",value:function(){this._clearAddTasks(),this.attributeOverrides=Object(j.e)(this.attributeOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var e=this._worker;e&&(e.destroyContext(this.i3slayer.uid).then((function(){return e.destroy()})),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=Object(j.e)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=Object(j.e)(this._labeler),this._treeDebugger=Object(j.e)(this._treeDebugger),this._controller=Object(j.e)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}},{key:"memEstimateTextureAdded",value:function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t}},{key:"memEstimateTextureRemoved",value:function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t}},{key:"memEstimateGeometryAdded",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t}},{key:"memEstimateGeometryRemoved",value:function(e){var t=this._collection.getObjectGPUMemoryUsage(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t}},{key:"isNodeLoaded",value:function(e){return this._nodeId2Meta.has(e)}},{key:"isNodeReloading",value:function(e){return this._nodeId2MetaReloading.has(e)}},{key:"getUsedMemory",value:function(){var e=Object(j.k)(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=Object(j.k)(t)?t.node.memory:0})),this._nodeId2MetaReloading.forEach((function(t){return e+=Object(j.k)(t)?t.node.memory:0})),e}},{key:"getUnloadedMemory",value:function(){return(Object(j.k)(this._controller)?this._controller.unloadedMemoryEstimate:0)+(Object(j.k)(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}},{key:"ignoresMemoryFactor",value:function(){return!1}},{key:"_labelingChanged",value:function(){var e=this;if(Object(G.a)(this.i3slayer)&&this._supportsLabeling){if(!Object(j.k)(this._labeler)){var t=new le({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach((function(r){return Object(j.k)(r)&&e._addMetaToLabeler(t,r)})),this._labeler=t}}else Object(j.k)(this._labeler)&&(this._labeler.destroy(),this._labeler=null)}},{key:"_loadAsyncModule",value:function(e){var t=this;return++this._asyncModuleLoading,e.then((function(e){return--t._asyncModuleLoading,e}),(function(e){throw--t._asyncModuleLoading,e}))}},{key:"_modificationsChanged",value:function(){var e=this;if(!this._i3sWasmLoaded&&this._hasModifications)return this._i3sWasmLoaded=Object(ye.initialize)().then((function(){e._i3sWasmLoaded=!0,e._modificationsChanged(),e.notifyUpdate()})),void this.notifyUpdate();if(!0===this._i3sWasmLoaded){var t=this.i3slayer.uid,r=this.i3slayer.spatialReference;this._worker.setModifications(t,this._modifications,r);var i=pe(this._modifications,r);Object(ye.setModificationsSync)({context:t,modifications:i,isGeodetic:r.isGeographic}),this._controller.modificationsChanged();var n=this._hasModifications?new _.a:null;this._nodeId2Meta.forEach((function(t,r){Object(j.j)(t)?e._nodeId2Meta.delete(r):t.node.hasModifications?(e._nodeId2Meta.delete(r),e._nodeId2MetaReloading.set(r,t)):Object(j.k)(n)&&n.push(t.node)})),Object(j.k)(n)&&this._nodeId2MetaReloading.forEach((function(e){return n.push(e.node)})),Object(j.k)(n)&&n.length>0&&(this.updateNodeModificationStatus(n),n.forAll((function(t){if(2!==t.imModificationImpact){var r=e._nodeId2Meta.get(t.index);e._controller.invalidateGeometryVisibility(t.index),e._nodeId2Meta.delete(t.index),Object(j.k)(r)&&e._nodeId2MetaReloading.set(t.index,r)}}))),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}}},{key:"_showModifications",value:function(){if(Object(j.k)(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),Qe.a.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;var r,i=Object(c.a)(this._modifications);try{for(i.s();!(r=i.n()).done;){var n=r.value;n.geometry.spatialReference=this.i3slayer.spatialReference;var a=Object(o.a)(Object(o.a)({},t),{},{color:e[n.type]});this._modificationGraphics.push(new y.a({geometry:n.geometry,symbol:a}))}}catch(s){i.e(s)}finally{i.f()}this.view.graphics.addMany(this._modificationGraphics)}}},{key:"_addMetaToLabeler",value:function(e,t){var r=this;e.addNodeMeta(t,(function(e,t){return r._createAttributes(e,t)}))}},{key:"_suspendedChange",value:function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}},{key:"getLoadedAttributes",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(j.k)(t)&&Object(j.k)(t.attributeInfo))return t.attributeInfo.loadedAttributes}},{key:"getAttributeData",value:function(e){var t=this._nodeId2Meta.get(e);if(Object(j.k)(t)&&Object(j.k)(t.attributeInfo))return t.attributeInfo.attributeData}},{key:"setAttributeData",value:function(e,t){var r=this._nodeId2Meta.get(e);Object(j.k)(r)&&Object(j.k)(r.attributeInfo)&&(r.attributeInfo.attributeData=t,this._attributeValuesChanged(r))}},{key:"updateAttributes",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._nodeId2Meta.get(t),e.t0=Object(j.k)(n),!e.t0){e.next=7;break}return e.next=5,this.attributeOverrides.apply(n.featureIds,r,i);case 5:n.attributeInfo=r,this._attributeValuesChanged(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_attributeValuesChanged",value:function(e){var t=this;e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,Object(j.k)(this._labeler)&&this._labeler.setNodeMetaAttributes(e,(function(e,r){return t._createAttributes(e,r)})),this._updateEngineObject(e)}},{key:"clearMemCache",value:function(){Object(j.k)(this._memCache)&&this._memCache.clear()}},{key:"getVisibleNodes",value:function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return Object(j.k)(t)&&e.push(t.node)})),e}},{key:"getLoadedNodeIndices",value:function(e){this._nodeId2Meta.forEach((function(t,r){return e.push(r)})),this._nodeId2MetaReloading.forEach((function(t,r){return e.push(r)}))}},{key:"preLoadBasis",value:function(){!Object(g.a)("disable-feature:i3s-basis")&&0!=(2&this.supportedTextureEncodings)&&Object(j.c)(this.i3slayer.textureSetDefinitions,(function(e){return e.some((function(e){return e.formats.some((function(e){return"basis"===e.format||"ktx2"===e.format}))}))}))&&Object(Ze.e)()}},{key:"_getVertexBufferLayout",value:function(e,t){var r={hasTexture:ct(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return Object(Je.a)(Object(Ye.a)(this._getGeometryParameters(r)))}},{key:"_getObjectIdField",value:function(){return this.i3slayer.objectIdField||"OBJECTID"}},{key:"_findGraphicNodeAndIndex",value:function(e){var t=Object(ze.a)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField()),r=null;return Object(m.c)(this._nodeId2Meta,(function(e){if(Object(j.j)(e))return!1;var i=e.featureIds.indexOf(t);return-1!==i&&(r={node:e.node,index:i},!0)})),r}},{key:"_getGraphicIndices",value:function(e,t){var r=this._nodeId2Meta.get(e.index);if(Object(j.j)(r))return[];var i,n=[],a=this._getObjectIdField(),s=this.i3slayer.fieldsIndex,o=Object(c.a)(t);try{for(o.s();!(i=o.n()).done;){var l=i.value,u=Object(ze.a)(s,l.attributes,a),d=r.featureIds.indexOf(u);-1!==d&&n.push(d)}}catch(h){o.e(h)}finally{o.f()}return n}},{key:"whenGraphicBounds",value:function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();var r=this._nodeId2Meta.get(t.node.index);if(Object(j.j)(r))return Promise.reject();var i=r.objectHandle,n=Object($.a)(t.index,this._collection,i,new Float64Array(24)),a=this.view.renderSpatialReference,s=this.view.spatialReference;if(Object(A.q)(n,a,0,n,s,0,8)){var o=Object(V.k)();return Object(V.n)(o,n,0,8),Promise.resolve({boundingBox:o,screenSpaceObjects:[]})}}},{key:"whenGraphicAttributes",value:function(e,t){var r=this;return Object(Ue.x)(this.i3slayer,e,this._getObjectIdField(),t,(function(){return Object(i.a)(r._nodeId2Meta.values()).filter(j.k)}))}},{key:"getGraphicFromIntersectorMetadata",value:function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return Object(j.j)(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}},{key:"_getCacheKey",value:function(e){return"".concat(this._layerUrl,"/v").concat(19,"/").concat(e.id).concat(this._cacheKeySuffix)}},{key:"_getMemCacheKey",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;return e+"#"+t}},{key:"_idbCacheEnabled",get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix}},{key:"loadCachedGPUData",value:function(e){return Object(j.k)(this._memCache)?this._memCache.pop(this._getMemCacheKey(e.index)):null}},{key:"deleteCachedGPUData",value:function(e){Object(j.k)(e)&&this._deleteComponentObject(e)}},{key:"_cacheGPUData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.elevationOffset;if(Object(j.j)(this._memCache))this._deleteComponentObject(e);else{var r=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,r)}}},{key:"loadMissingTextures",value:function(e,t,r,i){var n=this,a=e.filter((function(e,r){if(0==(e.usage&n.rendererTextureUsage))return!1;if(Object(j.j)(t))return!0;var i=Object(Ve.f)(e.encodings,n.supportedTextureEncodings),a=t[r];return!!(Object(j.j)(a)||null==a.data||i&&a.encoding!==i.encoding)}));return 0===a.length?Promise.resolve(!1):r(a,i).then((function(r){for(var i=0,n=0;n<e.length;n++)i<r.length&&r[i].id===e[n].id&&(t[n]=r[i],i++);return!0}))}},{key:"loadCachedNodeData",value:function(e,t,r){var i=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((function(n){return null==n?null:n.nodeVersion!==e.version?(i._idbCache.remove(i._getCacheKey(e)),null):(e.geometryObb=n.geometryObb,i.loadMissingTextures(n.requiredTextures,n.textureData,r,t).then((function(r){return r&&i._idbCache.initialized&&Object(j.k)(n.textureData)&&(n.byteSize=ut(n.transformedGeometry,n.textureData),n.textureData.every(lt)&&dt(e,n)&&i._idbCache.put(i._getCacheKey(e),n).catch((function(t){return Xe.warn("Failed to update node with textures in IndexedDB cache: ".concat(e.id,": ").concat(t))}))),Object(x.x)(t),n})))})):Promise.resolve(null)}},{key:"addNode",value:function(e,t,r){var i=this;return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(function(){return i._transformNode(e,t,r).then((function(n){return i._safeReschedule((function(){if(Object(j.j)(n))return e.hasModifications=!1,i._addCachedNodeData(e,null,r);e.hasModifications=n.transformedGeometry.hasModifications;var a=n.obb,s=n.componentOffsets,c=n.featureIds,l=n.transformedGeometry,u=i._controller.crsIndex,d=i.view.renderSpatialReference,h=Object(Te.a)(e.mbs,i.elevationOffset,u,d);e.geometryObb=Object(Pe.e)([a.center.x,a.center.y,a.center.z],[a.extents.x,a.extents.y,a.extents.z],[a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w]),Object(P.s)(e.geometryObb.center,e.geometryObb.center,h),t.geometryData.componentOffsets=s,c&&(t.geometryData.featureIds=Array.prototype.slice.call(c));var b={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:l,globalTrafo:h,geometryObb:e.geometryObb,byteSize:ut(l,t.textureData)};if(i._idbCacheEnabled&&i._idbCache.initialized&&dt(e,b)){var f=Object(j.k)(b.textureData)?b.textureData.map((function(e){return lt(e)?e:null})):null;i._idbCache.put(i._getCacheKey(e),Object(o.a)(Object(o.a)({},b),{},{textureData:f})).catch((function(t){return Xe.warn("Failed to store node in IndexedDB cache: ".concat(e.id,": ").concat(t))}))}return i._addCachedNodeData(e,b,r)}),r)}))})):Promise.reject()}},{key:"computeVisibilityObb",value:function(e){return Object(Ue.h)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}},{key:"_transformNode",value:function(e,t,r){for(var i=t.geometryData.geometries,n=new Array(i.length),a=0;a<i.length;++a)n[a]=this._getVertexBufferLayout(i[a],t.geometryDescriptor);var s=e.mbs,o=this.elevationOffset,c=this._controller.crsIndex,l=this._controller.crsVertex,u=this.view.renderSpatialReference,d=Object(Te.b)(s,o,c),h=Object(Te.a)(s,o,c,u),b=Object(A.e)(c,l),f=Object(A.e)(l,u);if(Object(j.j)(b)||Object(j.j)(f))return Promise.resolve(null);var p={context:this.i3slayer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:n,localOrigin:d,globalTrafo:h,mbs:s,obb:e.serviceObb,elevationOffset:o,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:b,vertexToRenderProjector:f};return this._worker.invoke(p,r)}},{key:"supportsNodeCrossFading",get:function(){var e,t;return!(null!=(e=this.view)&&null!=(t=e._stage)&&t.renderView.hasShadowsEnabled)}},{key:"nodeCrossfadingEnabled",get:function(){return this.supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}},{key:"nodeFadeoutEnabled",get:function(){return this.supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}},{key:"_setNewNodeOpacity",value:function(e){var t=this.nodeCrossfadingEnabled?0:this.fullOpacity;this._setNodeOpacity(e,t)}},{key:"addCachedGPUData",value:function(e,t,r){if(e.geometryObb=Object(Pe.b)(this._collection.getComponentObb(t.objectHandle)),this._controller.isGeometryVisible(e)){Object(j.k)(this._labeler)&&this._addMetaToLabeler(this._labeler,t);var i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,r),this._collection.setObjectVisibility(t.objectHandle,1),this._updateMaterial(t),this._setNewNodeOpacity(t),this._updateEngineObject(t),this._highlights.objectCreated(t),Object(j.k)(this._treeDebugger)&&this._treeDebugger.update()}else this._cacheGPUData(t)}},{key:"addCachedNodeData",value:function(e,t,r,i){var n=this;return this._addData(e,r,(function(){return n._addCachedNodeData(e,t,i)}))}},{key:"_addCachedNodeData",value:function(){var e=Object(s.a)(a.a.mark((function e(t,r,i){var n,s,o,c,l,u,d,h,b,f,p,y,v,O,m,_,x,k,w,I,C,S,F,P,L,V,T,U,G,q,H,B,z=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended&&this._controller.isGeometryVisible(t)){e.next=2;break}return e.abrupt("return",void this._removeNodeStageData(t.index,this.elevationOffset,this._nodeId2MetaReloading));case 2:if(!Object(j.j)(r)){e.next=4;break}return e.abrupt("return",void this._addNodeMeta(t.index,null));case 4:return n=this._addTasks.get(t.index),s=r.geometryData,o=r.transformedGeometry,c=r.globalTrafo,e.next=7,this.attributeOverrides.apply(s.featureIds,n.attributeInfo,i);case 7:if(l=Object(j.k)(r.textureData)?r.textureData.filter((function(e){return Object(j.k)(e)&&0!=(e.usage&z.rendererTextureUsage)})):[],e.t0=!Object(g.a)("disable-feature:i3s-basis")&&l.some((function(e){return Object(j.k)(e)&&(2===e.encoding||1===e.encoding)})),!e.t0){e.next=12;break}return e.next=12,Object(Ze.e)();case 12:return t.memory=0,u=s.componentOffsets,d=s.geometries,h=s.featureIds,b=this._collection,f=d[0],p=o.layout,y=o.indices,v=o.interleavedVertexData,O=o.positionData,m=o.hasColors,_=this._materialParameters(f,p),x=u||new Uint32Array([0,y?y.length:v.byteLength/p[0].stride]),k={vertices:{data:v,count:v.byteLength/p[0].stride,layoutParameters:_.geometryParams},positionData:{positions:O.data,indices:O.indices},indices:y,componentOffsets:x},w=f.transformation?Object(D.c)(f.transformation):Object(D.d)(),Object(E.m)(w,c,w),I=Object(E.v)(Object(R.e)(),w),C=Object(N.f)(Object(M.b)(),w),S=this.view.renderSpatialReference,F=this.view.basemapTerrain.spatialReference,P=Object(R.e)(),L=[1,1,1],Object(A.k)(I,S,L,F)||Xe.errorOnce("Unsupported coordinate system for IM overlay"),Object(A.z)(I,S,P,F),V=b.createObject({toMapSpace:[P[0],P[1],L[0],L[1]],geometry:k,obb:Object(j.t)(t.geometryObb),transform:{position:I,rotationScale:C}}),T=2===_.geometryParams.textureCoordinates,U=this._initMaterialAndTextures(V,_.material,l,T),t.memory+=this.memEstimateGeometryAdded(V),t.memory+=U.reduce((function(e,t){return e+(Object(j.k)(t)?z.memEstimateTextureAdded(t):0)}),0),G=!!_.material.hasParametersFromSource,q="blend"!==_.material.alphaMode&&_.material.metallicRoughness.baseColorFactor[3]>=1,H=new et(t,h,V,this._getInvalidRendererVersion(),n.attributeInfo,{hasParametersFromSource:G,isOpaque:q},U),n.meta=H,!this._hasTextures&&r.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||m,this._hasTextures=this._hasTextures||!!t.resources.texture,this.notifyChange("hasTexturesOrVertexColors"),B=this.slicePlaneEnabled,e.abrupt("return",this._addOrUpdateEdgeRendering(H).then((function(e){return Object(j.k)(e)&&e.updateObjectVisibility(H.objectHandle,!1),z._safeReschedule((function(){var r=z._addTasks.get(t.index);if(r)if(Object(j.k)(z._labeler)&&z._addMetaToLabeler(z._labeler,H),z._addNodeMeta(t.index,H),r.meta=null,z.suspended)z._removeNodeStageData(t.index,z.elevationOffset);else{b.setObjectVisibility(V,1),Object(j.k)(e)&&e.updateObjectVisibility(H.objectHandle,!0),H.attributeInfo=r.attributeInfo;var i=H.cachedRendererVersion!==z._rendererVersion,n=B!==z.slicePlaneEnabled;z._setObjectSymbolColors(H);var a=z._applyFiltersToNode(H);(i||Object(j.k)(e)&&(n||a))&&z._addOrUpdateEdgeRendering(H),z._visibleGeometryChanged(H),z._highlights.objectCreated(H),z._updateMaterial(H),z._setNewNodeOpacity(H),Object(j.k)(z._treeDebugger)&&z._treeDebugger.update()}}),i)})).catch((function(e){throw Object(j.k)(n.meta)&&(z._deleteComponentObject(n.meta),n.meta=null),e})));case 23:case"end":return e.stop()}}),e,this)})));return function(t,r,i){return e.apply(this,arguments)}}()},{key:"_addNodeMeta",value:function(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){Xe.error("Removing duplicated node");var r=this._nodeId2Meta.get(e);Object(j.k)(r)&&this._deleteComponentObject(r)}Object(j.k)(t)&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&bt(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t)}},{key:"_safeReschedule",value:function(e,t){return Object(x.x)(t),this._controller.reschedule(e,t)}},{key:"_materialParameters",value:function(e,t){var r=e.params.material,i=t.some((function(e){return"uvRegion"===e.name})),n=t.some((function(e){return"normalCompressed"===e.name})),a=ct(r);return{geometryParams:this._getGeometryParameters({hasTexture:a,hasNormals:n,hasRegions:i}),material:r}}},{key:"_initMaterialAndTextures",value:function(e,t,r,i){var n,a=this,s=this._stage.renderView,o=r.map((function(e){return Object(Ve.b)(e,t,i,s)})),l=Object(c.a)(o);try{for(l.s();!(n=l.n()).done;){var u=n.value;Object(j.k)(u)&&this._stage.add(u)}}catch(d){l.e(d)}finally{l.f()}return this._collection.updateMaterial(e,(function(e){Object(Ve.a)(e,t,o,r,a.view._stage.renderView.textureRepository,{rendererTextureUsage:a.rendererTextureUsage,usePBR:a._usePBR(),isIntegratedMesh:a._isIntegratedMesh,slicePlaneEnabled:a.slicePlaneEnabled,viewSpatialReference:a.view.spatialReference}),a._updateMaterialOverlay(e)})),o}},{key:"_getGeometryParameters",value:function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}}},{key:"_addData",value:function(e,t,r){var i=this,n=this._addTasks.get(e.index);return n?n.attributeInfo=t:(n=Object(o.a)(Object(o.a)({},Object(x.h)()),{},{attributeInfo:t,meta:null}),this._addTasks.set(e.index,n),r().then(n.resolve,n.reject).then((function(){return i._addTasks.delete(e.index)})).catch((function(t){throw i._addTasks.delete(e.index),t}))),n.promise}},{key:"_clearAddTasks",value:function(){var e=this;this._addTasks.forEach((function(t){Object(j.k)(t.meta)&&(e._deleteComponentObject(t.meta),t.meta=null)})),this._addTasks.clear()}},{key:"_clippingAreaChanged",value:function(){var e=Object(V.h)();Object(We.a)(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)}},{key:"_geometryFilterChange",value:function(){this._controller.geometryFilterChanged(this.hasGeometryFilter)}},{key:"hasGeometryFilter",get:function(){return!1}},{key:"_filterChange",value:function(){this._applyFilters(!1)}},{key:"_applyFilters",value:function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){Object(j.k)(e)&&t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t._visibleGeometryChanged(e))}))}},{key:"getFilters",value:function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)})),t}},{key:"addSqlFilter",value:function(e,t,r){var i=this;if(Object(j.k)(t)){var n=t.fieldNames;e.push((function(e,a){return i._sqlFilter(e,a,t,n,r)}))}}},{key:"_sqlFilter",value:function(e,t,r,i,n){var a={},s=this._createLayerGraphic(a),o=this.i3slayer.objectIdField,l=t.featureIds,u=Object(j.k)(t.attributeInfo)&&t.attributeInfo.attributeData;i.every((function(e){return null!=u[e]||e===o}))&&Object(Ue.j)(e,l,(function(e){a[o]=l[e];var d,h=Object(c.a)(i);try{for(h.s();!(d=h.n()).done;){var b=d.value;b!==o&&(a[b]=Object(Ue.n)(u[b],e))}}catch(f){h.e(f)}finally{h.f()}try{return r.testFeature(s)}catch(t){return n(t),!1}}))}},{key:"_boundingboxNodeTest",value:function(e,t){return Object(A.p)(e.node.mbs,this._controller.crsIndex,ot,this.view.renderSpatialReference),Object(Ue.s)(t,ot)}},{key:"_boundingboxFeatureTest",value:function(e,t,r){return Object(V.v)(r,this._collection.getComponentAabb(e.objectHandle,t,rt))}},{key:"_boundingboxFilter",value:function(e,t,r){var i=this,n=this._collection,a=this._boundingboxNodeTest(t,r);if(3!==a)if(0!==a){var s=n.getComponentCount(t.objectHandle);if(s.invisible+s.visible===t.featureIds.length){var o=this._transformAABB(it,r,t.objectHandle);Object(Ue.j)(e,t.featureIds,(function(e){return i._boundingboxFeatureTest(t,e,o)}))}}else e.length=0}},{key:"_transformAABB",value:function(e,t,r){var i=this._collection.getObjectTransform(r),n=i.position,a=i.rotationScale;return e[0]=(t[0]-n[0])/a[0],e[1]=(t[1]-n[1])/a[4],e[2]=(t[2]-n[2])/a[8],e[3]=(t[3]-n[0])/a[0],e[4]=(t[4]-n[1])/a[4],e[5]=(t[5]-n[2])/a[8],e}},{key:"_addOrUpdateEdgeRendering",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(Object(j.j)(this._edgeView))return Promise.resolve(null);var i=e.objectHandle,n=this._edgeView.hasObject(i),a=this._getFilteredEdgeMaterials(e),s=a.hasEdges,o=a.perFeatureEdgeMaterials,c={slicePlaneEnabled:this.slicePlaneEnabled};return s?n?(this.nodeCrossfadingEnabled&&bt(o,this.getNodeOpacity(e)),this._edgeView.updateAllComponentMaterials(i,o,c,r),this._edgeView.updateObjectVisibility(i,!0),Promise.resolve(this._edgeView)):this._collection.addEdges(i,this._edgeView,o,c).then((function(){return t._edgeView})):(n&&this._edgeView.removeObject(i),Promise.resolve(null))}},{key:"_removeEdgeRendering",value:function(e){Object(j.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)}},{key:"_applyFiltersToNode",value:function(e){return!!this._applyFiltersToNodeComponents(e)&&(Object(j.k)(this._labeler)&&this._labeler.applyFilterChange(e),!0)}},{key:"_applyFiltersToNodeComponents",value:function(e){var t=this._collection,r=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!r;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!r;var i=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,i),!0}},{key:"_updateCachedFilteredIds",value:function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}},{key:"_computeFilteredIds",value:function(e){var t,r=e.featureIds.slice(),i=Object(c.a)(this._filters);try{for(i.s();!(t=i.n()).done;){if((0,t.value)(r,e),0===r.length)break}}catch(n){i.e(n)}finally{i.f()}return r.length===e.featureIds.length?e.featureIds:r}},{key:"_computeFilteredComponentIndices",value:function(e){var t=new Array;return e.featureIds.forEach((function(r,i){e.filteredIds[t.length]===r&&t.push(i)})),t}},{key:"_removeAllNodeDataFromStage",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._nodeId2Meta.forEach((function(r,i){return e._removeNodeStageData(i,t)})),this._nodeId2MetaReloading.forEach((function(r,i){return e._removeNodeStageData(i,t,e._nodeId2MetaReloading)}))}},{key:"removeNode",value:function(e){var t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading)}},{key:"_removeNodeStageData",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodeId2Meta,i=r.get(e);Object(j.j)(i)?r.delete(e):(this._collection.setObjectVisibility(i.objectHandle,0),this._visibleGeometryChanged(i),this._removeEdgeRendering(i),Object(j.k)(this._labeler)&&this._labeler.removeNodeMeta(i),r.delete(e),this._highlights.objectDeleted(i),r===this._nodeId2Meta?(this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),Object(j.k)(this._treeDebugger)&&this._treeDebugger.update())}},{key:"_deleteComponentObject",value:function(e){if(Object(j.k)(this._edgeView)&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures){var t,r=Object(c.a)(e.textures);try{for(r.s();!(t=r.n()).done;){var i=t.value;this.memEstimateTextureRemoved(i),this._stage.remove(i)}}catch(n){r.e(n)}finally{r.f()}}}},{key:"updateNodeState",value:function(e,t){var r=this._nodeId2Meta.get(e);Object(j.k)(r)&&this._collection.updateMaterial(r.objectHandle,(function(e){return e.polygonOffsetEnabled=0===t}))}},{key:"_invalidateAllSymbols",value:function(){this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}},{key:"_getInvalidRendererVersion",value:function(){return Object(Ue.a)(this._rendererVersion,-1)}},{key:"_rendererChange",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var r,i,n,s,o,l;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._currentRenderer=t,this.notifyChange("rendererTextureUsage"),this._rendererVersion=Object(Ue.a)(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e.t0=t,!e.t0){e.next=12;break}return e.next=11,t.getRequiredFields(this.i3slayer.fieldsIndex);case 11:this._rendererFields=e.sent;case 12:if(this._updateSymbologyFields(),e.t1=!this._arcade&&t&&"arcadeRequired"in t&&t.arcadeRequired,!e.t1){e.next=18;break}return e.next=17,Object(B.e)();case 17:this._arcade=e.sent;case 18:if(!(t&&"visualVariables"in t&&t.visualVariables)){e.next=21;break}r=Object(c.a)(t.visualVariables);try{for(r.s();!(i=r.n()).done;)"color"===(n=i.value).type?this._colorVariable=n:"opacity"===n.type?this._opacityVariable=n:Xe.warn("Unsupported visual variable type for 3D Object Scene Services: ".concat(n.type))}catch(a){r.e(a)}finally{r.f()}case 21:if(t){s=Object(c.a)(t.getSymbols());try{for(s.s();!(o=s.n()).done;)"mesh-3d"!==(l=o.value).type&&Xe.error("Symbols of type '".concat(l.type,"' are not supported for 3D Object Scene Services."))}catch(a){s.e(a)}finally{s.f()}}this._controller&&this._controller.requestUpdate();case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getCachedEdgeMaterials",value:function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}},{key:"_getSymbolColors",value:function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,r){var i=5*e;Object(L.l)(r.externalColor,t[i+0]/255,t[i+1]/255,t[i+2]/255,t[i+3]/255),r.externalColorMixMode=15&t[i+4],r.castShadows=0!=(16&t[i+4]),r.pickable=0!=(32&t[i+4])}}},{key:"_getSymbolInfo",value:function(e,t){var r=e&&e.getSymbol(t,{arcade:this._arcade});if(!(r instanceof z.a))return null;var i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);var n=Object(Ue.q)(r);return this._symbolInfos.set(i,n),n}},{key:"_setSymbologyOverride",value:function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}},{key:"_updateSymbologyFields",value:function(){this._symbologyFields=Object(j.k)(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?Object(j.k)(this._rendererFields)&&this._rendererFields.length>0?Object(U.j)(this.i3slayer.fieldsIndex,[].concat(Object(i.a)(this._rendererFields),Object(i.a)(this._symbologyOverrideFields))):this._symbologyOverrideFields:this._rendererFields}},{key:"_updateCachedRendererData",value:function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,r={};t.attributes=r;var i=this._currentRenderer,n=Object(j.k)(e.attributeInfo)&&e.attributeInfo.attributeData,a=null!=e.featureIds?this.i3slayer.objectIdField:null,s=null!=n&&Object(j.k)(this._symbologyFields)&&this._symbologyFields.length>0,l=s?[]:null,u=s?[]:null;if(s&&Object(j.k)(this._symbologyFields)){var d,h=Object(c.a)(this._symbologyFields);try{for(h.s();!(d=h.n()).done;){var b=d.value,f=n[b];f&&(l.push(b),u.push(f))}}catch(M){h.e(M)}finally{h.f()}}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var p={color:at,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},y=this.fullOpacity,v=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):y,g=null,O=2,m=Ue.w,_=0,x=0;x<e.featureIds.length;x++){if(null!=a&&(r[a]=e.featureIds[x]),s)for(var k=0;k<l.length;k++)r[l[k]]=Object(Ue.n)(u[k],x);var w=this._getSymbolInfo(i,t),I=null,C=null;if(i&&"visualVariables"in i){if(this._colorVariable){var S=Object(H.getColor)(this._colorVariable,t,{color:st,arcade:this._arcade});S&&((I=at)[0]=S.r/255,I[1]=S.g/255,I[2]=S.b/255,this._opacityVariable||null===S.a||(C=S.a))}this._opacityVariable&&(C=Object(H.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(w&&w.material){var F=w.material;I=Object(j.j)(I)||Object(j.j)(C)?Object(ve.i)(I,C,F.color,F.alpha,$e,at):Object(ve.i)(I,C,null,null,$e,at)}if(Object(j.j)(I)&&((I=at)[0]=1,I[1]=1,I[2]=1,I[3]=1),p.pickable=!0,p.castShadows=!w||w.castShadows,p.colorMixMode=w&&w.material?w.material.colorMixMode:1,p.edgeMaterial=w?w.edgeMaterial:null,Object(j.k)(this._symbologyOverride)&&(p.color=I,this._symbologyOverride(t,p),I=p.color),Object(j.k)(p.edgeMaterial)){var N=I[3]<=0?0:I[3]>=1&&(e.material.isOpaque||3===p.colorMixMode)?2:1;p.edgeMaterial===g&&N===O||(m=Object(o.a)(Object(o.a)({},p.edgeMaterial),{},{opacity:v,objectTransparency:N}),g=p.edgeMaterial,O=N),e.cachedEdgeMaterials[x]=m}else e.cachedEdgeMaterials[x]=Ue.w;e.cachedSymbology[_+0]=Math.round(255*I[0]),e.cachedSymbology[_+1]=Math.round(255*I[1]),e.cachedSymbology[_+2]=Math.round(255*I[2]),e.cachedSymbology[_+3]=Math.round(255*I[3]),e.cachedSymbology[_+4]=p.colorMixMode|+p.castShadows<<4|+p.pickable<<5,_+=5}}}},{key:"_getFilteredEdgeMaterials",value:function(e){var t=this._getCachedEdgeMaterials(e);if(this.nodeCrossfadingEnabled||bt(t,this.fullOpacity),Object(j.j)(e.filteredIds))return{hasEdges:t.some((function(e){return e!==Ue.w})),perFeatureEdgeMaterials:t};var r=0,i=!1,n=t.map((function(t,n){return e.featureIds[n]!==e.filteredIds[r]?Ue.w:(i=i||t!==Ue.w,r++,t)}));return{hasEdges:i,perFeatureEdgeMaterials:n}}},{key:"_setObjectSymbolColors",value:function(e){if(this._hasSymbolColors){var t=e.objectHandle,r=this._getSymbolColors(e);this._collection.setComponentData(t,r),this._stage.renderView.setNeedsRender()}}},{key:"_reloadAll",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.elevationOffset;this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}},{key:"_opacityChange",value:function(e){var t=this;this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach((function(r){Object(j.j)(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){return t.objectOpacity=e})),bt(r.cachedEdgeMaterials,e),t._updateEdgeRendering(r))}))}},{key:"_updateMaterial",value:function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(e){e.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,e.usePBR=t._usePBR(),t._updateMaterialOverlay(e)}))}},{key:"_updateMaterialOverlay",value:function(e){}},{key:"_updateEngineObject",value:function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e)}},{key:"_slicePlaneEnabledChange",value:function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),Object(j.k)(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(r){Object(j.j)(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(r,!1))}))}},{key:"_updatePBR",value:function(){var e=this;this._nodeId2Meta.forEach((function(t){Object(j.j)(t)||e._collection.updateMaterial(t.objectHandle,(function(t){t.usePBR=e._usePBR()}))})),this._hasLoadedPBRTextures=!0}},{key:"_usePBR",value:function(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}},{key:"_updateEdgeRendering",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];Object(j.k)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}},{key:"_forAllNodes",value:function(e){this._nodeId2Meta.forEach(e)}},{key:"_forAllFeatures",value:function(e,t){var r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(m.c)(this._nodeId2Meta,(function(n){if(Object(j.j)(n))return!1;if(Object(j.k)(t))switch(t(n)){case 0:return!0;case 2:return!1}var a=1;switch(i){case 1:a=r._forAllFeaturesOfNode(n,e);break;case 0:a=r._forVisibleFeaturesOfNode(n,e);break;case 2:a=r._forAllFeaturesOfNodeInClippingArea(n,e)}return 0===a}))}},{key:"_forAllFeaturesOfNode",value:function(e,t){for(var r=1,i=e.featureIds,n=0;n<i.length;n++)if(0===(r=t(i[n],n,e)))return r;return r}},{key:"_forVisibleFeaturesOfNode",value:function(e,t){var r=1,i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(n){return 1===(r=t(i[n],n,e))})),r}},{key:"_forAllFeaturesOfNodeInClippingArea",value:function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var r=this._boundingboxNodeTest(e,this._clippingArea);if(0===r)return 1;if(3===r)return this._forAllFeaturesOfNode(e,t);for(var i=e.featureIds,n=e.objectHandle,a=Object(Ue.o)(this._clippingArea,this._collection.getObjectTransform(n)),s=0;s<i.length;s++)if(this._boundingboxFeatureTest(e,s,a)){var o=t(i[s],s,e);if(0===o)return o}return 1}},{key:"_createAttributes",value:function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=Object(j.k)(t.attributeInfo)&&t.attributeInfo.attributeData;if(Object(j.k)(i))for(var n=0,a=Object.keys(i);n<a.length;n++){var s=a[n];r[s]=Object(Ue.n)(i[s],e)}return r}},{key:"_createGraphic",value:function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}},{key:"highlight",value:function(e){var t=this._highlights;if("number"==typeof e||e instanceof y.a?e=[e]:e instanceof v.a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y.a){var r=e,i=this.i3slayer.fieldsIndex,n=this._getObjectIdField(),a=r.map((function(e){return Object(ze.a)(i,e.attributes,n)})),s=t.acquireSet(),o=s.set,c=s.handle;return t.setFeatureIds(o,a),c}if("number"==typeof e[0]){var l=e,u=t.acquireSet(),d=u.set,h=u.handle;return t.setFeatureIds(d,l),h}}return ht}},{key:"_visibleGeometryChanged",value:function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=Object(k.b)((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))}},{key:"performanceInfo",get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};return Object(j.k)(this._memCache)&&(e.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e}},{key:"test",get:function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}}},{key:"getNodeOpacityByIndex",value:function(e){var t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}},{key:"getNodeOpacity",value:function(e){return Object(j.k)(e)?this._collection.getMaterial(e.objectHandle).objectOpacity:0}},{key:"isNodeFullyFadedIn",value:function(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}},{key:"getNodeCrossfadeMetaData",value:function(e){return this._nodeId2Meta.get(e)}},{key:"markNodeToRemove",value:function(e){this._controller&&this._controller.markNodeToRemove(e)}},{key:"removeMarkedNodes",value:function(){this._controller&&this._controller.removeMarkedNodes()}},{key:"foreachCrossfadeNode",value:function(e){this._nodeId2Meta.forEach((function(t,r){return e(r,t)}))}},{key:"fadeNode",value:function(e,t,r){if(this.nodeCrossfadingEnabled){var i=this._nodeId2Meta.get(e);Object(j.k)(i)&&this._crossfadeHelper.fadeNode(e,i,t,r)}}},{key:"setNodeOpacityByIndex",value:function(e,t){var r=this._nodeId2Meta.get(e);Object(j.k)(r)&&this._setNodeOpacity(r,t)}},{key:"_setNodeOpacity",value:function(e,t){this._collection.updateMaterial(e.objectHandle,(function(e){return e.objectOpacity=t})),this._setNodeEdgeOpacity(e,t)}},{key:"_setNodeEdgeOpacity",value:function(e,t){if(Object(j.k)(this._edgeView)&&e.cachedEdgeMaterials){bt(e.cachedEdgeMaterials,t);var r=e.objectHandle;this._edgeView.hasObject(r)&&this._edgeView.updateAllComponentOpacities(r,t)}}},{key:"_hasModifications",get:function(){return this._modifications&&this._modifications.length>0}},{key:"updateNodeModificationStatus",value:function(e){var t=this,r=e.length;if(this._hasModifications&&!(r<=0)&&!0===this._i3sWasmLoaded){var i=this.i3slayer.uid,n=function(e){if(0===e.length)return null;var t=10*e.length,r=new Float64Array(t);return e.forAll((function(e,t){var i=e.serviceObb;Object(j.j)(i)&&(i=nt,Object(P.m)(i.center,e.mbs),i.halfSize[0]=i.halfSize[1]=i.halfSize[2]=e.mbs[3]);var n=10*t;r[n+0]=i.center[0],r[n+1]=i.center[1],r[n+2]=i.center[2],r[n+3]=i.halfSize[0],r[n+4]=i.halfSize[1],r[n+5]=i.halfSize[2],r[n+6]=i.quaternion[0],r[n+7]=i.quaternion[1],r[n+8]=i.quaternion[2],r[n+9]=i.quaternion[3]})),r}(e);if(Object(j.k)(n)){var a={context:i,buffer:n.buffer};Object(ye.filterObbsForModificationsSync)(a);var s=new Float64Array(n.buffer);e.forAll((function(e,r){var i=s[r],n=Object(ye.interpretObbModificationResults)(i);e.imModificationImpact=n,0!==n&&t._controller.invalidateGeometryVisibility(e.index)}))}}}},{key:"notifyUpdate",value:function(){this.notifyChange("updating")}},{key:"notifyLODUpdate",value:function(){this._controller.notifyLODUpdate()}},{key:"isUpdating",value:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||Object(j.k)(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0}}]),n}(e);return Object(f.a)([Object(S.b)()],t.prototype,"_hasLoadedPBRTextures",void 0),Object(f.a)([Object(S.b)()],t.prototype,"_asyncModuleLoading",void 0),Object(f.a)([Object(S.b)()],t.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),Object(f.a)([Object(S.b)()],t.prototype,"view",void 0),Object(f.a)([Object(S.b)()],t.prototype,"i3slayer",void 0),Object(f.a)([Object(S.b)()],t.prototype,"_controller",void 0),Object(f.a)([Object(S.b)()],t.prototype,"_labeler",void 0),Object(f.a)([Object(S.b)()],t.prototype,"updating",void 0),Object(f.a)([Object(S.b)()],t.prototype,"suspended",void 0),Object(f.a)([Object(S.b)()],t.prototype,"holeFilling",void 0),Object(f.a)([Object(S.b)(Ke.a)],t.prototype,"updatingProgress",void 0),Object(f.a)([Object(S.b)({readOnly:!0,aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),Object(f.a)([Object(S.b)({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),Object(f.a)([Object(S.b)({readOnly:!0})],t.prototype,"rendererTextureUsage",null),Object(f.a)([Object(S.b)({readOnly:!0})],t.prototype,"elevationOffset",null),Object(f.a)([Object(S.b)({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),Object(f.a)([Object(S.b)()],t.prototype,"supportedTextureEncodings",null),Object(f.a)([Object(S.b)()],t.prototype,"uncompressedTextureDownsamplingEnabled",null),Object(f.a)([Object(S.b)({type:[q.a]})],t.prototype,"_modifications",void 0),t=Object(f.a)([Object(F.a)("esri.views.3d.layers.I3SMeshView3D")],t)},rt=Object(V.h)(),it=Object(V.h)(),nt=Object(Pe.e)(),at=[0,0,0,0],st=new p.a([0,0,0,0]),ot=[0,0,0,0];function ct(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function lt(e){return Object(j.k)(e)&&Object(w.c)(e.data)}function ut(e,t){var r=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(Object(j.k)(t)){var i,n=Object(c.a)(t);try{for(n.s();!(i=n.n()).done;){var a=i.value;Object(j.k)(a)&&Object(w.c)(a.data)&&(r+=a.data.byteLength)}}catch(s){n.e(s)}finally{n.f()}}return r}function dt(e,t){return t.byteSize>104857600?(Xe.warn("Node is too big to store in IndexedDB cache: ".concat(e.id," (").concat(t.byteSize," bytes)")),!1):t.byteSize>0}var ht={remove:function(){},pause:function(){},resume:function(){}};function bt(e,t){e.forEach((function(e){return e.opacity=t}))}},963:function(e,t,r){"use strict";r.d(t,"a",(function(){return m}));var i,n=r(2),a=r(3),s=r(6),o=r(7),c=r(0),l=r(54),u=r(503),d=r(216),h=r(1),b=(r(17),r(18),r(16),r(12)),f=r(872),p=r(897),y={type:l.a,readOnly:!0,json:{origins:{service:{read:{source:"sublayers",reader:v}}},read:!1}};function v(e,t,r){if(e&&Array.isArray(e))return new l.a(e.map((function(e){var t=function(e){return"group"===e.layerType?O:f.a}(e);if(t){var i=new t;return i.read(e,r),i}r&&r.messages&&e&&r.messages.push(new d.a("building-scene-layer:unsupported-sublayer-type","Building scene sublayer of type '"+(e.type||"unknown")+"' are not supported",{definition:e,context:r}))})))}var g,O=i=function(e){Object(s.a)(r,e);var t=Object(o.a)(r);function r(e){var i;return Object(n.a)(this,r),(i=t.call(this,e)).type="building-group",i.listMode="show",i.sublayers=null,i}return Object(a.a)(r,[{key:"loadAll",value:function(){var e=this;return Object(u.b)(this,(function(t){return i.forEachSublayer(e.sublayers,(function(e){"building-group"!==e.type&&t(e)}))}))}}]),r}(p.a);Object(c.a)([Object(h.b)({type:["hide","show","hide-children"],json:{write:!0}})],O.prototype,"listMode",void 0),Object(c.a)([Object(h.b)(y)],O.prototype,"sublayers",void 0),O=i=Object(c.a)([Object(b.a)("esri.layers.buildingSublayers.BuildingGroupSublayer")],O),(g=O||(O={})).sublayersProperty=y,g.readSublayers=v,g.forEachSublayer=function e(t,r){t.forEach((function(t){r(t),"building-group"===t.type&&e(t.sublayers,r)}))};var m=O},964:function(e,t,r){"use strict";r.d(t,"a",(function(){return M}));var i,n=r(8),a=r.n(n),s=r(11),o=r(15),c=r(2),l=r(3),u=r(6),d=r(7),h=r(0),b=(r(140),r(34)),f=r(115),p=r(16),y=r(4),v=r(78),g=r(36),O=r(1),m=(r(17),r(18),r(12)),j=r(5),_=r(773),x=r(49),k=r(37),w=r(43),I=r(77),C=r(801),S=r(808),F=r(56),N=p.a.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter"),M=function(e){Object(u.a)(r,e);var t=Object(d.a)(r);function r(e){var i;return Object(c.a)(this,r),(i=t.call(this,e))._projectionEngineLoaded=!1,i}return Object(l.a)(r,[{key:"initialize",value:function(){var e=this;Object(g.j)(this,"filter.geometry").then((function(){return e.loadAsyncModule(function(){return D.apply(this,arguments)}().then((function(t){e.destroyed||(e._geometryEngine=t,e.applyFilters())})))}))}},{key:"sortedObjectIds",get:function(){if(Object(y.j)(this.filter.objectIds))return null;var e=new Float64Array(this.filter.objectIds);return e.sort(),e}},{key:"parsedWhereClause",get:function(){var e=Object(y.k)(this.filter)?this.filter.where:null;if(Object(y.j)(e)||!e)return null;try{return _.WhereClause.create(e,this.layerFieldsIndex)}catch(t){N.error("Failed to parse filter where clause: ".concat(t))}return null}},{key:"addFilters",value:function(e,t,r,n){var a=this.sortedObjectIds;Object(y.k)(a)&&e.push((function(e){return Object(C.t)(a,!0,e)})),this.addSqlFilter(e,this.parsedWhereClause);var o=this.parsedGeometry;if(Object(y.k)(o)){var c=this.spatialRelationship;e.push((function(e,a){return function(e,t,r,n,a,o,c){var l=o[0].spatialReference||n.spatialReference;if(!Object(x.p)(t.node.mbs,a,L,l))return void N.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");var u,d=A(L,l),h=function(e,t,r,n,a){var s=t.renderSpatialReference,o=new Map,c={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};c.rings[0][3]=c.rings[0][0];var l,u,d={indices:null,data:null,stride:0,startIndex:0,endIndex:0};switch(e){case"intersects":l=function(e,t){return i.intersects(e,t)?0:2},u=T;break;case"contains":l=function(e,t){return i.contains(e,t)?2:1},u=T;break;default:l=function(e,t){return i.disjoint(e,t)?2:1},u=U}return{collection:n,object:a,type:e,maskSR:r,renderSR:s,aabbCache:o,triangle:c,positions:d,triangleTest:l,geometryTest:u}}(c,n,l,r,t.objectHandle),b=Object(s.a)(o);try{var f=function(){var r=u.value;if(0===e.length)return{v:void 0};switch(V(r,d,c)){case 1:return{v:void(e.length=0)};case 0:return"continue"}Object(C.j)(e,t.featureIds,(function(e){return function(e,t,r){var i=r.collection,n=r.object,a=r.renderSR,s=r.maskSR,o=r.geometryTest,c=r.aabbCache,l=c.get(t);if(!l){var u=i.getObjectTransform(n);i.getComponentAabb(n,t,q);for(var d=[[q[0],q[1],0],[q[0],q[4],0],[q[3],q[4],0],[q[3],q[1],0]],h=0;h<4;++h)Object(j.z)(d[h],d[h],u.rotationScale),Object(j.h)(d[h],d[h],u.position),Object(x.z)(d[h],a,d[h],s);(l={rings:[d],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s}).rings[0][4]=l.rings[0][0],c.set(t,l)}switch(o(e,l)){case 1:return!1;case 0:return!0}var b=r.triangle,f=r.triangleTest,p=r.positions,y=b.rings[0][0],v=b.rings[0][1],g=b.rings[0][2],O=i.getObjectTransform(n);i.getComponentPositions(n,t,p);for(var m=p.indices,_=p.data,k=p.stride,w=p.startIndex,I=p.endIndex,C=w;C<I;C+=3){var S=k*m[C+0],F=k*m[C+1],N=k*m[C+2];Object(j.y)(y,_[S+0],_[S+1],_[S+2]),Object(j.y)(v,_[F+0],_[F+1],_[F+2]),Object(j.y)(g,_[N+0],_[N+1],_[N+2]),Object(j.z)(y,y,O.rotationScale),Object(j.z)(v,v,O.rotationScale),Object(j.z)(g,g,O.rotationScale),Object(j.h)(y,y,O.position),Object(j.h)(v,v,O.position),Object(j.h)(g,g,O.position),Object(x.z)(y,a,y,s),Object(x.z)(v,a,v,s),Object(x.z)(g,a,g,s);var M=v[0]-y[0],E=v[1]-y[1],D=g[0]-y[0],P=g[1]-y[1];if(!(Math.abs(M*P-E*D)<G))switch(delete b._geVersion,f(e,b)){case 1:return!1;case 0:return!0}}return"intersects"!==r.type}(r,e,h)}))};for(b.s();!(u=b.n()).done;){var p=f();if("continue"!==p&&"object"===typeof p)return p.v}}catch(y){b.e(y)}finally{b.f()}}(e,a,n,t,r,o,c)}))}}},{key:"isMBSGeoemtryVisible",value:function(e,t,r){var i=this.parsedGeometry;if(Object(y.k)(i)){var n=this.spatialRelationship,a=i[0].spatialReference||t;return Object(x.p)(e,r,L,a)?function(e,t,r,i){var n=A(e,r);return t.every((function(e){return 1!==V(e,n,i)}))}(L,i,a,n):(N.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}},{key:"parsedGeometry",get:function(){var e=this;if(Object(y.j)(this.filter))return null;if(!this._geometryEngine)return null;var t=this.filter.geometry;if(Object(y.j)(t))return null;var r=this.filter,i=r.distance,n=r.units,a=this.spatialRelationship,s="mesh"===t.type?t.extent:t;if(Object(y.j)(i)||0===i)return R(s,a);var o=n||Object(v.h)(s.spatialReference);if(s.spatialReference.isWGS84)return R(this._geometryEngine.geodesicBuffer(s,i,o),a);var c=Object(I.d)(s,F.a.WGS84);if(Object(y.k)(c))return R(Object(I.d)(this._geometryEngine.geodesicBuffer(c,i,o),s.spatialReference),a);if(!this._projectionEngineLoaded&&(this.loadAsyncModule(Object(x.j)().then((function(){return e._projectionEngineLoaded=!0}))),!this._projectionEngineLoaded))return null;var l=null;try{l=Object(x.n)(s,F.a.WGS84)}catch(u){}if(l)try{l=Object(x.n)(this._geometryEngine.geodesicBuffer(l,i,o),s.spatialReference)}catch(u){l=null}return l||N.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry (".concat(s.spatialReference.wkid,") to WGS84.")),R(l,a)}},{key:"spatialRelationship",get:function(){return Object(y.k)(this.filter)?this.filter.spatialRelationship:"intersects"}}],[{key:"checkSupport",value:function(e){return e.timeExtent?(N.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&P.indexOf(e)>=0}(e.spatialRelationship)||(N.warn("Filters with spatialRelationship other than ".concat(P.join(", ")," are not supported for mesh scene layers")),!1)}}]),r}(b.a);function E(){return!!i}function D(){return(D=Object(o.a)(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=E(),e.t0){e.next=5;break}return e.next=4,Promise.all([r.e(3),r.e(36)]).then(r.bind(null,874));case 4:i=e.sent;case 5:return e.abrupt("return",i);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Object(h.a)([Object(O.b)({type:S.a})],M.prototype,"filter",void 0),Object(h.a)([Object(O.b)()],M.prototype,"layerFieldsIndex",void 0),Object(h.a)([Object(O.b)()],M.prototype,"loadAsyncModule",void 0),Object(h.a)([Object(O.b)()],M.prototype,"applyFilters",void 0),Object(h.a)([Object(O.b)()],M.prototype,"addSqlFilter",void 0),Object(h.a)([Object(O.b)({readOnly:!0})],M.prototype,"sortedObjectIds",null),Object(h.a)([Object(O.b)({readOnly:!0})],M.prototype,"parsedWhereClause",null),Object(h.a)([Object(O.b)({readOnly:!0})],M.prototype,"parsedGeometry",null),Object(h.a)([Object(O.b)({readOnly:!0})],M.prototype,"spatialRelationship",null),Object(h.a)([Object(O.b)()],M.prototype,"_projectionEngineLoaded",void 0),Object(h.a)([Object(O.b)()],M.prototype,"_geometryEngine",void 0),M=Object(h.a)([Object(m.a)("esri.views.3d.layers.i3s.I3SMeshViewFilter")],M);var P=["contains","intersects","disjoint"];function R(e,t){if(Object(y.j)(e))return null;if("disjoint"===t&&"polygon"===e.type){var r=function(){for(var t=new Array(e.rings.length),r=0;r<e.rings.length;++r){var n=Object(w.t)(1/0,1/0,-1/0,-1/0);Object(w.r)(n,e.rings[r]),t[r]={type:"polygon",rings:[e.rings[r]],spatialReference:e.spatialReference,aabr:n}}t.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));for(var a=new Set,s=new f.a,o=function(e){for(var r=t[e],n=e+1;n<t.length;++n){var o=t[n];if(o.aabr[0]>=r.aabr[2])break;a.add(o)}a.forEach((function(e){if(r!==e)if(e.aabr[2]<=r.aabr[0])a.delete(e);else if(i.intersects(r,e)){r.rings=r.rings.concat(e.rings),Object(w.p)(r.aabr,e.aabr,r.aabr),delete r._geVersion,a.delete(e);var n=Object(f.g)(t,e,t.length,s);t.splice(n,1)}})),a.add(r)},c=0;c<t.length;++c)o(c);for(var l=0,u=t;l<u.length;l++){delete u[l].aabr}return{v:t}}();if("object"===typeof r)return r.v}return[e]}var L=[0,0,0,0];function A(e,t){var r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=t.isWGS84||t.isWebMercator?i.geodesicBuffer(r,e[3],1):i.buffer(r,e[3],1);return n.type="polygon",n}function V(e,t,r){switch(r){case"intersects":case"contains":return T(e,t);case"disjoint":return U(e,t)}}function T(e,t){return i.intersects(e,t)?i.contains(e,t)?0:2:1}function U(e,t){return i.intersects(e,t)?i.contains(e,t)?1:2:0}var G=Math.pow(2,-32);var q=Object(k.h)()},965:function(e,t,r){"use strict";r.d(t,"a",(function(){return x}));var i=r(8),n=r.n(i),a=r(15),s=r(2),o=r(3),c=r(6),l=r(7),u=r(0),d=r(34),h=r(24),b=r(61),f=r(4),p=r(1),y=(r(17),r(18),r(16),r(12)),v=r(72),g=r(846),O=r(243),m=r(171),j=g.a,_=function(e){Object(c.a)(r,e);var t=Object(l.a)(r);function r(e){var i;return Object(s.a)(this,r),(i=t.call(this,e))._dataQueryEngineInstance=null,i._handles=new b.a,i}return Object(o.a)(r,[{key:"defaultQueryJSON",get:function(){return new m.a({outSpatialReference:this.spatialReference}).toJSON()}},{key:"dataQueryEngine",get:function(){return this.ensureDataQueryEngine()}},{key:"initialize",value:function(){var e=this;this._handles.add(this.layerView.on("visible-geometry-changed",(function(){return e.spatialIndex.events.emit("changed")})))}},{key:"destroy",value:function(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}},{key:"executeQueryForCount",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){var i,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),r);case 2:return i=e.sent,a=i.count,s=i.extent,e.abrupt("return",{count:a,extent:v.a.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),r));case 1:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=Object(a.a)(n.a.mark((function e(t,r){var i,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=this._ensureQueryJSON(t)).returnGeometry){e.next=3;break}throw new h.a("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");case 3:if(!i.returnCentroid){e.next=5;break}throw new h.a("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");case 5:return e.next=7,this.dataQueryEngine.executeQuery(i,r);case 7:return a=e.sent,s=O.default.fromJSON(a),e.abrupt("return",(s.features.forEach((function(e){e.geometry=null})),s));case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e){if(Object(f.j)(e))return this.defaultQueryJSON;var t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}},{key:"ensureDataQueryEngine",value:function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((function(e){return e.toJSON()})),r=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),n=this.priority,a=this.spatialIndex;return this._dataQueryEngineInstance=new j({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:i,objectIdField:e,featureStore:a,scheduler:r,priority:n}),this._dataQueryEngineInstance}}]),r}(d.a);Object(u.a)([Object(p.b)({constructOnly:!0})],_.prototype,"layerView",void 0),Object(u.a)([Object(p.b)({constructOnly:!0})],_.prototype,"priority",void 0),Object(u.a)([Object(p.b)({constructOnly:!0})],_.prototype,"spatialIndex",void 0),Object(u.a)([Object(p.b)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],_.prototype,"spatialReference",void 0),Object(u.a)([Object(p.b)({readOnly:!0,aliasOf:"layerView.i3slayer"})],_.prototype,"layer",void 0),Object(u.a)([Object(p.b)({readOnly:!0})],_.prototype,"defaultQueryJSON",null);var x=_=Object(u.a)([Object(y.a)("esri.views.3d.layers.i3s.I3SQueryEngine")],_)},966:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var i=r(29),n=r(2),a=r(3),s=r(4),o=r(37),c=r(815),l=r(244),u=r(801),d=function(){function e(t){Object(n.a)(this,e),this.objectIdField=t.objectIdField,this.getFeatureExtent=t.getFeatureExtent}return Object(a.a)(e,[{key:"getObjectId",value:function(e){return e.id}},{key:"getAttributes",value:function(e){var t=e.meta,r=e.index,i={};this.objectIdField&&(i[this.objectIdField]=e.id);var n=Object(s.k)(t.attributeInfo)&&t.attributeInfo.attributeData;if(Object(s.k)(n))for(var a=0,o=Object.keys(n);a<o.length;a++){var c=o[a];i[c]=Object(u.n)(n[c],r)}return i}},{key:"getAttribute",value:function(e,t){if(t===this.objectIdField)return e.id;var r=e.meta,i=e.index,n=Object(s.k)(r.attributeInfo)&&r.attributeInfo.attributeData;return Object(s.k)(n)?Object(u.n)(n[t],i):null}},{key:"getGeometry",value:function(e){if(e.geometry)return e.geometry;var t=this.getFeatureExtent(e,h),r=Object(i.a)(t,5),n=r[0],a=r[1],s=r[2],o=r[3],c=r[4];return new l.a([5],[n,a,s,o,a,s,o,c,s,n,c,s,n,a,s])}},{key:"getCentroid",value:function(e,t){if(e.geometry)return Object(c.a)(new l.a,e.geometry,t.hasZ,t.hasM);var r=this.getFeatureExtent(e,h),n=Object(i.a)(r,6),a=n[0],s=n[1],o=n[2],u=n[3],d=n[4],b=n[5];return new l.a([0],[(a+u)/2,(s+d)/2,(o+b)/2])}},{key:"cloneWithGeometry",value:function(e,t){return{id:e.id,index:e.index,meta:e.meta,geometry:t}}}]),e}(),h=Object(o.h)()},967:function(e,t,r){"use strict";r.d(t,"a",(function(){return j}));var i=r(11),n=r(2),a=r(3),s=r(6),o=r(7),c=r(0),l=r(34),u=r(94),d=r(1),h=(r(17),r(18),r(16),r(12)),b=r(46),f=r(49),p=r(37),y=r(43),v=function(e){Object(s.a)(r,e);var t=Object(o.a)(r);function r(e){var i;return Object(n.a)(this,r),(i=t.call(this,e)).events=new u.a,i}return Object(a.a)(r,[{key:"forEach",value:function(e){this.forAllFeatures((function(t){return e(t),1}))}},{key:"forEachBounds",value:function(e,t,r){var n,a=this.getFeatureExtent,s=Object(i.a)(e);try{for(s.s();!(n=s.n()).done;){t(a(n.value,r))}}catch(o){s.e(o)}finally{s.f()}}},{key:"forEachInBounds",value:function(e,t){var r=this;this.forAllFeatures((function(i){var n=r.getFeatureExtent(i,O);return Object(y.w)(e,Object(p.F)(n,m))&&t(i),1}),(function(t){if(Object(f.p)(t.node.mbs,r.sourceSpatialReference,g,r.viewSpatialReference),g[0]>=e[0]&&g[2]<=e[2]&&g[1]>=e[1]&&g[3]<=e[3])return 1;var i=Math.max(e[0],Math.min(g[0],e[2])),n=Math.max(e[1],Math.min(g[1],e[3])),a=g[0]-i,s=g[1]-n;return a*a+s*s<=g[3]*g[3]?1:2}))}}]),r}(l.a);Object(c.a)([Object(d.b)({constructOnly:!0})],v.prototype,"featureAdapter",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],v.prototype,"forAllFeatures",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],v.prototype,"getFeatureExtent",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],v.prototype,"sourceSpatialReference",void 0),Object(c.a)([Object(d.b)({constructOnly:!0})],v.prototype,"viewSpatialReference",void 0),v=Object(c.a)([Object(h.a)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],v);var g=Object(b.e)(),O=Object(p.h)(),m=Object(y.l)(),j=v}}]);
//# sourceMappingURL=46.cebfcd7b.chunk.js.map