(this.webpackJsonpexample=this.webpackJsonpexample||[]).push([[72],{1136:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return Ze}));var r=n(34),i=n(8),a=n.n(i),o=n(16),s=n(44),u=n(13),l=n(2),c=n(4),d=n(28),h=n(27),f=n(6),p=n(7),b=n(0),v=n(130),g=n(53),_=n(15),y=n(3),m=n(23),O=n(31),j=n(98),x=n(76),k=n(1),S=(n(17),n(18),n(11)),w=n(5),P=n(62),z=n(48),N=n(37),C=n(42),R=n(41),I=n(184),A=n(657),M=n(350),F=(n(265),n(351),n(352),n(105)),V=n(596),E=n(425),L=n(578),q=function(e){Object(f.a)(n,e);var t=Object(p.a)(n);function n(e){return Object(l.a)(this,n),t.call(this,"PointCloudWorker","transform",e)}return Object(c.a)(n,[{key:"getTransferList",value:function(e){var t=[e.geometryBuffer];if(Object(y.k)(e.primaryAttributeData)&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),Object(y.k)(e.modulationAttributeData)&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),Object(y.k)(e.filterAttributesData)){var n,r=Object(u.a)(e.filterAttributesData);try{for(r.s();!(n=r.n()).done;){var i=n.value;Object(y.k)(i)&&i.buffer&&t.push(i.buffer)}}catch(l){r.e(l)}finally{r.f()}}var a,o=Object(u.a)(e.userAttributesData);try{for(o.s();!(a=o.n()).done;){var s=a.value;s.buffer&&t.push(s.buffer)}}catch(l){o.e(l)}finally{o.f()}return t}}]),n}(n(458).a),D=n(740);var H=[!1],U=[null],Q=[!1],W=[null];function T(e,t,n){for(var r=e;r>0;){var i=t.indexOf(r);if(i>=0)return i;r=n.getParentId(r)}return t.indexOf(r)}function B(e,t,n){for(var r=[t.remove[0]],i=[];1===r.length;){var a=r.pop();i.length=0;for(var o=0;o<t.load.length;o++){for(var s=t.load[o],u=n.getParentId(s);u!==a;)s=u,u=n.getParentId(s);var l=r.indexOf(s);l<0&&(l=r.length,r.push(s),i.push([])),i[l].push(t.load[o])}}t.load=r;for(var c=0;c<r.length;c++)i[c].length>1?e.push({remove:[r[c]],load:i[c]}):r[c]=i[c][0]}var G=n(374),J=function(){function e(t,n,r){Object(l.a)(this,e),this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=t,this._renderSR=n,this.pageSize=r}return Object(c.a)(e,[{key:"addPage",value:function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._pages.length<e;)this._pages.push(null);var r=K(t,this._nodeSR,this._renderSR,n);this._pages[e]={nodes:t,renderObbs:r,parents:new Uint32Array(this.pageSize)},Y(this._pages,this.pageSize)}},{key:"hasPage",value:function(e){return!!this._pages[e]}},{key:"getNode",value:function(e){var t=this.pageSize;return this._pages[X(e,t)].nodes[Z(e,t)]}},{key:"getRenderObb",value:function(e){var t=this.pageSize;return this._pages[X(e,t)].renderObbs[Z(e,t)]}},{key:"getRenderCenter",value:function(e){return this.getRenderObb(e).center}},{key:"setRenderObb",value:function(e,t){var n=this.pageSize;Object(G.m)(t,this._pages[X(e,n)].renderObbs[Z(e,n)])}},{key:"getParentId",value:function(e){var t=this.pageSize;return this._pages[X(e,t)].parents[Z(e,t)]}},{key:"hasNodes",value:function(e,t){for(var n=X(e,this.pageSize),r=X(e+t-1,this.pageSize),i=n;i<=r;i++)if(null==this._pages[i])return!1;return!0}},{key:"forEachNodeId",value:function(e){for(var t=0;t<this._pages.length;t++){var n=this._pages[t];if(n)for(var r=0;r<n.nodes.length;r++)e(t*this.pageSize+r)}}},{key:"createVisibilityTraverse",value:function(){var e={index:this,queue:[],masks:[],tempAabb:Object(N.h)()};return function(t,n){return function(e,t,n){var r=e.index;if(!r.hasNodes(0,1))return;var i=e.queue;i.length=0,i.push(0);var a=e.masks;for(a.length=0,a.push(0);i.length>0;){var o=i.pop(),s=a.pop(),u=r.getNode(o),l=r.getRenderObb(o),c=!0;if(null!=t.clippingBox){var d=1<<t.frustum.length;if(0==(s&d)){var h=Object(G.n)(l,e.tempAabb);Object(N.f)(t.clippingBox,h)?s|=d:Object(N.v)(t.clippingBox,h)||(c=!1)}}for(var f=0;f<t.frustum.length&&c;f++){var p=1<<f;if(0==(s&p)){var b=Object(G.g)(l,t.frustum[f]);b>0?c=!1:b<0&&(s|=p)}}if(n.predicate(o,u,c)){for(var v=u.firstChild,g=u.childCount,_=!1,y=X(v,r.pageSize),m=X(v+g-1,r.pageSize),O=y;O<=m;O++)if(!r.hasPage(O)){n.pageMiss(o,O),_=!0;break}if(!_)for(var j=0;j<g;j++)i.push(v+j),a.push(s)}}}(e,t,n)}}}]),e}();function K(e,t,n,r){for(var i=new G.a(e.length),a=0;a<e.length;a++)Object(D.v)(e[a].obb,t,i.obbs[a],n,r);return i.obbs}function Y(e,t){for(var n=[0];n.length;)for(var r=n.pop(),i=e[X(r,t)].nodes[Z(r,t)],a=0;a<i.childCount;a++){var o=i.firstChild+a;null!=e[X(o,t)]&&(e[X(o,t)].parents[Z(o,t)]=r,n.push(o))}}function X(e,t){return e/t|0}function Z(e,t){return e%t}function $(e){var t=e.renderer,n=t&&t.type,r=t&&e.renderer.toJSON()||null,i=null,a=!1;"point-cloud-unique-value"===n||"point-cloud-stretch"===n||"point-cloud-class-breaks"===n?i=re(e.attributeStorageInfo,t.field):"point-cloud-rgb"===n?a=null!=(i=ne(e.attributeStorageInfo,t.field)):a=null!=(i=ne(e.attributeStorageInfo,"RGB"));var o=null;return t&&t.colorModulation&&(o=re(e.attributeStorageInfo,t.colorModulation.field)),{rendererJSON:r,isRGBRenderer:a,primaryAttribute:i,modulationAttribute:o}}function ee(e){var t=e.filters;return t?t.map((function(t){return{filterJSON:t.toJSON(),attributeInfo:re(e.attributeStorageInfo,t.field)}})):[]}function te(e){var t=e&&e.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null}function ne(e,t){var n,r=Object(u.a)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:t,storageInfo:i,useElevation:!1}}}catch(a){r.e(a)}finally{r.f()}return null}function re(e,t){var n,r=Object(u.a)(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(i.name===t){var a="embedded-elevation"===i.encoding;return{name:t,storageInfo:a?null:i,useElevation:a}}}}catch(o){r.e(o)}finally{r.f()}return"elevation"===t.toLowerCase()?{name:t,storageInfo:null,useElevation:!0}:null}var ie,ae=n(957),oe=n(14),se=n(134),ue=ie=function(e){Object(f.a)(n,e);var t=Object(p.a)(n);function n(e){return Object(l.a)(this,n),t.call(this,e)}return Object(c.a)(n,[{key:"clone",value:function(){return new ie(this.cloneProperties())}},{key:"cloneProperties",value:function(){var e=this.pointCloudMetadata;return Object(oe.a)(Object(oe.a)({},Object(d.a)(Object(h.a)(n.prototype),"cloneProperties",this).call(this)),{},{pointCloudMetadata:e})}}]),n}(se.a);Object(b.a)([Object(k.b)({constructOnly:!0})],ue.prototype,"pointCloudMetadata",void 0),ue=ie=Object(b.a)([Object(S.a)("esri.views.3d.layers.i3s.PointGraphic")],ue);var le=n(71),ce=n(26),de=n(434),he=n(32),fe=n(10),pe=n(54),be=n(80),ve=n(195),ge=n(360),_e=function(){function e(t){Object(l.a)(this,e),this.context=t,this.highlights=new Set}return Object(c.a)(e,[{key:"hasHighlights",get:function(){return this.highlights.size>0}},{key:"destroy",value:function(){this.highlights=null}},{key:"add",value:function(e){var t=this,n=new ye(e);return this.highlights.add(n),this.enableSet(n),Object(ve.b)((function(){return t.removeSet(n)}))}},{key:"removeSet",value:function(e){this.disableSet(e),this.highlights.delete(e)}},{key:"enableSet",value:function(e){var t=this;e.enabled||(e.enabled=!0,this.context.forEachNode((function(n){return t.enableSetForNode(e,n)})))}},{key:"enableSetForNode",value:function(e,t){var n=this;if(e.enabled){var r=e.ids.get(t.id);r&&r.forEach((function(r){return n.context.addHighlight(t,r,e.id)}))}}},{key:"disableSet",value:function(e){var t=this;e.enabled&&(e.enabled=!1,this.context.forEachNode((function(n){return t.disableSetForNode(e,n)})))}},{key:"disableSetForNode",value:function(e,t){e.enabled||this.context.removeHighlight(t,e.id)}},{key:"nodeAdded",value:function(e){var t=this;this.highlights.forEach((function(n){return t.enableSetForNode(n,e)}))}},{key:"nodeRemoved",value:function(e){var t=this;this.highlights.forEach((function(n){return t.disableSetForNode(n,e)}))}},{key:"removeAll",value:function(){var e=this;this.highlights.forEach((function(t){return e.disableSet(t)}))}}]),e}(),ye=function(){function e(t){Object(l.a)(this,e),this.id=new ge.a(0),this.ids=new Map,this.enabled=!1;var n,r=Object(u.a)(t);try{for(r.s();!(n=r.n()).done;){var i=n.value;Object(y.k)(i)&&this.add(i.nodeId,i.pointId)}}catch(a){r.e(a)}finally{r.f()}}return Object(c.a)(e,[{key:"add",value:function(e,t){var n=this.ids.get(e);n?n.add(t):this.ids.set(e,new Set([t]))}}]),e}(),me=n(78),Oe=n(112),je=n(73),xe=n(251),ke=n(83),Se=n(87),we=n(24),Pe=n(82),ze=n(114),Ne=n(913),Ce=n(38),Re=function(e){Object(f.a)(n,e);var t=Object(p.a)(n);function n(e,r,i){return Object(l.a)(this,n),t.call(this,e,r,i)}return Object(c.a)(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get(),r=this.configuration,i=t.build({output:r.output,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,drawScreenSize:r.drawScreenSize});return new Pe.a(e.rctx,i,je.a)}},{key:"initializePipeline",value:function(){return Object(Ce.g)({depthTest:{func:513},depthWrite:Ce.e,colorWrite:Ce.d,stencilWrite:this.configuration.sceneHasOcludees?ze.j:null,stencilTest:this.configuration.sceneHasOcludees?ze.e:null})}}]),n}(Se.a);Re.shader=new ke.a(Ne.a,(function(){return n.e(214).then(n.bind(null,1127))}));var Ie=function(e){Object(f.a)(n,e);var t=Object(p.a)(n);function n(){var e;return Object(l.a)(this,n),(e=t.apply(this,arguments)).output=0,e.slicePlaneEnabled=!1,e.drawScreenSize=!1,e.sceneHasOcludees=!1,e}return n}(we.a);Object(b.a)([Object(we.b)({count:8})],Ie.prototype,"output",void 0),Object(b.a)([Object(we.b)()],Ie.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(we.b)()],Ie.prototype,"drawScreenSize",void 0),Object(b.a)([Object(we.b)()],Ie.prototype,"sceneHasOcludees",void 0);var Ae=n(85),Me=n(104),Fe={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]},Ve=function(){function e(t){var n=this;Object(l.a)(this,e),this._params=t,this.type="Point",this.isGround=!1,this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null},this._highlights=new _e({forEachNode:function(e){return n.forEachNode(e)},addHighlight:function(e,t,r){return n.addHighlight(e,t,r)},removeHighlight:function(e,t){return n.removeHighlight(e,t)}}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=Object(N.h)(N.b),this._techniqueConfig=new Ie,this.tempMatrix4=Object(de.a)(),this.tempVec3=Object(P.c)(),this.nodes=new le.a}return Object(c.a)(e,[{key:"needsHighlight",get:function(){return this._highlights.hasHighlights}},{key:"initializeRenderContext",value:function(e){this._context=e,this._techniqueRep=this._context.shaderTechniqueRep,e.requestRender()}},{key:"uninitializeRenderContext",value:function(){}},{key:"intersect",value:function(e,t,n,r){var i=this,a=Object(fe.e)(),o=Object(fe.e)(),s=Object(fe.e)(),c=Object(fe.e)(),d=Object(R.d)(),h=e.camera.perScreenPixelRatio/2,f=e.camera.near,p=this._getSizeParams();Object(w.l)(o,r,n);var b=1/Object(w.r)(o);Object(w.g)(o,o,b),Object(w.u)(s,o),Object(pe.l)(d,o[0],o[1],o[2],-Object(w.j)(o,n));var v=function e(){Object(l.a)(this,e),this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""},g=new v,_=new v,y=[],m=Object(N.h)(),O=Object(N.h)(this._clipBox);Object(N.z)(O,-n[0],-n[1],-n[2],O),this.nodes.forAll((function(u){var l=u.splatSize*i._scaleFactor,j=Object(G.j)(u.obb,d),x=Object(G.i)(u.obb,d);j-=qe(l,j+f,p,h,u.isLeaf);var k=(x-=qe(l,x+f,p,h,u.isLeaf))<0,S=null!=g.dist&&null!=_.dist&&g.dist<j*b&&_.dist>x*b;if(!k&&!S){var P=Le(l,x+f,p,h,u.isLeaf);if(Object(G.f)(u.obb,n,o,P)){var z=P*P;Object(G.n)(u.obb,m),Object(N.z)(m,-n[0],-n[1],-n[2],m);var C=!Object(N.f)(O,m);Object(w.l)(c,u.origin,n);for(var R=u.coordinates.length/3,I=function(d){if(a[0]=c[0]+u.coordinates[3*d],a[1]=c[1]+u.coordinates[3*d+1],a[2]=c[2]+u.coordinates[3*d+2],C&&!Object(N.g)(O,a))return"continue";var m=Object(w.j)(a,o),j=Object(w.v)(a)-m*m;if(j>z)return"continue";var x=m+f,k=qe(l,x,p,h,u.isLeaf);if(m-k<0)return"continue";var S=Le(l,x-=k,p,h,u.isLeaf);if(j>S*S)return"continue";var P=(m-k)*b,R=function(e){e.point=function(e,t,n){return null==n&&(n=Object(fe.e)()),n[0]=e.origin[0]+e.coordinates[3*t],n[1]=e.origin[1]+e.coordinates[3*t+1],n[2]=e.origin[2]+e.coordinates[3*t+2],n}(u,d,e.point),e.dist=P,e.normal=s,e.node=u,e.pointId=d,e.layerUid=i.layerUid};if((null==g.dist||P<g.dist)&&(null==t||t(n,r,P))&&R(g),0!==e.options.store&&(null==_.dist||P>_.dist)&&(null==t||t(n,r,P))&&R(_),2===e.options.store&&(null==t||t(n,r,P))){var I=new v;R(I),y.push(I)}},A=0;A<R;A++)I(A)}}}));var j=function(e,t){var n=function(e){var t=e.layerUid,n=e.node,r=e.pointId;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:function(){return i._params.createGraphic(n,r,e.point)}}}}(t),r="".concat(t.layerUid,"/").concat(t.node.id,"/").concat(t.pointId);e.set(n,r,t.dist,t.normal,he.a,void 0),e.intersector="PointRenderer"};if(null!=g.dist){var x=e.results.min;(null==x.dist||g.dist<x.dist)&&j(x,g)}if(null!=_.dist&&0!==e.options.store){var k=e.results.max;(null==k.dist||_.dist>k.dist)&&j(k,_)}if(2===e.options.store){var S,P=Object(be.e)(n,r),z=Object(u.a)(y);try{for(z.s();!(S=z.n()).done;){var C=S.value,I=new xe.a(P);j(I,C),e.results.all.push(I)}}catch(A){z.e(A)}finally{z.f()}}}},{key:"render",value:function(e){var t=this;if(0!==e.pass&&2!==e.pass&&5!==e.pass)return!1;var n=2===e.pass,r=e.rctx;this.nodes.forAll((function(n){null==n.vao&&t._initNode(e,n)}));var i=this._getSizeParams(),a=this.selectTechnique(e,i),o=a.program;if(null==o||0===this.nodes.length)return!0;var s=this._clipBox,u=!Object(N.l)(s,N.b,(function(e,t){return e===t}));u||(Object(w.y)(this.tempVec3,-1/0,-1/0,-1/0),o.setUniform3fv("uClipMin",this.tempVec3),Object(w.y)(this.tempVec3,1/0,1/0,1/0),o.setUniform3fv("uClipMax",this.tempVec3)),r.useProgram(o),a.bindPipelineState(r),o.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),n&&o.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/e.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/e.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=e.highlightDepthTexture,Object(Oe.b)(o,this._bindParameters));var l=e.camera.pixelRatio;i.drawFixedSize&&o.setUniform2f("uPointScale",i.fixedSize*l,e.camera.fullHeight);var c=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null;return this.nodes.forAll((function(n){if(0!==n.coordinates.length&&(!e.isHighlightPass||n.highlights)){if(o.setUniform2f("uScreenMinMaxSize",i.screenMinSize*l,Ee(n.isLeaf)*l),!i.drawFixedSize){var d=n.splatSize*t._scaleFactor;o.setUniform2f("uPointScale",d*l,e.camera.fullHeight/l)}var h=n.origin;u&&(Object(w.y)(t.tempVec3,s[0]-h[0],s[1]-h[1],s[2]-h[2]),o.setUniform3fv("uClipMin",t.tempVec3),Object(w.y)(t.tempVec3,s[3]-h[0],s[4]-h[1],s[5]-h[2]),o.setUniform3fv("uClipMax",t.tempVec3)),Object(ce.i)(t.tempMatrix4),Object(ce.t)(t.tempMatrix4,t.tempMatrix4,h),Object(ce.m)(t.tempMatrix4,e.camera.viewMatrix,t.tempMatrix4),o.setUniformMatrix4fv("uModelViewMatrix",t.tempMatrix4),Object(me.b)(o,a.configuration,c,h),r.bindVAO(n.vao),e.isHighlightPass?t._renderHighlightFragments(r,n):r.drawArrays(0,0,n.coordinates.length/3)}})),!0}},{key:"_renderHighlightFragments",value:function(e,t){var n=t.highlights;if(!Object(y.j)(n)){for(var r=Object(y.t)(n[0].component),i=r+1,a=1;a<n.length;a++){var o=Object(y.t)(n[a].component);if(o!==i){var s=i-r;s>0&&e.drawArrays(0,r,s),r=o}i=o+1}var u=i-r;u>0&&e.drawArrays(0,r,u)}}},{key:"useFixedSizes",get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())}},{key:"scaleFactor",get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())}},{key:"minSizePx",get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())}},{key:"useRealWorldSymbolSizes",get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())}},{key:"size",get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())}},{key:"sizePx",get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())}},{key:"clippingBox",set:function(e){Object(N.B)(this._clipBox,e||N.b)}},{key:"slicePlane",get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}},{key:"intersectionHandlerId",get:function(){return this.layerUid}},{key:"addNode",value:function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}},{key:"removeNode",value:function(e){var t=this,n=null;return this.nodes.filterInPlace((function(r){return r.id!==e||(n=r,r.vao=Object(y.f)(r.vao),t._highlights.nodeRemoved(r),!1)})),this._requestRender(),n}},{key:"forEachNode",value:function(e){this.nodes.forAll(e)}},{key:"removeAll",value:function(){this.nodes.forAll((function(e){return e.vao=Object(y.f)(e.vao)})),this._highlights.removeAll(),this.nodes.clear(),this._requestRender()}},{key:"highlight",value:function(e){return this._highlights.add(e)}},{key:"addHighlight",value:function(e,t,n){e.highlights=function(e,t,n){Object(y.j)(e)&&(e=[]);var r={component:t,id:n};e.push(r);for(var i=De(r),a=e.length-1;a>0&&i<De(e[a-1]);){var o;o=[e[a],e[a-1]],e[a-1]=o[0],e[a]=o[1],--a}return e}(e.highlights,t,n),this._requestRender()}},{key:"removeHighlight",value:function(e,t){e.highlights=function(e,t){if(Object(y.j)(e))return e;var n=e.filter((function(e){return e.id!==t}));return 0===n.length?null:n}(e.highlights,t),this._requestRender()}},{key:"_initNode",value:function(e,t){var n=e.rctx;t.vao=new Me.a(n,je.a,Fe,{positions:Ae.a.createVertex(n,35044,t.coordinates),colors:Ae.a.createVertex(n,35044,t.rgb)})}},{key:"_requestRender",value:function(){this._context&&this._context.requestRender()}},{key:"_getSizeParams",value:function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes;return{drawScreenSpace:t,drawFixedSize:e,fixedSize:t?this._sizePx:this._size,screenMinSize:e?0:this._minSizePx}}},{key:"selectTechnique",value:function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=2===e.pass?1:5===e.pass?4:0,this._techniqueRep.releaseAndAcquire(Re,this._techniqueConfig,this._technique)}}]),e}();function Ee(e){return e?256:64}function Le(e,t,n,r,i){if(n.drawScreenSpace)return n.fixedSize*t*r;var a=Ee(i)*t*r;return n.drawFixedSize?Math.min(n.fixedSize/2,a):n.screenMinSize>0?Math.min(Math.max(n.screenMinSize*t*r,e/2),a):Math.min(e/2,a)}function qe(e,t,n,r,i){return n.drawScreenSpace?0:Le(e,t,n,r,i)}function De(e){return Object(y.k)(e.component)?e.component:-1}(Ve||(Ve={})).isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")};var He=n(841),Ue=n(460),Qe=n(420),We=n(577),Te=n(466),Be=n(97),Ge=_.a.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),Je=Object(R.d)(),Ke=function(e){Object(f.a)(n,e);var t=Object(p.a)(n);function n(){var e;return Object(l.a)(this,n),(e=t.apply(this,arguments)).type="point-cloud-3d",e.maximumPointCount=4e6,e.slicePlaneEnabled=!1,e._renderer=null,e._rendererAdded=!1,e._renderedNodes=new Set,e._nodeScales=new Map,e._updateViewNeeded=!0,e._lodFactor=1,e._maxLoggedBoxWarnings=5,e._pageMultiplier=1,e._nodeLoadEpoch=0,e._indexQueue=[],e._workQueue=new Array,e._idleQueue=new V.a,e._indexPagesLoading=new Map,e._loadingNodes=new Map,e._recalcWork=!0,e._layerIsVisible=!1,e._codedDomainPopulationPromise=null,e._codedDomainPopulationAbortController=null,e._totalWork=0,e._index=null,e._loadingInitNodePage=!1,e._nodeIdArray=[],e}return Object(c.a)(n,[{key:"pointScale",get:function(){var e=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"splat"===t.type?t:null}(this.layer&&this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1}},{key:"useRealWorldSymbolSizes",get:function(){var e=te(this.layer&&this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes}},{key:"pointSize",get:function(){var e=te(this.layer&&this.layer.renderer);return e&&null!=e.size?e.size:0}},{key:"inverseDensity",get:function(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}},{key:"availableFields",get:function(){var e=$(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);var n=ee(this.layer);if(n){var r,i=Object(u.a)(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;t.add(a.attributeInfo.name)}}catch(c){i.e(c)}finally{i.f()}}if(this.layer.outFields){var o,s=Object(u.a)(Object(F.u)(this.layer.fieldsIndex,this.layer.outFields));try{for(s.s();!(o=s.n()).done;){var l=o.value;t.add(l)}}catch(c){s.e(c)}finally{s.f()}}return Array.from(t)}},{key:"_clippingBox",get:function(){if(!this.view||!this.view.clippingArea)return null;var e=Object(N.h)(),t=this.view.renderSpatialReference;return Object(Ue.a)(this.view.clippingArea,e,t)?e:null}},{key:"_elevationOffset",get:function(){var e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=Object(x.g)(this.layer.spatialReference),n=Object(E.a)(e.unit);return Object(y.u)(e.offset,0)*n/t}return 0}},{key:"initialize",value:function(){var e=this,t=this.view.resourceController;this._worker=new q((function(e){return t.schedule(e)})),this.addResolvingPromise(this._worker.promise),this._tmpPoint=Object(I.j)(0,0,0,this.layer.spatialReference),Object(D.c)(this.layer),Object(D.b)(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(2),this._dataRequester=t.createStreamDataRequester(3),this._initRenderer();var n=this._initNodePages(),r=this.view.resourceController.memoryController;this._memCache=r.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"_elevationOffset",(function(){return e._elevationOffsetChanged()}),2),this.updatingHandles.add(this.layer,"renderer",(function(){return e._rendererChanged()}),2),this.updatingHandles.add(this.layer,"filters",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"outFields",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"scaleRangeId",(function(){return e._setUpdateViewNeeded()})),this.updatingHandles.add(this,"clippingArea",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view.state,"contentCamera",(function(){return e._setUpdateViewNeeded()})),this.handles.add([this.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),r.events.on("quality-changed",(function(){return e._setUpdateViewNeeded()}))]),this.addResolvingPromise(n),this.when((function(){e.handles.add([t.scheduler.registerTask(Be.b.POINT_CLOUD_LAYER,e),t.scheduler.registerIdleStateCallbacks((function(){return e._idleBegin()}),(function(){return e._idleEnd()})),e.updatingHandles.add(e,"suspended",(function(t){t?e._clearNodeState():e._setUpdateViewNeeded()}),2)])}),(function(){e.updatingHandles.removeAll(),e.handles.removeAll()}))}},{key:"_setUpdateViewNeeded",value:function(){this._updateViewNeeded=!0,this._updateLoading()}},{key:"destroy",value:function(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null}},{key:"_initRenderer",value:function(){var e=this;this._renderer=new Ve({createGraphic:function(t,n,r){return e._createGraphic(t,n,r)}}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(function(t){return e._renderer.clippingBox=t}),2),this.updatingHandles.add(this,"suspended",(function(t){return e._setPointsVisible(!t)}),2),this.updatingHandles.add(this,"pointScale",(function(t){return e._renderer.scaleFactor=t}),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(function(t){return e._renderer.useRealWorldSymbolSizes=t}),2),this.updatingHandles.add(this,"pointSize",(function(t){var n=Object(O.g)(t);e._renderer.size=t,e._renderer.sizePx=n}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._renderer.slicePlane=t}),2),this.updatingHandles.add(this,"inverseDensity",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"maximumPointCount",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(function(t){e._lodFactor=t,e._setUpdateViewNeeded()}),2)}},{key:"_destroyRenderer",value:function(){this._renderer.removeAll(),this._setPointsVisible(!1)}},{key:"_createGraphic",value:function(e,t,n){var r=Object(y.k)(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,i=this.view.computeMapPointFromVec3d(n),a=this._createGraphicAttributes(e,r);return new ue({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:r,epoch:this._nodeLoadEpoch},geometry:i,attributes:a,layer:this.layer,sourceLayer:this.layer})}},{key:"_createGraphicAttributes",value:function(e,t){var n,r={},i=Object(u.a)(e.attributes);try{for(i.s();!(n=i.n()).done;){var a=n.value;this._encodeGraphicAttribute(a.attributeInfo,a.values,t,r)}}catch(o){i.e(o)}finally{i.f()}return r}},{key:"_encodeGraphicAttribute",value:function(e,t,n,r){var i=e.storageInfo&&e.storageInfo.attributeValues,a=i?i.valuesPerElement:1;if(1===a)r[e.name]=t[n];else if("UInt8"===i.valueType&&a<=4){for(var o=0,s=n*a,u=s;u<s+a;u++)o=(o<<8)+t[u];r[e.name]=o}else r[e.name]=void 0}},{key:"_setPointsVisible",value:function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}},{key:"_rendererChanged",value:function(){this._renderer.useFixedSizes=function(e){var t=e&&e.pointSizeAlgorithm;return!(!t||!t.type)&&"fixed-size"===t.type}(this.layer.renderer),this._reload()}},{key:"_reload",value:function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}},{key:"_elevationOffsetChanged",value:function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}},{key:"_scaleUpdateHandler",value:function(e){var t=this;this.layer.minScale||this.layer.maxScale?Object(z.o)(e.extent,e.spatialReference,Ye,this.layer.spatialReference)&&(this._nodeScales.forEach((function(n,r){if(t._renderedNodes.has(r)){var i=t._index.getNode(r);Object(C.h)(Ye,i.obb.center)&&t._nodeScales.set(r,e.scale)}else t._nodeScales.delete(r)})),this._setUpdateViewNeeded()):this._nodeScales.clear()}},{key:"displayNodes",value:function(e){var t,n,r;this._workQueue=function(e,t,n){for(var r=0;r<t.length;r++)Q[r]=!1,W[r]=null;for(var i=0;i<e.length;i++)H[i]=!1,U[i]=null;for(var a=0;a<t.length;a++){var o=T(t[a],e,n);o>=0&&(Q[a]=!0,null!=U[o]?U[o].push(t[a]):U[o]=[t[a]])}for(var s=0;s<e.length;s++){var u=T(e[s],t,n);u>=0&&(H[s]=!0,null!=W[u]?W[u].push(e[s]):W[u]=[e[s]])}for(var l=[],c=0;c<e.length;c++)null!=U[c]||H[c]||l.push({load:[],remove:[e[c]]});for(var d=0;d<t.length;d++)null!=W[d]||Q[d]||l.push({load:[t[d]],remove:[]});for(var h=0;h<t.length;h++)null!=W[h]&&(W[h].length>1||W[h][0]!==t[h])&&l.push({load:[t[h]],remove:W[h]});for(var f=0;f<e.length;f++)null!=U[f]&&(U[f].length>1||U[f][0]!==e[f])&&l.push({load:U[f],remove:[e[f]]});return l}(Object(s.a)(this._renderedNodes),e,this._index),t=this._workQueue,n=this.view.state.contentCamera.viewForward,r=this._index,t.sort((function(e,t){if(0===e.load.length&&0===t.load.length)return 0;if(0===e.load.length)return-1;if(0===t.load.length)return 1;if(0===e.remove.length&&0===t.remove.length){var i=r.getRenderCenter(e.load[0]),a=r.getRenderCenter(t.load[0]);return Object(w.j)(i,n)-Object(w.j)(a,n)}if(0===e.remove.length)return-1;if(0===t.remove.length)return 1;if(1===e.load.length&&1===t.load.length){var o=r.getRenderCenter(e.load[0]),s=r.getRenderCenter(t.load[0]);return Object(w.j)(o,n)-Object(w.j)(s,n)}if(1===e.load.length)return-1;if(1===t.load.length)return 1;var u=r.getRenderCenter(e.remove[0]),l=r.getRenderCenter(t.remove[0]);return Object(w.j)(u,n)-Object(w.j)(l,n)})),function(e,t,n){for(var r=0;r<e.length;++r){var i=e[r];i.load.length>t&&1===i.remove.length&&B(e,i,n)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}},{key:"cancelLoading",value:function(){this._cancelNodeLoading(),this._cancelIndexLoading()}},{key:"_cancelNodeLoading",value:function(){var e=new Array;this._loadingNodes.forEach((function(t){var n=t.abortController;return e.push(n)})),this._loadingNodes.clear();for(var t=0,n=e;t<n.length;t++){n[t].abort()}this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_updateQueues",value:function(){var e=this,t=new Set;this._workQueue.forEach((function(e){return e.load.forEach((function(e){return t.add(e)}))}));var n=new Array,r=new Map;this._loadingNodes.forEach((function(e,i){t.has(i)?r.set(i,e):n.push(e)})),this._loadingNodes=r;for(var i=0,a=n;i<a.length;i++){a[i].abortController.abort()}this._workQueue=this._workQueue.filter((function(t){var n,r=Object(u.a)(t.load);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(e._loadingNodes.has(i))return e._recalcWork=!0,!1}}catch(a){r.e(a)}finally{r.f()}return!0})),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_cancelIndexLoading",value:function(){this._indexQueue=[],this._indexPagesLoading.forEach((function(e){return e.abortController.abort()})),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}},{key:"_clearNodeState",value:function(){var e=this;this._nodeLoadEpoch++,this._renderedNodes.forEach((function(t){return e._removeFromRenderer(t)})),this._cancelNodeLoading()}},{key:"_idleBegin",value:function(){this._setUpdateViewNeeded()}},{key:"_idleEnd",value:function(){this._setUpdateViewNeeded()}},{key:"running",get:function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0}},{key:"runTask",value:function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var n=this._isRootNodeVisible();n!==this._layerIsVisible&&(this._layerIsVisible=n,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((function(){return t._updateWorkQueues()}));this._indexQueue.length>0&&e.run((function(){return t._processIndexQueue()})););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((function(){return t._idleQueue.process()})););}}},{key:"_processIndexQueue",value:function(){var e=this,t=this._indexQueue.shift(),n=this._loadNodePage(t);return this._indexPagesLoading.set(t,n),n.promise.then((function(n){e._index.addPage(t,n,e._elevationOffset),e._setUpdateViewNeeded()})).then((function(){e._indexPagesLoading.delete(t)}),(function(){e._indexPagesLoading.delete(t)})),!0}},{key:"_processWorkQueue",value:function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(Object(y.j)(t))return;this._processWorkEntry(t),e.madeProgress()}}},{key:"_scheduleWorkEntry",value:function(){for(var e=this,t=this._workQueue.length;t--;){var n=this._workQueue.shift();if(!n.remove.find((function(t){return!e._renderedNodes.has(t)})))return n;this._workQueue.push(n)}return null}},{key:"_processWorkEntry",value:function(e){var t=this;if(0!==e.load.length)Promise.all(e.load.map((function(e){var n=Object(m.e)(),r=t._memCache.pop(e.toString());return Object(y.k)(r)?t._loadingNodes.set(e,{abortController:n,promise:Promise.resolve(r)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:n,promise:t.loadNode(e,n.signal)}),t._loadingNodes.get(e).promise}))).then((function(n){for(var r=0;r<e.load.length;r++)if(n[r]){var i=t._setupRendererData(e.load[r],n[r]);t._addToRenderer(i)}var a,o=Object(u.a)(e.remove);try{for(o.s();!(a=o.n()).done;){var s=a.value;t._removeFromRenderer(s)}}catch(l){o.e(l)}finally{o.f()}})).catch((function(){})).then((function(){var n,r=Object(u.a)(e.load);try{for(r.s();!(n=r.n()).done;){var i=n.value;t._loadingNodes.delete(i)}}catch(a){r.e(a)}finally{r.f()}t._updateLoading(),t._recalcWork&&0===t._idleQueue.length&&0===t._indexQueue.length&&0===t._loadingNodes.size&&(t._recalcWork=!1,t._setUpdateViewNeeded())})),this._updateLoading();else{var n,r=Object(u.a)(e.remove);try{for(r.s();!(n=r.n()).done;){var i=n.value;this._removeFromRenderer(i)}}catch(a){r.e(a)}finally{r.f()}}}},{key:"populateClassCodeCodedDomain",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n){var r,i,o,s,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r="CLASS_CODE",(i=this.layer.fieldsIndex.get(r))&&!i.domain){e.next=3;break}return e.abrupt("return");case 3:if(-1!==t.indexOf(i.name)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(v.d)(this.layer.queryCachedStatistics(r,{signal:n}));case 7:if(!1!==(o=e.sent).ok){e.next=10;break}return e.abrupt("return");case 10:s=o.value,(u=s&&s.labels&&s.labels.labels)&&Array.isArray(u)&&(i.domain=new M.a({name:"CLASS_CODE",codedValues:u.map((function(e){return new A.a({code:e.value,name:e.label})}))}));case 12:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"prepareFetchPopupFeatures",value:function(){var e=Object(o.a)(a.a.mark((function e(t){var n=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=Object(m.e)(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(t,this._codedDomainPopulationAbortController.signal).then((function(){n._codedDomainPopulationAbortController=null}))),this._codedDomainPopulationPromise));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"whenGraphicAttributes",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n){var r,i,s,l,c,d=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._splitGraphicsPerNode(t),i=this.layer.attributeStorageInfo,s=n.map((function(e){return re(i,e)})),l=function(){var e=Object(o.a)(a.a.mark((function e(t,n){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d._index.getNode(n),e.next=3,Object(v.b)(s,function(){var e=Object(o.a)(a.a.mark((function e(n){var i,o,s,l,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.useElevation){e.next=6;break}return e.next=3,d._loadElevationAttributeFromGeometry(r.resourceId);case 3:e.t0=e.sent,e.next=9;break;case 6:return e.next=8,d._loadAndParseAttribute(r,n);case 8:e.t0=e.sent;case 9:if(i=e.t0){o=Object(u.a)(t);try{for(o.s();!(s=o.n()).done;)l=s.value,d._isValidPointGraphic(l)&&(c=l.pointCloudMetadata.attributePointIndexInNode,d._encodeGraphicAttribute(n,i,c,l.attributes))}catch(a){o.e(a)}finally{o.f()}}case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),c=[],r.forEach((function(e,t){c.push(l(e,t))})),e.next=4,Object(m.k)(c);case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_isValidPointGraphic",value:function(e){return e instanceof ue&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch}},{key:"_splitGraphicsPerNode",value:function(e){var t,n=new Map,r=Object(u.a)(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(this._isValidPointGraphic(i)){var a=i.pointCloudMetadata,o=n.get(a.nodeId);o?o.push(i):n.set(a.nodeId,[i])}}}catch(s){r.e(s)}finally{r.f()}return n}},{key:"_loadAndParseAttribute",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._loadAttribute(t.resourceId,n,null);case 2:return r=e.sent,e.abrupt("return",Object(y.k)(r)?Object(ae.d)({attributeInfo:n,buffer:r},null,t.vertexCount):null);case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadElevationAttributeFromGeometry",value:function(){var e=Object(o.a)(a.a.mark((function e(t){var n,r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.layer.store.defaultGeometrySchema,e.t0=ae.e,e.t1=n,e.next=5,this._loadGeometry(t,null);case 5:return e.t2=e.sent,r=(0,e.t0)(e.t1,e.t2),e.abrupt("return",Object(ae.a)(r,r.length/3));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"highlight",value:function(e){var t=this;if(!e)return{remove:function(){}};var n=g.a.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(n.map((function(e){return t._graphicToPointDefinition(e)})))}},{key:"_graphicToPointDefinition",value:function(e){if(!this._isValidPointGraphic(e))return null;var t=e.pointCloudMetadata,n=t.nodeId,r=t.pointIndexInNode;return null!=n&&null!=r?{nodeId:n,pointId:r}:null}},{key:"_computeWork",value:function(){var e,t=0,n=Object(u.a)(this._workQueue);try{for(n.s();!(e=n.n()).done;){var r=e.value;t+=r.load.length+r.remove.length}}catch(i){n.e(i)}finally{n.f()}return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0}},{key:"updatingProgressValue",get:function(){if(this.suspended)return this._updateViewNeeded?0:1;var e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}},{key:"_updateLoading",value:function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}},{key:"canResume",value:function(){return Object(d.a)(Object(h.a)(n.prototype),"canResume",this).call(this)&&this._layerIsVisible}},{key:"isUpdating",value:function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}},{key:"_initNodePages",value:function(){var e=this,t=this.layer.store.index,n=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new J(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,n),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then((function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()}))}},{key:"_loadNodePage",value:function(e){var t=this,n=Object(m.e)(),r="".concat(this.baseUrl,"/nodepages/").concat(e*this._pageMultiplier);return{promise:this._requestNodePage(r,n.signal).then((function(n){return n.nodes.map((function(n,r){return{resourceId:null!=n.resourceId?n.resourceId:e*t._index.pageSize+r,obb:n.obb,firstChild:n.firstChild,childCount:n.childCount,vertexCount:null!=n.vertexCount?n.vertexCount:n.pointCount,lodThreshold:null!=n.lodThreshold?n.lodThreshold:n.effectiveArea}}))})),abortController:n}}},{key:"_updateWorkQueues",value:function(){if(!this._updateViewNeeded)return!1;for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),n=this._computeNodesForMinimumDensity(e),r=this._computePointCount(n),i=Math.sqrt(r/(.75*t));r>t;)e*=i,n=this._computeNodesForMinimumDensity(e),r=this._computePointCount(n),i=Math.sqrt(2);return this.displayNodes(n),this._updateViewNeeded=!1,this._updateLoading(),!0}},{key:"_computePointCount",value:function(e){for(var t=0,n=0;n<e.length;n++){var r=this._index.getNode(e[n]);r&&(t+=r.vertexCount)}return t}},{key:"_getLodMemoryFactor",value:function(){return this.view.resourceController.memoryController.memoryFactor}},{key:"_isRootNodeVisible",value:function(){var e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:function(t,n,r){return e=r,!1},pageMiss:function(){}}),e}},{key:"_computeNodesForMinimumDensity",value:function(e){var t=this,n=this.view.state.contentCamera,r=n.frustum,i=this._clippingBox,a=n.viewForward,o=Object(w.j)(a,n.eye),s=Object(R.f)(a,-o,Je),u=n.perScreenPixelRatio/2,l=e*e,c=this._nodeIdArray;c.length=0;var d=Object(Te.a)(this.layer),h=d.minScale,f=d.maxScale,p=0===h&&0===f?function(e){return c.push(e)}:function(e){var n=t._getScale(e);Object(Te.d)(n,h,f)&&c.push(e)};return this._traverseVisible({frustum:r,clippingBox:i},{predicate:function(e,n,r){if(!r)return!1;if(0===n.childCount)return p(e),!1;var i=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(i,n.lodThreshold,n.vertexCount,s,u)<=l)||(p(e),!1)},pageMiss:function(e,n){p(e),t._indexQueue.indexOf(n)<0&&t._indexQueue.push(n)}}),c}},{key:"_getScale",value:function(e){var t=this._nodeScales.get(e);if(null==t){var n=this._index.getNode(e).obb.center;this._tmpPoint.x=n[0],this._tmpPoint.y=n[1],this._tmpPoint.z=n[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t}},{key:"_computeAveragePixelArea",value:function(e,t,n,r,i){var a=Math.max(1e-7,Object(G.j)(e,r));return t/(a*a)/(4*i*i)/n}},{key:"loadNode",value:function(e,t){try{return this.loadNodeAsync(e,t)}catch(n){throw Object(m.n)(n)||Ge.error(n),n}}},{key:"loadAdditionalUserAttributes",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n,r){var i,o,s,l,c,d,h,f,p,b;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.layer.outFields){e.next=3;break}return e.abrupt("return",[]);case 3:o=Object(F.u)(this.layer.fieldsIndex,i),s=new Set(t.map((function(e){return Object(y.k)(e)?e.name:null}))),l=this.layer.attributeStorageInfo,c=[],d=Object(u.a)(o),e.prev=5,d.s();case 7:if((h=d.n()).done){e.next=15;break}if(f=h.value,!s.has(f)){e.next=11;break}return e.abrupt("continue",13);case 11:(p=re(l,f))&&c.push(n(p));case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),d.e(e.t0);case 20:return e.prev=20,d.f(),e.finish(20);case 23:return e.next=25,Object(m.l)(c);case 25:return b=e.sent,e.abrupt("return",(Object(m.x)(r),Object(y.o)(b,(function(e){return e}))));case 27:case"end":return e.stop()}}),e,this,[[5,17,20,23]])})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"loadNodeAsync",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n){var i,u,l,c,d,h=this;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._index.getNode(t),u=$(this.layer),l=ee(this.layer),c=i.resourceId,d=function(){var e=Object(o.a)(a.a.mark((function e(t){var r;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(y.j)(t)){e.next=2;break}return e.abrupt("return",null);case 2:if(!t.useElevation){e.next=4;break}return e.abrupt("return",{attributeInfo:t,buffer:null});case 4:return e.next=6,h._loadAttribute(c,t,n);case 6:return r=e.sent,e.abrupt("return",Object(y.k)(r)?{attributeInfo:t,buffer:r}:null);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.abrupt("return",this._idleQueue.push(Object(o.a)(a.a.mark((function e(){var i,o,f,p,b,v,g,_,y,O,j,x,k,S,w,P;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=h._loadGeometry(c,n),o=u.primaryAttribute,f=u.modulationAttribute,p=d(o),b=d(f),v=l.map((function(e){return e.attributeInfo})),g=v.map((function(e){return d(e)})),_=h.loadAdditionalUserAttributes([o,f].concat(Object(s.a)(v)),d,n),e.next=10,Promise.all([i,p,b,Promise.all(g),_]);case 10:return y=e.sent,O=Object(r.a)(y,5),j=O[0],x=O[1],k=O[2],S=O[3],w=O[4],Object(m.x)(n),P={geometryBuffer:j,primaryAttributeData:x,modulationAttributeData:k,filterAttributesData:S,userAttributesData:w,schema:h.layer.store.defaultGeometrySchema,rendererInfo:u,filterInfo:l,obb:h._index.getRenderObb(t),elevationOffset:h._elevationOffset,inSR:h.layer.spatialReference.toJSON(),outSR:h.view.renderCoordsHelper.spatialReference.toJSON()},e.abrupt("return",h._worker.invoke(P,n));case 20:case"end":return e.stop()}}),e)}))),n));case 2:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadGeometry",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._requestData("".concat(this.baseUrl,"/nodes/").concat(t,"/geometries/0"),n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"_loadAttribute",value:function(){var e=Object(o.a)(a.a.mark((function e(t,n,r){var i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(y.j)(n)&&n.storageInfo){e.next=2;break}return e.abrupt("return",null);case 2:return i=n.storageInfo.key,e.abrupt("return",this._requestData("".concat(this.baseUrl,"/nodes/").concat(t,"/attributes/").concat(i),r));case 4:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"_requestNodePage",value:function(e,t){var n={f:"json",token:this.layer.apiKey};return this._indexRequester.request(e,"json",{query:n,signal:t})}},{key:"_requestData",value:function(e,t){return this._dataRequester.request(e,"binary",{query:{token:this.layer.apiKey},signal:t})}},{key:"_removeFromRenderer",value:function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}}},{key:"_addToRenderer",value:function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}},{key:"_setupRendererData",value:function(e,t){var n=this._index.getNode(e),r=Math.sqrt(n.lodThreshold/n.vertexCount),i=this._index.getRenderObb(e);if(Ve.isInstanceOfNode(t))return t.splatSize=r,t.obb=i,t.origin=Object(P.a)(t.obb.center),t;var a=.01*Math.max(i.halfSize[0],i.halfSize[1],i.halfSize[2]);if(t.obb.halfSize[0]>i.halfSize[0]+a||t.obb.halfSize[1]>i.halfSize[1]+a||t.obb.halfSize[2]>i.halfSize[2]+a){if(this._maxLoggedBoxWarnings>0){var o=function(e){return"[".concat(e.halfSize[0],", ").concat(e.halfSize[1],", ").concat(e.halfSize[2],"]")};Ge.warn("Node ".concat(e," reported bounding box too small. got ").concat(o(i)," but points cover ").concat(o(t.obb))),0==--this._maxLoggedBoxWarnings&&Ge.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:Object(P.a)(i.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:r,obb:i,isLeaf:0===n.childCount}}},{key:"getUsedMemory",value:function(){var e=0;return this._renderer.forEachNode((function(t){e+=Xe,e+=Object(j.a)(t.coordinates);var n,r=Object(u.a)(t.attributes);try{for(r.s();!(n=r.n()).done;){var i=n.value.values;Object(j.c)(i.buffer)&&(e+=Object(j.a)(i))}}catch(a){r.e(a)}finally{r.f()}})),e}},{key:"getUnloadedMemory",value:function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var n=Object(s.a)(this._renderedNodes).reduce((function(t,n){return t+e._index.getNode(n).vertexCount})),r=this._loadingNodes.size,i=0;i<this._workQueue.length;i++)r+=this._workQueue[i].load.length,r-=this._workQueue[i].remove.length;return r<0?0:r*n/t*((this.getUsedMemory()-t*Xe)/n)+r*Xe}},{key:"ignoresMemoryFactor",value:function(){return!1}},{key:"performanceInfo",get:function(){var e=this;return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:Object(s.a)(this._renderedNodes).reduce((function(t,n){return t+e._index.getNode(n).vertexCount}),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}},{key:"test",get:function(){return{index:this._index,visibleNodes:this._renderedNodes}}}]),n}(Object(He.a)(Object(L.a)(We.a)));Object(b.a)([Object(k.b)()],Ke.prototype,"layer",void 0),Object(b.a)([Object(k.b)({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],Ke.prototype,"baseUrl",void 0),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"pointScale",null),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"useRealWorldSymbolSizes",null),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"pointSize",null),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"inverseDensity",null),Object(b.a)([Object(k.b)()],Ke.prototype,"maximumPointCount",void 0),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"availableFields",null),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"_clippingBox",null),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"_elevationOffset",null),Object(b.a)([Object(k.b)({type:Boolean})],Ke.prototype,"slicePlaneEnabled",void 0),Object(b.a)([Object(k.b)()],Ke.prototype,"updating",void 0),Object(b.a)([Object(k.b)(Qe.a)],Ke.prototype,"updatingProgress",void 0),Object(b.a)([Object(k.b)({readOnly:!0})],Ke.prototype,"updatingProgressValue",null),Ke=Object(b.a)([Object(S.a)("esri.views.3d.layers.PointCloudLayerView3D")],Ke);var Ye=Object(C.l)(),Xe=160,Ze=Ke},742:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return l}));var r=n(8),i=n.n(r),a=n(44),o=n(16),s=n(3),u=n(105);function l(e){return c.apply(this,arguments)}function c(){return c=Object(o.a)(i.a.mark((function e(t){var n,r,o,l,c,d,h,f,p,b=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=b.length>1&&void 0!==b[1]?b[1]:t.popupTemplate,Object(s.k)(n)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,n.getRequiredFields(t.fieldsIndex);case 5:if(r=e.sent,o=n.lastEditInfoEnabled,l=t.objectIdField,c=t.typeIdField,d=t.globalIdField,h=t.relationships,!r.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!o){e.next=19;break}return e.next=16,Object(u.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,p=Object(u.j)(t.fieldsIndex,[].concat(Object(a.a)(r),Object(a.a)(f))),e.abrupt("return",(c&&p.push(c),p&&l&&t.fieldsIndex.has(l)&&-1===p.indexOf(l)&&p.push(l),p&&d&&t.fieldsIndex.has(d)&&-1===p.indexOf(d)&&p.push(d),h&&h.forEach((function(e){var n=e.keyField;p&&n&&t.fieldsIndex.has(n)&&-1===p.indexOf(n)&&p.push(n)})),p));case 23:case"end":return e.stop()}}),e)}))),c.apply(this,arguments)}function d(e,t){return e.popupTemplate?e.popupTemplate:Object(s.k)(t)&&t.defaultPopupTemplateEnabled&&Object(s.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},841:function(e,t,n){"use strict";n.d(t,"a",(function(){return _}));var r=n(44),i=n(13),a=n(8),o=n.n(a),s=n(16),u=n(2),l=n(4),c=n(6),d=n(7),h=n(0),f=n(22),p=n(3),b=(n(1),n(17),n(18),n(15),n(11)),v=n(105),g=n(742),_=function(e){var t=function(e){Object(c.a)(n,e);var t=Object(d.a)(n);function n(){return Object(u.a)(this,n),t.apply(this,arguments)}return Object(l.a)(n,[{key:"_validateFetchPopupFeatures",value:function(e){var t=this.layer;return t.popupEnabled?Object(g.a)(t,e)?void 0:new f.a("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new f.a("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}},{key:"prepareFetchPopupFeatures",value:function(){var e=Object(s.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPopupFeatures",value:function(){var e=Object(s.a)(o.a.mark((function e(t,n){var a,s,u,l,c,d,h,f,b,_;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=this._validateFetchPopupFeatures(n))){e.next=3;break}return e.abrupt("return",Promise.reject(a));case 3:if((s=Object(p.k)(n)?n.clientGraphics:null)&&0!==s.length){e.next=6;break}return e.abrupt("return",Promise.resolve([]));case 6:return u=[],l=[],c="scene"===this.layer.type&&Object(p.k)(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,e.t0=v.u,e.t1=this.layer.fieldsIndex,e.next=13,Object(g.b)(c,Object(g.a)(this.layer,n));case 13:return e.t2=e.sent,d=(0,e.t0)(e.t1,e.t2),e.next=17,this.prepareFetchPopupFeatures(d);case 17:h=new Set,f=Object(i.a)(s);try{for(f.s();!(b=f.n()).done;)_=b.value,Object(v.s)(d,_,h)?l.push(_):u.push(_)}catch(t){f.e(t)}finally{f.f()}return e.abrupt("return",0===l.length?Promise.resolve(u):this.whenGraphicAttributes(l,Object(r.a)(h)).catch((function(){return l})).then((function(e){return u.concat(e)})));case 21:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()}]),n}(e);return t=Object(h.a)([Object(b.a)("esri.views.3d.layers.support.PopupSceneLayerView")],t)}},913:function(e,t,n){"use strict";n.d(t,"a",(function(){return y})),n.d(t,"b",(function(){return _}));var r,i,a,o,s,u,l,c,d,h=n(12),f=n(78),p=n(112),b=n(166),v=n(9),g=n(81);function _(e){var t=new g.a,n=0===e.output,_=1===e.output,y=4===e.output;return t.extensions.add("GL_OES_standard_derivatives"),t.include(f.a,e),t.attributes.add("position","vec3"),t.attributes.add("color","vec3"),t.vertex.uniforms.add("uModelViewMatrix","mat4").add("uProjectionMatrix","mat4").add("uScreenMinMaxSize","vec2").add("uPointScale","vec2").add("uClipMin","vec3").add("uClipMax","vec3"),_?(t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float")):4!==e.output&&t.varyings.add("vColor","vec3"),t.vertex.code.add(Object(v.a)(r||(r=Object(h.a)(["\n    void main(void) {\n      // Move clipped points outside of clipspace\n      if (position.x < uClipMin.x || position.y < uClipMin.y || position.z < uClipMin.z ||\n        position.x > uClipMax.x || position.y > uClipMax.y || position.z > uClipMax.z) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      if (rejectBySlice(position)) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      // Position in camera space\n      vec4 camera = uModelViewMatrix * vec4(position, 1.0);\n\n      float pointSize = uPointScale.x;\n      vec4 position = uProjectionMatrix * camera;\n     ","\n\n     gl_PointSize = clampedScreenSize;\n     gl_Position = position;\n\n     ","\n     ","\n    }\n  "])),e.drawScreenSize?Object(v.a)(i||(i=Object(h.a)(["\n      float clampedScreenSize = pointSize;"]))):Object(v.a)(a||(a=Object(h.a)(["\n      float pointRadius = 0.5 * pointSize;\n      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);\n      vec4 positionOffset = uProjectionMatrix * cameraOffset;\n      float radius = abs(positionOffset.y - position.y);\n      float viewHeight = uPointScale.y;\n      // screen diameter = (2 * r / w) * (h / 2)\n      float screenPointSize = (radius / position.w) * viewHeight;\n      float clampedScreenSize = clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);\n      // Shift towards camera, to move rendered point out of terrain i.e. to\n      // the camera-facing end of the virtual point when considering it as a\n      // 3D sphere.\n      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\n      position = uProjectionMatrix * camera;"]))),_?Object(v.a)(o||(o=Object(h.a)(["depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);"]))):"",n?Object(v.a)(s||(s=Object(h.a)(["vColor = color;"]))):"")),t.fragment.include(b.a,e),y&&t.include(p.a),t.fragment.code.add(Object(v.a)(u||(u=Object(h.a)(["\n    void main(void) {\n      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);\n      float r2 = dot(vOffset, vOffset);\n\n      if (r2 > 0.25) {\n        discard;\n      }\n      ","\n      ","\n      ","\n    }\n  "])),_?Object(v.a)(l||(l=Object(h.a)(["gl_FragColor = float2rgba(depth);"]))):"",y?Object(v.a)(c||(c=Object(h.a)(["outputHighlight();"]))):"",n?Object(v.a)(d||(d=Object(h.a)(["gl_FragColor = vec4(vColor, 1.0);"]))):"")),t}var y=Object.freeze({__proto__:null,build:_})}}]);
//# sourceMappingURL=72.668c8c4b.chunk.js.map